<DOCUMENT filename="index.html">
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TURKMEDYA TEKNiK VARDiYA LiSTESi | Pro_Ugr</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<style>
:root {
--primary: #1e293b; --blue: #2563eb; --bg: #f1f5f9; --card-bg: #ffffff;
--text: #334155; --border: #e2e8f0; --danger: #ef4444; --success: #22c55e;
--warning: #f59e0b; --weekend-bg: #fff1f2; --table-head: #f8fafc;
--saat1: #e0f2fe; --saat2: #f0fdf4; --saat3: #faf5ff; --saat4: #fff7ed;
--izin-bg: #fef2f2;
}
[data-theme="dark"] {
--primary: #0f172a; --bg: #020617; --card-bg: #1e293b; --text: #f1f5f9;
--border: #334155; --weekend-bg: #2d1a1a; --table-head: #0f172a;
--saat1: #0c4a6e; --saat2: #064e3b; --saat3: #581c87; --saat4: #7c2d12;
--izin-bg: #450a0a;
}
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; font-size: 12px; transition: background 0.3s ease; }
/* GÄ°RÄ°Å EKRANI CSS */
#loginOverlay {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: var(--primary); z-index: 9999;
display: flex; flex-direction: column; align-items: center; justify-content: center;
transition: 0.5s;
}
.login-card {
background: var(--card-bg); padding: 40px; border-radius: 20px;
box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); text-align: center; width: 320px;
}
.login-btn {
width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px;
font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 14px;
}
.btn-user { background: var(--blue); color: white; }
.btn-admin { background: #475569; color: white; }
.login-logo { height: 60px; margin-bottom: 20px; }
.app-wrapper { padding: 10px; display: none; }
.main-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; gap: 10px; }
.table-container { overflow-x: auto; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); }
table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; table-layout: fixed; }
th { background: var(--table-head); color: var(--text); padding: 12px 8px; border-bottom: 2px solid var(--border); border-right: 1px solid var(--border); }
td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 6px; vertical-align: top; height: 95px; }
.saat-col { font-weight: 800; text-align: center; border-left: 5px solid var(--blue); width: 100px; }
.row-saat-0 { background-color: var(--saat1); }
.row-saat-1 { background-color: var(--saat2); }
.row-saat-2 { background-color: var(--saat3); }
.row-saat-3 { background-color: var(--saat4); }
.row-izin { background-color: var(--izin-bg) !important; }
.row-izin .saat-col { border-left-color: var(--danger) !important; color: var(--danger); }
.weekend-col { background-color: var(--weekend-bg) !important; }
.birim-card { border-left: 4px solid var(--blue); padding: 6px 8px; margin-bottom: 5px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border); cursor: pointer; }
.birim-ayirici { border-top: 5px solid #1e293b !important; margin-top: 8px !important; padding-top: 8px !important; }
.birim-tag { font-size: 7px; font-weight: 800; color: white; display: inline-block; padding: 1px 4px; border-radius: 3px; margin-bottom: 2px; text-transform: uppercase; }
.pers-name { font-size: 10px; font-weight: 700; display: block; }
.side-panel { position: fixed; top: 0; right: -550px; width: 500px; height: 100%; background: var(--card-bg); z-index: 1000; transition: 0.4s; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.2); }
.side-panel.open { right: 0; }
.panel-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
.panel-content { padding: 15px; overflow-y: auto; flex: 1; }
.panel-action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
.btn-main-action { padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px; color: white; }
.hidden { display: none; }
.tab-btn { flex: 1; padding: 8px; border: none; background: #e2e8f0; cursor: pointer; font-size: 10px; font-weight: 700; border-radius: 4px; color: #64748b; }
.tab-btn.active { background: var(--blue); color: white; }
.izin-gun-pill { padding: 4px 6px; background: var(--bg); border-radius: 4px; margin: 2px; font-size: 9px; cursor: pointer; display: inline-block; font-weight: 700; border: 1px solid var(--border); }
.izin-gun-pill.active { background: var(--danger); color: white; }
.mcr-ayarlar { background: #f8fafc; border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-top: 10px; }
/* YENÄ° SWAP UI STÄ°LLERÄ° */
.swap-container { border: 2px solid var(--blue); border-radius: 12px; padding: 15px; background: var(--saat3); margin-bottom: 15px; }
.swap-header { font-weight: 800; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; font-size: 13px; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
.swap-row { margin-bottom: 10px; }
.swap-label { display: block; font-size: 10px; font-weight: 700; margin-bottom: 3px; color: #64748b; }
.swap-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: white; font-weight: 600; font-size: 11px; }
.swap-days { display: flex; gap: 10px; margin-top: 10px; justify-content: space-between; }
.swap-day-item { display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; }
.admin-only { display: none; }
/* MOBÄ°L UYUMLULUK AYARLARI /
@media screen and (max-width: 768px) {
/ Tablo yapÄ±sÄ±nÄ± dikey karta Ã§evir */
#vardiyaTablosu, #vardiyaTablosu thead, #vardiyaTablosu tbody, #vardiyaTablosu th, #vardiyaTablosu td, #vardiyaTablosu tr {
display: block;
width: 100% !important;
min-width: 100% !important;
}
/* BaÅŸlÄ±klarÄ± gizle (kart iÃ§inde gÃ¶stereceÄŸiz) */
#tableHeader { display: none; }
/* Her satÄ±rÄ± (saat dilimini) bir kart gibi yap */
#tableBody tr, #tableFooter tr {
margin-bottom: 20px;
border: 2px solid var(--border);
border-radius: 12px;
overflow: hidden;
background: var(--card-bg);
}
/* Saat hÃ¼cresini kart baÅŸlÄ±ÄŸÄ±na Ã§evir */
.saat-col {
display: block;
width: 100% !important;
background: var(--primary);
color: white !important;
padding: 10px;
text-align: left !important;
border-left: none !important;
font-size: 14px;
}
/* GÃ¼n hÃ¼crelerini belirginleÅŸtir /
td:not(.saat-col)::before {
content: attr(data-label);
font-weight: 800;
text-transform: uppercase;
font-size: 12px;
display: block;
margin-bottom: 10px;
color: var(--blue);
background: var(--bg); / Arka plan ekleyerek netliÄŸi artÄ±rÄ±r */
padding: 4px;
border-radius: 4px;
text-align: center;
}
/* HÃ¼crenin hangi gÃ¼ne ait olduÄŸunu sol Ã¼ste ekle /
td:not(.saat-col) {
display: flex;
flex-direction: column;
gap: 8px; / Kartlar arasÄ± boÅŸluk /
height: auto !important; / Sabit yÃ¼ksekliÄŸi kaldÄ±r */
min-height: 50px;
}
/* Yan paneli mobilde tam ekran yap */
.side-panel {
width: 100%;
right: -100%;
}
.main-header {
flex-direction: column;
text-align: center;
}
}
</style>
</head>
<body>
  
    
        Logo
        Sistem GiriÅŸi
        <button onclick="enterSystem(&#x27;personel&#x27;)" class="login-btn btn-user">ğŸ‘¤ PERSONEL GÄ°RÄ°ÅÄ°</button>
        <button onclick="enterSystem(&#x27;admin&#x27;)" class="login-btn btn-admin">âš™ï¸ YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ°</button>
        TURKMEDYA TEKNÄ°K V61
    
  

    
        Vardiya / Ä°zin Talebi
        <select id="talepPersonel" style="width:100%; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border);"></select>
TARÄ°H SEÃ‡Ä°N:

        <select id="talepTuru" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border);">
            <option value="Ä°ZÄ°NLÄ°">Ä°ZÄ°NLÄ° (Ä°zin Talebi)</option>
            <option value="06:30â€“16:00">06:30â€“16:00</option>
            <option value="09:00â€“18:00">09:00â€“18:00</option>
            <option value="16:00â€“00:00">16:00â€“00:00</option>
            <option value="00:00â€“07:00">00:00â€“07:00</option>
        </select>
        <button onclick="talepGonder()" class="btn-main-action" style="background:var(--success); width:100%; padding:12px;">TALEBÄ° GÃ–NDER</button>
        <button onclick="document.getElementById(&#x27;talepModal&#x27;).style.display=&#x27;none&#x27;" style="background:none; border:none; color:var(--danger); margin-top:10px; cursor:pointer; font-weight:bold;">Ä°ptal</button>
    

  
  
    
      
        Logo
        TEKNiK EKÄ°P Ã‡ALIÅMA LÄ°STESÄ° V61
      
      
        <button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#475569">Â« Geri</button>
        <button onclick="buluttanYukle()" class="btn-main-action admin-only" style="background:#4285f4">ğŸ”„ BULUTTAN YÃœKLE</button>
        <button onclick="toggleTheme()" class="btn-main-action" style="background:#64748b" id="themeBtn">ğŸŒ™</button>
        <button onclick="excelIndir()" class="btn-main-action admin-only" style="background:#16a34a">EXCEL</button>
        <button onclick="window.print()" class="btn-main-action" style="background:var(--blue)">PDF / YAZDIR</button>
        <button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#475569">Ä°leri Â»</button>
        <button onclick="toggleAdminPanel()" class="btn-main-action admin-only" style="background:var(--primary); border: 1px solid #475569;" id="adminSettingsBtn">âš™ AYARLAR</button>
      
    
    
         <button onclick="talepModalAc()" class="btn-main-action" style="background:var(--warning); margin: 0 auto 15px auto; width: 250px; color: #1e293b; font-weight: 800; border: 2px solid #1e293b;">ğŸ“ VARDÄ°YA / Ä°ZÄ°N TALEBÄ° OLUÅTUR</button>
    
    
        
    
  
  
    YÃ¶netim Paneli<button onclick="toggleAdminPanel()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">Ã—</button>
    
        
            <button onclick="vardiyaUretVeKaydet()" class="btn-main-action" style="background:var(--success); grid-column: span 2; padding: 15px; font-size: 13px;">âœ¨ VARDÄ°YA OLUÅTUR</button>
            <button onclick="bulutaKaydet()" class="btn-main-action" style="background:#ea4335">â˜ï¸ BULUTA KAYDET</button>
            <button onclick="whatsappGonder()" class="btn-main-action" style="background:#25D366">ğŸŸ¢ WHATSAPP</button>
        
        
          <button id="btn-tab-personel" class="tab-btn active" onclick="tabDegistir(&#x27;personel&#x27;)">Personel</button>
          <button id="btn-tab-birimler" class="tab-btn" onclick="tabDegistir(&#x27;birimler&#x27;)">Birimler</button>
          <button id="btn-tab-saatler" class="tab-btn" onclick="tabDegistir(&#x27;saatler&#x27;)">Saatler</button>
          <button id="btn-tab-sabitle" class="tab-btn" onclick="tabDegistir(&#x27;sabitle&#x27;)">Sabitler</button>
          <button id="btn-tab-kapasite" class="tab-btn" onclick="tabDegistir(&#x27;kapasite&#x27;)">Kapasite</button>
          <button id="btn-tab-degisim" class="tab-btn" onclick="tabDegistir(&#x27;degisim&#x27;)" style="background: #2563eb; color: white;">DeÄŸiÅŸim</button>
          <button id="btn-tab-sistem" class="tab-btn" onclick="tabDegistir(&#x27;sistem&#x27;)">Sistem</button>
          <button id="btn-tab-talepler" class="tab-btn" onclick="tabDegistir(&#x27;talepler&#x27;)" style="background: var(--warning); color: black;">Talepler</button>
        
        <select id="yeniPersBirimSec" style="width:100%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);"></select><button onclick="personelEkle()" class="btn-main-action" style="width:100%; background:var(--success)">PERSONEL EKLE</button>
        
        
        
        
        
            
                âš¡ PERSONEL DEÄÄ°ÅÄ°MÄ° / SWAP
                
                    MEVCUT BÄ°RÄ°MÄ° KULLANILACAK OLAN (AYRILAN):
                    <select id="swapKaynakPersonel" class="swap-select"><option>SeÃ§iniz...</option></select>
                
                
                    â¬‡ï¸ YERÄ°NE GEÃ‡ECEK (Ä°ZÄ°NCÄ° KÄ°ÅÄ°) â¬‡ï¸
                    <select id="swapHedefPersonel" class="swap-select"><option>SeÃ§iniz...</option></select>
                
                
                    HANGÄ° GÃœNLER? (SeÃ§ilmezse iÅŸlem yapÄ±lmaz)
                    
                         Pzt
                         Sal
                         Ã‡ar
                         Per
                         Cum
                         Cmt
                         Paz
                    
                
<button onclick="degisimiUygula()" class="btn-main-action" style="background:var(--blue); width:100%; padding:12px; margin-top:10px;">DEÄÄ°ÅÄ°MÄ° UYGULA</button>
                * Yerine geÃ§ecek kiÅŸi, seÃ§ili gÃ¼nlerde kaynak personelin birim renginde ve grubunda gÃ¶rÃ¼necektir.
            
            
            <button onclick="tumDegisimleriTemizle()" class="btn-main-action" style="background:var(--danger); width:100%; margin-top:20px;">ğŸ—‘ï¸ TÃœM DEÄÄ°ÅÄ°MLERÄ° SÄ°L</button>
        
        <button onclick="jsonYedekAl()" class="btn-main-action" style="width:100%; background:var(--blue); margin-bottom:10px;">ğŸ’¾ JSON Ä°NDÄ°R</button><button onclick="jsonYedekYukle()" class="btn-main-action" style="width:100%; background:var(--success); margin-bottom:10px;">ğŸ“‚ YEDEÄÄ° YÃœKLE</button><button onclick="githubdanYedekYukle()" class="btn-main-action" style="width:100%; background:#000; color:#fff; margin-bottom:10px;">ğŸ“‚ GITHUB'DAN YÃœKLE</button><button onclick="vardiyaSifirla()" class="btn-main-action" style="width:100%; background:var(--warning); margin-bottom:10px;">Bu HaftayÄ± Temizle</button><button onclick="tamSifirla()" class="btn-main-action" style="width:100%; background:var(--danger)">TÃ¼m HafÄ±zayÄ± Sil</button>
        
        
    
  
  <script>
    // --- TELEGRAM AYARLARI (YENÄ°) ---
    let TELEGRAM_API = ""; 
    let TELEGRAM_ID = "";

    const firebaseConfig = { apiKey: "AIzaSyBY8dA7IQ0vcdjtG0haRVFuF0vTgZACU0M", authDomain: "teknik-vardiya-listesi.firebaseapp.com", databaseURL: "https://teknik-vardiya-listesi-default-rtdb.europe-west1.firebasedatabase.app", projectId: "teknik-vardiya-listesi", storageBucket: "teknik-vardiya-listesi.firebasestorage.app", messagingSenderId: "900931844150", appId: "1:900931844150:web:41c799492e85d62df8c097" };
    firebase.initializeApp(firebaseConfig); const database = firebase.database();
    const GUNLER = ["Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt", "Paz"]; const PREFIX = ""; const PANEL_SIFRE = "6161"; 
    const BIRIM_RENKLERI = { "TEKNÄ°K YÃ–NETMEN": "#2563eb", "SES OPERATÃ–RÃœ": "#7c3aed", "KJ OPERATÃ–RÃœ": "#db2777", "PLAYOUT OPERATÃ–RÃœ": "#059669", "REJÄ°": "#d97706", "24TV MCR OPERATÃ–RÃœ": "#9333ea","360TV MCR OPERATÃ–RÃœ": "#9333ea", "INGEST OPERATÃ–RÃœ": "#06b6d4" };

    let isAdmin = false;

    let state = {
        birimler: JSON.parse(localStorage.getItem(PREFIX + "birimler")) || ["TEKNÄ°K YÃ–NETMEN", "SES OPERATÃ–RÃœ", "KJ OPERATÃ–RÃœ", "PLAYOUT OPERATÃ–RÃœ", "24TV MCR OPERATÃ–RÃœ","360TV MCR OPERATÃ–RÃœ", "INGEST OPERATÃ–RÃœ"],
        saatler: JSON.parse(localStorage.getItem(PREFIX + "saatler")) || ["06:30â€“16:00", "09:00â€“18:00", "16:00â€“00:00", "00:00â€“07:00"],
        personeller: JSON.parse(localStorage.getItem(PREFIX + "personeller")) || [],
        kapasite: JSON.parse(localStorage.getItem(PREFIX + "kapasite")) || {},
        manuelAtamalar: JSON.parse(localStorage.getItem(PREFIX + "manuelAtamalar")) || {},
        haftaIciSabitler: JSON.parse(localStorage.getItem(PREFIX + "haftaIciSabitler")) || {},
        mcrAyarlari: JSON.parse(localStorage.getItem(PREFIX + "mcrAyarlari")) || { baslangicTarihi: new Date().toISOString().split('T')[0], ofsetler: {} },
        geciciGorevler: JSON.parse(localStorage.getItem(PREFIX + "geciciGorevler")) || {} // YENÄ° EKLENEN
    };

    let currentMonday = getMonday(new Date());

    // --- GÄ°RÄ°Å FONKSÄ°YONU (GÃœNCELLENDÄ°) ---
    // --- GÃœVENLÄ° GÄ°RÄ°Å VE AYAR YÃœKLEME ---
    async function hassasAyarlariYukle() {
        try {
            const snap = await database.ref('config').once('value');
            if (snap.exists()) {
                const config = snap.val();
                TELEGRAM_API = config.telegram_api;
                TELEGRAM_ID = config.telegram_id;
                console.log("Sistem: GÃ¼venli ayarlar yÃ¼klendi.");
            }
        } catch (error) {
            console.error("Ayarlar yÃ¼klenirken hata oluÅŸtu:", error);
        }
    }

    async function enterSystem(role) {
        if (role === 'admin') {
            const email = prompt("YÃ¶netici E-posta:");
            const password = prompt("YÃ¶netici Åifresi:");
            
            if (!email || !password) return;

            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                isAdmin = true;
                await hassasAyarlariYukle(); 
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                document.getElementById('persTalepArea').style.display = 'none';
                alert("YÃ¶netici giriÅŸi baÅŸarÄ±lÄ±!");
            } catch (error) {
                alert("HatalÄ± giriÅŸ: " + error.message);
                return;
            }
        } else {
            isAdmin = false;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.getElementById('persTalepArea').style.display = 'block';
        }
        
        document.getElementById('loginOverlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appMain').style.display = 'block';
            tabloyuOlustur();
        }, 500);
    }
      

    // --- TALEP SÄ°STEMÄ° FONKSÄ°YONLARI (YENÄ°) ---
    function talepModalAc() {
        const sel = document.getElementById('talepPersonel');
        sel.innerHTML = state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
        document.getElementById('talepModal').style.display = 'flex';
    }

    function talepGonder() {
    const ad = document.getElementById('talepPersonel').value;
    const tarih = document.getElementById('talepTarih').value;
    const tur = document.getElementById('talepTuru').value;
    
    if(!tarih) { alert("LÃ¼tfen tarih seÃ§in!"); return; }

    const secilenTarih = new Date(tarih);
    const pzt = getMonday(secilenTarih);
    const hKey = pzt.toISOString().split('T')[0];
    const gunIdx = (secilenTarih.getDay() + 6) % 7; 
    const talepId = Date.now().toString();

    // VeritabanÄ±na KayÄ±t
    database.ref('talepler/' + talepId).set({
        id: talepId, ad, tarih, gunIdx, tur, hKey, durum: "bekliyor"
    });

    // Telegram'a Butonlu GÃ¶nderim
    fetch(`https://api.telegram.org/bot${TELEGRAM_API}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            chat_id: TELEGRAM_ID,
            text: `ğŸ”” *YENÄ° VARDÄ°YA TALEBÄ°*\n\nğŸ‘¤ *Personel:* ${ad}\nğŸ“… *Tarih:* ${tarih}\nğŸ“ *Vardiya:* ${tur}`,
            parse_mode: 'Markdown',
            reply_markup: {
                inline_keyboard: [
                    [
                        { text: "âœ… ONAYLA", callback_data: `onay_${talepId}` },
                        { text: "âŒ REDDET", callback_data: `red_${talepId}` }
                    ]
                ]
            }
        })
    });

    alert("Talebiniz yÃ¶neticiye butonlu mesaj olarak iletildi.");
    document.getElementById('talepModal').style.display = 'none';
}

function talepleriYukle() {
    database.ref('talepler').orderByChild('durum').equalTo('bekliyor').on('value', snap => {
        const liste = document.getElementById('gelenTaleplerListesi');
        if(!snap.exists()) {
            liste.innerHTML = "Bekleyen talep bulunmuyor.";
            return;
        }
        let html = "";
        snap.forEach(item => {
            const t = item.val();
            html += `
            
                ${t.ad}
                ğŸ“… ${t.tarih} (Hafta: $$   {t.hKey})
ğŸ“ Ä°stek:    $${t.tur}
                
                    <button onclick="talepIslem(&#x27;${t.id}&#x27;, &#x27;onay&#x27;)" style="flex:1; background:var(--success); color:white; border:none; border-radius:6px; padding:8px; cursor:pointer; font-weight:700; font-size:10px;">ONAYLA</button>
                    <button onclick="talepIslem(&#x27;${t.id}&#x27;, &#x27;red&#x27;)" style="flex:1; background:var(--danger); color:white; border:none; border-radius:6px; padding:8px; cursor:pointer; font-weight:700; font-size:10px;">REDDET</button>
                
            `;
        });
        liste.innerHTML = html;
    });
}

function talepIslem(id, tip) {
    database.ref('talepler/' + id).once('value', snap => {
        const t = snap.val();
        if(tip === 'onay') {
            const mKey = `${t.hKey}_${t.ad}_${t.gunIdx}`;
            state.manuelAtamalar[mKey] = t.tur;
            save();
            tabloyuOlustur();
            database.ref('talepler/' + id).update({ durum: 'onaylandi' });
            alert("OnaylandÄ± ve vardiyaya iÅŸlendi.");
        } else {
            database.ref('talepler/' + id).update({ durum: 'reddedildi' });
            alert("Talep reddedildi.");
        }
    });
}

    // --- MEVCUT DÄ°ÄER FONKSÄ°YONLAR (BOZULMADI) ---
    function getMonday(d) { d = new Date(d); let day = d.getDay(); return new Date(d.setDate(d.getDate() - day + (day == 0 ? -6 : 1))); }
    function save() { Object.keys(state).forEach(k => localStorage.setItem(PREFIX + k, JSON.stringify(state[k]))); }
    function getBirimColor(birim) { return BIRIM_RENKLERI[birim] || "#64748b"; }

    // --- YENÄ° FONKSÄ°YON: GEÃ‡Ä°CÄ° BÄ°RÄ°M HESAPLAMA ---
    function getGecerliBirim(p, g) {
        // Bu fonksiyon, personelin o gÃ¼n iÃ§in Ã¶zel bir gÃ¶revi varsa onu dÃ¶ndÃ¼rÃ¼r.
        // Yoksa orijinal birimini dÃ¶ndÃ¼rÃ¼r.
        let d = new Date(currentMonday);
        d.setDate(d.getDate() + g);
        const dateKey = d.toISOString().split('T')[0];
        const key = `${dateKey}_${p.ad}`;
        
        return state.geciciGorevler[key] || p.birim;
    }

    function tabloyuOlustur() {
        const hKey = currentMonday.toISOString().split('T')[0];
        document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} HaftasÄ±`;
        
        // --- DÄ°NAMÄ°K TARÄ°H BAÅLIÄI (YIL EKLENDÄ°) ---
        document.getElementById("tableHeader").innerHTML = `SAAT${GUNLER.map((g,i)=>{
            let d = new Date(currentMonday); d.setDate(d.getDate() + i);
            let dateStr = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return `${g}
${dateStr}`;
        }).join('')}`;

        let prog = {}; let calis = {};
        state.personeller.forEach(p => { 
            prog[p.ad] = Array(7).fill(null); calis[p.ad] = 0;
            for(let i=0; i<7; i++) {
                let mKey = `${hKey}_${p.ad}_${i}`;
                if(state.manuelAtamalar[mKey]) prog[p.ad][i] = state.manuelAtamalar[mKey];
                if(prog[p.ad][i] && !["Ä°ZÄ°NLÄ°","BOÅ",null].includes(prog[p.ad][i])) calis[p.ad]++;
            }
        });

        document.getElementById("tableBody").innerHTML = state.saatler.map((s, sIdx) => {
            let rowHtml = `${s}`;
            for(let g=0; g<7; g++) {
                // --- DEÄÄ°ÅÄ°KLÄ°K: SIRALAMA VE GRUPLAMA ARTIK 'GEÃ‡ERLÄ° BÄ°RÄ°M'E GÃ–RE ---
                let sortedPers = state.personeller
                    .filter(p => prog[p.ad][g] === s)
                    .sort((a, b) => {
                        let birimA = getGecerliBirim(a, g);
                        let birimB = getGecerliBirim(b, g);
                        return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB);
                    });
                
                let cellContent = "";
                let lastBirim = "";
                sortedPers.forEach((p) => {
                    let gecerliBirim = getGecerliBirim(p, g); // O gÃ¼nkÃ¼ birimi al
                    let ayiriciClass = (lastBirim !== "" && lastBirim !== gecerliBirim) ? "birim-ayirici" : "";
                    let clickAttr = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : "";
                    let dragAttr = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, '${s}')"` : "";
                    
                    cellContent += `${gecerliBirim}${p.ad}`;
                    lastBirim = gecerliBirim;
                });
      rowHtml += `${cellContent}`;
            }
            return rowHtml + "";
        }).join('');

        document.getElementById("tableFooter").innerHTML = `
            Ä°ZÄ°N / BOÅ
                ${[0,1,2,3,4,5,6].map(g => {
                    let sortedPers = state.personeller
                        .filter(p => ["Ä°ZÄ°NLÄ°","BOÅ",null].includes(prog[p.ad][g]))
                        .sort((a, b) => {
                             let birimA = getGecerliBirim(a, g);
                             let birimB = getGecerliBirim(b, g);
                             return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB);
                        });
                    let cellContent = "";
                    let lastBirim = "";
                    sortedPers.forEach(p => {
                        let gecerliBirim = getGecerliBirim(p, g);
                        let ayiriciClass = (lastBirim !== "" && lastBirim !== gecerliBirim) ? "birim-ayirici" : "";
                        let clickAttr = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : "";
                        let dragAttr = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, 'BOÅ')"` : "";

                        cellContent += `${prog[p.ad][g]==='Ä°ZÄ°NLÄ°'?'Ä°ZÄ°NLÄ°':gecerliBirim}${p.ad} (${calis[p.ad]}G)`;
                        lastBirim = gecerliBirim;
                    });
                    return `${cellContent}`;
                }).join('')}`;
    }

    function cakismaKontrol(personelAd, hedefGun, hedefSaat) {
        const hKey = currentMonday.toISOString().split('T')[0];
        if (["Ä°ZÄ°NLÄ°", "BOÅ", null].includes(hedefSaat)) return;
        if (hedefGun > 0) {
            let dunKey = `${hKey}_${personelAd}_${hedefGun - 1}`;
            let dunVardiya = state.manuelAtamalar[dunKey];
            let sabahVardiyalari = ["06:30â€“16:00", "09:00â€“18:00"];
            let aksamVardiyalari = ["16:00â€“00:00", "00:00â€“07:00"];
            if (aksamVardiyalari.includes(dunVardiya) && sabahVardiyalari.includes(hedefSaat)) {
                alert(`âš ï¸ DÄ°KKAT: ${personelAd} dÃ¼n AKÅAM/GECE vardiyasÄ±ndaydÄ±. BugÃ¼n SABAH vardiyasÄ±na yazÄ±yorsunuz. Dinlenme sÃ¼resi yetersiz olabilir!`);
            }
        }
        if (hedefGun < 6) {
            let yarinKey = `${hKey}_${personelAd}_${hedefGun + 1}`;
            let yarinVardiya = state.manuelAtamalar[yarinKey];
            let sabahVardiyalari = ["06:30â€“16:00", "09:00â€“18:00"];
            let aksamVardiyalari = ["16:00â€“00:00", "00:00â€“07:00"];
            if (aksamVardiyalari.includes(hedefSaat) && sabahVardiyalari.includes(yarinVardiya)) {
                alert(`âš ï¸ DÄ°KKAT: ${personelAd} yarÄ±n SABAH vardiyasÄ±nda gÃ¶rÃ¼nÃ¼yor. BugÃ¼n AKÅAM/GECE vardiyasÄ±na yazÄ±yorsunuz. Dinlenme sÃ¼resi yetersiz olabilir!`);
            }
        }
    }

    // --- YENÄ° EKLENEN: PRNG (Kumarhane UsulÃ¼ Rastgele SayÄ± Ãœreteci) ---
    function mulberry32(a) {
      return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    // --- YENÄ° EKLENEN: SEEDED SHUFFLE (Tohumlu KarÄ±ÅŸtÄ±rma) ---
    // (ArtÄ±k kullanÄ±lmÄ±yor ama kÃ¼tÃ¼phane olarak kalsÄ±n)
    function seededShuffle(array, seed) {
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            hash = Math.imul(31, hash) + seed.charCodeAt(i) | 0;
        }
        let rng = mulberry32(hash);
        let m = array.length, t, i;
        while (m) {
            i = Math.floor(rng() * m--);
            t = array[m];
            array[m] = array[i];
            array[i] = t;
        }
        return array;
    }

    // --- KRÄ°TÄ°K GÃœNCELLEME: ADALETLÄ° PAZARTESÄ° ROTASYONU ---
    function vardiyaUretVeKaydet() {
        if(!isAdmin) return;
        const hKey = currentMonday.toISOString().split('T')[0];
        const prevMonday = new Date(currentMonday); prevMonday.setDate(prevMonday.getDate() - 7);
        const prevHKey = prevMonday.toISOString().split('T')[0];
        const weekOffset = Math.floor(currentMonday.getTime() / (1000 * 60 * 60 * 24 * 7)) % 10;

        let tempProg = {}; let calis = {};
        
        const mcrDongu = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "00:00â€“07:00", "00:00â€“07:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"];
        const ingestDongu = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"];
        const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);

        // --- 1. Ã–NCE TEMEL ATAMALARI YAP (MCR/INGEST/SABÄ°T) ---
        state.personeller.forEach(p => { 
            tempProg[p.ad] = Array(7).fill(null); 
            
            if(p.birim.includes("MCR")) {
                const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
                for(let g=0; g<7; g++) {
                    let d = new Date(currentMonday); d.setDate(d.getDate() + g);
                    const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
                    const donguIndex = (diffDays + persOfset) % 8;
                    const modIndex = donguIndex < 0 ? donguIndex + 8 : donguIndex;
                    tempProg[p.ad][g] = mcrDongu[modIndex];
                }
            } 
            else if(p.birim.includes("INGEST")) {
                const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
                for(let g=0; g<7; g++) {
                    let d = new Date(currentMonday); d.setDate(d.getDate() + g);
                    const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
                    const donguIndex = (diffDays + persOfset) % 6; 
                    const modIndex = donguIndex < 0 ? donguIndex + 6 : donguIndex;
                    tempProg[p.ad][g] = ingestDongu[modIndex];
                }
            }
            else {
                if(p.izinGunleri) p.izinGunleri.forEach(gi => tempProg[p.ad][gi] = "Ä°ZÄ°NLÄ°");
                if (state.haftaIciSabitler[p.ad]) {
                    const sabitSaat = state.haftaIciSabitler[p.ad];
                    for(let i=0; i<5; i++) tempProg[p.ad][i] = sabitSaat;
                    tempProg[p.ad][5] = "Ä°ZÄ°NLÄ°"; tempProg[p.ad][6] = "Ä°ZÄ°NLÄ°";
                }
            }
        });

        // --- 2. GRUP BAZLI Ä°ZÄ°N ATAMA (ADALETLÄ° PAZARTESÄ° ROTASYONU) ---
        state.birimler.forEach(birim => {
            if(birim.includes("MCR") || birim.includes("INGEST")) return;

            let adaylar = state.personeller.filter(p => p.birim === birim && !state.haftaIciSabitler[p.ad]);
            adaylar.sort((a,b) => a.ad.localeCompare(b.ad));

            // KaydÄ±rma
            let shiftAmount = weekOffset % adaylar.length;
            let rotatingList = [...adaylar];
            for(let i=0; i<shiftamount; i++)="" rotatinglist.push(rotatinglist.shift());="" rotatinglist.foreach((p,="" idx)=""> {
                if (p.izinGunleri &#x26;&#x26; p.izinGunleri.length > 0) return;

                // --- ANALÄ°Z EDÄ°LEN MANTIK: ---
                // Ä°lk kiÅŸi: Pzt - Cmt bÃ¶lÃ¼nmÃ¼ÅŸ (idx === 0)
                if(idx === 0) {
                    tempProg[p.ad][0] = "Ä°ZÄ°NLÄ°"; tempProg[p.ad][5] = "Ä°ZÄ°NLÄ°";
                }
                // Ä°kinci kiÅŸi: Pzt - Paz bÃ¶lÃ¼nmÃ¼ÅŸ (idx === 1)
                else if(idx === 1) {
                    tempProg[p.ad][0] = "Ä°ZÄ°NLÄ°"; tempProg[p.ad][6] = "Ä°ZÄ°NLÄ°";
                }
                // DiÄŸerleri: PeÅŸ peÅŸe (Pazartesi Ã§alÄ±ÅŸÄ±r)
                else {
                    const blocks = [[1, 2], [2, 3], [3, 4], [5, 6]];
                    let bIdx = (idx - 2) % blocks.length;
                    blocks[bIdx].forEach(d => tempProg[p.ad][d] = "Ä°ZÄ°NLÄ°");
                }
            });
        });

        // --- 3. MANUEL ATAMALARI YÃœKLE ---
        state.personeller.forEach(p => {
             calis[p.ad] = 0; 
            for(let g=0; g&#x3C;7; g++) {
                let mKey = `${hKey}_${p.ad}_${g}`;
                if(state.manuelAtamalar[mKey]) {
                    tempProg[p.ad][g] = state.manuelAtamalar[mKey];
                }
                if(tempProg[p.ad][g] &#x26;&#x26; !["Ä°ZÄ°NLÄ°","BOÅ",null].includes(tempProg[p.ad][g])) {
                    calis[p.ad]++;
                }
            }
        });

        // --- 4. ANA VARDÄ°YA DAÄITIM DÃ–NGÃœSÃœ ---
        for (let gun = 0; gun &#x3C; 7; gun++) {
            
            // A. GECE VARDÄ°YASI
            state.birimler.filter(b => !b.includes("MCR") &#x26;&#x26; !b.includes("INGEST")).forEach(birim => {
                const geceSaati = "00:00â€“07:00";
                const hedef = (state.kapasite[`${birim}_${geceSaati}`] || [0,0,0,0,0,0,0])[gun];
                let atanan = state.personeller.filter(p => p.birim === birim &#x26;&#x26; tempProg[p.ad][gun] === geceSaati).length;
                
                if (atanan &#x3C; hedef) {
                    let adaylar = state.personeller.filter(p => p.birim === birim &#x26;&#x26; tempProg[p.ad][gun] === null);
                    // Ä°kinci bir shuffle yok, sÄ±ralama stabil kalsÄ±n. Sadece iÅŸ yÃ¼kÃ¼ne bak.
                    adaylar.sort((a, b) => calis[a.ad] - calis[b.ad]);
                    
                    for (let p of adaylar) { 
                        if (atanan &#x3C; hedef &#x26;&#x26; calis[p.ad] &#x3C; 6) { tempProg[p.ad][gun] = geceSaati; calis[p.ad]++; atanan++; } 
                    }
                    if (atanan &#x3C; hedef) { // Panik Modu
                        let zorunluAdaylar = state.personeller.filter(p => p.birim === birim &#x26;&#x26; tempProg[p.ad][gun] === "Ä°ZÄ°NLÄ°");
                        zorunluAdaylar.sort((a, b) => calis[a.ad] - calis[b.ad]);
                        for (let p of zorunluAdaylar) {
                            if (atanan &#x3C; hedef) { tempProg[p.ad][gun] = geceSaati; calis[p.ad]++; atanan++; }
                        }
                    }
                }
            });

            // B. DÄ°ÄER SAATLER
            state.saatler.filter(s => s !== "00:00â€“07:00").forEach(saat => {
                state.birimler.filter(b => !b.includes("MCR") &#x26;&#x26; !b.includes("INGEST")).forEach(birim => {
                    const hedef = (state.kapasite[`${birim}_${saat}`] || [0,0,0,0,0,0,0])[gun];
                    let mevcut = state.personeller.filter(p => p.birim === birim &#x26;&#x26; tempProg[p.ad][gun] === saat).length;
                    
                    if (mevcut &#x3C; hedef) {
                        let adaylar = state.personeller.filter(p => {
                            let basic = p.birim === birim &#x26;&#x26; (tempProg[p.ad][gun] === null); 
                            let pazarGecesiSorunu = false;
                            if (gun === 0 &#x26;&#x26; (saat.startsWith("06") || saat.startsWith("09"))) {
                                let prevShift = state.manuelAtamalar[`${prevHKey}_${p.ad}_6`];
                                if (prevShift === "00:00â€“07:00" || prevShift === "16:00â€“00:00") pazarGecesiSorunu = true;
                            }
                            let dunGece = (gun > 0 &#x26;&#x26; tempProg[p.ad][gun-1] === "00:00â€“07:00");
                            return basic &#x26;&#x26; !(dunGece &#x26;&#x26; saat.startsWith("06")) &#x26;&#x26; !pazarGecesiSorunu;
                        });
                        
                        adaylar.sort((a, b) => {
                            if (saat.startsWith("06") || saat.startsWith("09")) {
                                let aDunBos = (gun > 0 &#x26;&#x26; ["Ä°ZÄ°NLÄ°", null].includes(tempProg[a.ad][gun-1])) ? 1 : 0;
                                let bDunBos = (gun > 0 &#x26;&#x26; ["Ä°ZÄ°NLÄ°", null].includes(tempProg[b.ad][gun-1])) ? 1 : 0;
                                if (aDunBos !== bDunBos) return bDunBos - aDunBos;
                            }
                            return calis[a.ad] - calis[b.ad];
                        });

                        for (let p of adaylar) {
                            if (mevcut &#x3C; hedef &#x26;&#x26; calis[p.ad] &#x3C; 6) { 
                                tempProg[p.ad][gun] = saat; calis[p.ad]++; mevcut++; 
                            }
                        }
                        
                        if (mevcut &#x3C; hedef) {
                             let zorunluAdaylar = state.personeller.filter(p => p.birim === birim &#x26;&#x26; tempProg[p.ad][gun] === "Ä°ZÄ°NLÄ°");
                             zorunluAdaylar = zorunluAdaylar.filter(p => {
                                 let dunGece = (gun > 0 &#x26;&#x26; tempProg[p.ad][gun-1] === "00:00â€“07:00");
                                 return !(dunGece &#x26;&#x26; saat.startsWith("06"));
                             });
                             zorunluAdaylar.sort((a, b) => calis[a.ad] - calis[b.ad]);
                             for (let p of zorunluAdaylar) {
                                if (mevcut &#x3C; hedef) { tempProg[p.ad][gun] = saat; calis[p.ad]++; mevcut++; }
                            }
                        }
                    }
                });
            });
        }

        // --- TEMÄ°ZLÄ°K ---
        state.personeller.forEach(p => {
            for(let g=0; g&#x3C;7; g++) {
                if(tempProg[p.ad][g] === null) tempProg[p.ad][g] = "Ä°ZÄ°NLÄ°";
            }
        });

        state.personeller.forEach(p => { for(let i=0; i&#x3C;7; i++) if(tempProg[p.ad][i]) state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] = tempProg[p.ad][i]; });
        save(); tabloyuOlustur(); alert("Vardiya oluÅŸturuldu.");
    }

    function excelIndir() {
        const hKey = currentMonday.toISOString().split('T')[0];
        let html = `<meta charset="UTF-8">&#x3C;style>
            table { border-collapse: collapse; font-family: Arial; } td { border: 1px solid #000; text-align: center; padding: 4px; font-size: 8pt; }
            .title { background: #312e81; color: white; font-weight: bold; font-size: 12pt; }
            .header { background: #1e1b4b; color: white; font-weight: bold; }
            .saat-0630 { background: #ffff00; font-weight: bold; }
            .saat-0900 { background: #00b0f0; color: white; font-weight: bold; }
            .saat-1600 { background: #7030a0; color: white; font-weight: bold; }
            .saat-0000 { background: #ed7d31; color: white; font-weight: bold; }
            .saat-izin { background: #ff0000; color: white; font-weight: bold; }
        &#x3C;/style>
        ${GUNLER.map(g => ``).join('')}`;
<p>state.birimler.forEach(birim => {
html += <code>&#x3C;tr>&#x3C;td colspan="8" style="background:${getBirimColor(birim)}; color:white; font-weight:bold;">${birim}&#x3C;/td>&#x3C;/tr></code>;
[...state.saatler, "Ä°ZÄ°N"].forEach(s => {
let pByDay = []; let maxRow = 1;
for(let i=0; i&#x3C;7; i++) {
let list = state.personeller.filter(p => {
let v = state.manuelAtamalar[<code>${hKey}_${p.ad}_${i}</code>];
if(s === "Ä°ZÄ°N") return p.birim === birim &#x26;&#x26; (v === "Ä°ZÄ°NLÄ°" || v === "BOÅ" || !v);
return p.birim === birim &#x26;&#x26; v === s;
});
pByDay[i] = list; if(list.length > maxRow) list.length;
}
let cls = s.includes("06:30") ? "saat-0630" : s.includes("09:00") ? "saat-0900" : s.includes("16:00") ? "saat-1600" : s.includes("00:00") ? "saat-0000" : s === "Ä°ZÄ°N" ? "saat-izin" : "";
for(let r=0; r&#x3C;maxRow; r++) {
html += <code>&#x3C;tr>${r===0 ? </code></p><code>).join('')}&#x3C;/tr></code>;
}
});
});
html += <code>&#x3C;/table>&#x3C;/body>&#x3C;/html></code>;
const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = <code>Vardiya_${hKey}.xls</code>; a.click();
}<p></p>
<p>function toggleAdminPanel() {
if(!isAdmin) return;
const p = document.getElementById("sidePanel");
const o = document.getElementById("panelOverlay");
p.classList.toggle("open");
o.style.display = p.classList.contains("open") ? "block" : "none";
if(p.classList.contains("open")) tabDegistir('personel');
}</p>
<p>function tabDegistir(t) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab-' + t).classList.remove('hidden'); document.getElementById('btn-tab-' + t).classList.add('active'); refreshUI(); }
function bulutaKaydet() { database.ref('vardiya_data').set(state).then(() => alert("Kaydedildi!")).catch(e => alert(e.message)); }
function buluttanYukle() { database.ref('vardiya_data').once('value').then(snap => { if(snap.exists()){ state = snap.val(); save(); location.reload(); } }); }</p>
<p>function refreshUI() {
document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => <code>&#x3C;option value="${b}">${b}&#x3C;/option></code>).join('');
document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => {
let mcrHtml = "";
if(p.birim.includes("MCR") || p.birim.includes("INGEST")) {
mcrHtml = `</p><div class="mcr-ayarlar">
<span>${p.birim.includes("INGEST") ? 'INGEST' : 'MCR'} DÃ¶ngÃ¼ Ofseti: </span>
<input type="number" value="$$   {state.mcrAyarlari.ofsetler[p.ad] || 0}" style="width:40px" onchange="mcrOfsetGuncelle(&#x27;   $${p.ad}&#x27;, this.value)"><p></p>
                </div>`;
            }
<p>return `</p><div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:5px;">
<strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>p</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>d</mi></mrow><mo>&#x3C;</mo><mi mathvariant="normal">/</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>n</mi><mi>g</mi><mo>></mo><mo>&#x3C;</mo><mi>s</mi><mi>m</mi><mi>a</mi><mi>l</mi><mi>l</mi><mo>></mo><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">  {p.ad}&#x3C;/strong> &#x3C;small>(  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord">.</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&#x3C;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">>&#x3C;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">ma</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span></span></span></span>{p.birim})
&#x3C;button onclick="state.personeller.splice(${i},1); save(); refreshUI(); tabloyuOlustur();" style="color:var(--danger); border:none; background:none; cursor:pointer; float:right;">Sil&#x3C;/button><p></p>
                <div style="margin-top:5px;">${GUNLER.map((g, gi) => `<span class="izin-gun-pill ${p.izinGunleri?.includes(gi)?&#x27;active&#x27;:&#x27;&#x27;}" onclick="izinGunuTetikle(${i},${gi})">${g}</span>`).join('')}</div>
                ${mcrHtml}
            </strong></div><strong>`;
        }).join('');
<p>// --- SWAP DROPDOWN DOLDURMA ---
const swapKaynak = document.getElementById('swapKaynakPersonel');
const swapHedef = document.getElementById('swapHedefPersonel');
const optionsHtml = "&#x3C;option value=''>SeÃ§iniz...&#x3C;/option>" + state.personeller.sort((a,b) => a.ad.localeCompare(b.ad)).map(p => <code>&#x3C;option value="${p.ad}">${p.ad} (${p.birim})&#x3C;/option></code>).join('');
if(swapKaynak) swapKaynak.innerHTML = optionsHtml;
if(swapHedef) swapHedef.innerHTML = optionsHtml;</p>
<p>// --- AKTÄ°F DEÄÄ°ÅÄ°MLERÄ° LÄ°STELE ---
if(!state.geciciGorevler) state.geciciGorevler = {};
let degisimHtml = "<strong>Aktif DeÄŸiÅŸimler (Bu Hafta):</strong>
";
let hasDegisim = false;
Object.keys(state.geciciGorevler).forEach(k => {
const [dateStr, pName] = k.split('_');
const targetUnit = state.geciciGorevler[k];
// Sadece bu haftaya ait olanlarÄ± gÃ¶sterelim
let d = new Date(dateStr);
let nextMonday = new Date(currentMonday); nextMonday.setDate(nextMonday.getDate() + 7);</p>
<p>if(d >= currentMonday &#x26;&#x26; d &#x3C; nextMonday) {
degisimHtml += <code>&#x3C;div style="font-size:10px; border-bottom:1px solid #eee; padding:2px;">ğŸ“… ${dateStr} - &#x3C;b>${pName}&#x3C;/b> â¡ï¸ ${targetUnit}&#x3C;/div></code>;
hasDegisim = true;
}
});
document.getElementById("aktifDegisimlerListesi").innerHTML = hasDegisim ? degisimHtml : "</p><div style="font-size:10px; color:#999;">Bu hafta iÃ§in aktif deÄŸiÅŸim yok.</div>";<p></p>
<p>let capHtml = ""; state.birimler.forEach(b => { capHtml += <code>&#x3C;div style="margin-bottom:15px; background:var(--bg); padding:10px; border-radius:8px;">&#x3C;strong>${b}&#x3C;/strong></code>; state.saatler.forEach(s => { const v = state.kapasite[<code>${b}_${s}</code>] || [0,0,0,0,0,0,0]; capHtml += <code>&#x3C;div style="font-size:9px; margin-top:5px;">${s}&#x3C;/div>&#x3C;div style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px;">${GUNLER.map((g, gi) => </code><input type="number" value="$$   {v[gi]}" style="width:100%; text-align:center;" onchange="capUp(&#x27;   $${b}_$$   {s}&#x27;,   $${gi},this.value)"><code>).join('')}&#x3C;/div></code>; }); capHtml += <code>&#x3C;/div></code>; });
document.getElementById("kapasiteTable").innerHTML = capHtml;</p>
<p>let mcrSistemHtml = `</p><div style="background:#e0f2fe; padding:10px; border-radius:8px; margin-bottom:10px;">
<strong>MCR/INGEST DÃ¶ngÃ¼ BaÅŸlangÄ±Ã§ Tarihi:</strong>

<input type="date" value="${state.mcrAyarlari.baslangicTarihi}" onchange="state.mcrAyarlari.baslangicTarihi = this.value; save();" style="width:100%; padding:5px; margin-top:5px;"><p></p>
        </div>`;
<p>document.getElementById("sabitListeAdmin").innerHTML = mcrSistemHtml + state.personeller.filter(p => !p.birim.includes("MCR") &#x26;&#x26; !p.birim.includes("INGEST")).map(p => <code>&#x3C;div style="display:flex; justify-content:space-between; margin-bottom:5px; background:var(--bg); padding:5px; border-radius:5px;">&#x3C;label>&#x3C;input type="checkbox" ${state.haftaIciSabitler[p.ad]?'checked':''} onchange="sabitTetikle('${p.ad}')"> ${p.ad}&#x3C;/label>&#x3C;select onchange="sabitSaatGuncelle('${p.ad}', this.value)" ${!state.haftaIciSabitler[p.ad]?'disabled':''}>${state.saatler.map(s => </code>&#x3C;option value="${s}" <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi mathvariant="normal">.</mi><mi>h</mi><mi>a</mi><mi>f</mi><mi>t</mi><mi>a</mi><mi>I</mi><mi>c</mi><mi>i</mi><mi>S</mi><mi>a</mi><mi>b</mi><mi>i</mi><mi>t</mi><mi>l</mi><mi>e</mi><mi>r</mi><mo stretchy="false">[</mo><mi>p</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>d</mi><mo stretchy="false">]</mo><mo>=</mo><mo>=</mo><mo>=</mo><mi>s</mi><msup><mo stretchy="false">?</mo><mo mathvariant="normal" lspace="0em" rspace="0em">â€²</mo></msup><mi>s</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>e</mi><msup><mi>d</mi><mo mathvariant="normal" lspace="0em" rspace="0em">â€²</mo></msup><msup><mo>:</mo><mrow><mo mathvariant="normal">â€²</mo><mo mathvariant="normal">â€²</mo></mrow></msup></mrow><mo>></mo></mrow><annotation encoding="application/x-tex">  {state.haftaIciSabitler[p.ad] === s ? 'selected' : ''}>  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord">.</span><span class="mord mathnormal">ha</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">c</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">abi</span><span class="mord mathnormal" style="margin-right:0.01968em;">tl</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mopen">[</span><span class="mord mathnormal">p</span><span class="mord">.</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">===</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">s</span><span class="mclose"><span class="mclose">?</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel">:</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²â€²</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">></span></span></span></span>{s}&#x3C;/option><code>).join('')}&#x3C;/select>&#x3C;/div></code>).join('');
// === BÄ°RÄ°MLER SEKME ===
let birimHtml = `</p>
    <div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:15px;">
        <input type="text" id="yeniBirimInp" placeholder="Yeni Birim AdÄ±" style="width:95%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);">
        <button onclick="birimEkle()" class="btn-main-action" style="width:100%; background:var(--success)">BÄ°RÄ°M EKLE</button>
    </div>
    <div id="birimListesi">`;
state.birimler.forEach((b, i) => {
    birimHtml += `
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg); padding:10px; border-radius:8px; margin-bottom:5px;">
            <span>${b}</span>
            <button onclick="birimSil(${i})" style="background:var(--danger); color:white; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:10px;">SÄ°L</button>
        </div>`;
});
birimHtml += `</div>`;
document.getElementById("birimListesiAdmin").innerHTML = birimHtml;
<p>// === SAATLER SEKME ===
let saatHtml = `</p>
    <div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:15px;">
        <input type="text" id="yeniSaatInp" placeholder="Yeni Saat Dilimi (Ã¶rn: 08:00â€“17:00)" style="width:95%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);">
        <button onclick="saatEkle()" class="btn-main-action" style="width:100%; background:var(--success)">SAAT EKLE</button>
    </div>
    <div id="saatListesi">`;
state.saatler.forEach((s, i) => {
    saatHtml += `
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg); padding:10px; border-radius:8px; margin-bottom:5px;">
            <span>${s}</span>
            <button onclick="saatSil(${i})" style="background:var(--danger); color:white; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:10px;">SÄ°L</button>
        </div>`;
});
saatHtml += `</div>`;
document.getElementById("saatListesiAdmin").innerHTML = saatHtml;
    }
<p>// YENÄ° YARDIMCI FONKSÄ°YON: VARDÄ°YAYI HER KAYNAKTAN ARAR (MANUEL > MCR/INGEST > SABÄ°T)
function vardiyaBul(pAd, gIdx) {
const hKey = currentMonday.toISOString().split('T')[0];
const mKey = <code>${hKey}_${pAd}_${gIdx}</code>;</p>
<p>// 1. Ã–nce Manuel/OnaylanmÄ±ÅŸ var mÄ±?
if (state.manuelAtamalar[mKey]) return state.manuelAtamalar[mKey];</p>
<p>const p = state.personeller.find(pers => pers.ad === pAd);
if (!p) return null;</p>
<p>// 2. MCR/Ingest DÃ¶ngÃ¼sÃ¼ HesabÄ±
const mcrDongu = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "00:00â€“07:00", "00:00â€“07:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"];
const ingestDongu = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"];
const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);</p>
<p>let d = new Date(currentMonday);
d.setDate(d.getDate() + gIdx);</p>
<p>if (p.birim.includes("MCR")) {
const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
const donguIndex = (diffDays + persOfset) % 8;
const modIndex = donguIndex &#x3C; 0 ? donguIndex + 8 : donguIndex;
return mcrDongu[modIndex];
}
else if (p.birim.includes("INGEST")) {
const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
const donguIndex = (diffDays + persOfset) % 6;
const modIndex = donguIndex &#x3C; 0 ? donguIndex + 6 : donguIndex;
return ingestDongu[modIndex];
}</p>
<p>// 3. Hafta Ä°Ã§i Sabitler
if (state.haftaIciSabitler[p.ad] &#x26;&#x26; gIdx &#x3C; 5) {
return state.haftaIciSabitler[p.ad];
}</p>
<p>return null;
}</p>
<p>// --- SWAP Ä°ÅLEM FONKSÄ°YONU (TAM OTOMATÄ°K VERSÄ°YON) ---
function degisimiUygula() {
const pKaynakAd = document.getElementById('swapKaynakPersonel').value; // AyrÄ±lan (Ã–rn: MCR Op)
const pHedefAd = document.getElementById('swapHedefPersonel').value;   // Yerine geÃ§en (Reliever)</p>
<p>if(!pKaynakAd || !pHedefAd) { alert("LÃ¼tfen iki personeli de seÃ§iniz."); return; }
if(pKaynakAd === pHedefAd) { alert("AynÄ± personeli seÃ§emezsiniz."); return; }</p>
<p>const checkboxes = document.querySelectorAll('.swap-day-cb:checked');
if(checkboxes.length === 0) { alert("LÃ¼tfen en az bir gÃ¼n seÃ§iniz."); return; }</p>
<p>const pKaynak = state.personeller.find(p => p.ad === pKaynakAd);
const hedefBirim = pKaynak.birim;
const hKey = currentMonday.toISOString().split('T')[0];</p>
<p>checkboxes.forEach(cb => {
const gunIdx = parseInt(cb.value);</p>
<p>// 1. Gecici Birim (Renk/Grup) AyarÄ±
let d = new Date(currentMonday);
d.setDate(d.getDate() + gunIdx);
const dateKey = d.toISOString().split('T')[0];
const gKey = <code>${dateKey}_${pHedefAd}</code>;</p>
<p>if(!state.geciciGorevler) state.geciciGorevler = {};
state.geciciGorevler[gKey] = hedefBirim;</p>
<p>// 2. Vardiya Transferi (TAM OTOMATÄ°K HESAPLAMA)
const kLeaving = <code>${hKey}_${pKaynakAd}_${gunIdx}</code>;
const kEntering = <code>${hKey}_${pHedefAd}_${gunIdx}</code>;</p>
<p>// vardiyaBul fonksiyonu manual yoksa MCR/Ingest hesabÄ±nÄ± yapar!
let shift = vardiyaBul(pKaynakAd, gunIdx);</p>
<p>if (shift &#x26;&#x26; shift !== "Ä°ZÄ°NLÄ°" &#x26;&#x26; shift !== "BOÅ") {
state.manuelAtamalar[kEntering] = shift;
}</p>
<p>state.manuelAtamalar[kLeaving] = "Ä°ZÄ°NLÄ°";
});</p>
<p>save();
alert("Tam Otomatik DeÄŸiÅŸim uygulandÄ±. MCR/Ingest vardiyasÄ± hesaplanÄ±p aktarÄ±ldÄ±.");
refreshUI();
tabloyuOlustur();</p>
<p>document.querySelectorAll('.swap-day-cb').forEach(cb => cb.checked = false);
document.getElementById('swapKaynakPersonel').value = "";
document.getElementById('swapHedefPersonel').value = "";
}</p>
<p>function tumDegisimleriTemizle() {
if(confirm("TÃ¼m geÃ§ici birim deÄŸiÅŸiklikleri silinecek. Emin misiniz?")) {
state.geciciGorevler = {};
save();
refreshUI();
tabloyuOlustur();
}
}</p>
<p>function mcrOfsetGuncelle(ad, val) { if(!state.mcrAyarlari.ofsetler) state.mcrAyarlari.ofsetler = {}; state.mcrAyarlari.ofsetler[ad] = parseInt(val); save(); }
function whatsappGonder() { const hKey = currentMonday.toISOString().split('T')[0]; let m = <code>*ğŸ“… ${currentMonday.toLocaleDateString('tr-TR')} VARDÄ°YASI*\n\n</code>; GUNLER.forEach((g, i) => { m += <code>*${g.toUpperCase()}*\n</code>; state.saatler.forEach(s => { let pList = state.personeller.filter(p => state.manuelAtamalar[<code>${hKey}_${p.ad}_${i}</code>] === s).map(p => p.ad).join(", "); if (pList) m += <code>â€¢ ${s}: ${pList}\n</code>; }); m += <code>\n</code>; }); window.open(<code>https://wa.me/?text=${encodeURIComponent(m)}</code>, '_blank'); }
function capUp(k, g, v) { if(!state.kapasite[k]) state.kapasite[k] = [0,0,0,0,0,0,0]; state.kapasite[k][g] = parseInt(v) || 0; save(); }
function izinGunuTetikle(pi, gi) { if(!state.personeller[pi].izinGunleri) state.personeller[pi].izinGunleri = []; const idx = state.personeller[pi].izinGunleri.indexOf(gi); if(idx > -1) state.personeller[pi].izinGunleri.splice(idx, 1); else state.personeller[pi].izinGunleri.push(gi); save(); refreshUI(); }
function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + v); tabloyuOlustur(); }
function personelEkle() { const ad = document.getElementById("yeniPersInp").value.toUpperCase(); const b = document.getElementById("yeniPersBirimSec").value; if(ad){ state.personeller.push({ad, birim:b, izinGunleri:[]}); save(); refreshUI(); document.getElementById("yeniPersInp").value=""; } }</p>
<p>function drag(e, p, g, s) {
if(!isAdmin) return;
e.dataTransfer.setData("p", p); e.dataTransfer.setData("oldG", g);
}</p>
<p>function drop(e, ns, ng) {
if(!isAdmin) return;
e.preventDefault();
const p = e.dataTransfer.getData("p");
const hKey = currentMonday.toISOString().split('T')[0];
cakismaKontrol(p, ng, ns);
state.manuelAtamalar[<code>${hKey}_${p}_${ng}</code>] = ns === 'BOÅ' ? null : ns;
save();
tabloyuOlustur();
}</p>
<p>function vardiyaDegistir(p, g) {
if(!isAdmin) return;
const s = prompt(<code>${p}: 1:06:30, 2:09:00, 3:16:00, 4:00:00, 5:Ä°ZÄ°N</code>);
if(s){
let v = null;
if(s=="1") v="06:30â€“16:00";
if(s=="2") v="09:00â€“18:00";
if(s=="3") v="16:00â€“00:00";
if(s=="4") v="00:00â€“07:00";
if(s=="5") v="Ä°ZÄ°NLÄ°";
cakismaKontrol(p, g, v);
state.manuelAtamalar[<code>${currentMonday.toISOString().split('T')[0]}_${p}_${g}</code>] = v;
save();
tabloyuOlustur();
}
}</p>
<p>function toggleTheme() { const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark"; document.documentElement.setAttribute("data-theme", t); localStorage.setItem(PREFIX + "theme", t); }
function vardiyaSifirla() { if(confirm("HaftayÄ± temizle?")) { const hKey = currentMonday.toISOString().split('T')[0]; Object.keys(state.manuelAtamalar).forEach(k => { if(k.startsWith(hKey)) delete state.manuelAtamalar[k]; }); save(); tabloyuOlustur(); } }
function tamSifirla() { if(confirm("SÄ±fÄ±rla?")) { localStorage.clear(); location.reload(); } }
function jsonYedekAl() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "Yedek.json"); dl.click(); }
async function githubdanYedekYukle() {
const url = "<a href="https://raw.githubusercontent.com/ugurbakirtas/vardiya-sistemi/main/ilk_kurulum.json?t=">https://raw.githubusercontent.com/ugurbakirtas/vardiya-sistemi/main/ilk_kurulum.json?t=</a>" + new Date().getTime();
if (confirm("Sistem verileri GitHub Ã¼zerindeki yedekle deÄŸiÅŸtirilecek. OnaylÄ±yor musunuz?")) {
try {
const response = await fetch(url);
if (!response.ok) throw new Error("GitHub'daki dosya bulunamadÄ± veya eriÅŸim engellendi.");
const data = await response.json();
state = data;
save();
alert("GitHub yedeÄŸi baÅŸarÄ±yla yÃ¼klendi!");
location.reload();
} catch (error) {
console.error(error);
alert("Hata: " + error.message);
}
}
}
function sabitTetikle(ad) { if(state.haftaIciSabitler[ad]) delete state.haftaIciSabitler[ad]; else state.haftaIciSabitler[ad] = state.saatler[0]; save(); refreshUI(); }
function sabitSaatGuncelle(ad, saat) { state.haftaIciSabitler[ad] = saat; save(); }</p>
<p>function anlikSenkronizasyonBaslat() {
database.ref().on('value', (snap) => {
if (snap.exists()) {
const data = snap.val();
if(data.vardiya_data) {
state = data.vardiya_data;
save();
tabloyuOlustur();
if(isAdmin) refreshUI();
}
if(isAdmin) {
talepleriYukle();
}
console.log("Sistem: TÃ¼m veriler (vardiya ve talepler) gÃ¼ncellendi.");
}
});
}
window.onload = async () => {
if(localStorage.getItem(PREFIX + "theme") === "dark") {
document.documentElement.setAttribute("data-theme", "dark");
}
await hassasAyarlariYukle();
anlikSenkronizasyonBaslat();
talepleriYukle();
};
function birimEkle() {
const ad = document.getElementById("yeniBirimInp").value.trim().toUpperCase();
if (ad &#x26;&#x26; !state.birimler.includes(ad)) {
state.birimler.push(ad);
save();
refreshUI();
tabloyuOlustur(); // kapasite ayarlarÄ± vs. iÃ§in tabloyu yenile
document.getElementById("yeniBirimInp").value = "";
} else if (state.birimler.includes(ad)) {
alert("Bu birim zaten var!");
} else {
alert("LÃ¼tfen geÃ§erli bir birim adÄ± girin.");
}
}</p>
<p>function birimSil(index) {
if (confirm(<code>"${state.birimler[index]}" birimini silmek istediÄŸinize emin misiniz?\nBu birime baÄŸlÄ± personel varsa sorun Ã§Ä±kabilir.</code>)) {
// Ä°lgili personellerin birimini boÅŸ bÄ±rakmamak iÃ§in opsiyonel: "TEKNÄ°K YÃ–NETMEN" yapabilirsin
state.personeller.forEach(p => {
if (p.birim === state.birimler[index]) {
p.birim = state.birimler[0] || "TEKNÄ°K YÃ–NETMEN"; // ilk birime taÅŸÄ±
}
});
state.birimler.splice(index, 1);
// Kapasite anahtarlarÄ±nÄ± temizle
Object.keys(state.kapasite).forEach(key => {
if (key.startsWith(state.birimler[index] + "_")) {
delete state.kapasite[key];
}
});
save();
refreshUI();
tabloyuOlustur();
}
}</p>
<p>function saatEkle() {
const saat = document.getElementById("yeniSaatInp").value.trim();
if (saat &#x26;&#x26; !state.saatler.includes(saat)) {
state.saatler.push(saat);
save();
refreshUI();
tabloyuOlustur();
document.getElementById("yeniSaatInp").value = "";
} else if (state.saatler.includes(saat)) {
alert("Bu saat dilimi zaten var!");
} else {
alert("LÃ¼tfen geÃ§erli bir saat dilimi girin.");
}
}</p>
<p>function saatSil(index) {
if (confirm(<code>"${state.saatler[index]}" saat dilimini silmek istediÄŸinize emin misiniz?\nBu saate atanmÄ±ÅŸ vardiyalar etkilenebilir.</code>)) {
// Kapasite anahtarlarÄ±nÄ± temizle
Object.keys(state.kapasite).forEach(key => {
if (key.endsWith("_" + state.saatler[index])) {
delete state.kapasite[key];
}
});
state.saatler.splice(index, 1);
save();
refreshUI();
tabloyuOlustur();
}
}
&#x3C;/script></p>
&#x3C;/body>
&#x3C;/html>&#x3C;/DOCUMENT></strong><table><tbody><tr><th colspan="8" class="title">TEKNÄ°K PERSONEL Ã‡ALIÅMA LÄ°STESÄ°</th></tr><tr><th class="header">SAAT</th><th class="header">${g.toUpperCase()}</th></tr><tr><td rowspan="$$   {maxRow}" class="$${cls}"><span class="katex-error" title="ParseError: KaTeX parse error: Expected &#x27;EOF&#x27;, got &#x27;}&#x27; at position 15:   {s}</td>&#x60;:&#x22;&#x22;}Ì²${pByDay.map(d â€¦" style="color:#cc0000">  {s}&#x3C;/td>`:""}${pByDay.map(d => `&#x3C;td>  </span>{d[r]?d[r].ad:""}</td></tr></tbody></table></shiftamount;>