<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TURKMEDYA TEKNiK VARDiYA LiSTESi | Pro_Ugr</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <style>
    :root { --primary: #1e293b; --blue: #2563eb; --bg: #f1f5f9; --card-bg: #ffffff; --text: #334155; --border: #e2e8f0; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; --weekend-bg: #fff1f2; --table-head: #f8fafc; --saat1: #e0f2fe; --saat2: #f0fdf4; --saat3: #faf5ff; --saat4: #fff7ed; --izin-bg: #fef2f2; --yillik-izin: #9333ea; }
    [data-theme="dark"] { --primary: #0f172a; --bg: #020617; --card-bg: #1e293b; --text: #f1f5f9; --border: #334155; --weekend-bg: #2d1a1a; --table-head: #0f172a; --saat1: #0c4a6e; --saat2: #064e3b; --saat3: #581c87; --saat4: #7c2d12; --izin-bg: #450a0a; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; font-size: 12px; transition: background 0.3s ease; }
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
    .login-card { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); text-align: center; width: 320px; }
    .login-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 14px; }
    .btn-user { background: var(--blue); color: white; } .btn-admin { background: #475569; color: white; }
    .app-wrapper { padding: 10px; display: none; } 
    .main-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; gap: 10px; }
    .table-container { overflow-x: auto; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; table-layout: fixed; }
    th { background: var(--table-head); color: var(--text); padding: 12px 8px; border-bottom: 2px solid var(--border); border-right: 1px solid var(--border); }
    td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 6px; vertical-align: top; height: 95px; }
    .saat-col { font-weight: 800; text-align: center; border-left: 5px solid var(--blue); width: 100px; }
    .row-saat-0 { background-color: var(--saat1); } .row-saat-1 { background-color: var(--saat2); } .row-saat-2 { background-color: var(--saat3); } .row-saat-3 { background-color: var(--saat4); }
    .row-izin { background-color: var(--izin-bg) !important; } .row-izin .saat-col { border-left-color: var(--danger) !important; color: var(--danger); }
    .weekend-col { background-color: var(--weekend-bg) !important; }
    .birim-card { border-left: 4px solid var(--blue); padding: 6px 8px; margin-bottom: 5px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border); cursor: pointer; }
    .birim-ayirici { border-top: 5px solid #1e293b !important; margin-top: 8px !important; padding-top: 8px !important; }
    .birim-tag { font-size: 7px; font-weight: 800; color: white; display: inline-block; padding: 1px 4px; border-radius: 3px; margin-bottom: 2px; text-transform: uppercase; }
    .pers-name { font-size: 10px; font-weight: 700; display: block; }
    .side-panel { position: fixed; top: 0; right: -550px; width: 500px; height: 100%; background: var(--card-bg); z-index: 1000; transition: 0.4s; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.2); }
    .side-panel.open { right: 0; }
    .panel-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
    .panel-content { padding: 15px; overflow-y: auto; flex: 1; }
    .panel-action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
    .btn-main-action { padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px; color: white; }
    .hidden { display: none; }
    .tab-btn { flex: 1; padding: 8px; border: none; background: #e2e8f0; cursor: pointer; font-size: 10px; font-weight: 700; border-radius: 4px; color: #64748b; }
    .tab-btn.active { background: var(--blue); color: white; }
    .izin-gun-pill { padding: 4px 6px; background: var(--bg); border-radius: 4px; margin: 2px; font-size: 9px; cursor: pointer; display: inline-block; font-weight: 700; border: 1px solid var(--border); }
    .izin-gun-pill.active { background: var(--danger); color: white; }
    .mcr-ayarlar { background: #f8fafc; border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-top: 10px; }
    .swap-container { border: 2px solid var(--blue); border-radius: 12px; padding: 15px; background: var(--saat3); margin-bottom: 15px; }
    .swap-header { font-weight: 800; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; font-size: 13px; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    .swap-row { margin-bottom: 10px; }
    .swap-label { display: block; font-size: 10px; font-weight: 700; margin-bottom: 3px; color: #64748b; }
    .swap-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: white; font-weight: 600; font-size: 11px; }
    .swap-days { display: flex; gap: 10px; margin-top: 10px; justify-content: space-between; }
    .swap-day-item { display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; }
    .admin-only { display: none; } 
    @media screen and (max-width: 768px) { 
        #vardiyaTablosu, #vardiyaTablosu thead, #vardiyaTablosu tbody, #vardiyaTablosu th, #vardiyaTablosu td, #vardiyaTablosu tr { display: block; width: 100% !important; min-width: 100% !important; }
        #tableHeader { display: none; }
        #tableBody tr, #tableFooter tr { margin-bottom: 20px; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--card-bg); }
        .saat-col { display: block; width: 100% !important; background: var(--primary); color: white !important; padding: 10px; text-align: left !important; border-left: none !important; font-size: 14px; }
        td:not(.saat-col)::before { content: attr(data-label); font-weight: 800; text-transform: uppercase; font-size: 12px; display: block; margin-bottom: 10px; color: var(--blue); background: var(--bg); padding: 4px; border-radius: 4px; text-align: center; }
        td:not(.saat-col) { display: flex; flex-direction: column; gap: 8px; height: auto !important; min-height: 50px; }
        .side-panel { width: 100%; right: -100%; }
        .main-header { flex-direction: column; text-align: center; }
    }  
  </style>
</head>
<body>
  <div id="loginOverlay"><div class="login-card"><img src="logo.png" alt="Logo" class="login-logo" onerror="this.style.display='none'"><h2 style="margin:0 0 20px 0; color:var(--primary)">Sistem GiriÅŸi</h2><button onclick="enterSystem('personel')" class="login-btn btn-user">ğŸ‘¤ PERSONEL GÄ°RÄ°ÅÄ°</button><button onclick="enterSystem('admin')" class="login-btn btn-admin">âš™ï¸ YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ°</button><p style="font-size: 10px; color: #64748b; margin-top: 20px;">TURKMEDYA TEKNÄ°K V61</p></div></div>
  <div id="talepModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10001; display:none; align-items:center; justify-content:center;">
    <div class="login-card" style="width: 320px; border: 2px solid var(--blue);">
        <h3 style="margin-top:0; color:var(--primary)">Vardiya / Ä°zin Talebi</h3>
        <select id="talepPersonel" style="width:100%; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border);"></select>
        <label style="display:block; text-align:left; font-size:10px; margin-bottom:5px; font-weight:bold; color:var(--text)">TARÄ°H SEÃ‡Ä°N:</label>
        <input type="date" id="talepTarih" style="width:93%; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border); font-family:inherit;">
        <select id="talepTuru" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border);">
            <option value="Ä°ZÄ°NLÄ°">Ä°ZÄ°NLÄ° (Ä°zin Talebi)</option><option value="06:30â€“16:00">06:30â€“16:00</option><option value="09:00â€“18:00">09:00â€“18:00</option><option value="16:00â€“00:00">16:00â€“00:00</option><option value="00:00â€“07:00">00:00â€“07:00</option>
        </select>
        <button onclick="talepGonder()" class="btn-main-action" style="background:var(--success); width:100%; padding:12px;">TALEBÄ° GÃ–NDER</button>
        <button onclick="document.getElementById('talepModal').style.display='none'" style="background:none; border:none; color:var(--danger); margin-top:10px; cursor:pointer; font-weight:bold;">Ä°ptal</button>
    </div>
  </div>
  <div id="panelOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none;" onclick="toggleAdminPanel()"></div>
  <div class="app-wrapper" id="appMain">
    <header class="main-header no-print">
      <div style="display: flex; align-items: center; gap: 10px;"><img src="logo.png" alt="Logo" style="height: 35px;"><div><h1 style="margin:0; font-size:16px;">TEKNiK EKÄ°P Ã‡ALIÅMA LÄ°STESÄ° V61</h1><p id="tarihAraligi" style="margin:0; opacity:0.8; font-size:10px;"></p></div></div>
      <div style="display:flex; gap:5px; flex-wrap: wrap; justify-content: center;"><button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#475569">Â« Geri</button><button onclick="buluttanYukle()" class="btn-main-action admin-only" style="background:#4285f4">ğŸ”„ BULUTTAN YÃœKLE</button><button onclick="toggleTheme()" class="btn-main-action" style="background:#64748b" id="themeBtn">ğŸŒ™</button><button onclick="excelIndir()" class="btn-main-action admin-only" style="background:#16a34a">EXCEL</button><button onclick="window.print()" class="btn-main-action" style="background:var(--blue)">PDF / YAZDIR</button><button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#475569">Ä°leri Â»</button><button onclick="toggleAdminPanel()" class="btn-main-action admin-only" style="background:var(--primary); border: 1px solid #475569;" id="adminSettingsBtn">âš™ AYARLAR</button></div>
    </header>
    <div id="persTalepArea" style="text-align:center; display:none;" class="no-print"><button onclick="talepModalAc()" class="btn-main-action" style="background:var(--warning); margin: 0 auto 15px auto; width: 250px; color: #1e293b; font-weight: 800; border: 2px solid #1e293b;">ğŸ“ VARDÄ°YA / Ä°ZÄ°N TALEBÄ° OLUÅTUR</button></div>
    <main class="table-container"><table id="vardiyaTablosu"><thead id="tableHeader"></thead><tbody id="tableBody"></tbody><tfoot id="tableFooter"></tfoot></table></main>
  </div>
  <div id="sidePanel" class="side-panel no-print">
    <div class="panel-header"><h2 style="margin:0; font-size:16px;">YÃ¶netim Paneli</h2><button onclick="toggleAdminPanel()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button></div>
    <div class="panel-content">
        <div class="panel-action-group"><button onclick="vardiyaUretVeKaydet()" class="btn-main-action" style="background:var(--success); grid-column: span 2; padding: 15px; font-size: 13px;">âœ¨ VARDÄ°YA OLUÅTUR</button><button onclick="bulutaKaydet()" class="btn-main-action" style="background:#ea4335">â˜ï¸ BULUTA KAYDET</button><button onclick="whatsappGonder()" class="btn-main-action" style="background:#25D366">ğŸŸ¢ WHATSAPP</button></div>
        <div class="admin-tabs" style="display:flex; gap:2px; margin-bottom:15px; flex-wrap:wrap;"><button id="btn-tab-personel" class="tab-btn active" onclick="tabDegistir('personel')">Personel</button><button id="btn-tab-birimler" class="tab-btn" onclick="tabDegistir('birimler')">Birimler</button><button id="btn-tab-saatler" class="tab-btn" onclick="tabDegistir('saatler')">Saatler</button><button id="btn-tab-sabitle" class="tab-btn" onclick="tabDegistir('sabitle')">Sabitler</button><button id="btn-tab-kapasite" class="tab-btn" onclick="tabDegistir('kapasite')">Kapasite</button><button id="btn-tab-degisim" class="tab-btn" onclick="tabDegistir('degisim')" style="background: #2563eb; color: white;">DeÄŸiÅŸim</button><button id="btn-tab-yillik" class="tab-btn" onclick="tabDegistir('yillik')" style="background: #9333ea; color: white;">ğŸ–ï¸ YILLIK Ä°ZÄ°N</button><button id="btn-tab-sistem" class="tab-btn" onclick="tabDegistir('sistem')">Sistem</button><button id="btn-tab-talepler" class="tab-btn" onclick="tabDegistir('talepler')" style="background: var(--warning); color: black;">Talepler</button></div>
        <div id="tab-personel" class="tab-content"><div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:15px;"><input type="text" id="yeniPersInp" placeholder="Ad Soyad" style="width:95%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);"><select id="yeniPersBirimSec" style="width:100%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);"></select><button onclick="personelEkle()" class="btn-main-action" style="width:100%; background:var(--success)">PERSONEL EKLE</button></div><div id="persListesiAdmin"></div></div>
        <div id="tab-birimler" class="tab-content hidden"><div id="birimListesiAdmin"></div></div>
        <div id="tab-saatler" class="tab-content hidden"><div id="saatListesiAdmin"></div></div>
        <div id="tab-sabitle" class="tab-content hidden"><div id="sabitListeAdmin"></div></div>
        <div id="tab-kapasite" class="tab-content hidden"><div id="kapasiteTable"></div></div>
        <div id="tab-degisim" class="tab-content hidden">
            <div class="swap-container"><div class="swap-header">âš¡ PERSONEL DEÄÄ°ÅÄ°MÄ° / SWAP</div><div class="swap-row"><label class="swap-label">MEVCUT BÄ°RÄ°MÄ° KULLANILACAK OLAN (AYRILAN):</label><select id="swapKaynakPersonel" class="swap-select"><option>SeÃ§iniz...</option></select></div><div class="swap-row"><label class="swap-label">â¬‡ï¸ YERÄ°NE GEÃ‡ECEK (Ä°ZÄ°NCÄ° KÄ°ÅÄ°) â¬‡ï¸</label><select id="swapHedefPersonel" class="swap-select"><option>SeÃ§iniz...</option></select></div><div class="swap-row"><label class="swap-label">HANGÄ° GÃœNLER?</label><div class="swap-days"><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="0"> Pzt</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="1"> Sal</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="2"> Ã‡ar</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="3"> Per</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="4"> Cum</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="5"> Cmt</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="6"> Paz</label></div></div><button onclick="degisimiUygula()" class="btn-main-action" style="background:var(--blue); width:100%; padding:12px; margin-top:10px;">DEÄÄ°ÅÄ°MÄ° UYGULA</button></div>
            <div id="aktifDegisimlerListesi" style="margin-top:20px;"></div><button onclick="tumDegisimleriTemizle()" class="btn-main-action" style="background:var(--danger); width:100%; margin-top:20px;">ğŸ—‘ï¸ TÃœM DEÄÄ°ÅÄ°MLERÄ° SÄ°L</button>
        </div>
        <div id="tab-yillik" class="tab-content hidden"><div class="swap-container" style="border-color:#9333ea; background:#f3e8ff;"><div class="swap-header" style="color:#9333ea;">ğŸ–ï¸ TOPLU YILLIK Ä°ZÄ°N Ä°ÅLEME</div><div class="swap-row"><label class="swap-label">PERSONEL SEÃ‡Ä°N:</label><select id="yillikIzinPersonel" class="swap-select"><option>SeÃ§iniz...</option></select></div><div class="swap-row" style="display:flex; gap:10px;"><div style="flex:1;"><label class="swap-label">BAÅLANGIÃ‡:</label><input type="date" id="yillikBaslangic" class="swap-select"></div><div style="flex:1;"><label class="swap-label">BÄ°TÄ°Å (Dahil):</label><input type="date" id="yillikBitis" class="swap-select"></div></div><button onclick="yillikIzinIsle()" class="btn-main-action" style="background:#9333ea; width:100%; padding:12px; margin-top:10px;">Ä°ZÄ°NLERÄ° Ä°ÅLE</button><div style="margin-top:10px; font-size:10px; color:#666; text-align:center;">* SeÃ§ilen tarih aralÄ±ÄŸÄ±na "YILLIK Ä°ZÄ°N" yazÄ±lacak.</div></div></div>
        <div id="tab-sistem" class="tab-content hidden"><button onclick="jsonYedekAl()" class="btn-main-action" style="width:100%; background:var(--blue); margin-bottom:10px;">ğŸ’¾ JSON Ä°NDÄ°R</button><button onclick="jsonYedekYukle()" class="btn-main-action" style="width:100%; background:var(--success); margin-bottom:10px;">ğŸ“‚ YEDEÄÄ° YÃœKLE</button><input type="file" id="jsonInput" style="display:none" onchange="handleFileSelect(this)"><button onclick="githubdanYedekYukle()" class="btn-main-action" style="width:100%; background:#000; color:#fff; margin-bottom:10px;">ğŸ“‚ GITHUB'DAN YÃœKLE</button><button onclick="vardiyaSifirla()" class="btn-main-action" style="width:100%; background:var(--warning); margin-bottom:10px;">Bu HaftayÄ± Temizle</button><button onclick="tamSifirla()" class="btn-main-action" style="width:100%; background:var(--danger)">TÃ¼m HafÄ±zayÄ± Sil</button></div>
        <div id="tab-talepler" class="tab-content hidden"><div id="gelenTaleplerListesi" style="max-height: 400px; overflow-y: auto;"></div></div>
  </div>
  <script>
    let TELEGRAM_API = "8509542541:AAFu-iDK85iELZQmImCWSZRi3_eWzUyyCiM"; 
    let TELEGRAM_ID = "859235247";
    const firebaseConfig = { apiKey: "AIzaSyBY8dA7IQ0vcdjtG0haRVFuF0vTgZACU0M", authDomain: "teknik-vardiya-listesi.firebaseapp.com", databaseURL: "https://teknik-vardiya-listesi-default-rtdb.europe-west1.firebasedatabase.app", projectId: "teknik-vardiya-listesi", storageBucket: "teknik-vardiya-listesi.firebasestorage.app", messagingSenderId: "900931844150", appId: "1:900931844150:web:41c799492e85d62df8c097" };
    firebase.initializeApp(firebaseConfig); const database = firebase.database();
    const GUNLER = ["Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt", "Paz"]; const PREFIX = ""; 
    const BIRIM_RENKLERI = { "TEKNÄ°K YÃ–NETMEN": "#2563eb", "SES OPERATÃ–RÃœ": "#7c3aed", "KJ OPERATÃ–RÃœ": "#db2777", "PLAYOUT OPERATÃ–RÃœ": "#059669", "REJÄ°": "#d97706", "24TV MCR OPERATÃ–RÃœ": "#9333ea","360TV MCR OPERATÃ–RÃœ": "#9333ea", "INGEST OPERATÃ–RÃœ": "#06b6d4" };
    let isAdmin = false;
    let state = { birimler: JSON.parse(localStorage.getItem(PREFIX + "birimler")) || ["TEKNÄ°K YÃ–NETMEN", "SES OPERATÃ–RÃœ", "KJ OPERATÃ–RÃœ", "PLAYOUT OPERATÃ–RÃœ", "24TV MCR OPERATÃ–RÃœ","360TV MCR OPERATÃ–RÃœ", "INGEST OPERATÃ–RÃœ"], saatler: JSON.parse(localStorage.getItem(PREFIX + "saatler")) || ["06:30â€“16:00", "09:00â€“18:00", "16:00â€“00:00", "00:00â€“07:00"], personeller: JSON.parse(localStorage.getItem(PREFIX + "personeller")) || [], kapasite: JSON.parse(localStorage.getItem(PREFIX + "kapasite")) || {}, manuelAtamalar: JSON.parse(localStorage.getItem(PREFIX + "manuelAtamalar")) || {}, haftaIciSabitler: JSON.parse(localStorage.getItem(PREFIX + "haftaIciSabitler")) || {}, mcrAyarlari: JSON.parse(localStorage.getItem(PREFIX + "mcrAyarlari")) || { baslangicTarihi: new Date().toISOString().split('T')[0], ofsetler: {} }, geciciGorevler: JSON.parse(localStorage.getItem(PREFIX + "geciciGorevler")) || {} };
    let currentMonday = getMonday(new Date());

    async function hassasAyarlariYukle() { try { const snap = await database.ref('config').once('value'); if (snap.exists()) { const config = snap.val(); if(config.telegram_api) TELEGRAM_API = config.telegram_api; if(config.telegram_id) TELEGRAM_ID = config.telegram_id; } } catch (error) { console.error(error); } }
    async function enterSystem(role) { if (role === 'admin') { const email = prompt("YÃ¶netici E-posta:"); const password = prompt("YÃ¶netici Åifresi:"); if (!email || !password) return; try { await firebase.auth().signInWithEmailAndPassword(email, password); isAdmin = true; await hassasAyarlariYukle(); document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex'); document.getElementById('persTalepArea').style.display = 'none'; checkUrlActions(); alert("YÃ¶netici giriÅŸi baÅŸarÄ±lÄ±!"); } catch (error) { alert("HatalÄ± giriÅŸ: " + error.message); return; } } else { isAdmin = false; document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none'); document.getElementById('persTalepArea').style.display = 'block'; } document.getElementById('loginOverlay').style.opacity = '0'; setTimeout(() => { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('appMain').style.display = 'block'; tabloyuOlustur(); }, 500); }
    function checkUrlActions() { const urlParams = new URLSearchParams(window.location.search); const action = urlParams.get('action'); const talepId = urlParams.get('id'); if((action === 'onay' || action === 'red') && talepId) { talepIslem(talepId, action); window.history.replaceState({}, document.title, window.location.pathname); } }
    function talepModalAc() { const sel = document.getElementById('talepPersonel'); sel.innerHTML = state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join(''); document.getElementById('talepModal').style.display = 'flex'; }
    function talepGonder() { const ad = document.getElementById('talepPersonel').value; const tarih = document.getElementById('talepTarih').value; const tur = document.getElementById('talepTuru').value; if(!tarih) { alert("LÃ¼tfen tarih seÃ§in!"); return; } const secilenTarih = new Date(tarih); const pzt = getMonday(secilenTarih); const hKey = pzt.toISOString().split('T')[0]; const gunIdx = (secilenTarih.getDay() + 6) % 7; const talepId = Date.now().toString(); database.ref('talepler/' + talepId).set({ id: talepId, ad, tarih, gunIdx, tur, hKey, durum: "bekliyor" }); const appUrl = window.location.href.split('?')[0]; fetch(`https://api.telegram.org/bot${TELEGRAM_API}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: TELEGRAM_ID, text: `ğŸ”” *YENÄ° VARDÄ°YA TALEBÄ°*\n\nğŸ‘¤ *Personel:* ${ad}\nğŸ“… *Tarih:* ${tarih}\nğŸ“ *Vardiya:* ${tur}`, parse_mode: 'Markdown', reply_markup: { inline_keyboard: [[{ text: "âœ… SÄ°TEYE GÄ°T VE ONAYLA", url: `${appUrl}?action=onay&id=${talepId}` }, { text: "âŒ SÄ°TEYE GÄ°T VE REDDET", url: `${appUrl}?action=red&id=${talepId}` }]] } }) }); alert("Talebiniz yÃ¶neticiye iletildi."); document.getElementById('talepModal').style.display = 'none'; }
    function talepleriYukle() { database.ref('talepler').orderByChild('durum').equalTo('bekliyor').on('value', snap => { const liste = document.getElementById('gelenTaleplerListesi'); if(!snap.exists()) { liste.innerHTML = "<p style='text-align:center; padding:20px; opacity:0.5;'>Bekleyen talep bulunmuyor.</p>"; return; } let html = ""; snap.forEach(item => { const t = item.val(); html += `<div style="background:var(--card-bg); border:1px solid var(--border); border-left:5px solid var(--warning); padding:12px; border-radius:8px; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,0.05);"><div style="font-weight:800; color:var(--primary); font-size:12px; margin-bottom:4px;">${t.ad}</div><div style="font-size:11px; margin-bottom:8px;">ğŸ“… ${t.tarih} (Hafta: ${t.hKey})<br>ğŸ“ Ä°stek: <b>${t.tur}</b></div><div style="display:flex; gap:8px;"><button onclick="talepIslem('${t.id}', 'onay')" style="flex:1; background:var(--success); color:white; border:none; border-radius:6px; padding:8px; cursor:pointer; font-weight:700; font-size:10px;">ONAYLA</button><button onclick="talepIslem('${t.id}', 'red')" style="flex:1; background:var(--danger); color:white; border:none; border-radius:6px; padding:8px; cursor:pointer; font-weight:700; font-size:10px;">REDDET</button></div></div>`; }); liste.innerHTML = html; }); }
    function talepIslem(id, tip) { database.ref('talepler/' + id).once('value', snap => { if(!snap.exists()) return; const t = snap.val(); if(tip === 'onay') { const mKey = `${t.hKey}_${t.ad}_${t.gunIdx}`; state.manuelAtamalar[mKey] = t.tur; save(); currentMonday = new Date(t.hKey); tabloyuOlustur(); database.ref('talepler/' + id).update({ durum: 'onaylandi' }); alert(`âœ… ${t.ad} iÃ§in ${t.tarih} talebi ONAYLANDI.\n\nTakvim ilgili haftaya (${t.hKey}) kaydÄ±rÄ±ldÄ±.`); } else { database.ref('talepler/' + id).update({ durum: 'reddedildi' }); alert("Talep reddedildi."); } }); }
    function getMonday(d) { d = new Date(d); let day = d.getDay(); return new Date(d.setDate(d.getDate() - day + (day == 0 ? -6 : 1))); }
    function save() { Object.keys(state).forEach(k => localStorage.setItem(PREFIX + k, JSON.stringify(state[k]))); }
    function getBirimColor(birim) { return BIRIM_RENKLERI[birim] || "#64748b"; }
    function getGecerliBirim(p, g) { let d = new Date(currentMonday); d.setDate(d.getDate() + g); const dateKey = d.toISOString().split('T')[0]; const key = `${dateKey}_${p.ad}`; return state.geciciGorevler[key] || p.birim; }
    function tabloyuOlustur() { const hKey = currentMonday.toISOString().split('T')[0]; document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} HaftasÄ±`; document.getElementById("tableHeader").innerHTML = `<tr><th style="width:100px;">SAAT</th>${GUNLER.map((g, i) => { let d = new Date(currentMonday); d.setDate(d.getDate() + i); let dateStr = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }); return `<th class="${i>=5?'weekend-col':''}">${g}<div style="font-size:9px; opacity:0.7; font-weight:normal;">${dateStr}</div></th>`; }).join('')}</tr>`;
        let prog = {}; let calis = {}; state.personeller.forEach(p => { prog[p.ad] = Array(7).fill(null); calis[p.ad] = 0; for(let i=0; i<7; i++) { let mKey = `${hKey}_${p.ad}_${i}`; if(state.manuelAtamalar[mKey]) prog[p.ad][i] = state.manuelAtamalar[mKey]; if(prog[p.ad][i] && !["Ä°ZÄ°NLÄ°","BOÅ",null,"YILLIK Ä°ZÄ°N"].includes(prog[p.ad][i])) calis[p.ad]++; } });
        document.getElementById("tableBody").innerHTML = state.saatler.map((s, sIdx) => { let rowHtml = `<tr class="row-saat-${sIdx}"><td class="saat-col">${s}</td>`; for(let g=0; g<7; g++) { let sortedPers = state.personeller.filter(p => prog[p.ad][g] === s).sort((a, b) => { let birimA = getGecerliBirim(a, g); let birimB = getGecerliBirim(b, g); return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB); }); let cellContent = ""; let lastBirim = ""; sortedPers.forEach((p) => { let gecerliBirim = getGecerliBirim(p, g); let ayiriciClass = (lastBirim !== "" && lastBirim !== gecerliBirim) ? "birim-ayirici" : ""; let clickAttr = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : ""; let dragAttr = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, '${s}')"` : ""; cellContent += `<div class="birim-card ${ayiriciClass}" style="border-left-color:${getBirimColor(gecerliBirim)}; background-color:${getBirimColor(gecerliBirim)}15;" ${dragAttr} ${clickAttr}><span class="birim-tag" style="background:${getBirimColor(gecerliBirim)}">${gecerliBirim}</span><span class="pers-name">${p.ad}</span></div>`; lastBirim = gecerliBirim; }); rowHtml += `<td class="${g>=5?'weekend-col':''}" data-label="${GUNLER[g]}" ondragover="event.preventDefault()" ondrop="drop(event, '${s}', ${g})">${cellContent}</td>`; } return rowHtml + "</tr>"; }).join('');
        document.getElementById("tableFooter").innerHTML = `<tr class="row-izin"><td class="saat-col">Ä°ZÄ°N / BOÅ</td>${[0,1,2,3,4,5,6].map(g => { let sortedPers = state.personeller.filter(p => ["Ä°ZÄ°NLÄ°","BOÅ",null,"YILLIK Ä°ZÄ°N"].includes(prog[p.ad][g])).sort((a, b) => { let birimA = getGecerliBirim(a, g); let birimB = getGecerliBirim(b, g); return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB); }); let cellContent = ""; let lastBirim = ""; sortedPers.forEach(p => { let gecerliBirim = getGecerliBirim(p, g); let ayiriciClass = (lastBirim !== "" && lastBirim !== gecerliBirim) ? "birim-ayirici" : ""; let clickAttr = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : ""; let dragAttr = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, 'BOÅ')"` : ""; let isYillik = prog[p.ad][g] === 'YILLIK Ä°ZÄ°N'; let bgStyle = isYillik ? 'background:var(--yillik-izin)' : (prog[p.ad][g]==='Ä°ZÄ°NLÄ°'?'background:var(--danger)':`background:${getBirimColor(gecerliBirim)}`); cellContent += `<div class="birim-card ${ayiriciClass}" style="border-left-color:${getBirimColor(gecerliBirim)};" ${dragAttr} ${clickAttr}><span class="birim-tag" style="${bgStyle}">${prog[p.ad][g] || 'BOÅ'}</span><span class="pers-name">${p.ad} (${calis[p.ad]}G)</span></div>`; lastBirim = gecerliBirim; }); return `<td class="${g>=5?'weekend-col':''}" data-label="${GUNLER[g]}" ondragover="event.preventDefault()" ondrop="drop(event, 'BOÅ', ${g})">${cellContent}</td>`; }).join('')}</tr>`;
    }
    function cakismaKontrol(personelAd, hedefGun, hedefSaat) { const hKey = currentMonday.toISOString().split('T')[0]; if (["Ä°ZÄ°NLÄ°", "BOÅ", null, "YILLIK Ä°ZÄ°N"].includes(hedefSaat)) return; if (hedefGun > 0) { let dunKey = `${hKey}_${personelAd}_${hedefGun - 1}`; let dunVardiya = state.manuelAtamalar[dunKey]; let sabahVardiyalari = ["06:30â€“16:00", "09:00â€“18:00"]; let aksamVardiyalari = ["16:00â€“00:00", "00:00â€“07:00"]; if (aksamVardiyalari.includes(dunVardiya) && sabahVardiyalari.includes(hedefSaat)) alert(`âš ï¸ DÄ°KKAT: ${personelAd} dÃ¼n AKÅAM/GECE vardiyasÄ±ndaydÄ±. BugÃ¼n SABAH vardiyasÄ±na yazÄ±yorsunuz. Dinlenme sÃ¼resi yetersiz olabilir!`); } if (hedefGun < 6) { let yarinKey = `${hKey}_${personelAd}_${hedefGun + 1}`; let yarinVardiya = state.manuelAtamalar[yarinKey]; let sabahVardiyalari = ["06:30â€“16:00", "09:00â€“18:00"]; let aksamVardiyalari = ["16:00â€“00:00", "00:00â€“07:00"]; if (aksamVardiyalari.includes(hedefSaat) && sabahVardiyalari.includes(yarinVardiya)) alert(`âš ï¸ DÄ°KKAT: ${personelAd} yarÄ±n SABAH vardiyasÄ±nda gÃ¶rÃ¼nÃ¼yor. BugÃ¼n AKÅAM/GECE vardiyasÄ±na yazÄ±yorsunuz. Dinlenme sÃ¼resi yetersiz olabilir!`); } }
    function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }
    function seededShuffle(array, seed) { let hash = 0; for (let i = 0; i < seed.length; i++) hash = Math.imul(31, hash) + seed.charCodeAt(i) | 0; let rng = mulberry32(hash); let m = array.length, t, i; while (m) { i = Math.floor(rng() * m--); t = array[m]; array[m] = array[i]; array[i] = t; } return array; }
    function yillikIzinIsle() { const pAd = document.getElementById('yillikIzinPersonel').value; const basTarih = document.getElementById('yillikBaslangic').value; const bitTarih = document.getElementById('yillikBitis').value; if(!pAd || !basTarih || !bitTarih) { alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun."); return; } let current = new Date(basTarih); let end = new Date(bitTarih); while(current <= end) { const hKey = getMonday(current).toISOString().split('T')[0]; let jsDay = current.getDay(); let gunIdx = (jsDay + 6) % 7; const mKey = `${hKey}_${pAd}_${gunIdx}`; state.manuelAtamalar[mKey] = "YILLIK Ä°ZÄ°N"; current.setDate(current.getDate() + 1); } save(); tabloyuOlustur(); alert(`${pAd} iÃ§in yÄ±llÄ±k izin iÅŸlendi.`); document.getElementById('yillikBaslangic').value = ""; document.getElementById('yillikBitis').value = ""; }
    
    function vardiyaUretVeKaydet() {
        if(!isAdmin) return;
        const hKey = currentMonday.toISOString().split('T')[0];
        const prevMonday = new Date(currentMonday); prevMonday.setDate(prevMonday.getDate() - 7);
        const prevHKey = prevMonday.toISOString().split('T')[0];
        let tempProg = {}; let calis = {};
        
        state.personeller.forEach(p => {
             tempProg[p.ad] = Array(7).fill(null);
             for(let g=0; g<7; g++) { let mKey = `${hKey}_${p.ad}_${g}`; if(state.manuelAtamalar[mKey]) tempProg[p.ad][g] = state.manuelAtamalar[mKey]; }
             if (state.haftaIciSabitler[p.ad]) { for(let i=0; i<5; i++) { if(!tempProg[p.ad][i]) tempProg[p.ad][i] = state.haftaIciSabitler[p.ad]; } if(!tempProg[p.ad][5]) tempProg[p.ad][5] = "Ä°ZÄ°NLÄ°"; if(!tempProg[p.ad][6]) tempProg[p.ad][6] = "Ä°ZÄ°NLÄ°"; }
             if(p.izinGunleri) { p.izinGunleri.forEach(gi => { if(!tempProg[p.ad][gi]) tempProg[p.ad][gi] = "Ä°ZÄ°NLÄ°"; }); }
        });

        const safeAssign = (p, day, shift) => {
             if (tempProg[p.ad][day] !== null) return;
             if (shift === "Ä°ZÄ°NLÄ°") { tempProg[p.ad][day] = shift; return; }
             const cap = (state.kapasite[`${p.birim}_${shift}`] || [0,0,0,0,0,0,0])[day];
             let currentCount = 0;
             state.personeller.filter(x => x.birim === p.birim).forEach(x => { if(tempProg[x.ad][day] === shift) currentCount++; });
             if (currentCount < cap) tempProg[p.ad][day] = shift;
        };

        const mcrDongu = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "00:00â€“07:00", "00:00â€“07:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"];
        const ingestDongu = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"];
        const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);

        state.personeller.forEach(p => { 
            if(p.birim.includes("MCR")) {
                const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
                for(let g=0; g<7; g++) {
                    if(tempProg[p.ad][g]) continue; 
                    let d = new Date(currentMonday); d.setDate(d.getDate() + g);
                    const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
                    tempProg[p.ad][g] = mcrDongu[((diffDays + persOfset) % 8 + 8) % 8];
                }
            } else if(p.birim.includes("INGEST")) {
                const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
                for(let g=0; g<7; g++) {
                    if(tempProg[p.ad][g]) continue;
                    let d = new Date(currentMonday); d.setDate(d.getDate() + g);
                    const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
                    tempProg[p.ad][g] = ingestDongu[((diffDays + persOfset) % 6 + 6) % 6];
                }
            }
        });

        ["PLAYOUT OPERATÃ–RÃœ", "SES OPERATÃ–RÃœ", "KJ OPERATÃ–RÃœ"].forEach(ozelBirim => {
            let personelListesi = state.personeller.filter(p => p.birim === ozelBirim);
            if (personelListesi.length === 0) return;
            let grupA = []; let grupB = []; let grupC = []; 
            personelListesi.forEach((p, index) => {
                let gecenPzt = state.manuelAtamalar[`${prevHKey}_${p.ad}_0`];
                if (gecenPzt === "Ä°ZÄ°NLÄ°" || gecenPzt === "BOÅ" || !gecenPzt || gecenPzt === "YILLIK Ä°ZÄ°N") grupA.push(p); 
                else if (gecenPzt === "06:30â€“16:00" || gecenPzt === "09:00â€“18:00") grupB.push(p); 
                else grupC.push(p); 
            });
            if (grupA.length === 0 && grupB.length === 0 && grupC.length === 0) { personelListesi.forEach((p, i) => { if (i % 3 === 0) grupA.push(p); else if (i % 3 === 1) grupB.push(p); else grupC.push(p); }); }
            grupA.forEach(p => { safeAssign(p, 0, "06:30â€“16:00"); safeAssign(p, 1, "16:00â€“00:00"); safeAssign(p, 2, "16:00â€“00:00"); safeAssign(p, 3, "Ä°ZÄ°NLÄ°"); safeAssign(p, 4, "Ä°ZÄ°NLÄ°"); safeAssign(p, 5, "06:30â€“16:00"); safeAssign(p, 6, "06:30â€“16:00"); });
            grupB.forEach(p => { safeAssign(p, 0, "16:00â€“00:00"); safeAssign(p, 1, "Ä°ZÄ°NLÄ°"); safeAssign(p, 2, "Ä°ZÄ°NLÄ°"); safeAssign(p, 3, "06:30â€“16:00"); safeAssign(p, 4, "06:30â€“16:00"); safeAssign(p, 5, "16:00â€“00:00"); safeAssign(p, 6, "16:00â€“00:00"); });
            seededShuffle(grupC, hKey); 
            grupC.forEach((p, index) => { safeAssign(p, 0, "Ä°ZÄ°NLÄ°"); safeAssign(p, 1, "06:30â€“16:00"); safeAssign(p, 2, "06:30â€“16:00"); safeAssign(p, 3, "16:00â€“00:00"); safeAssign(p, 4, "16:00â€“00:00"); if (index % 2 === 0) safeAssign(p, 5, "Ä°ZÄ°NLÄ°"); else safeAssign(p, 5, "16:00â€“00:00"); if (index % 2 === 0) safeAssign(p, 6, "06:30â€“16:00"); else safeAssign(p, 6, "Ä°ZÄ°NLÄ°"); });
        });

        state.personeller.forEach(p => { calis[p.ad] = 0; for(let g=0; g<7; g++) { if(tempProg[p.ad][g] && !["Ä°ZÄ°NLÄ°","BOÅ",null,"YILLIK Ä°ZÄ°N"].includes(tempProg[p.ad][g])) calis[p.ad]++; } });

        for (let gun = 0; gun < 7; gun++) {
            state.birimler.filter(b => !b.includes("MCR") && !b.includes("INGEST")).forEach(birim => {
                const geceSaati = "00:00â€“07:00"; const hedef = (state.kapasite[`${birim}_${geceSaati}`] || [0,0,0,0,0,0,0])[gun];
                let atanan = state.personeller.filter(p => p.birim === birim && tempProg[p.ad][gun] === geceSaati).length;
                if (atanan < hedef) {
                    let adaylar = state.personeller.filter(p => p.birim === birim && tempProg[p.ad][gun] === null);
                    if (adaylar.length === 0) {
                        adaylar = state.personeller.filter(p => {
                            let isSameUnit = p.birim === birim;
                            let isSystemIzin = tempProg[p.ad][gun] === "Ä°ZÄ°NLÄ°"; 
                            let isManual = state.manuelAtamalar[`${hKey}_${p.ad}_${gun}`] !== undefined;
                            let isFixedOff = p.izinGunleri && p.izinGunleri.includes(gun);
                            return isSameUnit && isSystemIzin && !isManual && !isFixedOff;
                        });
                    }
                    if (birim === "TEKNÄ°K YÃ–NETMEN") { adaylar.sort((a, b) => { let puanFarki = (b.yuzde || 0) - (a.yuzde || 0); if (puanFarki !== 0) return puanFarki; return calis[a.ad] - calis[b.ad]; }); } 
                    else { seededShuffle(adaylar, hKey); adaylar.sort((a, b) => calis[a.ad] - calis[b.ad]); }
                    for (let p of adaylar) { if (atanan < hedef && calis[p.ad] < 6) { tempProg[p.ad][gun] = geceSaati; calis[p.ad]++; atanan++; } }
                }
            });

            state.saatler.filter(s => s !== "00:00â€“07:00").forEach(saat => {
                state.birimler.filter(b => !b.includes("MCR") && !b.includes("INGEST")).forEach(birim => {
                    const hedef = (state.kapasite[`${birim}_${saat}`] || [0,0,0,0,0,0,0])[gun];
                    let mevcut = state.personeller.filter(p => p.birim === birim && tempProg[p.ad][gun] === saat).length;
                    if (mevcut < hedef) {
                        let adaylar = state.personeller.filter(p => {
                            let basic = p.birim === birim && tempProg[p.ad][gun] === null;
                            let dunGece = (gun > 0 && tempProg[p.ad][gun-1] === "00:00â€“07:00");
                            let pazarGecesiSorunu = false;
                            if (gun === 0 && (saat === "06:30â€“16:00" || saat === "09:00â€“18:00")) { let prevShift = state.manuelAtamalar[`${prevHKey}_${p.ad}_6`]; if (prevShift === "00:00â€“07:00" || prevShift === "16:00â€“00:00") pazarGecesiSorunu = true; }
                            return basic && !(dunGece && saat === "06:30â€“16:00") && !pazarGecesiSorunu;
                        });
                        if (adaylar.length === 0) {
                            adaylar = state.personeller.filter(p => {
                                let isSameUnit = p.birim === birim;
                                let isSystemIzin = tempProg[p.ad][gun] === "Ä°ZÄ°NLÄ°"; 
                                let isManual = state.manuelAtamalar[`${hKey}_${p.ad}_${gun}`] !== undefined;
                                let isFixedOff = p.izinGunleri && p.izinGunleri.includes(gun);
                                let dunGece = (gun > 0 && tempProg[p.ad][gun-1] === "00:00â€“07:00");
                                return isSameUnit && isSystemIzin && !isManual && !isFixedOff && !(dunGece && saat === "06:30â€“16:00");
                            });
                        }
                        seededShuffle(adaylar, hKey);
                        adaylar.sort((a, b) => calis[a.ad] - calis[b.ad]);
                        let limit = (gun >= 5) ? 6 : 5;
                        for (let p of adaylar) { if (mevcut < hedef && calis[p.ad] < limit) { tempProg[p.ad][gun] = saat; calis[p.ad]++; mevcut++; } }
                    }
                });
            });
        }

        state.personeller.forEach(p => {
            if(!p.birim.includes("MCR") && !p.birim.includes("INGEST") && !state.haftaIciSabitler[p.ad]) {
                if (calis[p.ad] < 5) { let g = 5; if (tempProg[p.ad][g] === null) { let dunGece = (tempProg[p.ad][4] === "00:00â€“07:00"); if (!dunGece) { tempProg[p.ad][g] = "09:00â€“18:00"; calis[p.ad]++; } } }
                if (calis[p.ad] < 5) { let g = 6; if (tempProg[p.ad][g] === null) { let dunGece = (tempProg[p.ad][5] === "00:00â€“07:00"); if (!dunGece) { tempProg[p.ad][g] = "09:00â€“18:00"; calis[p.ad]++; } } }
            }
        });

        state.personeller.forEach(p => { for(let g=0; g<7; g++) { if(tempProg[p.ad][g] === null) tempProg[p.ad][g] = "Ä°ZÄ°NLÄ°"; } });
        state.personeller.forEach(p => { for(let i=0; i<7; i++) if(tempProg[p.ad][i]) state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] = tempProg[p.ad][i]; });
        save(); tabloyuOlustur(); alert("Vardiya oluÅŸturuldu (Manuel/YÄ±llÄ±k Ä°zin > Kapasite [Yedek Kuvvet Dahil] > Desen).");
    }

    function excelIndir() {
        const hKey = currentMonday.toISOString().split('T')[0];
        let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>table { border-collapse: collapse; font-family: Arial; } td { border: 1px solid #000; text-align: center; padding: 4px; font-size: 8pt; } .title { background: #312e81; color: white; font-weight: bold; font-size: 12pt; } .header { background: #1e1b4b; color: white; font-weight: bold; } .saat-0630 { background: #ffff00; font-weight: bold; } .saat-0900 { background: #00b0f0; color: white; font-weight: bold; } .saat-1600 { background: #7030a0; color: white; font-weight: bold; } .saat-0000 { background: #ed7d31; color: white; font-weight: bold; } .saat-izin { background: #ff0000; color: white; font-weight: bold; }</style></head><body><table><tr><th colspan="8" class="title">TEKNÄ°K PERSONEL Ã‡ALIÅMA LÄ°STESÄ°</th></tr><tr><th class="header">SAAT</th>${GUNLER.map(g => `<th class="header">${g.toUpperCase()}</th>`).join('')}</tr>`;
        state.birimler.forEach(birim => {
            html += `<tr><td colspan="8" style="background:${getBirimColor(birim)}; color:white; font-weight:bold;">${birim}</td></tr>`;
            [...state.saatler, "Ä°ZÄ°N"].forEach(s => {
                let pByDay = []; let maxRow = 1;
                for(let i=0; i<7; i++) {
                    let list = state.personeller.filter(p => { let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`]; if(s === "Ä°ZÄ°N") return p.birim === birim && (v === "Ä°ZÄ°NLÄ°" || v === "BOÅ" || !v || v === "YILLIK Ä°ZÄ°N"); return p.birim === birim && v === s; });
                    pByDay[i] = list; if(list.length > maxRow) maxRow = list.length;
                }
                let cls = s.includes("06:30") ? "saat-0630" : s.includes("09:00") ? "saat-0900" : s.includes("16:00") ? "saat-1600" : s.includes("00:00") ? "saat-0000" : s === "Ä°ZÄ°N" ? "saat-izin" : "";
                for(let r=0; r<maxRow; r++) { html += `<tr>${r===0 ? `<td rowspan="${maxRow}" class="${cls}">${s}</td>`:""}${pByDay.map(d => `<td>${d[r]?d[r].ad:""}</td>`).join('')}</tr>`; }
            });
        });
        html += `</table></body></html>`;
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `Vardiya_${hKey}.xls`; a.click();
    }

    function toggleAdminPanel() { if(!isAdmin) return; const p = document.getElementById("sidePanel"); const o = document.getElementById("panelOverlay"); p.classList.toggle("open"); o.style.display = p.classList.contains("open") ? "block" : "none"; if(p.classList.contains("open")) tabDegistir('personel'); }
    function tabDegistir(t) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab-' + t).classList.remove('hidden'); document.getElementById('btn-tab-' + t).classList.add('active'); refreshUI(); }
    function bulutaKaydet() { database.ref('vardiya_data').set(state).then(() => alert("Kaydedildi!")).catch(e => alert(e.message)); }
    function buluttanYukle() { database.ref('vardiya_data').once('value').then(snap => { if(snap.exists()){ state = snap.val(); save(); location.reload(); } }); }
    function refreshUI() {
        document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
        document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => {
            let mcrHtml = (p.birim.includes("MCR") || p.birim.includes("INGEST")) ? `<div class="mcr-ayarlar"><span>${p.birim.includes("INGEST") ? 'INGEST' : 'MCR'} DÃ¶ngÃ¼ Ofseti: </span><input type="number" value="${state.mcrAyarlari.ofsetler[p.ad] || 0}" style="width:40px" onchange="mcrOfsetGuncelle('${p.ad}', this.value)"></div>` : "";
            let yuzdeHtml = `<div style="margin-top:5px; font-size:10px;"><span style="font-weight:bold;">Vardiya Ã–ncelik PuanÄ± (%):</span><input type="number" value="${p.yuzde || 0}" style="width:50px; padding:3px; border-radius:4px; border:1px solid #ccc;" onchange="yuzdeGuncelle(${i}, this.value)"></div>`;
            return `<div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:5px;"><strong>${p.ad}</strong> <small>(${p.birim})</small><button onclick="state.personeller.splice(${i},1); save(); refreshUI(); tabloyuOlustur();" style="color:var(--danger); border:none; background:none; cursor:pointer; float:right;">Sil</button><div style="margin-top:5px;">${GUNLER.map((g, gi) => `<span class="izin-gun-pill ${p.izinGunleri?.includes(gi)?'active':''}" onclick="izinGunuTetikle(${i},${gi})">${g}</span>`).join('')}</div>${yuzdeHtml}${mcrHtml}</div>`;
        }).join('');
        const swapKaynak = document.getElementById('swapKaynakPersonel'); const swapHedef = document.getElementById('swapHedefPersonel'); const optionsHtml = "<option value=''>SeÃ§iniz...</option>" + state.personeller.sort((a,b) => a.ad.localeCompare(b.ad)).map(p => `<option value="${p.ad}">${p.ad} (${p.birim})</option>`).join('');
        if(swapKaynak) swapKaynak.innerHTML = optionsHtml; if(swapHedef) swapHedef.innerHTML = optionsHtml;
        const yillikSel = document.getElementById('yillikIzinPersonel'); if(yillikSel) yillikSel.innerHTML = optionsHtml;
        if(!state.geciciGorevler) state.geciciGorevler = {};
        let degisimHtml = "<strong>Aktif DeÄŸiÅŸimler (Bu Hafta):</strong><br>"; let hasDegisim = false;
        Object.keys(state.geciciGorevler).forEach(k => { const [dateStr, pName] = k.split('_'); const targetUnit = state.geciciGorevler[k]; let d = new Date(dateStr); let nextMonday = new Date(currentMonday); nextMonday.setDate(nextMonday.getDate() + 7); if(d >= currentMonday && d < nextMonday) { degisimHtml += `<div style="font-size:10px; border-bottom:1px solid #eee; padding:2px;">ğŸ“… ${dateStr} - <b>${pName}</b> â¡ï¸ ${targetUnit}</div>`; hasDegisim = true; } });
        document.getElementById("aktifDegisimlerListesi").innerHTML = hasDegisim ? degisimHtml : "<div style='font-size:10px; color:#999;'>Bu hafta iÃ§in aktif deÄŸiÅŸim yok.</div>";
        let capHtml = ""; state.birimler.forEach(b => { capHtml += `<div style="margin-bottom:15px; background:var(--bg); padding:10px; border-radius:8px;"><strong>${b}</strong>`; state.saatler.forEach(s => { const v = state.kapasite[`${b}_${s}`] || [0,0,0,0,0,0,0]; capHtml += `<div style="font-size:9px; margin-top:5px;">${s}</div><div style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px;">${GUNLER.map((g, gi) => `<input type="number" value="${v[gi]}" style="width:100%; text-align:center;" onchange="capUp('${b}_${s}',${gi},this.value)">`).join('')}</div>`; }); capHtml += `</div>`; });
        document.getElementById("kapasiteTable").innerHTML = capHtml;
        let mcrSistemHtml = `<div style="background:#e0f2fe; padding:10px; border-radius:8px; margin-bottom:10px;"><strong>MCR/INGEST DÃ¶ngÃ¼ BaÅŸlangÄ±Ã§ Tarihi:</strong><br><input type="date" value="${state.mcrAyarlari.baslangicTarihi}" onchange="state.mcrAyarlari.baslangicTarihi = this.value; save();" style="width:100%; padding:5px; margin-top:5px;"></div>`;
        document.getElementById("sabitListeAdmin").innerHTML = mcrSistemHtml + state.personeller.filter(p => !p.birim.includes("MCR") && !p.birim.includes("INGEST")).map(p => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:var(--bg); padding:5px; border-radius:5px;"><label><input type="checkbox" ${state.haftaIciSabitler[p.ad]?'checked':''} onchange="sabitTetikle('${p.ad}')"> ${p.ad}</label><select onchange="sabitSaatGuncelle('${p.ad}', this.value)" ${!state.haftaIciSabitler[p.ad]?'disabled':''}>${state.saatler.map(s => `<option value="${s}" ${state.haftaIciSabitler[p.ad] === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`).join('');
        document.getElementById("birimListesiAdmin").innerHTML = `<div style="margin-bottom:10px; display:flex; gap:5px;"><input type="text" id="yeniBirimInp" placeholder="Yeni Birim AdÄ±" style="flex:1; padding:5px; border-radius:4px; border:1px solid #ccc;"><button onclick="birimEkle()" class="btn-main-action" style="background:var(--success); padding:5px 10px;">EKLE</button></div>${state.birimler.map((b, i) => `<div style="padding:8px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;"><span>${b}</span><button onclick="birimSil(${i})" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:10px;">Sil</button></div>`).join('')}`;
        document.getElementById("saatListesiAdmin").innerHTML = `<div style="margin-bottom:10px; display:flex; gap:5px;"><input type="text" id="yeniSaatInp" placeholder="Ã–rn: 10:00â€“19:00" style="flex:1; padding:5px; border-radius:4px; border:1px solid #ccc;"><button onclick="saatEkle()" class="btn-main-action" style="background:var(--success); padding:5px 10px;">EKLE</button></div>${state.saatler.map((s, i) => `<div style="padding:8px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;"><span>${s}</span><button onclick="saatSil(${i})" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:10px;">Sil</button></div>`).join('')}`;
    }
    function anlikSenkronizasyonBaslat() {
        database.ref().on('value', (snap) => {
            if (snap.exists()) {
                const data = snap.val();
                if(data.vardiya_data) { state = data.vardiya_data; save(); tabloyuOlustur(); if(isAdmin) refreshUI(); }
                if(isAdmin) { talepleriYukle(); }
            }
        });
    }
    window.onload = async () => { 
        if(localStorage.getItem(PREFIX + "theme") === "dark") { document.documentElement.setAttribute("data-theme", "dark"); }
        await hassasAyarlariYukle(); 
        anlikSenkronizasyonBaslat();
        talepleriYukle(); 
    };
  </script>
</body>
</html>