<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>TURKMEDYA TEKNiK VARDiYA LiSTESi | Pro_Ugr</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #1e293b; --blue: #2563eb; --bg: #f1f5f9; --card-bg: #ffffff;
      --text: #334155; --border: #e2e8f0; --danger: #ef4444; --success: #22c55e;
      --warning: #f59e0b; --weekend-bg: #fff1f2; --table-head: #f8fafc;
      --saat1: #e0f2fe; --saat2: #f0fdf4; --saat3: #faf5ff; --saat4: #fff7ed;
      --izin-bg: #fef2f2;
      --yillik-izin: #9333ea;
    }
    [data-theme="dark"] {
      --primary: #0f172a; --bg: #020617; --card-bg: #1e293b; --text: #f1f5f9;
      --border: #334155; --weekend-bg: #2d1a1a; --table-head: #0f172a;
      --saat1: #0c4a6e; --saat2: #064e3b; --saat3: #581c87; --saat4: #7c2d12;
      --izin-bg: #450a0a;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; font-size: 12px; transition: background 0.3s ease; }
    
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
    .login-card { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); text-align: center; width: 320px; }
    .login-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 14px; }
    .btn-user { background: var(--blue); color: white; } .btn-admin { background: #475569; color: white; }
    .login-logo { height: 60px; margin-bottom: 20px; }
    .app-wrapper { padding: 10px; display: none; } 
    .main-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; gap: 10px; }
    .table-container { overflow-x: auto; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; table-layout: fixed; }
    th { background: var(--table-head); color: var(--text); padding: 12px 8px; border-bottom: 2px solid var(--border); border-right: 1px solid var(--border); }
    td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 6px; vertical-align: top; height: 95px; }
    .saat-col { font-weight: 800; text-align: center; border-left: 5px solid var(--blue); width: 100px; }
    .row-saat-0 { background-color: var(--saat1); } .row-saat-1 { background-color: var(--saat2); } .row-saat-2 { background-color: var(--saat3); } .row-saat-3 { background-color: var(--saat4); }
    .row-izin { background-color: var(--izin-bg) !important; } .row-izin .saat-col { border-left-color: var(--danger) !important; color: var(--danger); }
    .weekend-col { background-color: var(--weekend-bg) !important; }
    .birim-card { border-left: 4px solid var(--blue); padding: 6px 8px; margin-bottom: 5px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.3s; }
    .birim-ayirici { border-top: 5px solid #1e293b !important; margin-top: 8px !important; padding-top: 8px !important; }
    .birim-tag { font-size: 7px; font-weight: 800; color: white; display: inline-block; padding: 1px 4px; border-radius: 3px; margin-bottom: 2px; text-transform: uppercase; }
    .pers-name { font-size: 10px; font-weight: 700; display: block; }
    
    .side-panel { position: fixed; top: 0; right: -550px; width: 500px; height: 100%; background: #f8fafc; z-index: 1000; transition: 0.4s; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.2); border-left: 1px solid var(--border); }
    .side-panel.open { right: 0; }
    .panel-header { padding: 20px; background: white; color: var(--primary); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .panel-header h2 { font-size: 18px; font-weight: 800; }
    .panel-content { padding: 20px; overflow-y: auto; flex: 1; }
    
    .panel-action-group { display: flex; gap: 10px; margin-bottom: 25px; }
    .panel-action-group button { flex: 1; padding: 15px; border-radius: 12px; font-size: 11px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; border: none; font-weight: 700; cursor: pointer; transition: transform 0.2s; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .panel-action-group button:hover { transform: translateY(-2px); }
    
    .admin-tabs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; background: white; padding: 15px; border-radius: 16px; border: 1px solid var(--border); }
    .tab-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px 5px; font-size: 10px; text-align: center; background: #f1f5f9; border: 1px solid transparent; border-radius: 10px; color: var(--text); cursor: pointer; transition: all 0.2s; height: 70px; font-weight: 600; }
    .tab-btn i { font-size: 20px; margin-bottom: 6px; font-style: normal; display: block; }
    .tab-btn.active { background: var(--blue); color: white; box-shadow: 0 4px 10px -2px rgba(37, 99, 235, 0.4); transform: scale(1.03); }
    
    .btn-main-action { padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px; color: white; }
    .hidden { display: none; }
    
    .izin-gun-pill { padding: 4px 6px; background: var(--bg); border-radius: 4px; margin: 2px; font-size: 9px; cursor: pointer; display: inline-block; font-weight: 700; border: 1px solid var(--border); }
    .izin-gun-pill.active { background: var(--danger); color: white; }
    .mcr-ayarlar { background: #f8fafc; border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-top: 10px; }
    .swap-container { border: 2px solid var(--blue); border-radius: 12px; padding: 15px; background: var(--saat3); margin-bottom: 15px; }
    .swap-header { font-weight: 800; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; font-size: 13px; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    .swap-row { margin-bottom: 10px; }
    .swap-label { display: block; font-size: 10px; font-weight: 700; margin-bottom: 3px; color: #64748b; }
    .swap-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: white; font-weight: 600; font-size: 11px; }
    .swap-days { display: flex; gap: 10px; margin-top: 10px; justify-content: space-between; }
    .swap-day-item { display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; }
    .admin-only { display: none; }
    
    .duyuru-bar { background: #fffbeb; color: #92400e; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #fcd34d; font-weight: 600; text-align: center; display: none; animation: fadeIn 0.5s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    /* YORGUNLUK UYARI BARI */
    .yorgunluk-bar { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; padding: 10px; margin-bottom: 15px; border-radius: 8px; font-weight: 700; text-align: center; display: none; animation: fadeIn 0.5s; }
    
    .log-item { font-size: 10px; padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .log-item:last-child { border-bottom: none; }
    .log-time { color: #999; font-size: 9px; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
    
    body.focus-active .birim-card { opacity: 0.1; }
    body.focus-active .birim-card.focused { opacity: 1; transform: scale(1.02); box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10; border: 2px solid var(--blue); }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    #mobilPersonelPanel { display: none; }
    @media screen and (max-width: 768px) { 
        #mobilPersonelPanel { display: block !important; }
        .table-container { display: none; } 
        #btnBeniBul, #btnPdf, .admin-only { display: none !important; } 
        .modern-shift-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; transition: transform 0.1s; }
        .modern-shift-card:active { transform: scale(0.98); }
        .m-date-group { display: flex; flex-direction: column; gap: 2px; }
        .m-day-name { font-size: 15px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .m-date-text { font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; }
        .m-shift-badge { padding: 8px 14px; border-radius: 12px; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .side-panel { width: 100%; right: -100%; }
        .main-header { flex-direction: column; text-align: center; gap: 10px;}
        .main-header div { width: 100%; justify-content: center; }
        .btn-main-action { width: 100%; padding: 14px; margin-bottom: 5px; font-size: 12px;}
        .admin-tabs { grid-template-columns: repeat(3, 1fr); }
    }  
  </style>
</head>
<body>
  <div id="loginOverlay"><div class="login-card"><img src="logo.png" alt="Logo" class="login-logo" onerror="this.style.display='none'"><h2 style="margin:0 0 20px 0; color:var(--primary)">Sistem GiriÅŸi</h2><button onclick="enterSystem('personel')" class="login-btn btn-user">ğŸ‘¤ PERSONEL GÄ°RÄ°ÅÄ°</button><button onclick="enterSystem('admin')" class="login-btn btn-admin">âš™ï¸ YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ°</button><p style="font-size: 10px; color: #64748b; margin-top: 20px;">TURKMEDYA TEKNÄ°K V61</p></div></div>
  
  <div id="talepModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10001; display:none; align-items:center; justify-content:center;">
    <div class="login-card" style="width: 320px; border: 2px solid var(--blue);">
        <h3 style="margin-top:0; color:var(--primary)">Vardiya / Ä°zin Talebi</h3>
        <select id="talepPersonel" style="width:100%; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border);"></select>
        <label style="display:block; text-align:left; font-size:10px; margin-bottom:5px; font-weight:bold; color:var(--text)">TARÄ°H SEÃ‡Ä°N:</label>
        <input type="date" id="talepTarih" style="width:93%; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border); font-family:inherit;">
        <select id="talepTuru" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border);">
            <option value="Ä°ZÄ°NLÄ°">Ä°ZÄ°NLÄ° (Ä°zin Talebi)</option><option value="06:30â€“16:00">06:30â€“16:00</option><option value="09:00â€“18:00">09:00â€“18:00</option><option value="16:00â€“00:00">16:00â€“00:00</option><option value="00:00â€“07:00">00:00â€“07:00</option>
        </select>
        <button onclick="talepGonder()" class="btn-main-action" style="background:var(--success); width:100%; padding:12px;">TALEBÄ° GÃ–NDER</button>
        <button onclick="document.getElementById('talepModal').style.display='none'" style="background:none; border:none; color:var(--danger); margin-top:10px; cursor:pointer; font-weight:bold;">Ä°ptal</button>
    </div>
  </div>

  <div id="panelOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none;" onclick="toggleAdminPanel()"></div>
  
  <div class="app-wrapper" id="appMain">
    <div id="duyuruAlani" class="duyuru-bar no-print">ğŸ“¢ <span id="duyuruMetniSpan"></span></div>
    
    <div id="yorgunlukUyari" class="yorgunluk-bar no-print"></div>
    
    <header class="main-header no-print">
      <div style="display: flex; align-items: center; gap: 10px;"><img src="logo.png" alt="Logo" style="height: 35px;"><div><h1 style="margin:0; font-size:16px;">TEKNiK EKÄ°P Ã‡ALIÅMA LÄ°STESÄ° V61</h1><p id="tarihAraligi" style="margin:0; opacity:0.8; font-size:10px;"></p></div></div>
      <div style="display:flex; gap:5px; flex-wrap: wrap; justify-content: center;">
          <button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#475569">Â« Geri</button>
          <button onclick="buluttanYukle()" class="btn-main-action admin-only" style="background:#4285f4">ğŸ”„ BULUTTAN YÃœKLE</button>
          <button onclick="toggleTheme()" class="btn-main-action" style="background:#64748b" id="themeBtn">ğŸŒ™</button>
          <button onclick="odakModuAc()" class="btn-main-action" style="background:#8b5cf6" id="btnBeniBul">ğŸ¯ BENÄ° BUL</button>
          <button onclick="excelIndir()" class="btn-main-action admin-only" style="background:#16a34a">EXCEL</button>
          <button onclick="ulastirmaExcelIndir()" class="btn-main-action admin-only" style="background:#881337; border:1px solid #fff;">ğŸšŒ ULAÅTIRMA LÄ°STESÄ°</button>
          <button onclick="window.print()" class="btn-main-action" style="background:var(--blue)" id="btnPdf">PDF / YAZDIR</button>
          <button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#475569">Ä°leri Â»</button>
          <button onclick="toggleAdminPanel()" class="btn-main-action admin-only" style="background:var(--primary); border: 1px solid #475569;" id="adminSettingsBtn">âš™ AYARLAR</button>
          <button onclick="cikisYap()" class="btn-main-action admin-only" style="background:#dc2626; border: 1px solid #fff;">ğŸšª Ã‡IKIÅ</button>
      </div>
    </header>
    
    <div id="mobilPersonelPanel" class="no-print" style="background:white; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border);">
        <h3 style="margin:0 0 10px 0; color:var(--primary); font-size:14px;">ğŸ“… KiÅŸisel Vardiya ProgramÄ±m</h3>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <select id="mobilPersonelSecim" onchange="kisiselProgramiGoster()" style="flex:1; padding:12px; border-radius:8px; border:1px solid var(--border); font-weight:bold; background:#f8fafc; color:var(--primary); font-size:14px;">
                <option value="">Ä°sminizi SeÃ§iniz...</option>
            </select>
            <button onclick="mobilVerileriYenile()" class="btn-main-action" style="background:var(--blue); width:auto; padding:0 15px; border-radius:8px;" title="Listeyi Yenile">ğŸ”„</button>
        </div>
        <div id="kisiselListeSonuc">
            <div style="text-align:center; padding:30px; color:#94a3b8; font-size:13px;">
                <div style="font-size:30px; margin-bottom:10px;">ğŸ‘‹</div>
                Listenizi gÃ¶rmek iÃ§in yukarÄ±dan isminizi seÃ§in.<br>Liste boÅŸsa ğŸ”„ butonuna basÄ±n.
            </div>
        </div>
    </div>

    <div id="persTalepArea" style="text-align:center; display:none;" class="no-print"><button onclick="talepModalAc()" class="btn-main-action" style="background:var(--warning); margin: 0 auto 15px auto; width: 100%; color: #1e293b; font-weight: 800; border: 2px solid #1e293b; padding:15px;">ğŸ“ VARDÄ°YA / Ä°ZÄ°N TALEBÄ° OLUÅTUR</button></div>
    <main class="table-container"><table id="vardiyaTablosu"><thead id="tableHeader"></thead><tbody id="tableBody"></tbody><tfoot id="tableFooter"></tfoot></table></main>
  </div>

  <div id="sidePanel" class="side-panel no-print">
    <div class="panel-header"><h2 style="margin:0;">YÃ¶netim Paneli</h2><button onclick="toggleAdminPanel()" style="background:none; border:none; color:var(--primary); font-size:24px; cursor:pointer;">&times;</button></div>
    <div class="panel-content">
        <div class="panel-action-group">
            <button onclick="vardiyaUretVeKaydet()" style="background:var(--success);">âœ¨<br>OTO VARDÄ°YA</button>
            <button onclick="bulutaKaydet()" style="background:#ea4335;">â˜ï¸<br>KAYDET</button>
            <button onclick="whatsappGonder()" style="background:#25D366;">ğŸŸ¢<br>WHATSAPP</button>
        </div>

        <div class="admin-tabs">
            <button id="btn-tab-personel" class="tab-btn active" onclick="tabDegistir('personel')"><i>ğŸ‘¥</i>Personel</button>
            <button id="btn-tab-talepler" class="tab-btn" onclick="tabDegistir('talepler')"><i>ğŸ“©</i>Talepler</button>
            <button id="btn-tab-degisim" class="tab-btn" onclick="tabDegistir('degisim')"><i>âš¡</i>DeÄŸiÅŸim</button>
            
            <button id="btn-tab-yillik" class="tab-btn" onclick="tabDegistir('yillik')"><i>ğŸ–ï¸</i>YÄ±llÄ±k</button>
            <button id="btn-tab-istatistik" class="tab-btn" onclick="tabDegistir('istatistik')"><i>ğŸ“Š</i>Analiz</button>
            <button id="btn-tab-loglar" class="tab-btn" onclick="tabDegistir('loglar')"><i>ğŸ•µï¸</i>Loglar</button>
            
            <button id="btn-tab-birimler" class="tab-btn" onclick="tabDegistir('birimler')"><i>ğŸ¢</i>Birimler</button>
            <button id="btn-tab-saatler" class="tab-btn" onclick="tabDegistir('saatler')"><i>â°</i>Saatler</button>
            <button id="btn-tab-sabitle" class="tab-btn" onclick="tabDegistir('sabitle')"><i>ğŸ”’</i>Sabitler</button>
            
            <button id="btn-tab-kapasite" class="tab-btn" onclick="tabDegistir('kapasite')"><i>ğŸ”¢</i>Kapasite</button>
            <button id="btn-tab-sistem" class="tab-btn" onclick="tabDegistir('sistem')"><i>âš™ï¸</i>Sistem</button>
        </div>
        
        <div id="tab-personel" class="tab-content"><div style="background:white; padding:15px; border-radius:12px; border:1px solid var(--border); box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:15px;"><input type="text" id="yeniPersInp" placeholder="Ad Soyad Giriniz" style="width:92%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border);"><select id="yeniPersBirimSec" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border);"></select><button onclick="personelEkle()" class="btn-main-action" style="width:100%; background:var(--success); padding:12px;">+ YENÄ° PERSONEL EKLE</button></div><div id="persListesiAdmin"></div></div>
        
        <div id="tab-birimler" class="tab-content hidden"><div id="birimListesiAdmin"></div></div>
        <div id="tab-saatler" class="tab-content hidden"><div id="saatListesiAdmin"></div></div>
        <div id="tab-sabitle" class="tab-content hidden"><div id="sabitListeAdmin"></div></div>
        <div id="tab-kapasite" class="tab-content hidden"><div id="kapasiteTable"></div></div>
        <div id="tab-degisim" class="tab-content hidden">
            <div class="swap-container"><div class="swap-header">âš¡ PERSONEL DEÄÄ°ÅÄ°MÄ° / SWAP</div><div class="swap-row"><label class="swap-label">MEVCUT BÄ°RÄ°MÄ° KULLANILACAK OLAN (AYRILAN):</label><select id="swapKaynakPersonel" class="swap-select"><option>SeÃ§iniz...</option></select></div><div class="swap-row"><label class="swap-label">â¬‡ï¸ YERÄ°NE GEÃ‡ECEK (Ä°ZÄ°NCÄ° KÄ°ÅÄ°) â¬‡ï¸</label><select id="swapHedefPersonel" class="swap-select"><option>SeÃ§iniz...</option></select></div><div class="swap-row"><label class="swap-label">HANGÄ° GÃœNLER?</label><div class="swap-days"><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="0"> Pzt</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="1"> Sal</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="2"> Ã‡ar</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="3"> Per</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="4"> Cum</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="5"> Cmt</label><label class="swap-day-item"><input type="checkbox" class="swap-day-cb" value="6"> Paz</label></div></div><button onclick="degisimiUygula()" class="btn-main-action" style="background:var(--blue); width:100%; padding:12px; margin-top:10px;">DEÄÄ°ÅÄ°MÄ° UYGULA</button></div>
            <div id="aktifDegisimlerListesi" style="margin-top:20px;"></div><button onclick="tumDegisimleriTemizle()" class="btn-main-action" style="background:var(--danger); width:100%; margin-top:20px;">ğŸ—‘ï¸ TÃœM DEÄÄ°ÅÄ°MLERÄ° SÄ°L</button>
        </div>
        <div id="tab-yillik" class="tab-content hidden"><div class="swap-container" style="border-color:#9333ea; background:#f3e8ff;"><div class="swap-header" style="color:#9333ea;">ğŸ–ï¸ TOPLU YILLIK Ä°ZÄ°N Ä°ÅLEME</div><div class="swap-row"><label class="swap-label">PERSONEL SEÃ‡Ä°N:</label><select id="yillikIzinPersonel" class="swap-select"><option>SeÃ§iniz...</option></select></div><div class="swap-row" style="display:flex; gap:10px;"><div style="flex:1;"><label class="swap-label">BAÅLANGIÃ‡:</label><input type="date" id="yillikBaslangic" class="swap-select"></div><div style="flex:1;"><label class="swap-label">BÄ°TÄ°Å (Dahil):</label><input type="date" id="yillikBitis" class="swap-select"></div></div><button onclick="yillikIzinIsle()" class="btn-main-action" style="background:#9333ea; width:100%; padding:12px; margin-top:10px;">Ä°ZÄ°NLERÄ° Ä°ÅLE</button><div style="margin-top:10px; font-size:10px; color:#666; text-align:center;">* SeÃ§ilen tarih aralÄ±ÄŸÄ±na "YILLIK Ä°ZÄ°N" yazÄ±lacak ve sistem gerektiÄŸinde yerine baÅŸkasÄ±nÄ± atayacaktÄ±r.</div></div></div>
        
        <div id="tab-loglar" class="tab-content hidden">
            <h3 style="margin-top:0; font-size:14px; color:var(--primary);">Son Ä°ÅŸlem KayÄ±tlarÄ±</h3>
            <div id="logListesi" style="max-height:400px; overflow-y:auto; background:white; padding:10px; border-radius:8px; border:1px solid #ccc;"></div>
            <button onclick="loglariTemizle()" style="margin-top:10px; font-size:10px; color:red; border:none; background:none; cursor:pointer;">LoglarÄ± Temizle</button>
        </div>
        
        <div id="tab-istatistik" class="tab-content hidden">
            <h3 style="margin-top:0; font-size:14px; color:var(--primary);">Bu Hafta Ã‡alÄ±ÅŸma Analizi</h3>
            <div id="istatistikListesi" style="max-height:400px; overflow-y:auto; background:white; padding:10px; border-radius:8px; border:1px solid #ccc;"></div>
        </div>
        
        <div id="tab-sistem" class="tab-content hidden">
            <div style="margin-bottom:15px; border:1px solid #fcd34d; padding:10px; border-radius:8px; background:#fffbeb;">
                <strong>ğŸ“¢ Sistem Duyurusu:</strong>
                <textarea id="adminDuyuruInp" style="width:96%; height:50px; margin-top:5px; border-radius:4px; border:1px solid #ccc; padding:5px;" placeholder="Buraya yazÄ±lanlar ana sayfada bant olarak geÃ§er..."></textarea>
                <button onclick="duyuruGuncelle()" class="btn-main-action" style="width:100%; background:#f59e0b; color:black; margin-top:5px;">DUYURUYU YAYINLA / GÄ°ZLE</button>
            </div>
            
            <div style="margin-bottom:15px; border:1px solid #22c55e; padding:10px; border-radius:8px; background:#f0fdf4;">
                <strong>ğŸ“Š DÄ±ÅŸarÄ±dan Liste YÃ¼kle (UlaÅŸtÄ±rma Tipi):</strong>
                <div style="font-size:10px; color:#666; margin-bottom:5px;">
                    Format: A SÃ¼tunu=Saatler (09:00, Ä°ZÄ°N vb.), HÃ¼creler=Ä°simler
                </div>
                <input type="file" id="excelUploadInput" accept=".xlsx, .xls" style="width:100%; margin-bottom:5px;">
                <button onclick="exceldenVardiyaYukle()" class="btn-main-action" style="width:100%; background:#15803d;">LÄ°STEYÄ° SÄ°STEME Ä°ÅLE</button>
            </div>
            
            <button onclick="jsonYedekAl()" class="btn-main-action" style="width:100%; background:var(--blue); margin-bottom:10px;">ğŸ’¾ JSON Ä°NDÄ°R</button>
            <input type="file" id="jsonInput" style="display:none" onchange="handleFileSelect(this)"><button onclick="githubdanYedekYukle()" class="btn-main-action" style="width:100%; background:#000; color:#fff; margin-bottom:10px;">ğŸ“‚ GITHUB'DAN YÃœKLE</button><button onclick="vardiyaSifirla()" class="btn-main-action" style="width:100%; background:var(--warning); margin-bottom:10px;">Bu HaftayÄ± Temizle</button><button onclick="tamSifirla()" class="btn-main-action" style="width:100%; background:var(--danger); margin-bottom:10px;">TÃ¼m HafÄ±zayÄ± Sil</button>
            <button onclick="arsivleVeTemizle()" class="btn-main-action" style="width:100%; background:#7c3aed; color:white; border:1px solid white;">ğŸ—‘ï¸ ESKÄ° VERÄ°LERÄ° TEMÄ°ZLE (ARÅÄ°V)</button>
        </div>
        <div id="tab-talepler" class="tab-content hidden"><div id="gelenTaleplerListesi" style="max-height: 400px; overflow-y: auto;"></div></div>
  </div>
  <script>
    const SHIFTS = {
        SABAH: "06:30â€“16:00",
        GUNDUZ: "09:00â€“18:00",
        AKSAM: "16:00â€“00:00",
        GECE: "00:00â€“07:00",
        IZIN: "Ä°ZÄ°NLÄ°",
        BOS: "BOÅ",
        YILLIK: "YILLIK Ä°ZÄ°N"
    };

    const UNITS = {
        YONETMEN: "TEKNÄ°K YÃ–NETMEN",
        SES: "SES OPERATÃ–RÃœ",
        KJ: "KJ OPERATÃ–RÃœ",
        PLAYOUT: "PLAYOUT OPERATÃ–RÃœ",
        REJI: "REJÄ°",
        MCR24: "24TV MCR OPERATÃ–RÃœ",
        MCR360: "360TV MCR OPERATÃ–RÃœ",
        INGEST: "INGEST OPERATÃ–RÃœ"
    };

    let TELEGRAM_API = "8509542541:AAFu-iDK85iELZQmImCWSZRi3_eWzUyyCiM"; 
    let TELEGRAM_ID = "859235247";
    const firebaseConfig = { apiKey: "AIzaSyBY8dA7IQ0vcdjtG0haRVFuF0vTgZACU0M", authDomain: "teknik-vardiya-listesi.firebaseapp.com", databaseURL: "https://teknik-vardiya-listesi-default-rtdb.europe-west1.firebasedatabase.app", projectId: "teknik-vardiya-listesi", storageBucket: "teknik-vardiya-listesi.firebasestorage.app", messagingSenderId: "900931844150", appId: "1:900931844150:web:41c799492e85d62df8c097" };
    firebase.initializeApp(firebaseConfig); const database = firebase.database();
    const GUNLER = ["Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt", "Paz"]; const PREFIX = ""; const PANEL_SIFRE = "6161"; 
    const BIRIM_RENKLERI = { [UNITS.YONETMEN]: "#2563eb", [UNITS.SES]: "#7c3aed", [UNITS.KJ]: "#db2777", [UNITS.PLAYOUT]: "#059669", [UNITS.REJI]: "#d97706", [UNITS.MCR24]: "#9333ea", [UNITS.MCR360]: "#9333ea", [UNITS.INGEST]: "#06b6d4" };
    let isAdmin = false;
    
    let state = { 
        birimler: JSON.parse(localStorage.getItem(PREFIX + "birimler")) || Object.values(UNITS), 
        saatler: JSON.parse(localStorage.getItem(PREFIX + "saatler")) || Object.values(SHIFTS).filter(s => s.includes(":")), 
        personeller: JSON.parse(localStorage.getItem(PREFIX + "personeller")) || [], 
        kapasite: JSON.parse(localStorage.getItem(PREFIX + "kapasite")) || {}, 
        manuelAtamalar: JSON.parse(localStorage.getItem(PREFIX + "manuelAtamalar")) || {}, 
        haftaIciSabitler: JSON.parse(localStorage.getItem(PREFIX + "haftaIciSabitler")) || {}, 
        mcrAyarlari: JSON.parse(localStorage.getItem(PREFIX + "mcrAyarlari")) || { baslangicTarihi: new Date().toISOString().split('T')[0], ofsetler: {} }, 
        geciciGorevler: JSON.parse(localStorage.getItem(PREFIX + "geciciGorevler")) || {},
        logs: JSON.parse(localStorage.getItem(PREFIX + "logs")) || [],
        duyuruMetni: JSON.parse(localStorage.getItem(PREFIX + "duyuruMetni")) || "",
        birimAyarlari: JSON.parse(localStorage.getItem(PREFIX + "birimAyarlari")) || {}
    };
    
    // GÃœVENLÄ° VE YEREL TARÄ°H FONKSÄ°YONU
    function getDateKey(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    let currentMonday = getMonday(new Date());

    async function hassasAyarlariYukle() { try { const snap = await database.ref('config').once('value'); if (snap.exists()) { const config = snap.val(); if(config.telegram_api) TELEGRAM_API = config.telegram_api; if(config.telegram_id) TELEGRAM_ID = config.telegram_id; } } catch (error) { console.error(error); } }
    
    /* --- YENÄ° EKLENEN GÃœVENLÄ°K VE GÃ–Ã‡ FONKSÄ°YONU --- */
    function verileriGuvenliHaleGetir() {
        if(!state) state = {};
        if(!state.manuelAtamalar) state.manuelAtamalar = {};
        if(!state.geciciGorevler) state.geciciGorevler = {};
        if(!state.personeller) state.personeller = [];
        if(!state.kapasite) state.kapasite = {};
        if(!state.haftaIciSabitler) state.haftaIciSabitler = {};
        if(!state.mcrAyarlari) state.mcrAyarlari = { baslangicTarihi: new Date().toISOString().split('T')[0], ofsetler: {} };
        if(!state.birimler) state.birimler = Object.values(UNITS);
        if(!state.saatler) state.saatler = Object.values(SHIFTS).filter(s => s.includes(":"));
        
        // YENÄ°: Otomatik Migration (Eski birimleri tanÄ±)
        if(!state.birimAyarlari || Object.keys(state.birimAyarlari).length === 0) {
            state.birimAyarlari = {};
            state.birimler.forEach(b => {
                let tip = "HAVUZ";
                let renk = BIRIM_RENKLERI[b] || "#64748b";
                if(b.includes("MCR")) tip = "DONGU8"; 
                if(b.includes("INGEST")) tip = "DONGU6"; 
                if(b === UNITS.PLAYOUT || b === UNITS.SES || b === UNITS.KJ) tip = "GRUP_ABC"; // Otomatik TanÄ±ma
                state.birimAyarlari[b] = { tip: tip, renk: renk };
            });
        }
    }

    async function enterSystem(role) { 
        if (role === 'admin') { 
            const email = prompt("YÃ¶netici E-posta:"); const password = prompt("YÃ¶netici Åifresi:"); 
            if (!email || !password) return; 
            try { 
                await firebase.auth().signInWithEmailAndPassword(email, password); 
                isAdmin = true; 
                await hassasAyarlariYukle(); 
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex'); 
                document.getElementById('persTalepArea').style.display = 'none'; 
                checkUrlActions(); 
                alert("YÃ¶netici giriÅŸi baÅŸarÄ±lÄ±!"); 
            } catch (error) { 
                alert("HatalÄ± giriÅŸ: " + error.message); 
                return; 
            } 
        } else { 
            isAdmin = false; 
            try {
                 const snap = await database.ref('vardiya_data').once('value');
                 if(snap.exists()) { 
                     state = snap.val(); 
                     verileriGuvenliHaleGetir(); 
                     save(); 
                 }
            } catch(e) { console.log("Veri Ã§ekilemedi: " + e.message); }

            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none'); 
            document.getElementById('persTalepArea').style.display = 'block'; 
        } 
        
        document.getElementById('loginOverlay').style.opacity = '0'; 
        setTimeout(() => { 
            document.getElementById('loginOverlay').style.display = 'none'; 
            document.getElementById('appMain').style.display = 'block'; 
            tabloyuOlustur(); 
        }, 500); 
    }
    
    function checkUrlActions() { const urlParams = new URLSearchParams(window.location.search); const action = urlParams.get('action'); const talepId = urlParams.get('id'); if((action === 'onay' || action === 'red') && talepId) { talepIslem(talepId, action); window.history.replaceState({}, document.title, window.location.pathname); } }
    function talepModalAc() { const sel = document.getElementById('talepPersonel'); sel.innerHTML = state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join(''); document.getElementById('talepModal').style.display = 'flex'; }
    function talepGonder() { const ad = document.getElementById('talepPersonel').value; const tarih = document.getElementById('talepTarih').value; const tur = document.getElementById('talepTuru').value; if(!tarih) { alert("LÃ¼tfen tarih seÃ§in!"); return; } const secilenTarih = new Date(tarih); const pzt = getMonday(secilenTarih); const hKey = getDateKey(pzt); const gunIdx = (secilenTarih.getDay() + 6) % 7; const talepId = Date.now().toString(); database.ref('talepler/' + talepId).set({ id: talepId, ad, tarih, gunIdx, tur, hKey, durum: "bekliyor" }); const appUrl = window.location.href.split('?')[0]; fetch(`https://api.telegram.org/bot${TELEGRAM_API}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: TELEGRAM_ID, text: `ğŸ”” *YENÄ° VARDÄ°YA TALEBÄ°*\n\nğŸ‘¤ *Personel:* ${ad}\nğŸ“… *Tarih:* ${tarih}\nğŸ“ *Vardiya:* ${tur}`, parse_mode: 'Markdown', reply_markup: { inline_keyboard: [[{ text: "âœ… SÄ°TEYE GÄ°T VE ONAYLA", url: `${appUrl}?action=onay&id=${talepId}` }, { text: "âŒ SÄ°TEYE GÄ°T VE REDDET", url: `${appUrl}?action=red&id=${talepId}` }]] } }) }); alert("Talebiniz yÃ¶neticiye iletildi."); document.getElementById('talepModal').style.display = 'none'; }
    function talepleriYukle() { database.ref('talepler').orderByChild('durum').equalTo('bekliyor').on('value', snap => { const liste = document.getElementById('gelenTaleplerListesi'); if(!snap.exists()) { liste.innerHTML = "<p style='text-align:center; padding:20px; opacity:0.5;'>Bekleyen talep bulunmuyor.</p>"; return; } let html = ""; snap.forEach(item => { const t = item.val(); html += `<div style="background:var(--card-bg); border:1px solid var(--border); border-left:5px solid var(--warning); padding:12px; border-radius:8px; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,0.05);"><div style="font-weight:800; color:var(--primary); font-size:12px; margin-bottom:4px;">${t.ad}</div><div style="font-size:11px; margin-bottom:8px;">ğŸ“… ${t.tarih} (Hafta: ${t.hKey})<br>ğŸ“ Ä°stek: <b>${t.tur}</b></div><div style="display:flex; gap:8px;"><button onclick="talepIslem('${t.id}', 'onay')" style="flex:1; background:var(--success); color:white; border:none; border-radius:6px; padding:8px; cursor:pointer; font-weight:700; font-size:10px;">ONAYLA</button><button onclick="talepIslem('${t.id}', 'red')" style="flex:1; background:var(--danger); color:white; border:none; border-radius:6px; padding:8px; cursor:pointer; font-weight:700; font-size:10px;">REDDET</button></div></div>`; }); liste.innerHTML = html; }); }
    function talepIslem(id, tip) { database.ref('talepler/' + id).once('value', snap => { if(!snap.exists()) return; const t = snap.val(); if(tip === 'onay') { const mKey = `${t.hKey}_${t.ad}_${t.gunIdx}`; state.manuelAtamalar[mKey] = t.tur; save(); currentMonday = new Date(t.hKey); tabloyuOlustur(); database.ref('talepler/' + id).update({ durum: 'onaylandi' }); alert(`âœ… ${t.ad} iÃ§in ${t.tarih} talebi ONAYLANDI.\n\nTakvim ilgili haftaya (${t.hKey}) kaydÄ±rÄ±ldÄ±.`); logKoy(`${t.ad} iÃ§in talep onaylandÄ±: ${t.tur}`); } else { database.ref('talepler/' + id).update({ durum: 'reddedildi' }); alert("Talep reddedildi."); logKoy(`${t.ad} iÃ§in talep reddedildi.`); } }); }
    function getMonday(d) { d = new Date(d); let day = d.getDay(); return new Date(d.setDate(d.getDate() - day + (day == 0 ? -6 : 1))); }
    function save() { Object.keys(state).forEach(k => localStorage.setItem(PREFIX + k, JSON.stringify(state[k]))); }
    function getBirimColor(birim) { 
        if(state.birimAyarlari && state.birimAyarlari[birim]) return state.birimAyarlari[birim].renk;
        return BIRIM_RENKLERI[birim] || "#64748b"; 
    }
    function getGecerliBirim(p, g) { let d = new Date(currentMonday); d.setDate(d.getDate() + g); const dateKey = getDateKey(d); const key = `${dateKey}_${p.ad}`; return state.geciciGorevler[key] || p.birim; }
    
    function logKoy(mesaj) {
        if(!state.logs) state.logs = [];
        const zaman = new Date().toLocaleString('tr-TR');
        const user = firebase.auth().currentUser ? firebase.auth().currentUser.email : "Anonim";
        state.logs.unshift({zaman, user, mesaj});
        if(state.logs.length > 200) state.logs.pop(); 
        save();
        refreshUI();
    }
    
    function tabloyuOlustur() { 
        if(state.duyuruMetni) {
            document.getElementById('duyuruAlani').style.display = 'block';
            document.getElementById('duyuruMetniSpan').innerText = state.duyuruMetni;
        } else {
            document.getElementById('duyuruAlani').style.display = 'none';
        }

        const hKey = getDateKey(currentMonday); document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} HaftasÄ±`; document.getElementById("tableHeader").innerHTML = `<tr><th style="width:100px;">SAAT</th>${GUNLER.map((g, i) => { let d = new Date(currentMonday); d.setDate(d.getDate() + i); let dateStr = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }); return `<th class="${i>=5?'weekend-col':''}">${g}<div style="font-size:9px; opacity:0.7; font-weight:normal;">${dateStr}</div></th>`; }).join('')}</tr>`;
        let prog = {}; let calis = {}; state.personeller.forEach(p => { prog[p.ad] = Array(7).fill(null); calis[p.ad] = 0; for(let i=0; i<7; i++) { let mKey = `${hKey}_${p.ad}_${i}`; if(state.manuelAtamalar[mKey]) prog[p.ad][i] = state.manuelAtamalar[mKey]; if(prog[p.ad][i] && ![SHIFTS.IZIN,SHIFTS.BOS,null,SHIFTS.YILLIK].includes(prog[p.ad][i])) calis[p.ad]++; } });
        document.getElementById("tableBody").innerHTML = state.saatler.map((s, sIdx) => { let rowHtml = `<tr class="row-saat-${sIdx}"><td class="saat-col">${s}</td>`; for(let g=0; g<7; g++) { let sortedPers = state.personeller.filter(p => prog[p.ad][g] === s).sort((a, b) => { let birimA = getGecerliBirim(a, g); let birimB = getGecerliBirim(b, g); return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB); }); let cellContent = ""; let lastBirim = ""; sortedPers.forEach((p) => { let gecerliBirim = getGecerliBirim(p, g); let ayiriciClass = (lastBirim !== "" && lastBirim !== gecerliBirim) ? "birim-ayirici" : ""; let clickAttr = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : ""; let dragAttr = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, '${s}')"` : ""; cellContent += `<div class="birim-card ${ayiriciClass}" style="border-left-color:${getBirimColor(gecerliBirim)}; background-color:${getBirimColor(gecerliBirim)}15;" ${dragAttr} ${clickAttr}><span class="birim-tag" style="background:${getBirimColor(gecerliBirim)}">${gecerliBirim}</span><span class="pers-name">${p.ad}</span></div>`; lastBirim = gecerliBirim; }); rowHtml += `<td class="${g>=5?'weekend-col':''}" data-label="${GUNLER[g]}" ondragover="event.preventDefault()" ondrop="drop(event, '${s}', ${g})">${cellContent}</td>`; } return rowHtml + "</tr>"; }).join('');
        document.getElementById("tableFooter").innerHTML = `<tr class="row-izin"><td class="saat-col">Ä°ZÄ°N / BOÅ</td>${[0,1,2,3,4,5,6].map(g => { let sortedPers = state.personeller.filter(p => [SHIFTS.IZIN,SHIFTS.BOS,null,SHIFTS.YILLIK].includes(prog[p.ad][g])).sort((a, b) => { let birimA = getGecerliBirim(a, g); let birimB = getGecerliBirim(b, g); return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB); }); let cellContent = ""; let lastBirim = ""; sortedPers.forEach(p => { let gecerliBirim = getGecerliBirim(p, g); let ayiriciClass = (lastBirim !== "" && lastBirim !== gecerliBirim) ? "birim-ayirici" : ""; let clickAttr = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : ""; let dragAttr = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, 'BOÅ')"` : ""; let isYillik = prog[p.ad][g] === SHIFTS.YILLIK; let bgStyle = isYillik ? 'background:var(--yillik-izin)' : (prog[p.ad][g]===SHIFTS.IZIN?'background:var(--danger)':`background:${getBirimColor(gecerliBirim)}`); let countStyle = calis[p.ad] >= 6 ? 'color:red; font-weight:bold; font-size:11px;' : ''; cellContent += `<div class="birim-card ${ayiriciClass}" style="border-left-color:${getBirimColor(gecerliBirim)};" ${dragAttr} ${clickAttr}><span class="birim-tag" style="${bgStyle}">${prog[p.ad][g] || 'BOÅ'}</span><span class="pers-name">${p.ad} <span style="${countStyle}">(${calis[p.ad]}G)</span></span></div>`; lastBirim = gecerliBirim; }); return `<td class="${g>=5?'weekend-col':''}" data-label="${GUNLER[g]}" ondragover="event.preventDefault()" ondrop="drop(event, 'BOÅ', ${g})">${cellContent}</td>`; }).join('')}</tr>`;
        
        // YENÄ°: YORGUNLUK KONTROLÃœ (6-7 GÃœN UYARISI)
        let yorgunlar = [];
        state.personeller.forEach(p => {
            if(calis[p.ad] >= 6) {
                yorgunlar.push(`<b>${p.ad}</b> (${calis[p.ad]} GÃ¼n)`);
            }
        });
        
        const uyariDiv = document.getElementById('yorgunlukUyari');
        if(yorgunlar.length > 0) {
            uyariDiv.innerHTML = "âš ï¸ DÄ°KKAT (6-7 GÃ¼n Ã‡alÄ±ÅŸanlar): " + yorgunlar.join(", ");
            uyariDiv.style.display = 'block';
        } else {
            uyariDiv.style.display = 'none';
        }

        istatistikleriHesapla();
        mobilListeyiGuncelle();
    }
    
    function cakismaKontrol(personelAd, hedefGun, hedefSaat) { const hKey = getDateKey(currentMonday); if ([SHIFTS.IZIN, SHIFTS.BOS, null, SHIFTS.YILLIK].includes(hedefSaat)) return; if (hedefGun > 0) { let dunKey = `${hKey}_${personelAd}_${hedefGun - 1}`; let dunVardiya = state.manuelAtamalar[dunKey]; let sabahVardiyalari = [SHIFTS.SABAH, SHIFTS.GUNDUZ]; let aksamVardiyalari = [SHIFTS.AKSAM, SHIFTS.GECE]; if (aksamVardiyalari.includes(dunVardiya) && sabahVardiyalari.includes(hedefSaat)) alert(`âš ï¸ DÄ°KKAT: ${personelAd} dÃ¼n AKÅAM/GECE vardiyasÄ±ndaydÄ±. BugÃ¼n SABAH vardiyasÄ±na yazÄ±yorsunuz. Dinlenme sÃ¼resi yetersiz olabilir!`); } if (hedefGun < 6) { let yarinKey = `${hKey}_${personelAd}_${hedefGun + 1}`; let yarinVardiya = state.manuelAtamalar[yarinKey]; let sabahVardiyalari = [SHIFTS.SABAH, SHIFTS.GUNDUZ]; let aksamVardiyalari = [SHIFTS.AKSAM, SHIFTS.GECE]; if (aksamVardiyalari.includes(hedefSaat) && sabahVardiyalari.includes(yarinVardiya)) alert(`âš ï¸ DÄ°KKAT: ${personelAd} yarÄ±n SABAH vardiyasÄ±nda gÃ¶rÃ¼nÃ¼yor. BugÃ¼n AKÅAM/GECE vardiyasÄ±na yazÄ±yorsunuz. Dinlenme sÃ¼resi yetersiz olabilir!`); } }
    function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }
    function seededShuffle(array, seed) { let hash = 0; for (let i = 0; i < seed.length; i++) hash = Math.imul(31, hash) + seed.charCodeAt(i) | 0; let rng = mulberry32(hash); let m = array.length, t, i; while (m) { i = Math.floor(rng() * m--); t = array[m]; array[m] = array[i]; array[i] = t; } return array; }
    function yillikIzinIsle() { const pAd = document.getElementById('yillikIzinPersonel').value; const basTarih = document.getElementById('yillikBaslangic').value; const bitTarih = document.getElementById('yillikBitis').value; if(!pAd || !basTarih || !bitTarih) { alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun."); return; } let current = new Date(basTarih); let end = new Date(bitTarih); while(current <= end) { const hKey = getDateKey(getMonday(current)); let jsDay = current.getDay(); let gunIdx = (jsDay + 6) % 7; const mKey = `${hKey}_${pAd}_${gunIdx}`; state.manuelAtamalar[mKey] = SHIFTS.YILLIK; current.setDate(current.getDate() + 1); } save(); tabloyuOlustur(); alert(`${pAd} iÃ§in yÄ±llÄ±k izin iÅŸlendi.`); logKoy(`${pAd} iÃ§in YILLIK Ä°ZÄ°N iÅŸlendi (${basTarih} - ${bitTarih})`); document.getElementById('yillikBaslangic').value = ""; document.getElementById('yillikBitis').value = ""; }
    
    function vardiyaUretVeKaydet() {
        if(!isAdmin) return;
        const hKey = getDateKey(currentMonday);
        const prevMonday = new Date(currentMonday); prevMonday.setDate(prevMonday.getDate() - 7);
        const prevHKey = getDateKey(prevMonday);
        let tempProg = {}; let calis = {};
        
        verileriGuvenliHaleGetir();

        // 1. Manuel AtamalarÄ± YÃ¼kle
        state.personeller.forEach(p => {
             tempProg[p.ad] = Array(7).fill(null);
             for(let g=0; g<7; g++) { let mKey = `${hKey}_${p.ad}_${g}`; if(state.manuelAtamalar[mKey]) tempProg[p.ad][g] = state.manuelAtamalar[mKey]; }
             if (state.haftaIciSabitler[p.ad]) { for(let i=0; i<5; i++) { if(!tempProg[p.ad][i]) tempProg[p.ad][i] = state.haftaIciSabitler[p.ad]; } if(!tempProg[p.ad][5]) tempProg[p.ad][5] = SHIFTS.IZIN; if(!tempProg[p.ad][6]) tempProg[p.ad][6] = SHIFTS.IZIN; }
             if(p.izinGunleri) { p.izinGunleri.forEach(gi => { if(!tempProg[p.ad][gi]) tempProg[p.ad][gi] = SHIFTS.IZIN; }); }
        });

        const safeAssign = (p, day, shift) => {
             if (tempProg[p.ad][day] !== null) return;
             if (shift === SHIFTS.IZIN) { tempProg[p.ad][day] = shift; return; }
             const cap = (state.kapasite[`${p.birim}_${shift}`] || [0,0,0,0,0,0,0])[day];
             let currentCount = 0;
             state.personeller.filter(x => x.birim === p.birim).forEach(x => { if(tempProg[x.ad][day] === shift) currentCount++; });
             if (currentCount < cap) tempProg[p.ad][day] = shift;
        };

        const mcrDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.GECE, SHIFTS.GECE, SHIFTS.IZIN, SHIFTS.IZIN];
        const ingestDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.IZIN, SHIFTS.IZIN];
        const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);

        // 2. DÄ°NAMÄ°K BÄ°RÄ°M MANTIÄI (MCR / INGEST / HAVUZ)
        state.personeller.forEach(p => { 
            const birimAyar = state.birimAyarlari[p.birim] || { tip: "HAVUZ" };
            
            // EÄŸer elle girilmiÅŸ bir kayÄ±t varsa, DÃ–NGÃœYÃœ Ã‡ALIÅTIRMA (KORUMA KALKANI)
            if (birimAyar.tip === "DONGU8" || birimAyar.tip === "DONGU6") {
                const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
                const loopArr = (birimAyar.tip === "DONGU8") ? mcrDongu : ingestDongu;
                const modVal = loopArr.length;

                for(let g=0; g<7; g++) {
                    if(tempProg[p.ad][g] !== null) continue; // ELLE GÄ°RÄ°LEN VARSA DOKUNMA!
                    
                    let d = new Date(currentMonday); d.setDate(d.getDate() + g);
                    const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
                    tempProg[p.ad][g] = loopArr[((diffDays + persOfset) % modVal + modVal) % modVal];
                }
            }
        });

        // 3. GRUP_ABC MANTIÄI (Playout/Ses/KJ Tipi) - DÄ°NAMÄ°KLEÅTÄ°RÄ°LDÄ°
        state.birimler.forEach(birim => {
            const ayar = state.birimAyarlari[birim] || { tip: "HAVUZ" };
            if (ayar.tip !== "GRUP_ABC") return;

            let personelListesi = state.personeller.filter(p => p.birim === birim);
            if (personelListesi.length === 0) return;
             
             let grupA = []; let grupB = []; let grupC = [];
             personelListesi.forEach((p, index) => {
                let gecenPzt = state.manuelAtamalar[`${prevHKey}_${p.ad}_0`];
                if (gecenPzt === SHIFTS.IZIN || gecenPzt === SHIFTS.BOS || !gecenPzt || gecenPzt === SHIFTS.YILLIK) { grupA.push(p); } 
                else if (gecenPzt === SHIFTS.SABAH || gecenPzt === SHIFTS.GUNDUZ) { grupB.push(p); } 
                else { grupC.push(p); }
            });
            if (grupA.length === 0 && grupB.length === 0 && grupC.length === 0) {
                personelListesi.forEach((p, i) => { if (i % 3 === 0) grupA.push(p); else if (i % 3 === 1) grupB.push(p); else grupC.push(p); });
            }
            grupA.forEach(p => { safeAssign(p, 0, SHIFTS.SABAH); safeAssign(p, 1, SHIFTS.AKSAM); safeAssign(p, 2, SHIFTS.AKSAM); safeAssign(p, 3, SHIFTS.IZIN); safeAssign(p, 4, SHIFTS.IZIN); safeAssign(p, 5, SHIFTS.SABAH); safeAssign(p, 6, SHIFTS.SABAH); });
            grupB.forEach(p => { safeAssign(p, 0, SHIFTS.AKSAM); safeAssign(p, 1, SHIFTS.IZIN); safeAssign(p, 2, SHIFTS.IZIN); safeAssign(p, 3, SHIFTS.SABAH); safeAssign(p, 4, SHIFTS.SABAH); safeAssign(p, 5, SHIFTS.AKSAM); safeAssign(p, 6, SHIFTS.AKSAM); });
            
            // GRUP C (Pazartesi Ä°zinliler)
            seededShuffle(grupC, hKey);
            grupC.forEach((p, index) => {
                // Hafta iÃ§i standart (Pzt Ä°zin, Sal-Ã‡ar Sabah, Per-Cum AkÅŸam)
                safeAssign(p, 0, SHIFTS.IZIN);
                safeAssign(p, 1, SHIFTS.SABAH);
                safeAssign(p, 2, SHIFTS.SABAH);
                safeAssign(p, 3, SHIFTS.AKSAM);
                safeAssign(p, 4, SHIFTS.AKSAM);

                // HAFTA SONU MAKASI + KAPASÄ°TE KONTROLÃœ
                if (index % 2 === 0) {
                    // 1. TÄ°P (NÃ¶betÃ§i): Cuma AkÅŸamdan Ã§Ä±ktÄ± -> Cmt AKÅAM devam eder -> Pazar Ä°ZÄ°N.
                    // Ama Ã¶nce Cmt AkÅŸam kapasitesi var mÄ± bak?
                    let cmtAksamCap = (state.kapasite[`${birim}_${SHIFTS.AKSAM}`] || [0,0,0,0,0,0,0])[5];
                    if(cmtAksamCap > 0) {
                         safeAssign(p, 5, SHIFTS.AKSAM);
                    } else {
                         safeAssign(p, 5, SHIFTS.IZIN);
                    }
                    safeAssign(p, 6, SHIFTS.IZIN);
                } else {
                    // 2. TÄ°P (DÃ¶nÃ¼ÅŸÃ¼mcÃ¼): Cuma AkÅŸamdan Ã§Ä±ktÄ± -> Cmt Ä°ZÄ°N -> Pazar SABAH (Pzt sabahÄ±na hazÄ±rlÄ±k).
                    safeAssign(p, 5, SHIFTS.IZIN);
                    // Pazar Sabah kapasitesi var mÄ± bak?
                    let pzSabahCap = (state.kapasite[`${birim}_${SHIFTS.SABAH}`] || [0,0,0,0,0,0,0])[6];
                    if(pzSabahCap > 0) {
                        safeAssign(p, 6, SHIFTS.SABAH);
                    } else {
                        safeAssign(p, 6, SHIFTS.IZIN);
                    }
                }
            });
        });

        // Ã‡alÄ±ÅŸma gÃ¼nlerini say
        state.personeller.forEach(p => { calis[p.ad] = 0; for(let g=0; g<7; g++) { if(tempProg[p.ad][g] && ![SHIFTS.IZIN,SHIFTS.BOS,null,SHIFTS.YILLIK].includes(tempProg[p.ad][g])) calis[p.ad]++; } });

        // EKSÄ°K KAPASÄ°TE TAMAMLAMA (YENÄ° EKLENTÄ°)
        // Sadece GRUP_ABC mantÄ±ÄŸÄ±yla yÃ¶netilen birimler iÃ§in eksikleri kontrol et ve doldur
        state.birimler.forEach(birim => {
            const ayar = state.birimAyarlari[birim] || { tip: "HAVUZ" };
            if (ayar.tip !== "GRUP_ABC") return;

            for (let gun = 0; gun < 7; gun++) {
                state.saatler.forEach(saat => {
                    if(saat === SHIFTS.IZIN) return;

                    const hedef = (state.kapasite[`${birim}_${saat}`] || [0,0,0,0,0,0,0])[gun];
                    let mevcut = state.personeller.filter(p => getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === saat).length;

                    if (mevcut < hedef) {
                        // Eksik var! DÄ±ÅŸarÄ±dan (diÄŸer gruplardan o gÃ¼n boÅŸta olanlardan) adam topla.
                        // Ama dikkat: 'tempProg[p.ad][gun] === null' olanlarÄ± al.
                        // YukarÄ±da Makas ile 'SHIFTS.IZIN' atadÄ±klarÄ±mÄ±zÄ± alma (Onlar dinlenmeli).
                        let yedekAdaylar = state.personeller.filter(p => {
                            let birimUygun = getGecerliBirim(p, gun) === birim;
                            // SADECE NULL OLANLARI AL (Zorla izin verilenleri alma)
                            let bosta = (tempProg[p.ad][gun] === null); 
                            let yorgunDegil = calis[p.ad] < 6;
                            let dunGece = (gun > 0 && tempProg[p.ad][gun-1] === SHIFTS.GECE);
                            let manuelVar = state.manuelAtamalar[`${hKey}_${p.ad}_${gun}`];
                            
                            return birimUygun && bosta && yorgunDegil && !dunGece && !manuelVar;
                        });

                        seededShuffle(yedekAdaylar, hKey + "yedek");

                        for (let p of yedekAdaylar) {
                            if (mevcut < hedef) {
                                tempProg[p.ad][gun] = saat;
                                calis[p.ad]++;
                                mevcut++;
                            }
                        }
                    }
                });
            }
        });
        
        // ------------------------------------------------------------
        // 4. YENÄ° MOD: AKILLI_HAFTASONU (CUMA KORUMALI)
        // ------------------------------------------------------------
        state.birimler.forEach(birim => {
            const ayar = state.birimAyarlari[birim] || { tip: "HAVUZ" };
            if (ayar.tip !== "AKILLI_HAFTASONU") return;
            
            for (let gun = 0; gun < 7; gun++) {
                // Sadece Cumartesi gÃ¼nÃ¼ (Gun 5) iÃ§in Ã–ZEL sÄ±ralama yapÄ±yoruz.
                // DiÄŸer gÃ¼nler standart sÄ±ralama.
                let siralama = [...state.saatler]; 
                
                if (gun === 5) {
                    // CUMARTESÄ° Ã–ZEL SIRALAMA:
                    // Ã–nce GUNDUZ (09:00), Sonra SABAH (06:30), Sonra AKSAM (16:00), Sonra GECE
                    siralama = siralama.filter(s => s !== SHIFTS.SABAH && s !== SHIFTS.GUNDUZ);
                    siralama.unshift(SHIFTS.SABAH); // 2. SÄ±ra
                    siralama.unshift(SHIFTS.GUNDUZ); // 1. SÄ±ra
                }

                siralama.forEach(saat => {
                    if (saat === SHIFTS.IZIN) return;
                    
                    const hedef = (state.kapasite[`${birim}_${saat}`] || [0,0,0,0,0,0,0])[gun];
                    let mevcut = state.personeller.filter(p => getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === saat).length;
                    
                    if (mevcut < hedef) {
                        let adaylar = state.personeller.filter(p => {
                            if (getGecerliBirim(p, gun) !== birim) return false;
                            if (tempProg[p.ad][gun] !== null) return false;
                            if (calis[p.ad] >= 6) return false;

                            // --- DÄ°NLENME KALKANI (Anti-Zombie) ---
                            // EÄŸer gÃ¼n Cumartesi ise (5) ve vardiya SABAH veya GUNDUZ ise;
                            // Cuma gÃ¼nÃ¼ne (4) bak. EÄŸer Cuma AKÅAM veya GECE ise -> REDDET.
                            if (gun === 5 && (saat === SHIFTS.SABAH || saat === SHIFTS.GUNDUZ)) {
                                let cumaVardiya = tempProg[p.ad][4];
                                if (cumaVardiya === SHIFTS.AKSAM || cumaVardiya === SHIFTS.GECE) return false;
                            }
                            // -------------------------------------

                            // Standart Dinlenme KontrolÃ¼ (DÃ¼n gece -> BugÃ¼n sabah olmaz)
                            if (gun > 0) {
                                let dun = tempProg[p.ad][gun-1];
                                if ((dun === SHIFTS.AKSAM || dun === SHIFTS.GECE) && (saat === SHIFTS.SABAH || saat === SHIFTS.GUNDUZ)) return false;
                            }
                            return true;
                        });
                        
                        seededShuffle(adaylar, hKey + gun + saat);
                        adaylar.sort((a,b) => calis[a.ad] - calis[b.ad]);

                        for (let p of adaylar) {
                            if (mevcut < hedef) {
                                tempProg[p.ad][gun] = saat;
                                calis[p.ad]++;
                                mevcut++;
                            }
                        }
                    }
                });
            }
        });
        // ------------------------------------------------------------


        // 5. GENEL HAVUZ VE PUANLI GECE MANTIÄI (GÃœNCELLENDÄ°: SADECE GECE PUANLI)
        for (let gun = 0; gun < 7; gun++) {
            state.birimler.forEach(birim => {
                const ayar = state.birimAyarlari[birim] || { tip: "HAVUZ" };
                
                // SADECE HAVUZ VEYA YENÄ° GECE Ã–NCELÄ°KLÄ° TÄ°PÄ°NÄ° KABUL ET
                if (ayar.tip !== "HAVUZ" && ayar.tip !== "GECE_ONCELIKLI") return; 

                // SIRALAMA FONKSÄ°YONU (AKILLI REVÄ°ZE EDÄ°LDÄ°)
                const siralamaYap = (adaylar, isGece) => {
                    seededShuffle(adaylar, hKey);
                    
                    if (ayar.tip === "GECE_ONCELIKLI" && isGece) {
                        // SADECE GECE Ä°SE: Ã–nce PUAN (% YÃ¼zde), Sonra AZ Ã‡ALIÅMA
                        adaylar.sort((a,b) => (b.yuzde || 0) - (a.yuzde || 0) || calis[a.ad] - calis[b.ad]);
                    } else {
                        // DÄ°ÄER DURUMLARDA (GÃ¼ndÃ¼z vb.): Sadece AZ Ã‡ALIÅMA (Adil KarÄ±ÅŸÄ±m)
                        adaylar.sort((a,b) => calis[a.ad] - calis[b.ad]);
                    }
                };

                // --- GECE VARDÄ°YASI ---
                const geceSaati = SHIFTS.GECE; 
                const hedefGece = (state.kapasite[`${birim}_${geceSaati}`] || [0,0,0,0,0,0,0])[gun];
                let atananGece = state.personeller.filter(p => getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === geceSaati).length;

                // TUR 1: Normal (6 GÃ¼n KuralÄ± Var)
                if (atananGece < hedefGece) {
                    let adaylar = state.personeller.filter(p => getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === null && (calis[p.ad] < 6));
                    siralamaYap(adaylar, true); // GECE = TRUE
                    for (let p of adaylar) { if (atananGece < hedefGece) { tempProg[p.ad][gun] = geceSaati; calis[p.ad]++; atananGece++; } }
                }
                // TUR 2: ZORUNLU (6 GÃ¼n KuralÄ±nÄ± Esnet)
                if (atananGece < hedefGece) {
                    let adaylar = state.personeller.filter(p => getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === null);
                    siralamaYap(adaylar, true); // GECE = TRUE
                    for (let p of adaylar) { if (atananGece < hedefGece) { tempProg[p.ad][gun] = geceSaati; calis[p.ad]++; atananGece++; } }
                }
                
                // --- DÄ°ÄER SAATLER (GÃœNDÃœZ, AKÅAM VB.) ---
                state.saatler.filter(s => s !== SHIFTS.GECE).forEach(saat => {
                    const hdf = (state.kapasite[`${birim}_${saat}`] || [0,0,0,0,0,0,0])[gun];
                    let mvc = state.personeller.filter(p => getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === saat).length;
                    
                    // TUR 1
                    if (mvc < hdf) {
                        let ady = state.personeller.filter(p => {
                            let basic = getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === null;
                            let dunGece = (gun > 0 && tempProg[p.ad][gun-1] === SHIFTS.GECE);
                            return basic && (calis[p.ad] < 6) && !(dunGece && saat === SHIFTS.SABAH);
                        });
                        siralamaYap(ady, false); // GECE DEÄÄ°L = FALSE (Adil KarÄ±ÅŸÄ±m)
                        for (let p of ady) { if (mvc < hdf) { tempProg[p.ad][gun] = saat; calis[p.ad]++; mvc++; } }
                    }
                    // TUR 2
                    if (mvc < hdf) {
                        let ady = state.personeller.filter(p => {
                            let basic = getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === null;
                            let dunGece = (gun > 0 && tempProg[p.ad][gun-1] === SHIFTS.GECE);
                            return basic && !(dunGece && saat === SHIFTS.SABAH);
                        });
                        siralamaYap(ady, false); // GECE DEÄÄ°L = FALSE
                        for (let p of ady) { if (mvc < hdf) { tempProg[p.ad][gun] = saat; calis[p.ad]++; mvc++; } }
                    }
                });
            });
        }

        state.personeller.forEach(p => { for(let g=0; g<7; g++) { if(tempProg[p.ad][g] === null) tempProg[p.ad][g] = SHIFTS.IZIN; } });
        state.personeller.forEach(p => { for(let i=0; i<7; i++) if(tempProg[p.ad][i]) state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] = tempProg[p.ad][i]; });
        
        save(); 
        logKoy("Otomatik vardiya oluÅŸturuldu.");
        tabloyuOlustur(); 
        alert("âœ… Vardiya baÅŸarÄ±yla oluÅŸturuldu.");
    }

    function excelIndir() {
        const hKey = getDateKey(currentMonday);
        let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>
            table { border-collapse: collapse; font-family: Arial; } td { border: 1px solid #000; text-align: center; padding: 4px; font-size: 8pt; }
            .title { background: #312e81; color: white; font-weight: bold; font-size: 12pt; }
            .header { background: #1e1b4b; color: white; font-weight: bold; }
            .saat-0630 { background: #ffff00; font-weight: bold; }
            .saat-0900 { background: #00b0f0; color: white; font-weight: bold; }
            .saat-1600 { background: #7030a0; color: white; font-weight: bold; }
            .saat-0000 { background: #ed7d31; color: white; font-weight: bold; }
            .saat-izin { background: #ff0000; color: white; font-weight: bold; }
        </style></head><body><table><tr><th colspan="8" class="title">TEKNÄ°K PERSONEL Ã‡ALIÅMA LÄ°STESÄ°</th></tr>
        <tr><th class="header">SAAT</th>${GUNLER.map(g => `<th class="header">${g.toUpperCase()}</th>`).join('')}</tr>`;
        
        state.birimler.forEach(birim => {
            html += `<tr><td colspan="8" style="background:${getBirimColor(birim)}; color:white; font-weight:bold;">${birim}</td></tr>`;
            [...state.saatler, "Ä°ZÄ°N"].forEach(s => {
                let pByDay = []; let maxRow = 1;
                for(let i=0; i<7; i++) {
                    let list = state.personeller.filter(p => {
                        let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`];
                        if(s === "Ä°ZÄ°N") return p.birim === birim && (v === SHIFTS.IZIN || v === SHIFTS.BOS || !v || v === SHIFTS.YILLIK);
                        return p.birim === birim && v === s;
                    });
                    pByDay[i] = list; if(list.length > maxRow) maxRow = list.length;
                }
                let cls = s.includes("06:30") ? "saat-0630" : s.includes("09:00") ? "saat-0900" : s.includes("16:00") ? "saat-1600" : s.includes("00:00") ? "saat-0000" : s === "Ä°ZÄ°N" ? "saat-izin" : "";
                for(let r=0; r<maxRow; r++) {
                    html += `<tr>${r===0 ? `<td rowspan="${maxRow}" class="${cls}">${s}</td>`:""}${pByDay.map(d => `<td>${d[r]?d[r].ad:""}</td>`).join('')}</tr>`;
                }
            });
        });
        html += `</table></body></html>`;
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `Vardiya_${hKey}.xls`; a.click();
    }

    function ulastirmaExcelIndir() {
        const hKey = getDateKey(currentMonday);
        let html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: 'Calibri', sans-serif; font-size: 11pt; background-color: #eff6ff; }
                table { border-collapse: collapse; width: 100%; table-layout: fixed; background-color: #eff6ff; }
                td, th { border: 1px solid #000000; text-align: center; vertical-align: middle; padding: 5px; }
                .header-main { background-color: #881337; color: #ffffff; font-weight: bold; font-size: 14pt; height: 40px; }
                .header-day { background-color: #881337; color: #ffffff; font-weight: bold; font-size: 11pt; height: 30px; }
                .time-col { background-color: #881337; color: #ffffff; font-weight: bold; width: 80px; text-align: center; vertical-align: middle; font-size: 12pt; }
                .shift-06 { background-color: #dbeafe; color: #000000; font-weight: bold; }
                .shift-09 { background-color: #93c5fd; color: #000000; font-weight: bold; }
                .shift-16 { background-color: #3b82f6; color: #ffffff; font-weight: bold; }
                .shift-00 { background-color: #1e3a8a; color: #ffffff; font-weight: bold; }
                .shift-off { background-color: #fca5a5; color: #000000; }
                .name-box { margin-bottom: 2px; font-size: 10pt; display: block; }
                .unit-label { font-size: 7pt; opacity: 0.8; display: block; margin-bottom: 2px; font-style: italic; }
            </style>
        </head>
        <body>
            <table>
                <tr>
                    <th class="header-main">SAAT</th>
                    ${GUNLER.map((g, i) => {
                        let d = new Date(currentMonday);
                        d.setDate(d.getDate() + i);
                        let dateStr = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        return `<th class="header-day">${dateStr}<br>${g.toUpperCase()}</th>`;
                    }).join('')}
                </tr>`;

        state.saatler.forEach(s => {
            let bgClass = "shift-06"; 
            if(s.includes("09:00")) bgClass = "shift-09";
            if(s.includes("16:00")) bgClass = "shift-16";
            if(s.includes("00:00")) bgClass = "shift-00";

            html += `<tr>`;
            html += `<td class="time-col">${s.split('â€“')[0]}<br><span style="font-size:8pt;">${s.split('â€“')[1]}</span></td>`;

            for(let i=0; i<7; i++) {
                let calisanlar = state.personeller.filter(p => {
                    let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`];
                    if (v === SHIFTS.IZIN || v === SHIFTS.BOS || v === SHIFTS.YILLIK || !v) return false;
                    return v === s;
                });

                calisanlar.sort((a, b) => {
                    let birimA = getGecerliBirim(a, i);
                    let birimB = getGecerliBirim(b, i);
                    return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB);
                });

                let cellContent = calisanlar.map(p => {
                    let birim = getGecerliBirim(p, i);
                    return `<span class="name-box">${p.ad} <span class="unit-label">(${birim})</span></span>`;
                }).join('<br>');

                html += `<td class="${bgClass}">${cellContent}</td>`;
            }
            html += `</tr>`;
        });

        html += `<tr><td class="time-col" style="background-color:#991b1b;">Ä°ZÄ°N</td>`;
        for(let i=0; i<7; i++) {
            let izinliler = state.personeller.filter(p => {
                let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`];
                return (v === SHIFTS.IZIN || v === SHIFTS.BOS || !v || v === SHIFTS.YILLIK);
            });
            
            let cellContent = izinliler.map(p => {
                let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`];
                let ek = v === SHIFTS.YILLIK ? " (YILLIK)" : "";
                return `<span class="name-box">${p.ad}${ek}</span>`;
            }).join('<br>');
            
            html += `<td class="shift-off">${cellContent}</td>`;
        }
        html += `</tr>`;

        html += `</table></body></html>`;
        
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Ulastirma_Listesi_${hKey}.xls`;
        a.click();
    }

    function toggleAdminPanel() { 
        if(!isAdmin) return;
        const p = document.getElementById("sidePanel"); 
        const o = document.getElementById("panelOverlay"); 
        p.classList.toggle("open"); 
        o.style.display = p.classList.contains("open") ? "block" : "none"; 
        if(p.classList.contains("open")) tabDegistir('personel'); 
    }
    
    function tabDegistir(t) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab-' + t).classList.remove('hidden'); document.getElementById('btn-tab-' + t).classList.add('active'); refreshUI(); }
    
    /* FIX: SayfayÄ± yenilemek yerine State'i gÃ¼ncelleyen yeni versiyon */
    function bulutaKaydet() { database.ref('vardiya_data').set(state).then(() => alert("Kaydedildi!")).catch(e => alert(e.message)); }
    function buluttanYukle() { 
        if(!isAdmin) return;
        database.ref('vardiya_data').once('value').then(snap => { 
            if(snap.exists()){ 
                state = snap.val(); 
                verileriGuvenliHaleGetir(); // GÃœVENLÄ°K KONTROLÃœ
                save(); 
                tabloyuOlustur(); 
                refreshUI();
                alert("Veriler buluttan yÃ¼klendi ve ekran gÃ¼ncellendi!");
            } else {
                alert("Bulutta veri bulunamadÄ±.");
            }
        }).catch(e => alert("Hata: " + e.message)); 
    }
    
    function loglariTemizle() {
        if(confirm("Loglar silinsin mi?")) {
            state.logs = [];
            save();
            refreshUI();
        }
    }

    function istatistikleriHesapla() {
        const hKey = getDateKey(currentMonday);
        let stats = {};
        
        state.personeller.forEach(p => {
            stats[p.ad] = { toplamGun: 0, gece: 0, haftasonu: 0, swap: 0 };
            
            for(let i=0; i<7; i++) {
                let mKey = `${hKey}_${p.ad}_${i}`;
                let v = state.manuelAtamalar[mKey];
                
                if(v && ![SHIFTS.IZIN, SHIFTS.BOS, null, SHIFTS.YILLIK].includes(v)) {
                    stats[p.ad].toplamGun++;
                    if(v === SHIFTS.GECE) stats[p.ad].gece++;
                    if(i >= 5) stats[p.ad].haftasonu++;
                }
            }
        });
        
        let html = "<table style='width:100%; border-collapse:collapse;'><tr><th style='text-align:left; border-bottom:1px solid #ccc;'>Personel</th><th style='border-bottom:1px solid #ccc;'>GÃ¼n</th><th style='border-bottom:1px solid #ccc;'>Gece</th><th style='border-bottom:1px solid #ccc;'>H.Sonu</th></tr>";
        
        Object.keys(stats).sort().forEach(ad => {
            const s = stats[ad];
            html += `<tr style='border-bottom:1px solid #eee;'>
                <td style='padding:4px;'>${ad}</td>
                <td style='text-align:center;'>${s.toplamGun}</td>
                <td style='text-align:center; font-weight:bold; color:${s.gece>0?'red':'black'}'>${s.gece}</td>
                <td style='text-align:center; color:blue;'>${s.haftasonu}</td>
            </tr>`;
        });
        html += "</table>";
        document.getElementById('istatistikListesi').innerHTML = html;
    }

    function duyuruGuncelle() {
        const yeniMetin = document.getElementById('adminDuyuruInp').value;
        state.duyuruMetni = yeniMetin;
        save();
        bulutaKaydet(); 
        alert("Duyuru gÃ¼ncellendi!");
        tabloyuOlustur();
    }

    function odakModuAc() {
        const ad = prompt("Ä°sminiz nedir? (Tam eÅŸleÅŸme gerekir)");
        if(!ad) {
            document.body.classList.remove('focus-active');
            document.querySelectorAll('.birim-card').forEach(el => el.classList.remove('focused'));
            return;
        }
        
        document.body.classList.add('focus-active');
        document.querySelectorAll('.birim-card').forEach(el => {
            if(el.querySelector('.pers-name').innerText.includes(ad)) {
                el.classList.add('focused');
            } else {
                el.classList.remove('focused');
            }
        });
    }

    function refreshUI() {
        document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
        document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => {
            let mcrHtml = "";
            if(p.birim.includes("MCR") || p.birim.includes("INGEST")) {
                mcrHtml = `<div class="mcr-ayarlar">
                    <span>${p.birim.includes("INGEST") ? 'INGEST' : 'MCR'} DÃ¶ngÃ¼ Ofseti: </span>
                    <input type="number" value="${state.mcrAyarlari.ofsetler[p.ad] || 0}" style="width:40px" onchange="mcrOfsetGuncelle('${p.ad}', this.value)">
                </div>`;
            }
            let yuzdeHtml = `<div style="margin-top:5px; font-size:10px;">
                <span style="font-weight:bold;">Vardiya Ã–ncelik PuanÄ± (%):</span>
                <input type="number" value="${p.yuzde || 0}" style="width:50px; padding:3px; border-radius:4px; border:1px solid #ccc;" onchange="yuzdeGuncelle(${i}, this.value)">
            </div>`;

            return `<div style="background:white; border:1px solid var(--border); padding:10px; border-radius:8px; margin-bottom:5px; box-shadow:0 2px 4px rgba(0,0,0,0.02);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span><strong>${p.ad}</strong> <small style="color:#64748b">(${p.birim})</small></span>
                    <button onclick="state.personeller.splice(${i},1); save(); refreshUI(); tabloyuOlustur();" style="color:var(--danger); border:none; background:none; cursor:pointer;">Sil</button>
                </div>
                <div style="margin-top:5px;">${GUNLER.map((g, gi) => `<span class="izin-gun-pill ${p.izinGunleri?.includes(gi)?'active':''}" onclick="izinGunuTetikle(${i},${gi})">${g}</span>`).join('')}</div>
                ${yuzdeHtml}
                ${mcrHtml}
            </div>`;
        }).join('');
        
        const swapKaynak = document.getElementById('swapKaynakPersonel');
        const swapHedef = document.getElementById('swapHedefPersonel');
        const optionsHtml = "<option value=''>SeÃ§iniz...</option>" + state.personeller.sort((a,b) => a.ad.localeCompare(b.ad)).map(p => `<option value="${p.ad}">${p.ad} (${p.birim})</option>`).join('');
        if(swapKaynak) swapKaynak.innerHTML = optionsHtml;
        if(swapHedef) swapHedef.innerHTML = optionsHtml;
        
        const yillikSel = document.getElementById('yillikIzinPersonel');
        if(yillikSel) yillikSel.innerHTML = optionsHtml;

        if(!state.geciciGorevler) state.geciciGorevler = {};
        let degisimHtml = "<strong>Aktif DeÄŸiÅŸimler (Bu Hafta):</strong><br>";
        let hasDegisim = false;
        Object.keys(state.geciciGorevler).forEach(k => {
            const [dateStr, pName] = k.split('_');
            const targetUnit = state.geciciGorevler[k];
            let d = new Date(dateStr);
            let nextMonday = new Date(currentMonday); nextMonday.setDate(nextMonday.getDate() + 7);
            
            if(d >= currentMonday && d < nextMonday) {
                degisimHtml += `<div style="font-size:10px; border-bottom:1px solid #eee; padding:2px;">ğŸ“… ${dateStr} - <b>${pName}</b> â¡ï¸ ${targetUnit}</div>`;
                hasDegisim = true;
            }
        });
        document.getElementById("aktifDegisimlerListesi").innerHTML = hasDegisim ? degisimHtml : "<div style='font-size:10px; color:#999;'>Bu hafta iÃ§in aktif deÄŸiÅŸim yok.</div>";

        if(state.logs) {
            document.getElementById('logListesi').innerHTML = state.logs.map(l => 
                `<div class="log-item"><span>${l.mesaj} <br><i style="color:#666">(${l.user})</i></span> <span class="log-time">${l.zaman}</span></div>`
            ).join('');
        }

        document.getElementById('adminDuyuruInp').value = state.duyuruMetni || "";

        let capHtml = ""; state.birimler.forEach(b => { capHtml += `<div style="margin-bottom:15px; background:white; padding:10px; border-radius:8px; border:1px solid var(--border);"><strong>${b}</strong>`; state.saatler.forEach(s => { const v = state.kapasite[`${b}_${s}`] || [0,0,0,0,0,0,0]; capHtml += `<div style="font-size:9px; margin-top:5px; color:#64748b;">${s}</div><div style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px;">${GUNLER.map((g, gi) => `<input type="number" value="${v[gi]}" style="width:100%; text-align:center; padding:4px; border:1px solid #e2e8f0; border-radius:4px;" onchange="capUp('${b}_${s}',${gi},this.value)">`).join('')}</div>`; }); capHtml += `</div>`; });
        document.getElementById("kapasiteTable").innerHTML = capHtml;
        
        let mcrSistemHtml = `<div style="background:#e0f2fe; padding:10px; border-radius:8px; margin-bottom:10px;">
            <strong>MCR/INGEST DÃ¶ngÃ¼ BaÅŸlangÄ±Ã§ Tarihi:</strong><br>
            <input type="date" value="${state.mcrAyarlari.baslangicTarihi}" onchange="state.mcrAyarlari.baslangicTarihi = this.value; save();" style="width:96%; padding:5px; margin-top:5px; border-radius:4px; border:1px solid #ccc;">
        </div>`;
        
        document.getElementById("sabitListeAdmin").innerHTML = mcrSistemHtml + state.personeller.filter(p => !p.birim.includes("MCR") && !p.birim.includes("INGEST")).map(p => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:white; padding:8px; border-radius:5px; border:1px solid #eee;"><label><input type="checkbox" ${state.haftaIciSabitler[p.ad]?'checked':''} onchange="sabitTetikle('${p.ad}')"> ${p.ad}</label><select onchange="sabitSaatGuncelle('${p.ad}', this.value)" ${!state.haftaIciSabitler[p.ad]?'disabled':''} style="border:1px solid #ccc; border-radius:4px;">${state.saatler.map(s => `<option value="${s}" ${state.haftaIciSabitler[p.ad] === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`).join('');
        
        document.getElementById("birimListesiAdmin").innerHTML = `
            <div style="margin-bottom:10px; display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                <input type="text" id="yeniBirimInp" placeholder="Yeni Birim AdÄ±" style="flex:1; padding:8px; border-radius:4px; border:1px solid #ccc; min-width:120px;">
                <input type="color" id="yeniBirimRenk" value="#3b82f6" style="width:40px; height:35px; border:none; border-radius:4px; cursor:pointer;" title="Birim Rengi">
                <select id="yeniBirimTipi" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                    <option value="HAVUZ">Standart (Havuz)</option>
                    <option value="GECE_ONCELIKLI">ğŸŒ™ Gece Ã–ncelikli (PuanlÄ±)</option>
                    <option value="DONGU8">MCR Tipi (8'li DÃ¶ngÃ¼)</option>
                    <option value="DONGU6">Ingest Tipi (6'lÄ± DÃ¶ngÃ¼)</option>
                    <option value="GRUP_ABC">3'lÃ¼ Grup (Playout/Ses/KJ)</option>
                    <option value="AKILLI_HAFTASONU">AkÄ±llÄ± Haftasonu (Cuma KorumalÄ±)</option>
                </select>
                <button onclick="birimEkle()" class="btn-main-action" style="background:var(--success); padding:8px 12px;">EKLE</button>
            </div>
            <div style="margin-top:5px; font-size:10px; color:#666; margin-bottom:10px;">
                * <b>Standart:</b> Kapasiteye gÃ¶re boÅŸ olanÄ± atar<br>
                * <b>DÃ¶ngÃ¼:</b> 7/24 SÄ±ralÄ± sistem<br>
                * <b>3'lÃ¼ Grup:</b> Sabah/AkÅŸam/Ä°zin grubu (Playout mantÄ±ÄŸÄ±)
            </div>
            ${state.birimler.map((b, i) => {
                let ayar = state.birimAyarlari[b] || {tip:"HAVUZ", renk:"#3b82f6"};
                let tipYazi = ayar.tip === "DONGU8" ? "8'li DÃ¶ngÃ¼" : 
                             (ayar.tip === "DONGU6" ? "6'lÄ± DÃ¶ngÃ¼" : 
                             (ayar.tip === "GRUP_ABC" ? "3'lÃ¼ Grup" : 
                             (ayar.tip === "AKILLI_HAFTASONU" ? "AkÄ±llÄ± H.Sonu" : 
                             (ayar.tip === "GECE_ONCELIKLI" ? "Gece PuanlÄ±" : "Standart"))));
                return `
                <div style="padding:8px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:white; border-left: 5px solid ${getBirimColor(b)}">
                    <div>
                        <span style="font-weight:bold;">${b}</span>
                        <span style="font-size:9px; background:#eee; padding:2px 4px; border-radius:3px; margin-left:5px;">${tipYazi}</span>
                    </div>
                    <button onclick="birimSil(${i})" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:10px;">Sil</button>
                </div>`;
            }).join('')}`;

        document.getElementById("saatListesiAdmin").innerHTML = `
            <div style="margin-bottom:10px; display:flex; gap:5px;">
                <input type="text" id="yeniSaatInp" placeholder="Ã–rn: 10:00â€“19:00" style="flex:1; padding:8px; border-radius:4px; border:1px solid #ccc;">
                <button onclick="saatEkle()" class="btn-main-action" style="background:var(--success); padding:5px 10px;">EKLE</button>
            </div>
            ${state.saatler.map((s, i) => `
                <div style="padding:8px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:white;">
                    <span>${s}</span>
                    <button onclick="saatSil(${i})" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:10px;">Sil</button>
                </div>
            `).join('')}`;
    }
    
    function vardiyaBul(pAd, gIdx) {
        const hKey = getDateKey(currentMonday);
        const mKey = `${hKey}_${pAd}_${gIdx}`;
        if (state.manuelAtamalar[mKey]) return state.manuelAtamalar[mKey];
        const p = state.personeller.find(pers => pers.ad === pAd);
        if (!p) return null;
        const mcrDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.GECE, SHIFTS.GECE, SHIFTS.IZIN, SHIFTS.IZIN];
        const ingestDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.IZIN, SHIFTS.IZIN];
        const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);
        let d = new Date(currentMonday);
        d.setDate(d.getDate() + gIdx);
        
        // DÄ°NAMÄ°K KONTROL
        const birimAyar = state.birimAyarlari[p.birim];
        if (birimAyar && (birimAyar.tip === "DONGU8" || birimAyar.tip === "DONGU6")) {
            const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
            const loopArr = (birimAyar.tip === "DONGU8") ? mcrDongu : ingestDongu;
            const modVal = loopArr.length;
            const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
            return loopArr[((diffDays + persOfset) % modVal + modVal) % modVal];
        }
        
        if (state.haftaIciSabitler[p.ad] && gIdx < 5) return state.haftaIciSabitler[p.ad];
        return null;
    }

    function degisimiUygula() {
        const pKaynakAd = document.getElementById('swapKaynakPersonel').value; 
        const pHedefAd = document.getElementById('swapHedefPersonel').value;   
        if(!pKaynakAd || !pHedefAd) { alert("LÃ¼tfen iki personeli de seÃ§iniz."); return; }
        if(pKaynakAd === pHedefAd) { alert("AynÄ± personeli seÃ§emezsiniz."); return; }
        const checkboxes = document.querySelectorAll('.swap-day-cb:checked');
        if(checkboxes.length === 0) { alert("LÃ¼tfen en az bir gÃ¼n seÃ§iniz."); return; }
        const selectedDays = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a,b) => a-b);
        const hKey = getDateKey(currentMonday);
        for (let gunIdx of selectedDays) {
            let hedefVardiya = vardiyaBul(pKaynakAd, gunIdx);
            if (hedefVardiya && [SHIFTS.SABAH, SHIFTS.GUNDUZ].includes(hedefVardiya)) {
                let prevVardiya = null;
                if (gunIdx > 0) {
                     prevVardiya = vardiyaBul(pHedefAd, gunIdx - 1);
                } else {
                     let prevDate = new Date(currentMonday); prevDate.setDate(prevDate.getDate() - 1);
                     let prevHKey = getDateKey(getMonday(prevDate));
                     let prevKey = `${prevHKey}_${pHedefAd}_6`; 
                     prevVardiya = state.manuelAtamalar[prevKey];
                }
                if (prevVardiya && [SHIFTS.AKSAM, SHIFTS.GECE].includes(prevVardiya)) {
                     alert(`âš ï¸ DÄ°NLENME KURALI Ä°HLALÄ°!\n\n${pHedefAd} personeli bir Ã¶nceki gÃ¼n (${prevVardiya}) Ã§alÄ±ÅŸÄ±yor.\nErtesi gÃ¼n ${hedefVardiya} vardiyasÄ±na yazÄ±lamaz.\n\nÄ°ÅŸlem iptal edildi.`);
                     return; 
                }
            }
        }
        selectedDays.forEach(gunIdx => {
             const pKaynak = state.personeller.find(p => p.ad === pKaynakAd);
             const hedefBirim = pKaynak.birim;
             let d = new Date(currentMonday); d.setDate(d.getDate() + gunIdx);
             const dateKey = getDateKey(d);
             const gKey = `${dateKey}_${pHedefAd}`;
             if(!state.geciciGorevler) state.geciciGorevler = {};
             state.geciciGorevler[gKey] = hedefBirim;
             const kLeaving = `${hKey}_${pKaynakAd}_${gunIdx}`;
             const kEntering = `${hKey}_${pHedefAd}_${gunIdx}`;
             let shift = vardiyaBul(pKaynakAd, gunIdx);
             if (shift && shift !== SHIFTS.IZIN && shift !== SHIFTS.BOS) { state.manuelAtamalar[kEntering] = shift; }
             state.manuelAtamalar[kLeaving] = SHIFTS.IZIN;
        });
        const lastDayIdx = selectedDays[selectedDays.length - 1];
        let returnDate = new Date(currentMonday); returnDate.setDate(returnDate.getDate() + lastDayIdx + 1); 
        const rHKey = getDateKey(getMonday(returnDate));
        const rDayIdx = (returnDate.getDay() + 6) % 7;
        const returnKey = `${rHKey}_${pHedefAd}_${rDayIdx}`;
        state.manuelAtamalar[returnKey] = SHIFTS.IZIN;
        save();
        alert(`âœ… DeÄŸiÅŸim baÅŸarÄ±yla uygulandÄ±.\n\nPersonelin dÃ¶nÃ¼ÅŸ gÃ¼nÃ¼ (${returnDate.toLocaleDateString('tr-TR')}) otomatik olarak Ä°ZÄ°NLÄ° ayarlandÄ±.`);
        logKoy(`${pKaynakAd} <-> ${pHedefAd} SWAP iÅŸlemi yapÄ±ldÄ±.`);
        refreshUI();
        tabloyuOlustur();
        document.querySelectorAll('.swap-day-cb').forEach(cb => cb.checked = false);
        document.getElementById('swapKaynakPersonel').value = "";
        document.getElementById('swapHedefPersonel').value = "";
    }

    function tumDegisimleriTemizle() {
        if(confirm("TÃ¼m geÃ§ici birim deÄŸiÅŸiklikleri silinecek. Emin misiniz?")) {
            state.geciciGorevler = {};
            save();
            refreshUI();
            tabloyuOlustur();
        }
    }

    function cikisYap() {
        firebase.auth().signOut().then(() => {
            location.reload(); 
        });
    }

    function arsivleVeTemizle() {
        if(!isAdmin) return;
        if(!confirm("âš ï¸ DÄ°KKAT: 30 gÃ¼nden eski tÃ¼m vardiya verileri silinecek ve sistem hÄ±zlandÄ±rÄ±lacak.\n\nBu iÅŸlem performansÄ± artÄ±rÄ±r. Ã–nce otomatik yedek alÄ±nacak.\n\nDevam edilsin mi?")) return;
        jsonYedekAl();
        const bugun = new Date();
        const sinirTarih = new Date();
        sinirTarih.setDate(bugun.getDate() - 30); 
        let silinenSayisi = 0;
        Object.keys(state.manuelAtamalar).forEach(key => {
            const tarihStr = key.split('_')[0]; 
            const kayitTarihi = new Date(tarihStr);
            if(kayitTarihi < sinirTarih) {
                delete state.manuelAtamalar[key];
                silinenSayisi++;
            }
        });
        if(state.geciciGorevler) {
            Object.keys(state.geciciGorevler).forEach(key => {
                 const tarihStr = key.split('_')[0];
                 const kayitTarihi = new Date(tarihStr);
                 if(kayitTarihi < sinirTarih) {
                     delete state.geciciGorevler[key];
                     silinenSayisi++;
                 }
            });
        }
        save();
        bulutaKaydet(); 
        logKoy(`Sistem temizliÄŸi yapÄ±ldÄ±. ${silinenSayisi} kayÄ±t silindi.`);
        alert(`âœ… TEMÄ°ZLÄ°K VE ARÅÄ°VLEME TAMAMLANDI.\n\nToplam ${silinenSayisi} eski kayÄ±t sistemden silindi.\nUygulama artÄ±k daha hÄ±zlÄ± Ã§alÄ±ÅŸacak.`);
        tabloyuOlustur();
    }

    function mcrOfsetGuncelle(ad, val) { if(!state.mcrAyarlari.ofsetler) state.mcrAyarlari.ofsetler = {}; state.mcrAyarlari.ofsetler[ad] = parseInt(val); save(); }
    function yuzdeGuncelle(idx, val) { state.personeller[idx].yuzde = val; save(); } 
    function whatsappGonder() { const hKey = getDateKey(currentMonday); let m = `*ğŸ“… ${currentMonday.toLocaleDateString('tr-TR')} VARDÄ°YASI*\n\n`; GUNLER.forEach((g, i) => { m += `*${g.toUpperCase()}*\n`; state.saatler.forEach(s => { let pList = state.personeller.filter(p => state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] === s).map(p => p.ad).join(", "); if (pList) m += `â€¢ ${s}: ${pList}\n`; }); m += `\n`; }); window.open(`https://wa.me/?text=${encodeURIComponent(m)}`, '_blank'); }
    function capUp(k, g, v) { if(!state.kapasite[k]) state.kapasite[k] = [0,0,0,0,0,0,0]; state.kapasite[k][g] = parseInt(v) || 0; save(); }
    function izinGunuTetikle(pi, gi) { if(!state.personeller[pi].izinGunleri) state.personeller[pi].izinGunleri = []; const idx = state.personeller[pi].izinGunleri.indexOf(gi); if(idx > -1) state.personeller[pi].izinGunleri.splice(idx, 1); else state.personeller[pi].izinGunleri.push(gi); save(); refreshUI(); }
    function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + v); tabloyuOlustur(); }
    function personelEkle() { const ad = document.getElementById("yeniPersInp").value.toUpperCase(); const b = document.getElementById("yeniPersBirimSec").value; if(ad){ state.personeller.push({ad, birim:b, izinGunleri:[], yuzde:0}); save(); refreshUI(); document.getElementById("yeniPersInp").value=""; } }
    
    function birimEkle() {
        const val = document.getElementById("yeniBirimInp").value.toUpperCase().trim();
        const renk = document.getElementById("yeniBirimRenk").value;
        const tip = document.getElementById("yeniBirimTipi").value;
        
        if(val && !state.birimler.includes(val)) {
            state.birimler.push(val);
            if(!state.birimAyarlari) state.birimAyarlari = {};
            state.birimAyarlari[val] = { tip: tip, renk: renk };
            
            save(); refreshUI(); tabloyuOlustur();
        } else if (state.birimler.includes(val)) {
            alert("Bu birim zaten mevcut.");
        }
    }
    function birimSil(index) {
        if(confirm(state.birimler[index] + " birimini silmek istediÄŸinize emin misiniz?")) {
            const silinen = state.birimler[index];
            state.birimler.splice(index, 1);
            if(state.birimAyarlari && state.birimAyarlari[silinen]) delete state.birimAyarlari[silinen];
            save(); refreshUI(); tabloyuOlustur();
        }
    }

    function saatEkle() {
        const val = document.getElementById("yeniSaatInp").value.trim();
        if(val && !state.saatler.includes(val)) {
            state.saatler.push(val);
            save(); refreshUI(); tabloyuOlustur();
        } else if (state.saatler.includes(val)) {
            alert("Bu saat zaten mevcut.");
        }
    }
    function saatSil(index) {
         if(confirm(state.saatler[index] + " saatini silmek istediÄŸinize emin misiniz?")) {
            state.saatler.splice(index, 1);
            save(); refreshUI(); tabloyuOlustur();
        }
    }

    function drag(e, p, g, s) { 
        if(!isAdmin) return;
        e.dataTransfer.setData("p", p); e.dataTransfer.setData("oldG", g); 
    }
    
    function drop(e, ns, ng) { 
        if(!isAdmin) return;
        e.preventDefault(); 
        const p = e.dataTransfer.getData("p"); 
        const hKey = getDateKey(currentMonday);
        cakismaKontrol(p, ng, ns);
        state.manuelAtamalar[`${hKey}_${p}_${ng}`] = ns === SHIFTS.BOS ? null : ns; 
        save(); 
        logKoy(`${p} iÃ§in ${GUNLER[ng]} vardiyasÄ± deÄŸiÅŸtirildi: ${ns}`);
        tabloyuOlustur(); 
    }

    function vardiyaDegistir(p, g) { 
        if(!isAdmin) return;
        const s = prompt(`${p}: 1:${SHIFTS.SABAH}, 2:${SHIFTS.GUNDUZ}, 3:${SHIFTS.AKSAM}, 4:${SHIFTS.GECE}, 5:${SHIFTS.IZIN}`); 
        if(s){ 
            let v = null; 
            if(s=="1") v=SHIFTS.SABAH; 
            if(s=="2") v=SHIFTS.GUNDUZ; 
            if(s=="3") v=SHIFTS.AKSAM; 
            if(s=="4") v=SHIFTS.GECE; 
            if(s=="5") v=SHIFTS.IZIN; 
            cakismaKontrol(p, g, v);
            state.manuelAtamalar[`${getDateKey(currentMonday)}_${p}_${g}`] = v; 
            save(); 
            logKoy(`${p} iÃ§in ${GUNLER[g]} gÃ¼nÃ¼ manuel deÄŸiÅŸtirildi: ${v}`);
            tabloyuOlustur(); 
        } 
    }

    function toggleTheme() { const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark"; document.documentElement.setAttribute("data-theme", t); localStorage.setItem(PREFIX + "theme", t); }
    function vardiyaSifirla() { if(confirm("HaftayÄ± temizle?")) { const hKey = getDateKey(currentMonday); Object.keys(state.manuelAtamalar).forEach(k => { if(k.startsWith(hKey)) delete state.manuelAtamalar[k]; }); save(); tabloyuOlustur(); logKoy("Bu haftanÄ±n vardiyasÄ± sÄ±fÄ±rlandÄ±."); } }
    function tamSifirla() { if(confirm("SÄ±fÄ±rla?")) { localStorage.clear(); location.reload(); } }
    function jsonYedekAl() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "Yedek.json"); dl.click(); }
    async function githubdanYedekYukle() {
    const url = "https://raw.githubusercontent.com/ugurbakirtas/vardiya-sistemi/main/ilk_kurulum.json?t=" + new Date().getTime();
    if (confirm("Sistem verileri GitHub Ã¼zerindeki yedekle deÄŸiÅŸtirilecek. OnaylÄ±yor musunuz?")) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("GitHub'daki dosya bulunamadÄ± veya eriÅŸim engellendi.");
            const data = await response.json();
            state = data;
            save();
            alert("GitHub yedeÄŸi baÅŸarÄ±yla yÃ¼klendi!");
            location.reload();
        } catch (error) {
            console.error(error);
            alert("Hata: " + error.message);
        }
    }
}
    function sabitTetikle(ad) { if(state.haftaIciSabitler[ad]) delete state.haftaIciSabitler[ad]; else state.haftaIciSabitler[ad] = state.saatler[0]; save(); refreshUI(); }
    function sabitSaatGuncelle(ad, saat) { state.haftaIciSabitler[ad] = saat; save(); }

function anlikSenkronizasyonBaslat() {
    database.ref().on('value', (snap) => {
        if (snap.exists()) {
            const data = snap.val();
            if(data.vardiya_data) {
                state = data.vardiya_data;
                verileriGuvenliHaleGetir(); // GÃœVENLÄ°K KONTROLÃœ
                save();
                tabloyuOlustur();
                if(isAdmin) refreshUI();
            }
            if(isAdmin) {
                talepleriYukle(); 
            }
            console.log("Sistem: TÃ¼m veriler (vardiya ve talepler) gÃ¼ncellendi.");
        }
    });
}

    /* --- MOBÄ°L LÄ°STE FONKSÄ°YONLARI --- */
    function mobilListeyiGuncelle() {
        const select = document.getElementById('mobilPersonelSecim');
        const mevcutSecim = select.value;
        const siraliPersonel = [...state.personeller].sort((a,b) => a.ad.localeCompare(b.ad));
        let html = '<option value="">Personel SeÃ§iniz...</option>';
        siraliPersonel.forEach(p => {
            html += `<option value="${p.ad}" ${p.ad === mevcutSecim ? 'selected' : ''}>${p.ad}</option>`;
        });
        select.innerHTML = html;
        if(mevcutSecim) kisiselProgramiGoster();
    }

    async function mobilVerileriYenile() {
        const btn = document.querySelector('#mobilPersonelPanel button');
        const oldText = btn.innerHTML;
        btn.innerHTML = "â³";
        try {
            const snap = await database.ref('vardiya_data').once('value');
            if (snap.exists()) {
                state = snap.val();
                verileriGuvenliHaleGetir(); // GÃœVENLÄ°K KONTROLÃœ
                save();
                tabloyuOlustur(); 
                alert("Veriler gÃ¼ncellendi, listenizi kontrol edebilirsiniz.");
            }
        } catch(e) { alert("Veri Ã§ekilemedi: " + e.message); }
        btn.innerHTML = oldText;
    }

    function kisiselProgramiGoster() {
        const isim = document.getElementById('mobilPersonelSecim').value;
        const alan = document.getElementById('kisiselListeSonuc');
        
        if(!isim) {
            alan.innerHTML = "<div style='text-align:center; padding:30px; color:#999;'>LÃ¼tfen isminizi seÃ§iniz.</div>";
            return;
        }

        let html = "";

        GUNLER.forEach((gunAdi, index) => {
            let d = new Date(currentMonday);
            d.setDate(d.getDate() + index);
            let tarihStr = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });

            // vardiyaBul fonksiyonunu kullanarak MCR, Ingest ve Manuel atamalarÄ±n hepsini doÄŸru Ã§ekeriz
            let vardiya = vardiyaBul(isim, index);
            
            if(!vardiya || vardiya === "BOÅ") vardiya = "Ä°ZÄ°NLÄ°";

            let renk = "#eee"; let yaziRengi = "#333"; let ikon = "âšª";
            
            if(vardiya.includes("06:30")) { renk = "#e0f2fe"; yaziRengi = "#0c4a6e"; ikon = "ğŸŒ…"; }
            else if(vardiya.includes("09:00")) { renk = "#f0fdf4"; yaziRengi = "#064e3b"; ikon = "â˜€ï¸"; }
            else if(vardiya.includes("16:00")) { renk = "#faf5ff"; yaziRengi = "#581c87"; ikon = "ğŸŒ‡"; }
            else if(vardiya.includes("00:00")) { renk = "#fff7ed"; yaziRengi = "#7c2d12"; ikon = "ğŸŒ™"; }
            else if(vardiya === "Ä°ZÄ°NLÄ°") { renk = "#fef2f2"; yaziRengi = "#ef4444"; ikon = "ğŸ–ï¸"; }
            else if(vardiya === "YILLIK Ä°ZÄ°N") { renk = "#9333ea"; yaziRengi = "#ffffff"; ikon = "âœˆï¸"; }

            html += `
            <div class="modern-shift-card">
                <div class="m-date-group">
                    <span class="m-day-name">${gunAdi}</span>
                    <span class="m-date-text">${tarihStr}</span>
                </div>
                <div class="m-shift-badge" style="background:${renk}; color:${yaziRengi};">
                    <span style="font-size:16px;">${ikon}</span>
                    <span>${vardiya}</span>
                </div>
            </div>`;
        });

        alan.innerHTML = html;
    }

    /* --- YENÄ° EKLENEN EXCEL OKUMA FONKSÄ°YONU (TERSTEN OKUMA - DÃœZELTÄ°LDÄ°) --- */
    function exceldenVardiyaYukle() {
        const fileInput = document.getElementById('excelUploadInput');
        if (!fileInput.files.length) { alert("LÃ¼tfen bir Excel dosyasÄ± seÃ§in!"); return; }
        
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                const hKey = getDateKey(currentMonday);
                let islenenSayisi = 0;
                let taninmayanSayisi = 0;

                // SatÄ±r SatÄ±r Ä°lerle
                jsonData.forEach(row => {
                    if (!row || row.length < 2) return; 

                    // A SÃ¼tunu (row[0]) = Saat veya Durum
                    let satirBasligi = row[0];
                    if(!satirBasligi || typeof satirBasligi !== 'string') return;
                    satirBasligi = satirBasligi.toUpperCase().trim();

                    // 1. ADIM: SATIRDAKÄ° VARDÄ°YAYI BELÄ°RLE (YENÄ° SIRALAMA)
                    let atanacakVardiya = null;

                    if (satirBasligi.includes("Ä°ZÄ°N") || satirBasligi.includes("OFF")) {
                        atanacakVardiya = SHIFTS.IZIN;
                    } else if (satirBasligi.includes("YILLIK")) {
                        atanacakVardiya = SHIFTS.YILLIK;
                    } else {
                        // Ã–NCE TAM EÅLEÅME ARA (Saat listesinde varsa)
                        atanacakVardiya = state.saatler.find(s => s.includes(satirBasligi) || s.replace(/[:\-\s]/g, "").includes(satirBasligi.replace(/[:\-\s]/g, "")));
                        
                        // BULAMAZSA MANTIK YÃœRÃœT (BURASI KRÄ°TÄ°K NOKTA - DÃœZELTÄ°LDÄ°)
                        if(!atanacakVardiya) {
                            // 1. Ã–NCELÄ°K: GECE (00 ile BAÅLAMALI veya 24 veya GECE iÃ§ermeli)
                            // "16:00 - 00:00" iÃ§inde 00 var ama baÅŸta deÄŸil, o yÃ¼zden buraya girmez.
                            if(satirBasligi.startsWith("00") || satirBasligi.startsWith("24") || satirBasligi.includes("GECE")) {
                                atanacakVardiya = SHIFTS.GECE;
                            }
                            // 2. Ã–NCELÄ°K: SABAH (06 veya 07 iÃ§ermeli)
                            // "00:00 - 07:00" buraya dÃ¼ÅŸmez Ã§Ã¼nkÃ¼ 1. adÄ±mda yakalandÄ±.
                            // "06:30 - 16:00" buraya girer (16'dan Ã¶nce kontrol edilmeli!)
                            else if(satirBasligi.includes("06") || satirBasligi.includes("07")) {
                                atanacakVardiya = SHIFTS.SABAH;
                            }
                            // 3. Ã–NCELÄ°K: GÃœNDÃœZ (09 veya 10 iÃ§ermeli)
                            else if(satirBasligi.includes("09") || satirBasligi.includes("10")) {
                                atanacakVardiya = SHIFTS.GUNDUZ;
                            }
                            // 4. Ã–NCELÄ°K: AKÅAM (16, 15, 14 iÃ§ermeli)
                            // "16:00 - 00:00" buraya girer.
                            else if(satirBasligi.includes("16") || satirBasligi.includes("15") || satirBasligi.includes("14")) {
                                atanacakVardiya = SHIFTS.AKSAM;
                            }
                        }
                    }

                    if (!atanacakVardiya) return; // Bu satÄ±rda vardiya bulamadÄ±k, geÃ§.

                    // 2. ADIM: SÃœTUNLARDAKÄ° Ä°SÄ°MLERÄ° BUL (B=Pzt -> H=Paz)
                    for (let i = 1; i <= 7; i++) {
                        let hucreVerisi = row[i];
                        if (hucreVerisi && typeof hucreVerisi === 'string') {
                            // Ä°SMÄ° TEMÄ°ZLE
                            let temizIsim = hucreVerisi
                                .split('*')[0] // YÄ±ldÄ±zdan sonrasÄ±nÄ± at
                                .split('-')[0] // Tireden sonrasÄ±nÄ± at (varsa)
                                .replace(/[\d\(\)\.]/g, '') // SayÄ±larÄ± ve parantezleri sil
                                .trim().toUpperCase();

                            // 3. ADIM: PERSONELÄ° BUL VE ATAMA YAP
                            let personel = state.personeller.find(p => p.ad === temizIsim);
                            
                            if (personel) {
                                // GÃ¼n Ä°ndeksi: Excelde 1. SÃ¼tun (B) -> Pzt (Index 0)
                                let gunIdx = i - 1;
                                state.manuelAtamalar[`${hKey}_${personel.ad}_${gunIdx}`] = atanacakVardiya;
                                islenenSayisi++;
                            } else if (temizIsim.length > 3) {
                                // Ä°sim dolu ama sistemde yok
                                console.log(`Bilinmeyen Personel: ${temizIsim}`);
                            }
                        }
                    }
                });

                if (islenenSayisi > 0) {
                    save();
                    tabloyuOlustur();
                    alert(`âœ… Excel BaÅŸarÄ±yla Ä°ÅŸlendi!\n\nToplam ${islenenSayisi} hÃ¼cre sisteme aktarÄ±ldÄ±.\nLÃ¼tfen tabloyu kontrol edin.`);
                    logKoy(`Excel yÃ¼klendi (${islenenSayisi} atama)`);
                } else {
                    alert("âš ï¸ Excel okundu ancak eÅŸleÅŸen veri bulunamadÄ±.\n\nLÃ¼tfen A sÃ¼tununda SAATLERÄ°N, hÃ¼crelerde Ä°SÄ°MLERÄ°N olduÄŸundan emin olun.");
                }

            } catch (err) {
                console.error(err);
                alert("Dosya okuma hatasÄ±: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    window.onload = async () => { 
        if(localStorage.getItem(PREFIX + "theme") === "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
        }
        
        await hassasAyarlariYukle(); 
        
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                console.log("Oturum aÃ§Ä±k:", user.email);
                isAdmin = true;
                
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                document.getElementById('persTalepArea').style.display = 'none';
                
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appMain').style.display = 'block'; 
                tabloyuOlustur(); 
                
                checkUrlActions();
                
                const p = document.getElementById("sidePanel");
                if(p.classList.contains("open")) tabDegistir('personel');
            }
        });

        anlikSenkronizasyonBaslat();
        talepleriYukle(); 
    };
  </script>
</body>
</html>