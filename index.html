const SHIFTS = { SABAH: "06:30‚Äì16:00", GUNDUZ: "09:00‚Äì18:00", AKSAM: "16:00‚Äì00:00", GECE: "00:00‚Äì07:00", IZIN: "ƒ∞Zƒ∞NLƒ∞", BOS: "BO≈û", YILLIK: "YILLIK ƒ∞Zƒ∞N" };
    const UNITS = { YONETMEN: "TEKNƒ∞K Y√ñNETMEN", SES: "SES OPERAT√ñR√ú", KJ: "KJ OPERAT√ñR√ú", PLAYOUT: "PLAYOUT OPERAT√ñR√ú", REJI: "REJƒ∞", MCR24: "24TV MCR OPERAT√ñR√ú", MCR360: "360TV MCR OPERAT√ñR√ú", INGEST: "INGEST OPERAT√ñR√ú" };
    
    let TELEGRAM_API = "8509542541:AAFu-iDK85iELZQmImCWSZRi3_eWzUyyCiM"; 
    let TELEGRAM_ID = "859235247";
    
    const firebaseConfig = { apiKey: "AIzaSyBY8dA7IQ0vcdjtG0haRVFuF0vTgZACU0M", authDomain: "teknik-vardiya-listesi.firebaseapp.com", databaseURL: "https://teknik-vardiya-listesi-default-rtdb.europe-west1.firebasedatabase.app", projectId: "teknik-vardiya-listesi", storageBucket: "teknik-vardiya-listesi.firebasestorage.app", messagingSenderId: "900931844150", appId: "1:900931844150:web:41c799492e85d62df8c097" };
    firebase.initializeApp(firebaseConfig); const database = firebase.database();
    
    const GUNLER = ["Pzt", "Sal", "√áar", "Per", "Cum", "Cmt", "Paz"]; 
    const PREFIX = ""; 
    const BIRIM_RENKLERI = { [UNITS.YONETMEN]: "#2563eb", [UNITS.SES]: "#7c3aed", [UNITS.KJ]: "#db2777", [UNITS.PLAYOUT]: "#059669", [UNITS.REJI]: "#d97706", [UNITS.MCR24]: "#9333ea", [UNITS.MCR360]: "#9333ea", [UNITS.INGEST]: "#06b6d4" };
    
    let isAdmin = false;
    let state = { 
        birimler: JSON.parse(localStorage.getItem(PREFIX + "birimler")) || Object.values(UNITS), 
        saatler: JSON.parse(localStorage.getItem(PREFIX + "saatler")) || Object.values(SHIFTS).filter(s => s.includes(":")), 
        personeller: JSON.parse(localStorage.getItem(PREFIX + "personeller")) || [], 
        kapasite: JSON.parse(localStorage.getItem(PREFIX + "kapasite")) || {}, 
        manuelAtamalar: JSON.parse(localStorage.getItem(PREFIX + "manuelAtamalar")) || {}, 
        haftaIciSabitler: JSON.parse(localStorage.getItem(PREFIX + "haftaIciSabitler")) || {}, 
        mcrAyarlari: JSON.parse(localStorage.getItem(PREFIX + "mcrAyarlari")) || { baslangicTarihi: new Date().toISOString().split('T')[0], ofsetler: {} }, 
        geciciGorevler: JSON.parse(localStorage.getItem(PREFIX + "geciciGorevler")) || {},
        logs: JSON.parse(localStorage.getItem(PREFIX + "logs")) || [],
        duyuruMetni: JSON.parse(localStorage.getItem(PREFIX + "duyuruMetni")) || "",
        birimAyarlari: JSON.parse(localStorage.getItem(PREFIX + "birimAyarlari")) || {},
        saatAyarlari: JSON.parse(localStorage.getItem(PREFIX + "saatAyarlari")) || {}
    };
    
    function getDateKey(d) { const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
    let currentMonday = getMonday(new Date());

    // --- EKSƒ∞K OLAN KRƒ∞Tƒ∞K FONKSƒ∞YON: VARDƒ∞YA BUL ---
    function vardiyaBul(pAd, gIdx) {
        const hKey = getDateKey(currentMonday);
        const mKey = `${hKey}_${pAd}_${gIdx}`;
        
        // 1. Manuel Atama Var mƒ±?
        if (state.manuelAtamalar[mKey]) return state.manuelAtamalar[mKey];
        
        const p = state.personeller.find(pers => pers.ad === pAd);
        if (!p) return null;

        // 2. MCR/Ingest D√∂ng√ºs√º
        const birimAyar = state.birimAyarlari[p.birim];
        if (birimAyar && (birimAyar.tip === "DONGU8" || birimAyar.tip === "DONGU6")) {
            const mcrDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.GECE, SHIFTS.GECE, SHIFTS.IZIN, SHIFTS.IZIN];
            const ingestDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.IZIN, SHIFTS.IZIN];
            const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);
            let d = new Date(currentMonday); d.setDate(d.getDate() + gIdx);
            
            const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
            const loopArr = (birimAyar.tip === "DONGU8") ? mcrDongu : ingestDongu;
            const modVal = loopArr.length;
            const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
            
            return loopArr[((diffDays + persOfset) % modVal + modVal) % modVal];
        }
        
        // 3. Hafta ƒ∞√ßi Sabiti mi?
        if (state.haftaIciSabitler && state.haftaIciSabitler[p.ad] && gIdx < 5) {
            return state.haftaIciSabitler[p.ad];
        }
        
        return null;
    }
    // ------------------------------------------------

    async function hassasAyarlariYukle() { try { const snap = await database.ref('config').once('value'); if (snap.exists()) { const config = snap.val(); if(config.telegram_api) TELEGRAM_API = config.telegram_api; if(config.telegram_id) TELEGRAM_ID = config.telegram_id; } } catch (error) { console.error(error); } }
    
    function verileriGuvenliHaleGetir() {
        if(!state) state = {};
        if(!state.manuelAtamalar) state.manuelAtamalar = {};
        if(!state.geciciGorevler) state.geciciGorevler = {};
        if(!state.personeller) state.personeller = [];
        if(!state.kapasite) state.kapasite = {};
        if(!state.haftaIciSabitler) state.haftaIciSabitler = {};
        if(!state.mcrAyarlari) state.mcrAyarlari = { baslangicTarihi: new Date().toISOString().split('T')[0], ofsetler: {} };
        if(!state.birimler) state.birimler = Object.values(UNITS);
        if(!state.saatler) state.saatler = Object.values(SHIFTS).filter(s => s.includes(":"));
        
        if(!state.birimAyarlari || Object.keys(state.birimAyarlari).length === 0) {
            state.birimAyarlari = {};
            state.birimler.forEach(b => {
                let tip = "HAVUZ";
                let renk = BIRIM_RENKLERI[b] || "#64748b";
                if(b.includes("MCR")) tip = "DONGU8"; 
                if(b.includes("INGEST")) tip = "DONGU6"; 
                if(b === UNITS.PLAYOUT || b === UNITS.SES || b === UNITS.KJ) tip = "GRUP_ABC"; 
                state.birimAyarlari[b] = { tip: tip, renk: renk };
            });
        }
        if(!state.saatAyarlari) state.saatAyarlari = {};
    }

    async function enterSystem(role) { 
        if (role === 'admin') { 
            const email = prompt("Y√∂netici E-posta:"); const password = prompt("Y√∂netici ≈ûifresi:"); 
            if (!email || !password) return; 
            try { await firebase.auth().signInWithEmailAndPassword(email, password); isAdmin = true; await hassasAyarlariYukle(); document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex'); document.getElementById('persTalepArea').style.display = 'none'; checkUrlActions(); alert("Y√∂netici giri≈üi ba≈üarƒ±lƒ±!"); } catch (error) { alert("Hatalƒ± giri≈ü: " + error.message); return; } 
        } else { 
            isAdmin = false; 
            try { const snap = await database.ref('vardiya_data').once('value'); if(snap.exists()) { state = snap.val(); verileriGuvenliHaleGetir(); save(); } } catch(e) { console.log("Veri √ßekilemedi: " + e.message); }
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none'); document.getElementById('persTalepArea').style.display = 'block'; 
        } 
        document.getElementById('loginOverlay').style.opacity = '0'; setTimeout(() => { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('appMain').style.display = 'block'; tabloyuOlustur(); }, 500); 
    }
    
    function checkUrlActions() { const urlParams = new URLSearchParams(window.location.search); const action = urlParams.get('action'); const talepId = urlParams.get('id'); if((action === 'onay' || action === 'red') && talepId) { talepIslem(talepId, action); window.history.replaceState({}, document.title, window.location.pathname); } }
    function talepModalAc() { const sel = document.getElementById('talepPersonel'); sel.innerHTML = state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join(''); document.getElementById('talepModal').style.display = 'flex'; }
    function talepGonder() { const ad = document.getElementById('talepPersonel').value; const tarih = document.getElementById('talepTarih').value; const tur = document.getElementById('talepTuru').value; if(!tarih) { alert("L√ºtfen tarih se√ßin!"); return; } const secilenTarih = new Date(tarih); const pzt = getMonday(secilenTarih); const hKey = getDateKey(pzt); const gunIdx = (secilenTarih.getDay() + 6) % 7; const talepId = Date.now().toString(); database.ref('talepler/' + talepId).set({ id: talepId, ad, tarih, gunIdx, tur, hKey, durum: "bekliyor" }); alert("Talebiniz y√∂neticiye iletildi."); document.getElementById('talepModal').style.display = 'none'; }
    function talepleriYukle() { database.ref('talepler').orderByChild('durum').equalTo('bekliyor').on('value', snap => { const liste = document.getElementById('gelenTaleplerListesi'); if(!snap.exists()) { liste.innerHTML = "<p style='text-align:center; padding:20px; opacity:0.5;'>Bekleyen talep bulunmuyor.</p>"; return; } let html = ""; snap.forEach(item => { const t = item.val(); html += `<div style="background:var(--card-bg); border:1px solid var(--border); border-left:5px solid var(--warning); padding:12px; border-radius:8px; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,0.05);"><div style="font-weight:800; color:var(--primary); font-size:12px; margin-bottom:4px;">${t.ad}</div><div style="font-size:11px; margin-bottom:8px;">üìÖ ${t.tarih} (Hafta: ${t.hKey})<br>üìù ƒ∞stek: <b>${t.tur}</b></div><div style="display:flex; gap:8px;"><button onclick="talepIslem('${t.id}', 'onay')" style="flex:1; background:var(--success); color:white; border:none; border-radius:6px; padding:8px; cursor:pointer; font-weight:700; font-size:10px;">ONAYLA</button><button onclick="talepIslem('${t.id}', 'red')" style="flex:1; background:var(--danger); color:white; border:none; border-radius:6px; padding:8px; cursor:pointer; font-weight:700; font-size:10px;">REDDET</button></div></div>`; }); liste.innerHTML = html; }); }
    function talepIslem(id, tip) { database.ref('talepler/' + id).once('value', snap => { if(!snap.exists()) return; const t = snap.val(); if(tip === 'onay') { const mKey = `${t.hKey}_${t.ad}_${t.gunIdx}`; state.manuelAtamalar[mKey] = t.tur; save(); currentMonday = new Date(t.hKey); tabloyuOlustur(); database.ref('talepler/' + id).update({ durum: 'onaylandi' }); alert(`‚úÖ ${t.ad} i√ßin talep ONAYLANDI.`); logKoy(`${t.ad} i√ßin talep onaylandƒ±: ${t.tur}`); } else { database.ref('talepler/' + id).update({ durum: 'reddedildi' }); alert("Talep reddedildi."); logKoy(`${t.ad} i√ßin talep reddedildi.`); } }); }
    function getMonday(d) { d = new Date(d); let day = d.getDay(); return new Date(d.setDate(d.getDate() - day + (day == 0 ? -6 : 1))); }
    function save() { Object.keys(state).forEach(k => localStorage.setItem(PREFIX + k, JSON.stringify(state[k]))); }
    function getBirimColor(birim) { if(state.birimAyarlari && state.birimAyarlari[birim]) return state.birimAyarlari[birim].renk; return BIRIM_RENKLERI[birim] || "#64748b"; }
    function getGecerliBirim(p, g) { let d = new Date(currentMonday); d.setDate(d.getDate() + g); const dateKey = getDateKey(d); const key = `${dateKey}_${p.ad}`; return state.geciciGorevler[key] || p.birim; }
    
    function logKoy(mesaj) {
        if(!state.logs) state.logs = [];
        const zaman = new Date().toLocaleString('tr-TR');
        const user = firebase.auth().currentUser ? firebase.auth().currentUser.email : "Anonim";
        state.logs.unshift({zaman, user, mesaj});
        if(state.logs.length > 200) state.logs.pop(); 
        save(); refreshUI();
    }
    
    // --- EKSƒ∞K OLAN KRƒ∞Tƒ∞K FONKSƒ∞YONLAR ---
    function cikisYap() {
        firebase.auth().signOut().then(() => {
            location.reload(); 
        });
    }

    function degisimiUygula() {
        const pKaynakAd = document.getElementById('swapKaynakPersonel').value; 
        const pHedefAd = document.getElementById('swapHedefPersonel').value;   
        if(!pKaynakAd || !pHedefAd) { alert("L√ºtfen iki personeli de se√ßiniz."); return; }
        if(pKaynakAd === pHedefAd) { alert("Aynƒ± personeli se√ßemezsiniz."); return; }
        
        const checkboxes = document.querySelectorAll('.swap-day-cb:checked');
        if(checkboxes.length === 0) { alert("L√ºtfen en az bir g√ºn se√ßiniz."); return; }
        
        const selectedDays = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a,b) => a-b);
        const hKey = getDateKey(currentMonday);

        selectedDays.forEach(gunIdx => {
             const pKaynak = state.personeller.find(p => p.ad === pKaynakAd);
             const hedefBirim = pKaynak.birim;
             
             let d = new Date(currentMonday); d.setDate(d.getDate() + gunIdx);
             const dateKey = getDateKey(d);
             const gKey = `${dateKey}_${pHedefAd}`;
             
             if(!state.geciciGorevler) state.geciciGorevler = {};
             state.geciciGorevler[gKey] = hedefBirim;
             
             const kLeaving = `${hKey}_${pKaynakAd}_${gunIdx}`;
             const kEntering = `${hKey}_${pHedefAd}_${gunIdx}`;
             
             let shift = vardiyaBul(pKaynakAd, gunIdx);
             if (shift && shift !== SHIFTS.IZIN && shift !== SHIFTS.BOS) { state.manuelAtamalar[kEntering] = shift; }
             state.manuelAtamalar[kLeaving] = SHIFTS.IZIN;
        });

        const lastDayIdx = selectedDays[selectedDays.length - 1];
        let returnDate = new Date(currentMonday); returnDate.setDate(returnDate.getDate() + lastDayIdx + 1); 
        const rHKey = getDateKey(getMonday(returnDate));
        const rDayIdx = (returnDate.getDay() + 6) % 7;
        const returnKey = `${rHKey}_${pHedefAd}_${rDayIdx}`;
        state.manuelAtamalar[returnKey] = SHIFTS.IZIN;
        
        save();
        alert(`‚úÖ Deƒüi≈üim ba≈üarƒ±yla uygulandƒ±.`);
        logKoy(`${pKaynakAd} <-> ${pHedefAd} SWAP i≈ülemi yapƒ±ldƒ±.`);
        refreshUI();
        tabloyuOlustur();
        
        // Temizlik
        document.querySelectorAll('.swap-day-cb').forEach(cb => cb.checked = false);
        document.getElementById('swapKaynakPersonel').value = "";
        document.getElementById('swapHedefPersonel').value = "";
    }

    function tumDegisimleriTemizle() {
        if(confirm("T√ºm ge√ßici birim deƒüi≈üiklikleri silinecek. Emin misiniz?")) {
            state.geciciGorevler = {};
            save();
            refreshUI();
            tabloyuOlustur();
        }
    }

    function arsivleVeTemizle() {
        if(!isAdmin) return;
        if(!confirm("30 g√ºnden eski veriler silinsin mi?")) return;
        jsonYedekAl();
        const bugun = new Date();
        const sinirTarih = new Date();
        sinirTarih.setDate(bugun.getDate() - 30); 
        let silinenSayisi = 0;
        
        Object.keys(state.manuelAtamalar).forEach(key => {
            const tarihStr = key.split('_')[0]; 
            const kayitTarihi = new Date(tarihStr);
            if(kayitTarihi < sinirTarih) {
                delete state.manuelAtamalar[key];
                silinenSayisi++;
            }
        });
        
        if(state.geciciGorevler) {
            Object.keys(state.geciciGorevler).forEach(key => {
                 const tarihStr = key.split('_')[0];
                 const kayitTarihi = new Date(tarihStr);
                 if(kayitTarihi < sinirTarih) {
                     delete state.geciciGorevler[key];
                     silinenSayisi++;
                 }
            });
        }
        
        save();
        bulutaKaydet();
        alert(`Temizlik tamamlandƒ±. ${silinenSayisi} kayƒ±t silindi.`);
        tabloyuOlustur();
    }
    // ---------------------------------------------

    function tabloyuOlustur() { 
        if(state.duyuruMetni) { document.getElementById('duyuruAlani').style.display = 'block'; document.getElementById('duyuruMetniSpan').innerText = state.duyuruMetni; } else { document.getElementById('duyuruAlani').style.display = 'none'; }
        const hKey = getDateKey(currentMonday); document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} Haftasƒ±`; document.getElementById("tableHeader").innerHTML = `<tr><th style="width:100px;">SAAT</th>${GUNLER.map((g, i) => { let d = new Date(currentMonday); d.setDate(d.getDate() + i); let dateStr = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }); return `<th class="${i>=5?'weekend-col':''}">${g}<div style="font-size:9px; opacity:0.7; font-weight:normal;">${dateStr}</div></th>`; }).join('')}</tr>`;
        let prog = {}; let calis = {}; state.personeller.forEach(p => { prog[p.ad] = Array(7).fill(null); calis[p.ad] = 0; for(let i=0; i<7; i++) { let mKey = `${hKey}_${p.ad}_${i}`; if(state.manuelAtamalar[mKey]) prog[p.ad][i] = state.manuelAtamalar[mKey]; if(prog[p.ad][i] && ![SHIFTS.IZIN,SHIFTS.BOS,null,SHIFTS.YILLIK].includes(prog[p.ad][i])) calis[p.ad]++; } });
        document.getElementById("tableBody").innerHTML = state.saatler.map((s, sIdx) => { 
            const ozelRenk = (state.saatAyarlari && state.saatAyarlari[s]) ? state.saatAyarlari[s].renk : null;
            const rowStyle = ozelRenk ? `style="background-color:${ozelRenk}"` : "";
            let rowHtml = `<tr class="row-saat-${sIdx}" ${rowStyle}><td class="saat-col">${s}</td>`; 
            for(let g=0; g<7; g++) { let sortedPers = state.personeller.filter(p => prog[p.ad][g] === s).sort((a, b) => { let birimA = getGecerliBirim(a, g); let birimB = getGecerliBirim(b, g); return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB); }); let cellContent = ""; let lastBirim = ""; sortedPers.forEach((p) => { let gecerliBirim = getGecerliBirim(p, g); let ayiriciClass = (lastBirim !== "" && lastBirim !== gecerliBirim) ? "birim-ayirici" : ""; let clickAttr = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : ""; let dragAttr = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, '${s}')"` : ""; cellContent += `<div class="birim-card ${ayiriciClass}" style="border-left-color:${getBirimColor(gecerliBirim)}; background-color:${getBirimColor(gecerliBirim)}15;" ${dragAttr} ${clickAttr}><span class="birim-tag" style="background:${getBirimColor(gecerliBirim)}">${gecerliBirim}</span><span class="pers-name">${p.ad}</span></div>`; lastBirim = gecerliBirim; }); rowHtml += `<td class="${g>=5?'weekend-col':''}" data-label="${GUNLER[g]}" ondragover="event.preventDefault()" ondrop="drop(event, '${s}', ${g})">${cellContent}</td>`; } return rowHtml + "</tr>"; 
        }).join('');
        document.getElementById("tableFooter").innerHTML = `<tr class="row-izin"><td class="saat-col">ƒ∞Zƒ∞N / BO≈û</td>${[0,1,2,3,4,5,6].map(g => { let sortedPers = state.personeller.filter(p => [SHIFTS.IZIN,SHIFTS.BOS,null,SHIFTS.YILLIK].includes(prog[p.ad][g])).sort((a, b) => { let birimA = getGecerliBirim(a, g); let birimB = getGecerliBirim(b, g); return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB); }); let cellContent = ""; let lastBirim = ""; sortedPers.forEach(p => { let gecerliBirim = getGecerliBirim(p, g); let ayiriciClass = (lastBirim !== "" && lastBirim !== gecerliBirim) ? "birim-ayirici" : ""; let clickAttr = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : ""; let dragAttr = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, 'BO≈û')"` : ""; let isYillik = prog[p.ad][g] === SHIFTS.YILLIK; let bgStyle = isYillik ? 'background:var(--yillik-izin)' : (prog[p.ad][g]===SHIFTS.IZIN?'background:var(--danger)':`background:${getBirimColor(gecerliBirim)}`); let countStyle = calis[p.ad] >= 6 ? 'color:red; font-weight:bold; font-size:11px;' : ''; cellContent += `<div class="birim-card ${ayiriciClass}" style="border-left-color:${getBirimColor(gecerliBirim)};" ${dragAttr} ${clickAttr}><span class="birim-tag" style="${bgStyle}">${prog[p.ad][g] || 'BO≈û'}</span><span class="pers-name">${p.ad} <span style="${countStyle}">(${calis[p.ad]}G)</span></span></div>`; lastBirim = gecerliBirim; }); return `<td class="${g>=5?'weekend-col':''}" data-label="${GUNLER[g]}" ondragover="event.preventDefault()" ondrop="drop(event, 'BO≈û', ${g})">${cellContent}</td>`; }).join('')}</tr>`;
        let yorgunlar = []; state.personeller.forEach(p => { if(calis[p.ad] >= 6) yorgunlar.push(`<b>${p.ad}</b> (${calis[p.ad]} G√ºn)`); });
        const uyariDiv = document.getElementById('yorgunlukUyari'); if(yorgunlar.length > 0) { uyariDiv.innerHTML = "‚ö†Ô∏è Dƒ∞KKAT (6-7 G√ºn √áalƒ±≈üanlar): " + yorgunlar.join(", "); uyariDiv.style.display = 'block'; } else { uyariDiv.style.display = 'none'; }
        istatistikleriHesapla(); mobilListeyiGuncelle();
    }
    
    function cakismaKontrol(personelAd, hedefGun, hedefSaat) { const hKey = getDateKey(currentMonday); if ([SHIFTS.IZIN, SHIFTS.BOS, null, SHIFTS.YILLIK].includes(hedefSaat)) return; if (hedefGun > 0) { let dunKey = `${hKey}_${personelAd}_${hedefGun - 1}`; let dunVardiya = state.manuelAtamalar[dunKey]; let sabahVardiyalari = [SHIFTS.SABAH, SHIFTS.GUNDUZ]; let aksamVardiyalari = [SHIFTS.AKSAM, SHIFTS.GECE]; if (aksamVardiyalari.includes(dunVardiya) && sabahVardiyalari.includes(hedefSaat)) alert(`‚ö†Ô∏è Dƒ∞KKAT: ${personelAd} d√ºn AK≈ûAM/GECE vardiyasƒ±ndaydƒ±. Bug√ºn SABAH vardiyasƒ±na yazƒ±yorsunuz. Dinlenme s√ºresi yetersiz olabilir!`); } if (hedefGun < 6) { let yarinKey = `${hKey}_${personelAd}_${hedefGun + 1}`; let yarinVardiya = state.manuelAtamalar[yarinKey]; let sabahVardiyalari = [SHIFTS.SABAH, SHIFTS.GUNDUZ]; let aksamVardiyalari = [SHIFTS.AKSAM, SHIFTS.GECE]; if (aksamVardiyalari.includes(hedefSaat) && sabahVardiyalari.includes(yarinVardiya)) alert(`‚ö†Ô∏è Dƒ∞KKAT: ${personelAd} yarƒ±n SABAH vardiyasƒ±nda g√∂r√ºn√ºyor. Bug√ºn AK≈ûAM/GECE vardiyasƒ±na yazƒ±yorsunuz. Dinlenme s√ºresi yetersiz olabilir!`); } }
    function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }
    function seededShuffle(array, seed) { let hash = 0; for (let i = 0; i < seed.length; i++) hash = Math.imul(31, hash) + seed.charCodeAt(i) | 0; let rng = mulberry32(hash); let m = array.length, t, i; while (m) { i = Math.floor(rng() * m--); t = array[m]; array[m] = array[i]; array[i] = t; } return array; }
    function yillikIzinIsle() { const pAd = document.getElementById('yillikIzinPersonel').value; const basTarih = document.getElementById('yillikBaslangic').value; const bitTarih = document.getElementById('yillikBitis').value; if(!pAd || !basTarih || !bitTarih) { alert("L√ºtfen t√ºm alanlarƒ± doldurun."); return; } let current = new Date(basTarih); let end = new Date(bitTarih); while(current <= end) { const hKey = getDateKey(getMonday(current)); let jsDay = current.getDay(); let gunIdx = (jsDay + 6) % 7; const mKey = `${hKey}_${pAd}_${gunIdx}`; state.manuelAtamalar[mKey] = SHIFTS.YILLIK; current.setDate(current.getDate() + 1); } save(); tabloyuOlustur(); alert(`${pAd} i√ßin yƒ±llƒ±k izin i≈ülendi.`); logKoy(`${pAd} i√ßin YILLIK ƒ∞Zƒ∞N i≈ülendi (${basTarih} - ${bitTarih})`); document.getElementById('yillikBaslangic').value = ""; document.getElementById('yillikBitis').value = ""; }
    
    function vardiyaUretVeKaydet() {
        if(!isAdmin) return;
        if (state.personeller.length === 0) { alert("Sistemde kayƒ±tlƒ± personel yok! L√ºtfen √∂nce personel ekleyin."); return; }
        if (Object.keys(state.kapasite).length === 0) { alert("Kapasite ayarlarƒ± bo≈ü! L√ºtfen Y√∂netim Paneli > Kapasite sekmesinden vardiya sayƒ±larƒ±nƒ± girin."); return; }

        try {
            const hKey = getDateKey(currentMonday); const prevMonday = new Date(currentMonday); prevMonday.setDate(prevMonday.getDate() - 7); const prevHKey = getDateKey(prevMonday); let tempProg = {}; let calis = {};
            verileriGuvenliHaleGetir();
            
            // 1. TEMƒ∞ZLƒ∞K VE SABƒ∞TLER
            state.personeller.forEach(p => { 
                tempProg[p.ad] = Array(7).fill(null); 
                for(let g=0; g<7; g++) { 
                    let mKey = `${hKey}_${p.ad}_${g}`; 
                    if(state.manuelAtamalar[mKey]) tempProg[p.ad][g] = state.manuelAtamalar[mKey]; 
                } 
                if (state.haftaIciSabitler && state.haftaIciSabitler[p.ad]) { 
                    for(let i=0; i<5; i++) { if(!tempProg[p.ad][i]) tempProg[p.ad][i] = state.haftaIciSabitler[p.ad]; } 
                    if(!tempProg[p.ad][5]) tempProg[p.ad][5] = SHIFTS.IZIN; 
                    if(!tempProg[p.ad][6]) tempProg[p.ad][6] = SHIFTS.IZIN; 
                } 
                if(p.izinGunleri) { 
                    p.izinGunleri.forEach(gi => { if(!tempProg[p.ad][gi]) tempProg[p.ad][gi] = SHIFTS.IZIN; }); 
                } 
            });

            // 2. MCR/INGEST D√ñNG√úLERƒ∞
            const mcrDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.GECE, SHIFTS.GECE, SHIFTS.IZIN, SHIFTS.IZIN];
            const ingestDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.IZIN, SHIFTS.IZIN];
            const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);

            state.personeller.forEach(p => { 
                const birimAyar = state.birimAyarlari[p.birim] || { tip: "HAVUZ" };
                if (birimAyar.tip === "DONGU8" || birimAyar.tip === "DONGU6") {
                    const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
                    const loopArr = (birimAyar.tip === "DONGU8") ? mcrDongu : ingestDongu;
                    const modVal = loopArr.length;
                    for(let g=0; g<7; g++) {
                        if(tempProg[p.ad][g] !== null) continue; 
                        let d = new Date(currentMonday); d.setDate(d.getDate() + g);
                        const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
                        tempProg[p.ad][g] = loopArr[((diffDays + persOfset) % modVal + modVal) % modVal];
                    }
                }
            });

            // 3. GRUP ABC DAƒûITIMI
            const safeAssign = (p, day, shift) => { 
                if (tempProg[p.ad][day] !== null) return;
                if (shift === SHIFTS.IZIN) { tempProg[p.ad][day] = shift; return; }
                const cap = (state.kapasite[`${p.birim}_${shift}`] || [0,0,0,0,0,0,0])[day];
                let currentCount = 0;
                state.personeller.filter(x => x.birim === p.birim).forEach(x => { if(tempProg[x.ad][day] === shift) currentCount++; });
                if (currentCount < cap) tempProg[p.ad][day] = shift; 
            };

            state.birimler.forEach(birim => {
                const ayar = state.birimAyarlari[birim] || { tip: "HAVUZ" }; 
                if (ayar.tip !== "GRUP_ABC") return;
                let personelListesi = state.personeller.filter(p => p.birim === birim); 
                if (personelListesi.length === 0) return;
                let grupA = [], grupB = [], grupC = [];
                personelListesi.forEach((p, index) => { 
                    let gecenPzt = state.manuelAtamalar[`${prevHKey}_${p.ad}_0`]; 
                    if (gecenPzt === SHIFTS.IZIN || gecenPzt === SHIFTS.BOS || !gecenPzt || gecenPzt === SHIFTS.YILLIK) { grupA.push(p); } 
                    else if (gecenPzt === SHIFTS.SABAH || gecenPzt === SHIFTS.GUNDUZ) { grupB.push(p); } 
                    else { grupC.push(p); } 
                });
                if (grupA.length === 0 && grupB.length === 0 && grupC.length === 0) { 
                    personelListesi.forEach((p, i) => { if (i % 3 === 0) grupA.push(p); else if (i % 3 === 1) grupB.push(p); else grupC.push(p); }); 
                }
                grupA.forEach(p => { safeAssign(p,0,SHIFTS.SABAH); safeAssign(p,1,SHIFTS.AKSAM); safeAssign(p,2,SHIFTS.AKSAM); safeAssign(p,3,SHIFTS.IZIN); safeAssign(p,4,SHIFTS.IZIN); safeAssign(p,5,SHIFTS.SABAH); safeAssign(p,6,SHIFTS.SABAH); });
                grupB.forEach(p => { safeAssign(p,0,SHIFTS.AKSAM); safeAssign(p,1,SHIFTS.IZIN); safeAssign(p,2,SHIFTS.IZIN); safeAssign(p,3,SHIFTS.SABAH); safeAssign(p,4,SHIFTS.SABAH); safeAssign(p,5,SHIFTS.AKSAM); safeAssign(p,6,SHIFTS.AKSAM); });
                seededShuffle(grupC, hKey);
                grupC.forEach((p, index) => { 
                    safeAssign(p,0,SHIFTS.IZIN); safeAssign(p,1,SHIFTS.SABAH); safeAssign(p,2,SHIFTS.SABAH); safeAssign(p,3,SHIFTS.AKSAM); safeAssign(p,4,SHIFTS.AKSAM); 
                    if (index % 2 === 0) { 
                        let cmtAksamCap = (state.kapasite[`${birim}_${SHIFTS.AKSAM}`] || [0,0,0,0,0,0,0])[5];
                        if(cmtAksamCap > 0) safeAssign(p,5,SHIFTS.AKSAM); else safeAssign(p,5,SHIFTS.IZIN);
                        safeAssign(p,6,SHIFTS.IZIN); 
                    } else { 
                        safeAssign(p,5,SHIFTS.IZIN); 
                        let pzSabahCap = (state.kapasite[`${birim}_${SHIFTS.SABAH}`] || [0,0,0,0,0,0,0])[6];
                        if(pzSabahCap > 0) safeAssign(p,6,SHIFTS.SABAH); else safeAssign(p,6,SHIFTS.IZIN); 
                    } 
                });
            });

            // --- 4. ZORLAYICI CUMARTESƒ∞ KURTARMA (FORCE RESCUE) ---
            state.birimler.forEach(birim => {
                const ayar = state.birimAyarlari[birim] || { tip: "HAVUZ" }; 
                if (ayar.tip !== "GRUP_ABC") return;
                
                // SABAH KONTROL
                let sabahHedef = (state.kapasite[`${birim}_${SHIFTS.SABAH}`] || [0,0,0,0,0,0,0])[5];
                let gunduzHedef = (state.kapasite[`${birim}_${SHIFTS.GUNDUZ}`] || [0,0,0,0,0,0,0])[5];
                let toplamSabahHedef = sabahHedef + gunduzHedef;
                let mevcutSabah = state.personeller.filter(p => p.birim === birim && (tempProg[p.ad][5] === SHIFTS.SABAH || tempProg[p.ad][5] === SHIFTS.GUNDUZ)).length;

                if (mevcutSabah < toplamSabahHedef) {
                    // Cuma Sabah/G√ºnd√ºz gelen ve Sabit OLMAYAN adaylarƒ± bul
                    let adaylar = state.personeller.filter(p => 
                        p.birim === birim && 
                        (!state.haftaIciSabitler || !state.haftaIciSabitler[p.ad]) && 
                        (tempProg[p.ad][4] === SHIFTS.SABAH || tempProg[p.ad][4] === SHIFTS.GUNDUZ) &&
                        (tempProg[p.ad][5] !== SHIFTS.SABAH && tempProg[p.ad][5] !== SHIFTS.GUNDUZ)
                    );
                    seededShuffle(adaylar, hKey + "ForceSabah");
                    for (let p of adaylar) {
                        if (mevcutSabah < toplamSabahHedef) {
                            // ZORLA YAZ (Override)
                            let atanacak = (sabahHedef > 0) ? SHIFTS.SABAH : SHIFTS.GUNDUZ;
                            tempProg[p.ad][5] = atanacak;
                            // Pazar g√ºn√ºne DOKUNMA (Normal d√∂ng√º kalsƒ±n)
                            mevcutSabah++;
                            if (sabahHedef > 0) sabahHedef--;
                        }
                    }
                }

                // AK≈ûAM KONTROL
                let aksamHedef = (state.kapasite[`${birim}_${SHIFTS.AKSAM}`] || [0,0,0,0,0,0,0])[5];
                let mevcutAksam = state.personeller.filter(p => p.birim === birim && tempProg[p.ad][5] === SHIFTS.AKSAM).length;

                if (mevcutAksam < aksamHedef) {
                    // Cuma Ak≈üam gelen ve Sabit OLMAYAN adaylarƒ± bul
                    let adaylar = state.personeller.filter(p => 
                        p.birim === birim && 
                        (!state.haftaIciSabitler || !state.haftaIciSabitler[p.ad]) && 
                        tempProg[p.ad][4] === SHIFTS.AKSAM &&
                        tempProg[p.ad][5] !== SHIFTS.AKSAM
                    );
                    seededShuffle(adaylar, hKey + "ForceAksam");
                    for (let p of adaylar) {
                        if (mevcutAksam < aksamHedef) {
                            // ZORLA YAZ
                            tempProg[p.ad][5] = SHIFTS.AKSAM;
                            // Pazar g√ºn√ºne DOKUNMA
                            mevcutAksam++;
                        }
                    }
                }
            });

            // 5. GENEL YAMA (Eksikleri Tamamla)
            state.personeller.forEach(p => { calis[p.ad] = 0; for(let g=0; g<7; g++) { if(tempProg[p.ad][g] && ![SHIFTS.IZIN,SHIFTS.BOS,null,SHIFTS.YILLIK].includes(tempProg[p.ad][g])) calis[p.ad]++; } });
            
            state.birimler.forEach(birim => {
                const ayar = state.birimAyarlari[birim] || { tip: "HAVUZ" }; 
                if (ayar.tip !== "GRUP_ABC") return;
                for (let gun = 0; gun < 7; gun++) { 
                    state.saatler.forEach(saat => { 
                        if(saat === SHIFTS.IZIN) return;
                        const hedef = (state.kapasite[`${birim}_${saat}`] || [0,0,0,0,0,0,0])[gun]; 
                        let mevcut = state.personeller.filter(p => getGecerliBirim(p, gun) === birim && tempProg[p.ad][gun] === saat).length; 
                        if (mevcut < hedef) { 
                            let yedekAdaylar = state.personeller.filter(p => { 
                                let birimUygun = getGecerliBirim(p, gun) === birim; 
                                let musait = (tempProg[p.ad][gun] === null || tempProg[p.ad][gun] === SHIFTS.IZIN); 
                                let yorgunDegil = calis[p.ad] < 6; 
                                let sabitDegil = (!state.haftaIciSabitler || !state.haftaIciSabitler[p.ad]); 
                                return birimUygun && musait && yorgunDegil && sabitDegil; 
                            }); 
                            seededShuffle(yedekAdaylar, hKey + "yedek"); 
                            for (let p of yedekAdaylar) { 
                                if (mevcut < hedef) { tempProg[p.ad][gun] = saat; calis[p.ad]++; mevcut++; } 
                            } 
                        } 
                    }); 
                }
            });

            // KAYIT VE Bƒ∞Tƒ∞≈û
            state.personeller.forEach(p => { for(let g=0; g<7; g++) { if(tempProg[p.ad][g] === null) tempProg[p.ad][g] = SHIFTS.IZIN; } });
            state.personeller.forEach(p => { for(let i=0; i<7; i++) if(tempProg[p.ad][i]) state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] = tempProg[p.ad][i]; });
            save(); logKoy("Otomatik vardiya olu≈üturuldu."); tabloyuOlustur(); alert("‚úÖ Vardiya ba≈üarƒ±yla olu≈üturuldu.");
        } catch (error) {
            console.error("Vardiya √úretme Hatasƒ±:", error);
            alert("HATA OLU≈ûTU: " + error.message);
        }
    }

    function excelIndir() {
        const hKey = getDateKey(currentMonday);
        let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>
            table { border-collapse: collapse; font-family: Arial; } td { border: 1px solid #000; text-align: center; padding: 4px; font-size: 8pt; }
            .title { background: #312e81; color: white; font-weight: bold; font-size: 12pt; }
            .header { background: #1e1b4b; color: white; font-weight: bold; }
            .saat-0630 { background: #ffff00; font-weight: bold; }
            .saat-0900 { background: #00b0f0; color: white; font-weight: bold; }
            .saat-1600 { background: #7030a0; color: white; font-weight: bold; }
            .saat-0000 { background: #ed7d31; color: white; font-weight: bold; }
            .saat-izin { background: #ff0000; color: white; font-weight: bold; }
        </style></head><body><table><tr><th colspan="8" class="title">TEKNƒ∞K PERSONEL √áALI≈ûMA Lƒ∞STESƒ∞</th></tr>
        <tr><th class="header">SAAT</th>`;
        GUNLER.forEach((g, i) => {
            let d = new Date(currentMonday); d.setDate(d.getDate() + i);
            let dateStr = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            html += `<th class="header">${g}<br>${dateStr}</th>`;
        });
        html += `</tr>`;
        state.birimler.forEach(birim => {
            html += `<tr><td colspan="8" style="background:${getBirimColor(birim)}; color:white; font-weight:bold;">${birim}</td></tr>`;
            [...state.saatler, "ƒ∞Zƒ∞N"].forEach(s => {
                let pByDay = []; let maxRow = 1;
                for(let i=0; i<7; i++) {
                    let list = state.personeller.filter(p => {
                        let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`];
                        if(s === "ƒ∞Zƒ∞N") return p.birim === birim && (v === SHIFTS.IZIN || v === SHIFTS.BOS || !v || v === SHIFTS.YILLIK);
                        return p.birim === birim && v === s;
                    });
                    pByDay[i] = list; if(list.length > maxRow) maxRow = list.length;
                }
                let cls = s.includes("06:30") ? "saat-0630" : s.includes("09:00") ? "saat-0900" : s.includes("16:00") ? "saat-1600" : s.includes("00:00") ? "saat-0000" : s === "ƒ∞Zƒ∞N" ? "saat-izin" : "";
                const ozelRenk = (state.saatAyarlari && state.saatAyarlari[s]) ? state.saatAyarlari[s].renk : null;
                const cellStyle = ozelRenk ? `style="background-color:${ozelRenk}"` : "";
                for(let r=0; r<maxRow; r++) {
                    html += `<tr>${r===0 ? `<td rowspan="${maxRow}" class="${cls}" ${cellStyle}>${s}</td>`:""}${pByDay.map(d => `<td ${cellStyle}>${d[r]?d[r].ad:""}</td>`).join('')}</tr>`;
                }
            });
        });
        html += `</table></body></html>`;
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `Vardiya_${hKey}.xls`; a.click();
    }

    function ulastirmaExcelIndir() {
        const hKey = getDateKey(currentMonday);
        let html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: 'Calibri', sans-serif; font-size: 11pt; background-color: #eff6ff; }
                table { border-collapse: collapse; width: 100%; table-layout: fixed; background-color: #eff6ff; }
                td, th { border: 1px solid #000000; text-align: center; vertical-align: middle; padding: 5px; }
                .header-main { background-color: #881337; color: #ffffff; font-weight: bold; font-size: 14pt; height: 40px; }
                .header-day { background-color: #881337; color: #ffffff; font-weight: bold; font-size: 11pt; height: 30px; }
                .time-col { background-color: #881337; color: #ffffff; font-weight: bold; width: 80px; text-align: center; vertical-align: middle; font-size: 12pt; }
                .shift-06 { background-color: #dbeafe; color: #000000; font-weight: bold; }
                .shift-09 { background-color: #93c5fd; color: #000000; font-weight: bold; }
                .shift-16 { background-color: #3b82f6; color: #ffffff; font-weight: bold; }
                .shift-00 { background-color: #1e3a8a; color: #ffffff; font-weight: bold; }
                .shift-off { background-color: #fca5a5; color: #000000; }
                .name-box { margin-bottom: 2px; font-size: 10pt; display: block; }
                .unit-label { font-size: 7pt; opacity: 0.8; display: block; margin-bottom: 2px; font-style: italic; }
            </style>
        </head>
        <body>
            <table>
                <tr>
                    <th class="header-main">SAAT</th>
                    ${GUNLER.map((g, i) => {
                        let d = new Date(currentMonday);
                        d.setDate(d.getDate() + i);
                        let dateStr = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        return `<th class="header-day">${dateStr}<br>${g.toUpperCase()}</th>`;
                    }).join('')}
                </tr>`;

        state.saatler.forEach(s => {
            let bgClass = "shift-06"; 
            if(s.includes("09:00")) bgClass = "shift-09";
            if(s.includes("16:00")) bgClass = "shift-16";
            if(s.includes("00:00")) bgClass = "shift-00";

            html += `<tr>`;
            html += `<td class="time-col">${s.split('‚Äì')[0]}<br><span style="font-size:8pt;">${s.split('‚Äì')[1]}</span></td>`;

            for(let i=0; i<7; i++) {
                let calisanlar = state.personeller.filter(p => {
                    let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`];
                    if (v === SHIFTS.IZIN || v === SHIFTS.BOS || v === SHIFTS.YILLIK || !v) return false;
                    return v === s;
                });

                calisanlar.sort((a, b) => {
                    let birimA = getGecerliBirim(a, i);
                    let birimB = getGecerliBirim(b, i);
                    return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB);
                });

                let cellContent = calisanlar.map(p => {
                    let birim = getGecerliBirim(p, i);
                    return `<span class="name-box">${p.ad} <span class="unit-label">(${birim})</span></span>`;
                }).join('<br>');

                html += `<td class="${bgClass}">${cellContent}</td>`;
            }
            html += `</tr>`;
        });

        html += `<tr><td class="time-col" style="background-color:#991b1b;">ƒ∞Zƒ∞N</td>`;
        for(let i=0; i<7; i++) {
            let izinliler = state.personeller.filter(p => {
                let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`];
                return (v === SHIFTS.IZIN || v === SHIFTS.BOS || !v || v === SHIFTS.YILLIK);
            });
            
            let cellContent = izinliler.map(p => {
                let v = state.manuelAtamalar[`${hKey}_${p.ad}_${i}`];
                let ek = v === SHIFTS.YILLIK ? " (YILLIK)" : "";
                return `<span class="name-box">${p.ad}${ek}</span>`;
            }).join('<br>');
            
            html += `<td class="shift-off">${cellContent}</td>`;
        }
        html += `</tr>`;

        html += `</table></body></html>`;
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Ulastirma_Listesi_${hKey}.xls`;
        a.click();
    }

    function toggleAdminPanel() { 
        if(!isAdmin) return;
        const p = document.getElementById("sidePanel"); 
        const o = document.getElementById("panelOverlay"); 
        p.classList.toggle("open"); 
        o.style.display = p.classList.contains("open") ? "block" : "none"; 
        if(p.classList.contains("open")) tabDegistir('personel'); 
    }
    
    function tabDegistir(t) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab-' + t).classList.remove('hidden'); document.getElementById('btn-tab-' + t).classList.add('active'); refreshUI(); }
    
    /* FIX: Sayfayƒ± yenilemek yerine State'i g√ºncelleyen yeni versiyon */
    function bulutaKaydet() { database.ref('vardiya_data').set(state).then(() => alert("Kaydedildi!")).catch(e => alert(e.message)); }
    function buluttanYukle() { 
        if(!isAdmin) return;
        database.ref('vardiya_data').once('value').then(snap => { 
            if(snap.exists()){ 
                state = snap.val(); 
                verileriGuvenliHaleGetir(); // G√úVENLƒ∞K KONTROL√ú
                save(); 
                tabloyuOlustur(); 
                refreshUI();
                alert("Veriler buluttan y√ºklendi ve ekran g√ºncellendi!");
            } else {
                alert("Bulutta veri bulunamadƒ±.");
            }
        }).catch(e => alert("Hata: " + e.message)); 
    }
    
    function loglariTemizle() {
        if(confirm("Loglar silinsin mi?")) {
            state.logs = [];
            save();
            refreshUI();
        }
    }

    function istatistikleriHesapla() {
        const hKey = getDateKey(currentMonday);
        let stats = {};
        
        state.personeller.forEach(p => {
            stats[p.ad] = { toplamGun: 0, gece: 0, haftasonu: 0, swap: 0 };
            
            for(let i=0; i<7; i++) {
                let mKey = `${hKey}_${p.ad}_${i}`;
                let v = state.manuelAtamalar[mKey];
                
                if(v && ![SHIFTS.IZIN, SHIFTS.BOS, null, SHIFTS.YILLIK].includes(v)) {
                    stats[p.ad].toplamGun++;
                    if(v === SHIFTS.GECE) stats[p.ad].gece++;
                    if(i >= 5) stats[p.ad].haftasonu++;
                }
            }
        });
        
        let html = "<table style='width:100%; border-collapse:collapse;'><tr><th style='text-align:left; border-bottom:1px solid #ccc;'>Personel</th><th style='border-bottom:1px solid #ccc;'>G√ºn</th><th style='border-bottom:1px solid #ccc;'>Gece</th><th style='border-bottom:1px solid #ccc;'>H.Sonu</th></tr>";
        
        Object.keys(stats).sort().forEach(ad => {
            const s = stats[ad];
            html += `<tr style='border-bottom:1px solid #eee;'>
                <td style='padding:4px;'>${ad}</td>
                <td style='text-align:center;'>${s.toplamGun}</td>
                <td style='text-align:center; font-weight:bold; color:${s.gece>0?'red':'black'}'>${s.gece}</td>
                <td style='text-align:center; color:blue;'>${s.haftasonu}</td>
            </tr>`;
        });
        html += "</table>";
        document.getElementById('istatistikListesi').innerHTML = html;
    }

    function duyuruGuncelle() {
        const yeniMetin = document.getElementById('adminDuyuruInp').value;
        state.duyuruMetni = yeniMetin;
        save();
        bulutaKaydet(); 
        alert("Duyuru g√ºncellendi!");
        tabloyuOlustur();
    }

    function odakModuAc() {
        const ad = prompt("ƒ∞sminiz nedir? (Tam e≈üle≈üme gerekir)");
        if(!ad) {
            document.body.classList.remove('focus-active');
            document.querySelectorAll('.birim-card').forEach(el => el.classList.remove('focused'));
            return;
        }
        
        document.body.classList.add('focus-active');
        document.querySelectorAll('.birim-card').forEach(el => {
            if(el.querySelector('.pers-name').innerText.includes(ad)) {
                el.classList.add('focused');
            } else {
                el.classList.remove('focused');
            }
        });
    }

    function refreshUI() {
        document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
        document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => {
            let mcrHtml = "";
            if(p.birim.includes("MCR") || p.birim.includes("INGEST")) {
                mcrHtml = `<div class="mcr-ayarlar">
                    <span>${p.birim.includes("INGEST") ? 'INGEST' : 'MCR'} D√∂ng√º Ofseti: </span>
                    <input type="number" value="${state.mcrAyarlari.ofsetler[p.ad] || 0}" style="width:40px" onchange="mcrOfsetGuncelle('${p.ad}', this.value)">
                </div>`;
            }
            let yuzdeHtml = `<div style="margin-top:5px; font-size:10px;">
                <span style="font-weight:bold;">Vardiya √ñncelik Puanƒ± (%):</span>
                <input type="number" value="${p.yuzde || 0}" style="width:50px; padding:3px; border-radius:4px; border:1px solid #ccc;" onchange="yuzdeGuncelle(${i}, this.value)">
            </div>`;

            return `<div style="background:var(--card-bg); padding:10px; border-radius:8px; border:1px solid var(--border); box-shadow:0 2px 5px rgba(0,0,0,0.05); margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span><strong>${p.ad}</strong> <small style="color:#64748b">(${p.birim})</small></span>
                    <button onclick="state.personeller.splice(${i},1); save(); refreshUI(); tabloyuOlustur();" style="color:var(--danger); border:none; background:none; cursor:pointer;">Sil</button>
                </div>
                <div style="margin-top:5px;">${GUNLER.map((g, gi) => `<span class="izin-gun-pill ${p.izinGunleri?.includes(gi)?'active':''}" onclick="izinGunuTetikle(${i},${gi})">${g}</span>`).join('')}</div>
                ${yuzdeHtml}
                ${mcrHtml}
            </div>`;
        }).join('');
        
        const swapKaynak = document.getElementById('swapKaynakPersonel');
        const swapHedef = document.getElementById('swapHedefPersonel');
        const optionsHtml = "<option value=''>Se√ßiniz...</option>" + state.personeller.sort((a,b) => a.ad.localeCompare(b.ad)).map(p => `<option value="${p.ad}">${p.ad} (${p.birim})</option>`).join('');
        if(swapKaynak) swapKaynak.innerHTML = optionsHtml;
        if(swapHedef) swapHedef.innerHTML = optionsHtml;
        
        const yillikSel = document.getElementById('yillikIzinPersonel');
        if(yillikSel) yillikSel.innerHTML = optionsHtml;

        if(!state.geciciGorevler) state.geciciGorevler = {};
        let degisimHtml = "<strong>Aktif Deƒüi≈üimler (Bu Hafta):</strong><br>";
        let hasDegisim = false;
        Object.keys(state.geciciGorevler).forEach(k => {
            const [dateStr, pName] = k.split('_');
            const targetUnit = state.geciciGorevler[k];
            let d = new Date(dateStr);
            let nextMonday = new Date(currentMonday); nextMonday.setDate(nextMonday.getDate() + 7);
            
            if(d >= currentMonday && d < nextMonday) {
                degisimHtml += `<div style="font-size:10px; border-bottom:1px solid #eee; padding:2px;">üìÖ ${dateStr} - <b>${pName}</b> ‚û°Ô∏è ${targetUnit}</div>`;
                hasDegisim = true;
            }
        });
        document.getElementById("aktifDegisimlerListesi").innerHTML = hasDegisim ? degisimHtml : "<div style='font-size:10px; color:#999;'>Bu hafta i√ßin aktif deƒüi≈üim yok.</div>";

        if(state.logs) {
            document.getElementById('logListesi').innerHTML = state.logs.map(l => 
                `<div class="log-item"><span>${l.mesaj} <br><i style="color:#666">(${l.user})</i></span> <span class="log-time">${l.zaman}</span></div>`
            ).join('');
        }

        document.getElementById('adminDuyuruInp').value = state.duyuruMetni || "";

        let capHtml = ""; state.birimler.forEach(b => { 
            capHtml += `<div style="margin-bottom:15px; background:var(--card-bg); padding:10px; border-radius:8px; border:1px solid var(--border);"><strong>${b}</strong>`; 
            capHtml += `<div style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px; margin-bottom:2px; font-size:9px; font-weight:bold; text-align:center;"><span>Pzt</span><span>Sal</span><span>√áar</span><span>Per</span><span>Cum</span><span>Cmt</span><span>Paz</span></div>`;
            state.saatler.forEach(s => { const v = state.kapasite[`${b}_${s}`] || [0,0,0,0,0,0,0]; capHtml += `<div style="font-size:9px; margin-top:5px; color:#64748b;">${s}</div><div style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px;">${GUNLER.map((g, gi) => `<input type="number" value="${v[gi]}" style="width:100%; text-align:center; padding:4px; border:1px solid #e2e8f0; border-radius:4px;" onchange="capUp('${b}_${s}',${gi},this.value)">`).join('')}</div>`});capHtml+=`</div>`});document.getElementById("kapasiteTable").innerHTML=capHtml;
        
        let mcrSistemHtml = `<div style="background:#e0f2fe; padding:10px; border-radius:8px; margin-bottom:10px; color:#334155;">
            <strong>MCR/INGEST D√∂ng√º Ba≈ülangƒ±√ß Tarihi:</strong><br>
            <input type="date" value="${state.mcrAyarlari.baslangicTarihi}" onchange="state.mcrAyarlari.baslangicTarihi = this.value; save();" style="width:96%; padding:5px; margin-top:5px; border-radius:4px; border:1px solid #ccc;">
        </div>`;
        
        document.getElementById("sabitListeAdmin").innerHTML = mcrSistemHtml + state.personeller.filter(p => !p.birim.includes("MCR") && !p.birim.includes("INGEST")).map(p => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:var(--card-bg); padding:8px; border-radius:5px; border:1px solid #eee;"><label><input type="checkbox" ${state.haftaIciSabitler[p.ad]?'checked':''} onchange="sabitTetikle('${p.ad}')"> ${p.ad}</label><select onchange="sabitSaatGuncelle('${p.ad}', this.value)" ${!state.haftaIciSabitler[p.ad]?'disabled':''} style="border:1px solid #ccc; border-radius:4px;">${state.saatler.map(s => `<option value="${s}" ${state.haftaIciSabitler[p.ad] === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`).join('');
        
        document.getElementById("birimListesiAdmin").innerHTML = `
            <div style="margin-bottom:10px; display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                <input type="text" id="yeniBirimInp" placeholder="Yeni Birim Adƒ±" style="flex:1; padding:8px; border-radius:4px; border:1px solid #ccc; min-width:120px;">
                <input type="color" id="yeniBirimRenk" value="#3b82f6" style="width:40px; height:35px; border:none; border-radius:4px; cursor:pointer;" title="Birim Rengi">
                <select id="yeniBirimTipi" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                    <option value="HAVUZ">Standart (Havuz)</option>
                    <option value="GECE_ONCELIKLI">üåô Gece √ñncelikli (Puanlƒ±)</option>
                    <option value="DONGU8">MCR Tipi (8'li D√∂ng√º)</option>
                    <option value="DONGU6">Ingest Tipi (6'lƒ± D√∂ng√º)</option>
                    <option value="GRUP_ABC">3'l√º Grup (Playout/Ses/KJ)</option>
                    <option value="AKILLI_HAFTASONU">Akƒ±llƒ± Haftasonu (Cuma Korumalƒ±)</option>
                </select>
                <button onclick="birimEkle()" class="btn-main-action" style="background:var(--success); padding:8px 12px;">EKLE</button>
            </div>
            <div style="margin-top:5px; font-size:10px; color:#666; margin-bottom:10px;">
                * <b>Standart:</b> Kapasiteye g√∂re bo≈ü olanƒ± atar<br>
                * <b>D√∂ng√º:</b> 7/24 Sƒ±ralƒ± sistem<br>
                * <b>3'l√º Grup:</b> Sabah/Ak≈üam/ƒ∞zin grubu (Playout mantƒ±ƒüƒ±)
            </div>
            ${state.birimler.map((b, i) => {
                let ayar = state.birimAyarlari[b] || {tip:"HAVUZ", renk:"#3b82f6"};
                let tipYazi = ayar.tip === "DONGU8" ? "8'li D√∂ng√º" : 
                             (ayar.tip === "DONGU6" ? "6'lƒ± D√∂ng√º" : 
                             (ayar.tip === "GRUP_ABC" ? "3'l√º Grup" : 
                             (ayar.tip === "AKILLI_HAFTASONU" ? "Akƒ±llƒ± H.Sonu" : 
                             (ayar.tip === "GECE_ONCELIKLI" ? "Gece Puanlƒ±" : "Standart"))));
                return `
                <div style="padding:8px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--card-bg); border-left: 5px solid ${getBirimColor(b)}">
                    <div>
                        <span style="font-weight:bold;">${b}</span>
                        <span style="font-size:9px; background:#eee; padding:2px 4px; border-radius:3px; margin-left:5px; color:#333;">${tipYazi}</span>
                    </div>
                    <button onclick="birimSil(${i})" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:10px;">Sil</button>
                </div>`;
            }).join('')}`;

        // SAAT Lƒ∞STESƒ∞ ADMIN KISMI
        document.getElementById("saatListesiAdmin").innerHTML = `
            <div style="margin-bottom:10px; display:flex; gap:5px;">
                <input type="text" id="yeniSaatInp" placeholder="√ñrn: 10:00‚Äì19:00" style="flex:1; padding:8px; border-radius:4px; border:1px solid #ccc;">
                <button onclick="saatEkle()" class="btn-main-action" style="background:var(--success); padding:5px 10px;">EKLE</button>
            </div>
            ${state.saatler.map((s, i) => {
                let mevcutRenk = (state.saatAyarlari && state.saatAyarlari[s]) ? state.saatAyarlari[s].renk : "#ffffff";
                return `
                <div style="padding:8px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--card-bg);">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="color" value="${mevcutRenk}" onchange="saatRenkGuncelle('${s}', this.value)" style="width:30px; height:30px; border:none; cursor:pointer;" title="Saat Rengini Deƒüi≈ütir">
                        <span>${s}</span>
                    </div>
                    <button onclick="saatSil(${i})" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:10px;">Sil</button>
                </div>
            `}).join('')}`;
    }
    
    // YENƒ∞ EKLENEN SAAT RENGƒ∞ G√úNCELLEME FONKSƒ∞YONU
    function saatRenkGuncelle(saat, renk) {
        if(!state.saatAyarlari) state.saatAyarlari = {};
        if(!state.saatAyarlari[saat]) state.saatAyarlari[saat] = {};
        
        state.saatAyarlari[saat].renk = renk;
        save();
        refreshUI(); // Admin panelini yenile
        tabloyuOlustur(); // Ana tabloyu hemen boya
    }
    
    function vardiyaBul(pAd, gIdx) {
        const hKey = getDateKey(currentMonday);
        const mKey = `${hKey}_${pAd}_${gIdx}`;
        if (state.manuelAtamalar[mKey]) return state.manuelAtamalar[mKey];
        const p = state.personeller.find(pers => pers.ad === pAd);
        if (!p) return null;
        const mcrDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.GECE, SHIFTS.GECE, SHIFTS.IZIN, SHIFTS.IZIN];
        const ingestDongu = [SHIFTS.SABAH, SHIFTS.SABAH, SHIFTS.AKSAM, SHIFTS.AKSAM, SHIFTS.IZIN, SHIFTS.IZIN];
        const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);
        let d = new Date(currentMonday);
        d.setDate(d.getDate() + gIdx);
        
        const birimAyar = state.birimAyarlari[p.birim];
        if (birimAyar && (birimAyar.tip === "DONGU8" || birimAyar.tip === "DONGU6")) {
            const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);
            const loopArr = (birimAyar.tip === "DONGU8") ? mcrDongu : ingestDongu;
            const modVal = loopArr.length;
            const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24));
            return loopArr[((diffDays + persOfset) % modVal + modVal) % modVal];
        }
        
        if (state.haftaIciSabitler[p.ad] && gIdx < 5) return state.haftaIciSabitler[p.ad];
        return null;
    }

    function degisimiUygula() {
        const pKaynakAd = document.getElementById('swapKaynakPersonel').value; 
        const pHedefAd = document.getElementById('swapHedefPersonel').value;   
        if(!pKaynakAd || !pHedefAd) { alert("L√ºtfen iki personeli de se√ßiniz."); return; }
        if(pKaynakAd === pHedefAd) { alert("Aynƒ± personeli se√ßemezsiniz."); return; }
        const checkboxes = document.querySelectorAll('.swap-day-cb:checked');
        if(checkboxes.length === 0) { alert("L√ºtfen en az bir g√ºn se√ßiniz."); return; }
        const selectedDays = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a,b) => a-b);
        const hKey = getDateKey(currentMonday);
        for (let gunIdx of selectedDays) {
            let hedefVardiya = vardiyaBul(pKaynakAd, gunIdx);
            if (hedefVardiya && [SHIFTS.SABAH, SHIFTS.GUNDUZ].includes(hedefVardiya)) {
                let prevVardiya = null;
                if (gunIdx > 0) {
                     prevVardiya = vardiyaBul(pHedefAd, gunIdx - 1);
                } else {
                     let prevDate = new Date(currentMonday); prevDate.setDate(prevDate.getDate() - 1);
                     let prevHKey = getDateKey(getMonday(prevDate));
                     let prevKey = `${prevHKey}_${pHedefAd}_6`; 
                     prevVardiya = state.manuelAtamalar[prevKey];
                }
                if (prevVardiya && [SHIFTS.AKSAM, SHIFTS.GECE].includes(prevVardiya)) {
                     alert(`‚ö†Ô∏è Dƒ∞NLENME KURALI ƒ∞HLALƒ∞!\n\n${pHedefAd} personeli bir √∂nceki g√ºn (${prevVardiya}) √ßalƒ±≈üƒ±yor.\nErtesi g√ºn ${hedefVardiya} vardiyasƒ±na yazƒ±lamaz.\n\nƒ∞≈ülem iptal edildi.`);
                     return; 
                }
            }
        }
        selectedDays.forEach(gunIdx => {
             const pKaynak = state.personeller.find(p => p.ad === pKaynakAd);
             const hedefBirim = pKaynak.birim;
             let d = new Date(currentMonday); d.setDate(d.getDate() + gunIdx);
             const dateKey = getDateKey(d);
             const gKey = `${dateKey}_${pHedefAd}`;
             if(!state.geciciGorevler) state.geciciGorevler = {};
             state.geciciGorevler[gKey] = hedefBirim;
             const kLeaving = `${hKey}_${pKaynakAd}_${gunIdx}`;
             const kEntering = `${hKey}_${pHedefAd}_${gunIdx}`;
             let shift = vardiyaBul(pKaynakAd, gunIdx);
             if (shift && shift !== SHIFTS.IZIN && shift !== SHIFTS.BOS) { state.manuelAtamalar[kEntering] = shift; }
             state.manuelAtamalar[kLeaving] = SHIFTS.IZIN;
        });
        const lastDayIdx = selectedDays[selectedDays.length - 1];
        let returnDate = new Date(currentMonday); returnDate.setDate(returnDate.getDate() + lastDayIdx + 1); 
        const rHKey = getDateKey(getMonday(returnDate));
        const rDayIdx = (returnDate.getDay() + 6) % 7;
        const returnKey = `${rHKey}_${pHedefAd}_${rDayIdx}`;
        state.manuelAtamalar[returnKey] = SHIFTS.IZIN;
        save();
        alert(`‚úÖ Deƒüi≈üim ba≈üarƒ±yla uygulandƒ±.\n\nPersonelin d√∂n√º≈ü g√ºn√º (${returnDate.toLocaleDateString('tr-TR')}) otomatik olarak ƒ∞Zƒ∞NLƒ∞ ayarlandƒ±.`);
        logKoy(`${pKaynakAd} <-> ${pHedefAd} SWAP i≈ülemi yapƒ±ldƒ±.`);
        refreshUI();
        tabloyuOlustur();
        document.querySelectorAll('.swap-day-cb').forEach(cb => cb.checked = false);
        document.getElementById('swapKaynakPersonel').value = "";
        document.getElementById('swapHedefPersonel').value = "";
    }

    function tumDegisimleriTemizle() {
        if(confirm("T√ºm ge√ßici birim deƒüi≈üiklikleri silinecek. Emin misiniz?")) {
            state.geciciGorevler = {};
            save();
            refreshUI();
            tabloyuOlustur();
        }
    }

    function cikisYap() {
        firebase.auth().signOut().then(() => {
            location.reload(); 
        });
    }

    function arsivleVeTemizle() {
        if(!isAdmin) return;
        if(!confirm("‚ö†Ô∏è Dƒ∞KKAT: 30 g√ºnden eski t√ºm vardiya verileri silinecek ve sistem hƒ±zlandƒ±rƒ±lacak.\n\nBu i≈ülem performansƒ± artƒ±rƒ±r. √ñnce otomatik yedek alƒ±nacak.\n\nDevam edilsin mi?")) return;
        jsonYedekAl();
        const bugun = new Date();
        const sinirTarih = new Date();
        sinirTarih.setDate(bugun.getDate() - 30); 
        let silinenSayisi = 0;
        Object.keys(state.manuelAtamalar).forEach(key => {
            const tarihStr = key.split('_')[0]; 
            const kayitTarihi = new Date(tarihStr);
            if(kayitTarihi < sinirTarih) {
                delete state.manuelAtamalar[key];
                silinenSayisi++;
            }
        });
        if(state.geciciGorevler) {
            Object.keys(state.geciciGorevler).forEach(key => {
                 const tarihStr = key.split('_')[0];
                 const kayitTarihi = new Date(tarihStr);
                 if(kayitTarihi < sinirTarih) {
                     delete state.geciciGorevler[key];
                     silinenSayisi++;
                 }
            });
        }
        save();
        bulutaKaydet(); 
        logKoy(`Sistem temizliƒüi yapƒ±ldƒ±. ${silinenSayisi} kayƒ±t silindi.`);
        alert(`‚úÖ TEMƒ∞ZLƒ∞K VE AR≈ûƒ∞VLEME TAMAMLANDI.\n\nToplam ${silinenSayisi} eski kayƒ±t sistemden silindi.\nUygulama artƒ±k daha hƒ±zlƒ± √ßalƒ±≈üacak.`);
        tabloyuOlustur();
    }

    function mcrOfsetGuncelle(ad, val) { if(!state.mcrAyarlari.ofsetler) state.mcrAyarlari.ofsetler = {}; state.mcrAyarlari.ofsetler[ad] = parseInt(val); save(); }
    function yuzdeGuncelle(idx, val) { state.personeller[idx].yuzde = val; save(); } 
    function whatsappGonder() { const hKey = getDateKey(currentMonday); let m = `*üìÖ ${currentMonday.toLocaleDateString('tr-TR')} VARDƒ∞YASI*\n\n`; GUNLER.forEach((g, i) => { m += `*${g.toUpperCase()}*\n`; state.saatler.forEach(s => { let pList = state.personeller.filter(p => state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] === s).map(p => p.ad).join(", "); if (pList) m += `‚Ä¢ ${s}: ${pList}\n`; }); m += `\n`; }); window.open(`https://wa.me/?text=${encodeURIComponent(m)}`, '_blank'); }
    function capUp(k, g, v) { if(!state.kapasite[k]) state.kapasite[k] = [0,0,0,0,0,0,0]; state.kapasite[k][g] = parseInt(v) || 0; save(); }
    function izinGunuTetikle(pi, gi) { if(!state.personeller[pi].izinGunleri) state.personeller[pi].izinGunleri = []; const idx = state.personeller[pi].izinGunleri.indexOf(gi); if(idx > -1) state.personeller[pi].izinGunleri.splice(idx, 1); else state.personeller[pi].izinGunleri.push(gi); save(); refreshUI(); }
    function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + v); tabloyuOlustur(); }
    function personelEkle() { const ad = document.getElementById("yeniPersInp").value.toUpperCase(); const b = document.getElementById("yeniPersBirimSec").value; if(ad){ state.personeller.push({ad, birim:b, izinGunleri:[], yuzde:0}); save(); refreshUI(); document.getElementById("yeniPersInp").value=""; } }
    
    function birimEkle() { const val = document.getElementById("yeniBirimInp").value.toUpperCase().trim(); const renk = document.getElementById("yeniBirimRenk").value; const tip = document.getElementById("yeniBirimTipi").value; if(val && !state.birimler.includes(val)) { state.birimler.push(val); if(!state.birimAyarlari) state.birimAyarlari = {}; state.birimAyarlari[val] = { tip: tip, renk: renk }; save(); refreshUI(); tabloyuOlustur(); } else if (state.birimler.includes(val)) { alert("Bu birim zaten mevcut."); } }
    function birimSil(index) { if(confirm(state.birimler[index] + " birimini silmek istediƒüinize emin misiniz?")) { const silinen = state.birimler[index]; state.birimler.splice(index, 1); if(state.birimAyarlari && state.birimAyarlari[silinen]) delete state.birimAyarlari[silinen]; save(); refreshUI(); tabloyuOlustur(); } }
    function saatEkle() { const val = document.getElementById("yeniSaatInp").value.trim(); if(val && !state.saatler.includes(val)) { state.saatler.push(val); save(); refreshUI(); tabloyuOlustur(); } else if (state.saatler.includes(val)) { alert("Bu saat zaten mevcut."); } }
    function saatSil(index) { if(confirm(state.saatler[index] + " saatini silmek istediƒüinize emin misiniz?")) { state.saatler.splice(index, 1); save(); refreshUI(); tabloyuOlustur(); } }
    function drag(e, p, g, s) { if(!isAdmin) return; e.dataTransfer.setData("p", p); e.dataTransfer.setData("oldG", g); }
    function drop(e, ns, ng) { if(!isAdmin) return; e.preventDefault(); const p = e.dataTransfer.getData("p"); const hKey = getDateKey(currentMonday); cakismaKontrol(p, ng, ns); state.manuelAtamalar[`${hKey}_${p}_${ng}`] = ns === SHIFTS.BOS ? null : ns; save(); logKoy(`${p} i√ßin ${GUNLER[ng]} vardiyasƒ± deƒüi≈ütirildi: ${ns}`); tabloyuOlustur(); }
    function vardiyaDegistir(p, g) { if(!isAdmin) return; const s = prompt(`${p}: 1:${SHIFTS.SABAH}, 2:${SHIFTS.GUNDUZ}, 3:${SHIFTS.AKSAM}, 4:${SHIFTS.GECE}, 5:${SHIFTS.IZIN}`); if(s){ let v = null; if(s=="1") v=SHIFTS.SABAH; if(s=="2") v=SHIFTS.GUNDUZ; if(s=="3") v=SHIFTS.AKSAM; if(s=="4") v=SHIFTS.GECE; if(s=="5") v=SHIFTS.IZIN; cakismaKontrol(p, g, v); state.manuelAtamalar[`${getDateKey(currentMonday)}_${p}_${g}`] = v; save(); logKoy(`${p} i√ßin ${GUNLER[g]} g√ºn√º manuel deƒüi≈ütirildi: ${v}`); tabloyuOlustur(); } }
    function toggleTheme() { const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark"; document.documentElement.setAttribute("data-theme", t); localStorage.setItem(PREFIX + "theme", t); }
    function vardiyaSifirla() { if(confirm("Haftayƒ± temizle?")) { const hKey = getDateKey(currentMonday); Object.keys(state.manuelAtamalar).forEach(k => { if(k.startsWith(hKey)) delete state.manuelAtamalar[k]; }); save(); tabloyuOlustur(); logKoy("Bu haftanƒ±n vardiyasƒ± sƒ±fƒ±rlandƒ±."); } }
    function tamSifirla() { if(confirm("Sƒ±fƒ±rla?")) { localStorage.clear(); location.reload(); } }
    function jsonYedekAl() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "Yedek.json"); dl.click(); }
    async function githubdanYedekYukle() { const url = "https://raw.githubusercontent.com/ugurbakirtas/vardiya-sistemi/main/ilk_kurulum.json?t=" + new Date().getTime(); if (confirm("Sistem verileri GitHub √ºzerindeki yedekle deƒüi≈ütirilecek. Onaylƒ±yor musunuz?")) { try { const response = await fetch(url); if (!response.ok) throw new Error("GitHub'daki dosya bulunamadƒ± veya eri≈üim engellendi."); const data = await response.json(); state = data; save(); alert("GitHub yedeƒüi ba≈üarƒ±yla y√ºklendi!"); location.reload(); } catch (error) { console.error(error); alert("Hata: " + error.message); } } }
    function sabitTetikle(ad) { if(state.haftaIciSabitler[ad]) delete state.haftaIciSabitler[ad]; else state.haftaIciSabitler[ad] = state.saatler[0]; save(); refreshUI(); }
    function sabitSaatGuncelle(ad, saat) { state.haftaIciSabitler[ad] = saat; save(); }
    function anlikSenkronizasyonBaslat() { database.ref().on('value', (snap) => { if (snap.exists()) { const data = snap.val(); if(data.vardiya_data) { state = data.vardiya_data; verileriGuvenliHaleGetir(); save(); tabloyuOlustur(); if(isAdmin) refreshUI(); } if(isAdmin) { talepleriYukle(); } console.log("Sistem: T√ºm veriler (vardiya ve talepler) g√ºncellendi."); } }); }
    function mobilListeyiGuncelle() { const select = document.getElementById('mobilPersonelSecim'); const mevcutSecim = select.value; const siraliPersonel = [...state.personeller].sort((a,b) => a.ad.localeCompare(b.ad)); let html = '<option value="">Personel Se√ßiniz...</option>'; siraliPersonel.forEach(p => { html += `<option value="${p.ad}" ${p.ad === mevcutSecim ? 'selected' : ''}>${p.ad}</option>`; }); select.innerHTML = html; if(mevcutSecim) kisiselProgramiGoster(); }
    async function mobilVerileriYenile() { const btn = document.querySelector('#mobilPersonelPanel button'); const oldText = btn.innerHTML; btn.innerHTML = "‚è≥"; try { const snap = await database.ref('vardiya_data').once('value'); if (snap.exists()) { state = snap.val(); verileriGuvenliHaleGetir(); save(); tabloyuOlustur(); alert("Veriler g√ºncellendi, listenizi kontrol edebilirsiniz."); } } catch(e) { alert("Veri √ßekilemedi: " + e.message); } btn.innerHTML = oldText; }
    function kisiselProgramiGoster() { const isim = document.getElementById('mobilPersonelSecim').value; const alan = document.getElementById('kisiselListeSonuc'); if(!isim) { alan.innerHTML = "<div style='text-align:center; padding:30px; color:#999;'>L√ºtfen isminizi se√ßiniz.</div>"; return; } let html = ""; GUNLER.forEach((gunAdi, index) => { let d = new Date(currentMonday); d.setDate(d.getDate() + index); let tarihStr = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' }); let vardiya = vardiyaBul(isim, index); if(!vardiya || vardiya === "BO≈û") vardiya = "ƒ∞Zƒ∞NLƒ∞"; let renk = "#eee"; let yaziRengi = "#333"; let ikon = "‚ö™"; if(vardiya.includes("06:30")) { renk = "#e0f2fe"; yaziRengi = "#0c4a6e"; ikon = "üåÖ"; } else if(vardiya.includes("09:00")) { renk = "#f0fdf4"; yaziRengi = "#064e3b"; ikon = "‚òÄÔ∏è"; } else if(vardiya.includes("16:00")) { renk = "#faf5ff"; yaziRengi = "#581c87"; ikon = "üåá"; } else if(vardiya.includes("00:00")) { renk = "#fff7ed"; yaziRengi = "#7c2d12"; ikon = "üåô"; } else if(vardiya === "ƒ∞Zƒ∞NLƒ∞") { renk = "#fef2f2"; yaziRengi = "#ef4444"; ikon = "üèñÔ∏è"; } else if(vardiya === "YILLIK ƒ∞Zƒ∞N") { renk = "#9333ea"; yaziRengi = "#ffffff"; ikon = "‚úàÔ∏è"; } html += `<div class="modern-shift-card"><div class="m-date-group"><span class="m-day-name">${gunAdi}</span><span class="m-date-text">${tarihStr}</span></div><div class="m-shift-badge" style="background:${renk}; color:${yaziRengi};"><span style="font-size:16px;">${ikon}</span><span>${vardiya}</span></div></div>`; }); alan.innerHTML = html; }
    function exceldenVardiyaYukle() { const fileInput = document.getElementById('excelUploadInput'); if (!fileInput.files.length) { alert("L√ºtfen bir Excel dosyasƒ± se√ßin!"); return; } const file = fileInput.files[0]; const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); const hKey = getDateKey(currentMonday); let islenenSayisi = 0; jsonData.forEach(row => { if (!row || row.length < 2) return; let satirBasligi = row[0]; if(!satirBasligi || typeof satirBasligi !== 'string') return; satirBasligi = satirBasligi.toUpperCase().trim(); let atanacakVardiya = null; if (satirBasligi.includes("ƒ∞Zƒ∞N") || satirBasligi.includes("OFF")) { atanacakVardiya = SHIFTS.IZIN; } else if (satirBasligi.includes("YILLIK")) { atanacakVardiya = SHIFTS.YILLIK; } else { atanacakVardiya = state.saatler.find(s => s.includes(satirBasligi) || s.replace(/[:\-\s]/g, "").includes(satirBasligi.replace(/[:\-\s]/g, ""))); if(!atanacakVardiya) { if(satirBasligi.startsWith("00") || satirBasligi.startsWith("24") || satirBasligi.includes("GECE")) { atanacakVardiya = SHIFTS.GECE; } else if(satirBasligi.includes("06") || satirBasligi.includes("07")) { atanacakVardiya = SHIFTS.SABAH; } else if(satirBasligi.includes("09") || satirBasligi.includes("10")) { atanacakVardiya = SHIFTS.GUNDUZ; } else if(satirBasligi.includes("16") || satirBasligi.includes("15") || satirBasligi.includes("14")) { atanacakVardiya = SHIFTS.AKSAM; } } } if (!atanacakVardiya) return; for (let i = 1; i <= 7; i++) { let hucreVerisi = row[i]; if (hucreVerisi && typeof hucreVerisi === 'string') { let temizIsim = hucreVerisi.split('*')[0].split('-')[0].replace(/[\d\(\)\.]/g, '').trim().toUpperCase(); let personel = state.personeller.find(p => p.ad === temizIsim); if (personel) { let gunIdx = i - 1; state.manuelAtamalar[`${hKey}_${personel.ad}_${gunIdx}`] = atanacakVardiya; islenenSayisi++; } } } }); if (islenenSayisi > 0) { save(); tabloyuOlustur(); alert(`‚úÖ Excel Ba≈üarƒ±yla ƒ∞≈ülendi!\n\nToplam ${islenenSayisi} h√ºcre sisteme aktarƒ±ldƒ±.\nL√ºtfen tabloyu kontrol edin.`); logKoy(`Excel y√ºklendi (${islenenSayisi} atama)`); } else { alert("‚ö†Ô∏è Excel okundu ancak e≈üle≈üen veri bulunamadƒ±."); } } catch (err) { console.error(err); alert("Dosya okuma hatasƒ±: " + err.message); } }; reader.readAsArrayBuffer(file); }
    window.onload = async () => { if(localStorage.getItem(PREFIX + "theme") === "dark") { document.documentElement.setAttribute("data-theme", "dark"); } await hassasAyarlariYukle(); firebase.auth().onAuthStateChanged(function(user) { if (user) { console.log("Oturum a√ßƒ±k:", user.email); isAdmin = true; document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex'); document.getElementById('persTalepArea').style.display = 'none'; document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('appMain').style.display = 'block'; tabloyuOlustur(); checkUrlActions(); const p = document.getElementById("sidePanel"); if(p.classList.contains("open")) tabDegistir('personel'); } }); anlikSenkronizasyonBaslat(); talepleriYukle(); };
  </script>
</body>
</html>