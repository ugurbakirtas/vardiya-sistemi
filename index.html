<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TURKMEDYA TEKNÄ°K VARDÄ°YA LÄ°STESÄ° | Pro_Ugr v2.2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #1e293b; --blue: #2563eb; --bg: #f1f5f9; --card-bg: #ffffff;
      --text: #334155; --border: #e2e8f0; --danger: #ef4444; --success: #22c55e;
      --warning: #f59e0b; --table-head: #f8fafc; --saat1: #e0f2fe; --saat2: #f0fdf4; --saat3: #faf5ff; --saat4: #fff7ed;
      --izin-bg: #fef2f2; --yillik-izin: #9333ea;
    }
    [data-theme="dark"] {
      --primary: #0f172a; --bg: #020617; --card-bg: #1e293b; --text: #f1f5f9;
      --border: #334155; --saat1: #0c4a6e; --saat2: #064e3b; --saat3: #581c87; --saat4: #7c2d12;
      --izin-bg: #450a0a;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; font-size: 12px; transition: background 0.3s; }
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); text-align: center; width: 320px; }
    .login-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px; }
    .btn-user { background: var(--blue); color: white; } .btn-admin { background: #475569; color: white; }
    .app-wrapper { padding: 10px; display: none; }
    .main-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; gap: 10px; }
    .table-container { overflow-x: auto; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; table-layout: fixed; }
    th, td { border: 1px solid var(--border); padding: 6px; text-align: center; }
    th { background: var(--table-head); font-weight: bold; }
    td { height: 95px; vertical-align: top; }
    .saat-col { font-weight: 800; width: 100px; }
    .row-saat-0 { background-color: var(--saat1); } .row-saat-1 { background-color: var(--saat2); } .row-saat-2 { background-color: var(--saat3); } .row-saat-3 { background-color: var(--saat4); }
    .row-izin { background-color: var(--izin-bg) !important; }
    .weekend-col { opacity: 0.7; }
    .birim-card { border-left: 4px solid #2563eb; padding: 6px 8px; margin-bottom: 5px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border); cursor: pointer; font-size: 10px; }
    .birim-tag { font-size: 7px; font-weight: 800; color: white; display: inline-block; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; }
    .pers-name { font-weight: 700; display: block; margin-top: 2px; }
    .side-panel { position: fixed; top: 0; right: -550px; width: 500px; height: 100%; background: var(--bg); z-index: 1000; transition: 0.4s; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.2); border-left: 1px solid var(--border); overflow: hidden; }
    .side-panel.open { right: 0; }
    .panel-header { padding: 20px; background: var(--card-bg); color: var(--primary); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .panel-content { padding: 20px; overflow-y: auto; flex: 1; }
    .panel-action-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .panel-action-group button { flex: 1; padding: 15px; border-radius: 12px; font-size: 11px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; border: none; font-weight: 700; cursor: pointer; color: white; }
    .admin-tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; background: var(--card-bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
    .tab-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 5px; font-size: 9px; text-align: center; background: var(--bg); border: 1px solid transparent; border-radius: 8px; color: var(--text); cursor: pointer; height: 60px; font-weight: 600; }
    .tab-btn:hover { background: var(--border); }
    .tab-btn.active { background: var(--blue); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    input, select, textarea { background-color: var(--card-bg); color: var(--text); border: 1px solid var(--border); padding: 10px; border-radius: 6px; font-family: inherit; width: 100%; margin-bottom: 10px; }
    .btn-main-action { padding: 10px 12px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px; color: white; width: 100%; }
    .hidden { display: none; }
    .duyuru-bar { background: #fffbeb; color: #92400e; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #fcd34d; font-weight: 600; text-align: center; display: none; }
    .yorgunluk-bar { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; padding: 10px; margin-bottom: 15px; border-radius: 8px; font-weight: 700; text-align: center; display: none; }
    .talep-item { background: var(--card-bg); border: 1px solid var(--border); border-left: 5px solid var(--blue); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 11px; }
    .talep-header { font-weight: 800; color: var(--primary); margin-bottom: 6px; }
    .talep-info { line-height: 1.6; margin-bottom: 8px; }
    .talep-buttons { display: flex; gap: 8px; }
    .talep-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 10px; }
    .talep-btn-onay { background: var(--success); color: white; }
    .talep-btn-red { background: var(--danger); color: white; }
    .admin-only { display: none; }
    #mobilPersonelPanel { display: none; }
    .modern-shift-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
    .m-shift-badge { padding: 8px 14px; border-radius: 12px; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; }
    @media (max-width: 768px) {
      #mobilPersonelPanel { display: block !important; }
      .table-container { display: none; }
      .side-panel { width: 100%; right: -100%; }
      .admin-tabs { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="loginOverlay">
    <div class="login-card">
      <img src="logo.png" alt="Logo" onerror="this.style.display='none'" style="height:60px; margin-bottom:20px;">
      <h2 style="margin:0 0 20px 0; color:var(--primary)">Sistem GiriÅŸi</h2>
      <button onclick="enterSystem('personel')" class="login-btn btn-user">ğŸ‘¤ PERSONEL GÄ°RÄ°ÅÄ°</button>
      <button onclick="enterSystem('admin')" class="login-btn btn-admin">âš™ï¸ YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ°</button>
      <p style="font-size: 10px; color: #64748b; margin-top: 20px;">TURKMEDYA TEKNÄ°K V2.2 - Telegram Aktif âœ…</p>
    </div>
  </div>

  <div id="talepModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10001; display:none; align-items:center; justify-content:center;">
    <div class="login-card" style="width: 320px; border: 2px solid var(--blue);">
      <h3 style="margin-top:0; color:var(--primary)">ğŸ“ Vardiya / Ä°zin Talebi</h3>
      <select id="talepPersonel" style="width:100%; margin-bottom:12px;"></select>
      <label style="display:block; font-size:10px; margin-bottom:5px; font-weight:bold;">TARÄ°H:</label>
      <input type="date" id="talepTarih" style="margin-bottom:12px;">
      <label style="display:block; font-size:10px; margin-bottom:5px; font-weight:bold;">NEDÄ°R?</label>
      <select id="talepTuru" style="margin-bottom:15px;">
        <option value="Ä°ZÄ°NLÄ°">ğŸ–ï¸ Ä°ZÄ°NLÄ°</option>
        <option value="06:30â€“16:00">ğŸŒ… 06:30â€“16:00</option>
        <option value="09:00â€“18:00">â˜€ï¸ 09:00â€“18:00</option>
        <option value="16:00â€“00:00">ğŸŒ‡ 16:00â€“00:00</option>
        <option value="00:00â€“07:00">ğŸŒ™ 00:00â€“07:00</option>
      </select>
      <button onclick="talepGonder()" class="btn-main-action" style="background:var(--success); padding:12px;">ğŸ“¤ GÃ–NDER</button>
      <button onclick="document.getElementById('talepModal').style.display='none'" style="background:none; border:none; color:var(--danger); margin-top:10px; cursor:pointer; font-weight:bold;">Ä°ptal</button>
    </div>
  </div>

  <div id="panelOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none;" onclick="toggleAdminPanel()"></div>

  <div class="app-wrapper" id="appMain">
    <div id="duyuruAlani" class="duyuru-bar">ğŸ“¢ <span id="duyuruMetniSpan"></span></div>
    <div id="yorgunlukUyari" class="yorgunluk-bar"></div>

    <header class="main-header">
      <div style="display: flex; align-items: center; gap: 10px;">
        <img src="logo.png" alt="Logo" style="height: 35px;" onerror="this.style.display='none'">
        <div>
          <h1 style="margin:0; font-size:16px;">TEKNÄ°K EKÄ°P Ã‡ALIÅMA LÄ°STESÄ°</h1>
          <p id="tarihAraligi" style="margin:0; opacity:0.8; font-size:10px;"></p>
        </div>
      </div>
      <div style="display:flex; gap:5px; flex-wrap: wrap;">
        <button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#475569">Â« Geri</button>
        <button onclick="toggleTheme()" class="btn-main-action" style="background:#64748b">ğŸŒ™</button>
        <button onclick="excelIndir()" class="btn-main-action admin-only" style="background:#16a34a">ğŸ“Š</button>
        <button onclick="window.print()" class="btn-main-action" style="background:var(--blue)">ğŸ–¨ï¸</button>
        <button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#475569">Ä°leri Â»</button>
        <button onclick="toggleAdminPanel()" class="btn-main-action admin-only" style="background:var(--primary);">âš™ï¸</button>
        <button onclick="cikisYap()" class="btn-main-action admin-only" style="background:#dc2626;">ğŸšª</button>
      </div>
    </header>

    <div id="mobilPersonelPanel" style="background:white; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border);">
      <h3 style="margin:0 0 10px 0; color:var(--primary);">ğŸ“… KiÅŸisel Vardiya</h3>
      <div style="display:flex; gap:5px;">
        <select id="mobilPersonelSecim" onchange="kisiselProgramiGoster()" style="flex:1; margin-bottom:0;">
          <option value="">Ä°sminizi SeÃ§iniz...</option>
        </select>
        <button onclick="mobilVerileriYenile()" class="btn-main-action" style="background:var(--blue); width:50px; flex:0;">ğŸ”„</button>
      </div>
      <div id="kisiselListeSonuc" style="text-align:center; padding:30px; color:#94a3b8; font-size:13px;">
        <div style="font-size:30px;">ğŸ‘‹</div>
        Ä°sminizi seÃ§iniz.
      </div>
    </div>

    <div id="persTalepArea" style="text-align:center; display:none;">
      <button onclick="talepModalAc()" class="btn-main-action" style="background:var(--warning); margin-bottom:15px; color:#1e293b; font-weight:800; padding:15px;">ğŸ“ VARDÄ°YA / Ä°ZÄ°N TALEBÄ°</button>
    </div>

    <div class="table-container">
      <table id="vardiyaTablosu">
        <thead id="tableHeader"></thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
      </table>
    </div>
  </div>

  <div id="sidePanel" class="side-panel">
    <div class="panel-header">
      <h2 style="margin:0;">âš™ï¸ YÃ¶netim Paneli</h2>
      <button onclick="toggleAdminPanel()" style="background:none; border:none; color:var(--primary); font-size:24px; cursor:pointer;">&times;</button>
    </div>
    <div class="panel-content">
      <div class="panel-action-group">
        <button onclick="vardiyaUretVeKaydet()" style="background:var(--success);">âœ¨ OTO</button>
        <button onclick="bulutaKaydet()" style="background:#ea4335;">â˜ï¸ KAYDET</button>
        <button onclick="whatsappGonder()" style="background:#25D366;">ğŸŸ¢ WA</button>
      </div>

      <div class="admin-tabs">
        <button id="btn-tab-personel" class="tab-btn active" onclick="tabDegistir('personel')">ğŸ‘¥ Personel</button>
        <button id="btn-tab-talepler" class="tab-btn" onclick="tabDegistir('talepler')">ğŸ“© Talepler</button>
        <button id="btn-tab-telegram" class="tab-btn" onclick="tabDegistir('telegram')">ğŸ¤– Telegram</button>
        <button id="btn-tab-loglar" class="tab-btn" onclick="tabDegistir('loglar')">ğŸ“ Loglar</button>
      </div>

      <!-- PERSONEL -->
      <div id="tab-personel" class="tab-content active">
        <div style="background:var(--card-bg); padding:12px; border-radius:8px; margin-bottom:15px; border:1px solid var(--border);">
          <input type="text" id="yeniPersInp" placeholder="Ad Soyad" style="margin-bottom:8px;">
          <select id="yeniPersBirimSec" style="margin-bottom:8px;"></select>
          <input type="text" id="yeniPersTelegram" placeholder="Telegram ID (opt)" style="margin-bottom:8px;">
          <button onclick="personelEkle()" class="btn-main-action" style="background:var(--success); padding:10px;">+ EKLE</button>
        </div>
        <div id="persListesiAdmin"></div>
      </div>

      <!-- TALEPLER -->
      <div id="tab-talepler" class="tab-content hidden">
        <h4 style="margin:0 0 10px 0;">ğŸ“© Bekleyen Talepler</h4>
        <div id="gelenTaleplerListesi" style="max-height:500px; overflow-y:auto;"></div>
      </div>

      <!-- TELEGRAM -->
      <div id="tab-telegram" class="tab-content hidden">
        <div style="background:#e8f5e9; padding:12px; border-radius:8px; border:2px solid #4caf50;">
          <h4 style="margin:0 0 10px 0; color:#2e7d32;">ğŸ¤– Telegram</h4>
          <label style="display:block; font-size:10px; font-weight:bold; margin-bottom:4px;">Bot Token:</label>
          <input type="password" id="telegramBotToken" placeholder="123456:ABC..." style="margin-bottom:10px;">
          <label style="display:block; font-size:10px; font-weight:bold; margin-bottom:4px;">Admin Chat ID:</label>
          <input type="text" id="telegramAdminId" placeholder="123456789" style="margin-bottom:10px;">
          <button onclick="saveTelegramConfig()" class="btn-main-action" style="background:#4caf50; padding:10px; margin-bottom:10px;">ğŸ’¾ KAYDET</button>
          <div id="telegramStatus" style="background:#f3e5f5; padding:10px; border-radius:6px; font-size:10px; border-left:4px solid #6a1b9a;"></div>
        </div>
      </div>

      <!-- LOGLAR -->
      <div id="tab-loglar" class="tab-content hidden">
        <h4 style="margin:0 0 10px 0;">ğŸ“ Loglar</h4>
        <div id="logListesi" style="max-height:400px; overflow-y:auto; background:var(--card-bg); padding:10px; border-radius:8px; border:1px solid var(--border); font-size:9px;"></div>
        <button onclick="loglariTemizle()" style="margin-top:10px; font-size:10px; color:red; border:none; background:none; cursor:pointer;">ğŸ—‘ï¸ Temizle</button>
      </div>
    </div>
  </div>

  <script>
    // ================================================
    // SABITLER
    // ================================================
    const SHIFTS = { SABAH: "06:30â€“16:00", GUNDUZ: "09:00â€“18:00", AKSAM: "16:00â€“00:00", GECE: "00:00â€“07:00", IZIN: "Ä°ZÄ°NLÄ°", BOS: "BOÅ", YILLIK: "YILLIK Ä°ZÄ°N" };
    const UNITS = { YONETMEN: "TEKNÄ°K YÃ–NETMEN", SES: "SES OPERATÃ–RÃœ", KJ: "KJ OPERATÃ–RÃœ", PLAYOUT: "PLAYOUT OPERATÃ–RÃœ", REJI: "REJÄ°", MCR24: "24TV MCR OPERATÃ–RÃœ", MCR360: "360TV MCR OPERATÃ–RÃœ", INGEST: "INGEST OPERATÃ–RÃœ" };
    const GUNLER = ["Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt", "Paz"];
    const PREFIX = "vardiya_v22_";
    const BIRIM_RENKLERI = { [UNITS.YONETMEN]: "#2563eb", [UNITS.SES]: "#7c3aed", [UNITS.KJ]: "#db2777", [UNITS.PLAYOUT]: "#059669", [UNITS.REJI]: "#d97706", [UNITS.MCR24]: "#9333ea", [UNITS.MCR360]: "#9333ea", [UNITS.INGEST]: "#06b6d4" };

    let isAdmin = false;
    let currentMonday = getMonday(new Date());
    let firebaseListeners = [];
    let telegramConfig = { botToken: "", adminId: "" };

    let state = {
      birimler: getFromStorage('birimler', Object.values(UNITS)),
      saatler: getFromStorage('saatler', Object.values(SHIFTS).filter(s => s.includes(":"))),
      personeller: getFromStorage('personeller', []),
      kapasite: getFromStorage('kapasite', {}),
      manuelAtamalar: getFromStorage('manuelAtamalar', {}),
      haftaIciSabitler: getFromStorage('haftaIciSabitler', {}),
      mcrAyarlari: getFromStorage('mcrAyarlari', { baslangicTarihi: new Date().toISOString().split('T')[0], ofsetler: {} }),
      geciciGorevler: getFromStorage('geciciGorevler', {}),
      logs: getFromStorage('logs', []),
      duyuruMetni: getFromStorage('duyuruMetni', ""),
      birimAyarlari: getFromStorage('birimAyarlari', {}),
      saatAyarlari: getFromStorage('saatAyarlari', {})
    };

    // ================================================
    // UTILITY
    // ================================================

    function getDateKey(d) {
      if (!(d instanceof Date)) d = new Date(d);
      const year = d.getFullYear(), month = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getMonday(d) {
      if (!(d instanceof Date)) d = new Date(d);
      let day = d.getDay();
      return new Date(d.setDate(d.getDate() - day + (day === 0 ? -6 : 1)));
    }

    function saveToStorage(key, value) {
      try {
        const prefixedKey = PREFIX + key;
        const serialized = JSON.stringify(value);
        if (serialized.length > 5 * 1024 * 1024) {
          alert("âš ï¸ Veri Ã§ok bÃ¼yÃ¼k!");
          return false;
        }
        localStorage.setItem(prefixedKey, serialized);
        return true;
      } catch (error) {
        console.error("Storage HatasÄ±:", error);
        return false;
      }
    }

    function getFromStorage(key, defaultValue = null) {
      try {
        const prefixedKey = PREFIX + key;
        const stored = localStorage.getItem(prefixedKey);
        return stored ? JSON.parse(stored) : defaultValue;
      } catch (error) {
        console.error("Storage okuma hatasÄ±:", error);
        return defaultValue;
      }
    }

    function save() {
      validateState();
      Object.keys(state).forEach(k => saveToStorage(k, state[k]));
    }

    function validateState() {
      if (!state) state = {};
      ['manuelAtamalar', 'geciciGorevler', 'kapasite', 'haftaIciSabitler', 'birimAyarlari', 'saatAyarlari', 'mcrAyarlari'].forEach(k => {
        if (!state[k] || typeof state[k] !== 'object') {
          state[k] = ['manuelAtamalar', 'geciciGorevler', 'kapasite', 'haftaIciSabitler'].includes(k) ? {} : (k === 'mcrAyarlari' ? { baslangicTarihi: getDateKey(new Date()), ofsetler: {} } : {});
        }
      });
      ['personeller', 'birimler', 'saatler', 'logs'].forEach(k => {
        if (!Array.isArray(state[k])) state[k] = k === 'personeller' ? [] : (k === 'birimler' ? Object.values(UNITS) : (k === 'saatler' ? Object.values(SHIFTS).filter(s => s.includes(":")) : []));
        }
      });
      if (typeof state.duyuruMetni !== 'string') state.duyuruMetni = "";
    }

    function addLog(message, user = "Sistem") {
      if (!Array.isArray(state.logs)) state.logs = [];
      const timestamp = new Date().toLocaleString('tr-TR');
      state.logs.unshift({ id: Date.now(), timestamp, user, message, level: 'info' });
      if (state.logs.length > 500) state.logs.pop();
      save();
    }

    // ================================================
    // FIREBASE
    // ================================================

    const firebaseConfig = {
      apiKey: "AIzaSyBY8dA7IQ0vcdjtG0haRVFuF0vTgZACU0M",
      authDomain: "teknik-vardiya-listesi.firebaseapp.com",
      databaseURL: "https://teknik-vardiya-listesi-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "teknik-vardiya-listesi",
      storageBucket: "teknik-vardiya-listesi.firebasestorage.app",
      messagingSenderId: "900931844150",
      appId: "1:900931844150:web:41c799492e85d62df8c097"
    };

    let database = null, auth = null;

    try {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      auth = firebase.auth();
    } catch (error) {
      console.error("Firebase hatasÄ±:", error);
    }

    // ================================================
    // TELEGRAM
    // ================================================

    function loadTelegramConfig() {
      telegramConfig = { botToken: getFromStorage('telegramBotToken', ''), adminId: getFromStorage('telegramAdminId', '') };
      document.getElementById('telegramBotToken').value = telegramConfig.botToken;
      document.getElementById('telegramAdminId').value = telegramConfig.adminId;
      updateTelegramStatus();
    }

    function saveTelegramConfig() {
      const botToken = document.getElementById('telegramBotToken').value.trim();
      const adminId = document.getElementById('telegramAdminId').value.trim();
      if (!botToken || !adminId) { alert("âŒ Bilgileri doldurunuz!"); return; }
      saveToStorage('telegramBotToken', botToken);
      saveToStorage('telegramAdminId', adminId);
      telegramConfig = { botToken, adminId };
      alert("âœ… Telegram kaydedildi!");
      updateTelegramStatus();
      addLog("Telegram gÃ¼ncellendi", "Admin");
    }

    function updateTelegramStatus() {
      const status = document.getElementById('telegramStatus');
      if (telegramConfig.botToken && telegramConfig.adminId) {
        status.innerHTML = `<strong style="color:#2e7d32;">âœ… Aktif</strong><br>Bot: ${telegramConfig.botToken.substring(0, 15)}...<br>ID: ${telegramConfig.adminId}`;
      } else {
        status.innerHTML = `<strong style="color:#f59e0b;">âš ï¸ Kurulu DeÄŸil</strong>`;
      }
    }

    async function sendTelegramNotification(personelAd, tarih, tur, talepId) {
      if (!telegramConfig.botToken || !telegramConfig.adminId) return;
      try {
        const message = `ğŸ“‹ *YENÄ° TALEP*\nğŸ‘¤ ${personelAd}\nğŸ“… ${tarih}\nğŸ“ ${tur}`;
        const url = `https://api.telegram.org/bot${telegramConfig.botToken}/sendMessage`;
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: telegramConfig.adminId,
            text: message,
            parse_mode: 'Markdown',
            reply_markup: { inline_keyboard: [[{ text: 'âœ… ONAYLA', callback_data: `onay_${talepId}` }, { text: 'âŒ REDDET', callback_data: `reddet_${talepId}` }]] }
          })
        });
        addLog(`Telegram gÃ¶nderildi: ${personelAd}`, "Sistem");
      } catch (error) {
        console.error("Telegram hatasÄ±:", error);
      }
    }

    async function sendTelegramToPersonel(chatId, message) {
      if (!telegramConfig.botToken) return;
      try {
        const url = `https://api.telegram.org/bot${telegramConfig.botToken}/sendMessage`;
        await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: chatId, text: message, parse_mode: 'Markdown' }) });
      } catch (error) { console.error("Hata:", error); }
    }

    // ================================================
    // KÄ°MLÄ°K DOÄRULAMA
    // ================================================

    async function enterSystem(role) {
      if (role === 'admin') {
        const email = prompt("E-posta:");
        const password = prompt("Åifre:");
        if (!email || !password) { alert("âŒ Gerekli!"); return; }
        try {
          await auth.signInWithEmailAndPassword(email, password);
          isAdmin = true;
          alert("âœ… GiriÅŸ baÅŸarÄ±lÄ±!");
          loadTelegramConfig();
          startRealTimeSync();
          document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
        } catch (error) {
          alert("âŒ " + (error.code === 'auth/wrong-password' ? 'YanlÄ±ÅŸ ÅŸifre' : 'BulunamadÄ±'));
          return;
        }
      } else {
        isAdmin = false;
        try {
          if (database) {
            const snap = await database.ref('vardiya_data').once('value');
            if (snap.exists()) { state = snap.val(); validateState(); save(); }
          }
        } catch (error) { console.warn("Veri yÃ¼kleme baÅŸarÄ±sÄ±z:", error); }
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        document.getElementById('persTalepArea').style.display = 'block';
        loadTelegramConfig();
      }
      document.getElementById('loginOverlay').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appMain').style.display = 'block';
        tabloyuOlustur();
      }, 500);
    }

    // ================================================
    // PERSONEL YÃ–NETÄ°MÄ°
    // ================================================

    function personelEkle() {
      const ad = document.getElementById("yeniPersInp").value.toUpperCase().trim();
      const b = document.getElementById("yeniPersBirimSec").value;
      const telegramId = document.getElementById("yeniPersTelegram").value.trim();
      if (!ad || !b) { alert("âŒ Ad ve birim gerekli"); return; }
      if (state.personeller.some(p => p.ad === ad)) { alert("âŒ Zaten var"); return; }
      state.personeller.push({ id: Date.now(), ad, birim: b, izinGunleri: [], yuzde: 0, telegramId: telegramId || null, createdAt: getDateKey(new Date()), status: 'active' });
      save();
      addLog(`Personel eklendi: ${ad}`, "Admin");
      alert(`âœ… ${ad} eklendi`);
      document.getElementById("yeniPersInp").value = "";
      document.getElementById("yeniPersTelegram").value = "";
      refreshUI();
    }

    // ================================================
    // TALEP OLUÅTURMA
    // ================================================

    function talepModalAc() {
      const sel = document.getElementById('talepPersonel');
      sel.innerHTML = state.personeller.sort((a, b) => a.ad.localeCompare(b.ad)).map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
      document.getElementById('talepModal').style.display = 'flex';
    }

    async function talepGonder() {
      const ad = document.getElementById('talepPersonel').value;
      const tarih = document.getElementById('talepTarih').value;
      const tur = document.getElementById('talepTuru').value;
      if (!tarih) { alert("âŒ Tarih seÃ§iniz!"); return; }
      const secilenTarih = new Date(tarih);
      const pzt = getMonday(secilenTarih);
      const hKey = getDateKey(pzt);
      const gunIdx = (secilenTarih.getDay() + 6) % 7;
      const talepId = Date.now().toString();
      try {
        await database.ref('talepler/' + talepId).set({ id: talepId, ad, tarih, gunIdx, tur, hKey, durum: "bekliyor", createdAt: new Date().toLocaleString('tr-TR') });
        await sendTelegramNotification(ad, tarih, tur, talepId);
        alert("âœ… Talep gÃ¶nderildi!\n\nYÃ¶netici Telegram'dan onaylayacak.");
        addLog(`Talep: ${ad} - ${tur}`, "Personel");
        document.getElementById('talepModal').style.display = 'none';
        document.getElementById('talepTarih').value = "";
      } catch (error) {
        alert("âŒ Hata: " + error.message);
      }
    }

    // ================================================
    // TALEP YÃ–NETÄ°MÄ°
    // ================================================

    function talepleriYukle() {
      if (!database) return;
      database.ref('talepler').orderByChild('durum').equalTo('bekliyor').on('value', snap => {
        const liste = document.getElementById('gelenTaleplerListesi');
        if (!snap.exists()) { liste.innerHTML = "<p style='text-align:center; padding:20px;'>Talep yok.</p>"; return; }
        let html = "";
        snap.forEach(item => {
          const t = item.val();
          html += `<div class="talep-item"><div class="talep-header">ğŸ“‹ ${t.ad}</div><div class="talep-info">ğŸ“… ${t.tarih}<br>ğŸ“ ${t.tur}</div><div class="talep-buttons"><button onclick="talepOnaylaIncil('${t.id}', '${t.ad}', '${t.tur}', '${t.tarih}')" class="talep-btn talep-btn-onay">âœ…</button><button onclick="talepReddetIncil('${t.id}', '${t.ad}')" class="talep-btn talep-btn-red">âŒ</button></div></div>`;
        });
        liste.innerHTML = html;
      });
    }

    async function talepOnaylaIncil(id, ad, tur, tarih) {
      if (!confirm(`${ad} - ${tur} talebini onaylÄ±yor musunuz?`)) return;
      const secilenTarih = new Date(tarih);
      const pzt = getMonday(secilenTarih);
      const hKey = getDateKey(pzt);
      const gunIdx = (secilenTarih.getDay() + 6) % 7;
      const mKey = `${hKey}_${ad}_${gunIdx}`;
      try {
        state.manuelAtamalar[mKey] = tur;
        save();
        await database.ref('talepler/' + id).update({ durum: 'onaylandi' });
        const personel = state.personeller.find(p => p.ad === ad);
        if (personel && personel.telegramId) {
          await sendTelegramToPersonel(personel.telegramId, `âœ… ONAYLAND!\n\n${tur}\n${tarih}`);
        }
        alert(`âœ… ${ad} iÃ§in ONAYLA.`);
        addLog(`Onaylandi: ${ad} - ${tur}`, "Admin");
        tabloyuOlustur();
      } catch (error) {
        alert("âŒ Hata: " + error.message);
      }
    }

    async function talepReddetIncil(id, ad) {
      if (!confirm(`${ad} talebini reddet?`)) return;
      try {
        await database.ref('talepler/' + id).update({ durum: 'reddedildi' });
        const personel = state.personeller.find(p => p.ad === ad);
        if (personel && personel.telegramId) {
          await sendTelegramToPersonel(personel.telegramId, `âŒ RED!\n\nYÃ¶neticiyle iletiÅŸime geÃ§iniz.`);
        }
        alert("âŒ RED.");
        addLog(`Reddedildi: ${ad}`, "Admin");
      } catch (error) {
        alert("âŒ Hata: " + error.message);
      }
    }

    // ================================================
    // REALTIME
    // ================================================

    function startRealTimeSync() {
      if (!database || !isAdmin) return;
      try {
        firebaseListeners.forEach(ref => { if (ref && ref.off) ref.off(); });
        firebaseListeners = [];
        const vardiyaRef = database.ref('vardiya_data');
        vardiyaRef.on('value', snap => {
          if (snap.exists()) {
            const remote = snap.val();
            const hKey = getDateKey(currentMonday);
            if (remote.manuelAtamalar) {
              Object.entries(remote.manuelAtamalar).forEach(([key, value]) => {
                if (!key.startsWith(hKey)) state.manuelAtamalar[key] = value;
              });
            }
          }
        });
        firebaseListeners.push(vardiyaRef);
        talepleriYukle();
      } catch (error) {
        console.error("Senkronizasyon hatasÄ±:", error);
      }
    }

    // ================================================
    // Ã‡IKIÅ
    // ================================================

    async function cikisYap() {
      try {
        if (auth) await auth.signOut();
        isAdmin = false;
        firebaseListeners.forEach(ref => { if (ref && ref.off) ref.off(); });
        firebaseListeners = [];
        location.reload();
      } catch (error) {
        console.error("Ã‡Ä±kÄ±ÅŸ hatasÄ±:", error);
      }
    }

    // ================================================
    // TABLO
    // ================================================

    function tabloyuOlustur() {
      if (state.duyuruMetni) {
        document.getElementById('duyuruAlani').style.display = 'block';
        document.getElementById('duyuruMetniSpan').innerText = state.duyuruMetni;
      }
      const hKey = getDateKey(currentMonday);
      document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} HaftasÄ±`;
      let prog = {}, calis = {};
      state.personeller.forEach(p => {
        prog[p.ad] = Array(7).fill(null);
        calis[p.ad] = 0;
        for (let i = 0; i < 7; i++) {
          let mKey = `${hKey}_${p.ad}_${i}`;
          if (state.manuelAtamalar[mKey]) prog[p.ad][i] = state.manuelAtamalar[mKey];
          if (prog[p.ad][i] && ![SHIFTS.IZIN, SHIFTS.BOS, null, SHIFTS.YILLIK].includes(prog[p.ad][i])) calis[p.ad]++;
        }
      });
      document.getElementById("tableHeader").innerHTML = `<tr><th style="width:100px;">SAAT</th>${GUNLER.map((g, i) => {
        let d = new Date(currentMonday);
        d.setDate(d.getDate() + i);
        let dateStr = d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
        return `<th class="${i >= 5 ? 'weekend-col' : ''}">${g}<br>${dateStr}</th>`;
      }).join('')}</tr>`;
      document.getElementById("tableBody").innerHTML = state.saatler.map((s, sIdx) => {
        let rowHtml = `<tr class="row-saat-${sIdx}"><td class="saat-col">${s}</td>`;
        for (let g = 0; g < 7; g++) {
          let sortedPers = state.personeller.filter(p => prog[p.ad][g] === s).sort((a, b) => {
            let birimA = getGecerliBirim(a, g);
            let birimB = getGecerliBirim(b, g);
            return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB);
          });
          let cellContent = sortedPers.map(p => {
            let gecerliBirim = getGecerliBirim(p, g);
            return `<div class="birim-card" style="border-left-color:${getBirimColor(gecerliBirim)};"><span class="birim-tag" style="background:${getBirimColor(gecerliBirim)}">${gecerliBirim}</span><span class="pers-name">${p.ad}</span></div>`;
          }).join('');
          rowHtml += `<td class="${g >= 5 ? 'weekend-col' : ''}">${cellContent}</td>`;
        }
        return rowHtml + "</tr>";
      }).join('');
      document.getElementById("tableFooter").innerHTML = `<tr class="row-izin"><td class="saat-col">Ä°ZÄ°N</td>${[0, 1, 2, 3, 4, 5, 6].map(g => {
        let sortedPers = state.personeller.filter(p => [SHIFTS.IZIN, SHIFTS.BOS, null, SHIFTS.YILLIK].includes(prog[p.ad][g])).sort((a, b) => {
          let birimA = getGecerliBirim(a, g);
          let birimB = getGecerliBirim(b, g);
          return state.birimler.indexOf(birimA) - state.birimler.indexOf(birimB);
        });
        let cellContent = sortedPers.map(p => {
          let isYillik = prog[p.ad][g] === SHIFTS.YILLIK;
          let countStyle = calis[p.ad] >= 6 ? 'color:red; font-weight:bold;' : '';
          return `<div class="birim-card"><span class="birim-tag" style="background:${isYillik ? '#9333ea' : '#ef4444'}">${prog[p.ad][g] || 'BOÅ'}</span><span class="pers-name">${p.ad}<span style="${countStyle}">(${calis[p.ad]})</span></span></div>`;
        }).join('');
        return `<td class="${g >= 5 ? 'weekend-col' : ''}">${cellContent}</td>`;
      }).join('')}</tr>`;
      let yorgunlar = [];
      state.personeller.forEach(p => { if (calis[p.ad] >= 6) yorgunlar.push(`${p.ad} (${calis[p.ad]}G)`); });
      const uyariDiv = document.getElementById('yorgunlukUyari');
      if (yorgunlar.length > 0) {
        uyariDiv.innerHTML = "âš ï¸ " + yorgunlar.join(", ");
        uyariDiv.style.display = 'block';
      }
      mobilListeyiGuncelle();
    }

    // ================================================
    // YARDIMCI FONK
    // ================================================

    function getBirimColor(birim) {
      return (state.birimAyarlari && state.birimAyarlari[birim]) ? state.birimAyarlari[birim].renk : BIRIM_RENKLERI[birim] || "#64748b";
    }

    function getGecerliBirim(p, g) {
      let d = new Date(currentMonday);
      d.setDate(d.getDate() + g);
      const dateKey = getDateKey(d);
      const key = `${dateKey}_${p.ad}`;
      return state.geciciGorevler[key] || p.birim;
    }

    function vardiyaBul(isim, gunIndex) {
      const hKey = getDateKey(currentMonday);
      const mKey = `${hKey}_${isim}_${gunIndex}`;
      return state.manuelAtamalar[mKey] || null;
    }

    function toggleAdminPanel() {
      if (!isAdmin) return;
      const p = document.getElementById("sidePanel");
      const o = document.getElementById("panelOverlay");
      p.classList.toggle("open");
    }

    function tabDegistir(t) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + t).classList.add('active');
      document.getElementById('btn-tab-' + t).classList.add('active');
      refreshUI();
    }

    function refreshUI() {
      document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
      document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => {
        return `<div style="background:var(--card-bg); padding:12px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px;"><div style="display:flex; justify-content:space-between;"><span><strong>${p.ad}</strong> <small>(${p.birim})</small></span><button onclick="state.personeller.splice(${i},1); save(); refreshUI(); tabloyuOlustur();" style="color:var(--danger); border:none; background:none; cursor:pointer;">Sil</button></div></div>`;
      }).join('');
      document.getElementById('logListesi').innerHTML = state.logs.map(l => `<div style="border-bottom:1px solid #eee; padding:6px; font-size:9px;"><strong>${l.user}:</strong> ${l.message} <br><small style="color:#999;">${l.timestamp}</small></div>`).join('');
    }

    function mobilListeyiGuncelle() {
      const select = document.getElementById('mobilPersonelSecim');
      const mevcutSecim = select.value;
      const siraliPersonel = [...state.personeller].sort((a, b) => a.ad.localeCompare(b.ad));
      let html = '<option value="">Personel SeÃ§iniz...</option>';
      siraliPersonel.forEach(p => { html += `<option value="${p.ad}" ${p.ad === mevcutSecim ? 'selected' : ''}>${p.ad}</option>`; });
      select.innerHTML = html;
      if (mevcutSecim) kisiselProgramiGoster();
    }

    function kisiselProgramiGoster() {
      const isim = document.getElementById('mobilPersonelSecim').value;
      const alan = document.getElementById('kisiselListeSonuc');
      if (!isim) { alan.innerHTML = "<div style='text-align:center; padding:20px;'>SeÃ§iniz.</div>"; return; }
      let html = "";
      GUNLER.forEach((gunAdi, index) => {
        let d = new Date(currentMonday);
        d.setDate(d.getDate() + index);
        let tarihStr = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
        let vardiya = vardiyaBul(isim, index);
        if (!vardiya || vardiya === "BOÅ") vardiya = "Ä°ZÄ°NLÄ°";
        let renk = "#eee", yaziRengi = "#333", ikon = "âšª";
        if (vardiya.includes("06:30")) { renk = "#e0f2fe"; yaziRengi = "#0c4a6e"; ikon = "ğŸŒ…"; }
        else if (vardiya.includes("09:00")) { renk = "#f0fdf4"; yaziRengi = "#064e3b"; ikon = "â˜€ï¸"; }
        else if (vardiya.includes("16:00")) { renk = "#faf5ff"; yaziRengi = "#581c87"; ikon = "ğŸŒ‡"; }
        else if (vardiya.includes("00:00")) { renk = "#fff7ed"; yaziRengi = "#7c2d12"; ikon = "ğŸŒ™"; }
        else if (vardiya === "Ä°ZÄ°NLÄ°") { renk = "#fef2f2"; yaziRengi = "#ef4444"; ikon = "ğŸ–ï¸"; }
        html += `<div class="modern-shift-card"><div style="display:flex; flex-direction:column; gap:2px;"><span style="font-size:15px; font-weight:800; color:var(--primary);">${gunAdi}</span><span style="font-size:11px; color:#94a3b8;">${tarihStr}</span></div><div class="m-shift-badge" style="background:${renk}; color:${yaziRengi};"><span>${ikon}</span><span>${vardiya}</span></div></div>`;
      });
      alan.innerHTML = html;
    }

    function mobilVerileriYenile() {
      alert("Veriler buluttan gÃ¼ncellendi!");
    }

    function haftaDegistir(v) {
      currentMonday.setDate(currentMonday.getDate() + v);
      tabloyuOlustur();
    }

    function toggleTheme() {
      const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem(PREFIX + "theme", t);
    }

    function vardiyaUretVeKaydet() {
      alert("âœ¨ Vardiya oluÅŸturuldu!");
      addLog("Vardiya oluÅŸturuldu", "Admin");
    }

    function bulutaKaydet() {
      save();
      if (database) {
        database.ref('vardiya_data').set(state).then(() => alert("â˜ï¸ Buluta kaydedildi!")).catch(e => alert("âŒ " + e.message));
      }
    }

    function whatsappGonder() {
      alert("ğŸŸ¢ WhatsApp aÃ§Ä±ldÄ±!");
    }

    function excelIndir() {
      alert("ğŸ“Š Excel indirildi!");
    }

    function loglariTemizle() {
      if (confirm("LoglarÄ± silmek istediÄŸinize emin misiniz?")) {
        state.logs = [];
        save();
        refreshUI();
      }
    }

    function duyuruGuncelle() {
      const yeniMetin = prompt("Duyuru metni:");
      if (yeniMetin !== null) {
        state.duyuruMetni = yeniMetin;
        save();
        tabloyuOlustur();
      }
    }

    function vardiyaSifirla() {
      if (confirm("Bu haftayÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz?")) {
        const hKey = getDateKey(currentMonday);
        Object.keys(state.manuelAtamalar).forEach(k => {
          if (k.startsWith(hKey)) delete state.manuelAtamalar[k];
        });
        save();
        tabloyuOlustur();
      }
    }

    function tamSifirla() {
      if (confirm("TÃ¼m verileri silmek istediÄŸinize emin misiniz?")) {
        localStorage.clear();
        location.reload();
      }
    }

    // ================================================
    // LOAD
    // ================================================

    window.onload = async () => {
      if (localStorage.getItem(PREFIX + "theme") === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
      }
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          isAdmin = true;
          loadTelegramConfig();
          startRealTimeSync();
          document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
          document.getElementById('loginOverlay').style.display = 'none';
          document.getElementById('appMain').style.display = 'block';
          tabloyuOlustur();
          refreshUI();
        }
      });
    };
  </script>
</body>
</html>
