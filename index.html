<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">
  
  <title>TURKMEDYA TEKNiK VARDiYA | V9.2 Final</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  
  <style>
    /* --- CSS AYARLARI --- */
    :root { 
      --primary: #1e293b; --blue: #2563eb; --bg: #f1f5f9; --card-bg: #ffffff; 
      --text: #334155; --border: #e2e8f0; --danger: #ef4444; --success: #22c55e; 
      --warning: #f59e0b; --table-head: #f8fafc; --saat1: #e0f2fe; --saat2: #f0fdf4; 
      --saat3: #faf5ff; --saat4: #fff7ed; --izin-bg: #fef2f2; 
    }
    
    [data-theme="dark"] { 
      --primary: #0f172a; --bg: #020617; --card-bg: #1e293b; --text: #f1f5f9; 
      --border: #334155; --table-head: #0f172a; --saat1: #0c4a6e; --saat2: #064e3b; 
      --saat3: #581c87; --saat4: #7c2d12; --izin-bg: #450a0a; 
    }
    
    body { 
        font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); 
        margin: 0; font-size: 12px; transition: background 0.3s ease; 
    }
    
    /* GÄ°RÄ°Å EKRANI */
    #loginOverlay, #panelOverlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 9999; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; transition: 0.5s; 
    }
    #loginOverlay { background: var(--primary); } 
    #panelOverlay { background: rgba(0,0,0,0.5); z-index:999; display:none; }
    
    .login-card { 
        background: var(--card-bg); padding: 40px; border-radius: 20px; 
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); text-align: center; width: 320px; 
    }
    .login-btn { 
        width: 100%; padding: 15px; margin: 10px 0; border: none; 
        border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 14px; 
    }
    .btn-user { background: var(--blue); color: white; } 
    .btn-admin { background: #475569; color: white; }
    .login-logo { 
        max-height: 80px; width: auto; max-width: 200px; 
        margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; 
    }
    #personelSecimDiv { display: none; margin-top: 15px; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    /* DASHBOARD */
    .dashboard-container { display: none; margin-bottom: 20px; width: 100%; }
    .welcome-card { 
        background: linear-gradient(135deg, var(--blue), var(--primary)); 
        color: white; padding: 20px; border-radius: 16px; 
        text-align: center; width: 100%; box-sizing: border-box; 
    }
    .status-badge { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-weight: 700; font-size: 12px; }
    .next-shift-info { margin-top: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; font-size: 11px; display: flex; justify-content: space-around; }
    
    .app-wrapper { padding: 10px; display: none; } 
    .main-header { 
        display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; 
        background: var(--primary); color: white; padding: 10px 15px; 
        border-radius: 12px; margin-bottom: 15px; gap: 10px; 
    }
    
    /* TABLO */
    .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; position: relative; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; table-layout: fixed; }
    th { background: var(--table-head); color: var(--text); padding: 12px 8px; border-bottom: 2px solid var(--border); border-right: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
    td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 6px; vertical-align: top; height: 95px; }
    .saat-col { font-weight: 800; text-align: center; border-left: 5px solid var(--blue); width: 100px; position: sticky; left: 0; z-index: 20; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    .row-saat-0 { background-color: var(--saat1); } .row-saat-0 .saat-col { background-color: var(--saat1); }
    .row-saat-1 { background-color: var(--saat2); } .row-saat-1 .saat-col { background-color: var(--saat2); }
    .row-saat-2 { background-color: var(--saat3); } .row-saat-2 .saat-col { background-color: var(--saat3); }
    .row-saat-3 { background-color: var(--saat4); } .row-saat-3 .saat-col { background-color: var(--saat4); }
    .row-izin { background-color: var(--izin-bg) !important; }
    .row-izin .saat-col { border-left-color: var(--danger) !important; color: var(--danger); background-color: var(--izin-bg) !important; }
    .weekend-col { background-color: var(--weekend-bg) !important; }
    
    .birim-card { 
        border-left: 4px solid var(--blue); padding: 6px 8px; margin-bottom: 5px; 
        background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border); 
        cursor: pointer; transition: all 0.3s ease; 
    }
    .birim-card.dimmed { opacity: 0.15; filter: grayscale(100%); }
    .birim-card.highlighted { opacity: 1; transform: scale(1.05); z-index: 50; border-color: var(--primary) !important; }
    .birim-tag { font-size: 7px; font-weight: 800; color: white; display: inline-block; padding: 1px 4px; border-radius: 3px; margin-bottom: 2px; text-transform: uppercase; }
    .pers-name { font-size: 10px; font-weight: 700; display: block; }
    
    /* PANEL */
    .side-panel { position: fixed; top: 0; right: -550px; width: 500px; height: 100%; background: var(--card-bg); z-index: 1000; transition: 0.4s; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.2); }
    .side-panel.open { right: 0; }
    .panel-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
    .panel-content { padding: 15px; overflow-y: auto; flex: 1; }
    .panel-action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
    .btn-main-action { padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px; color: white; }
    .hidden { display: none; }
    .tab-btn { flex: 1; padding: 8px; border: none; background: #e2e8f0; cursor: pointer; font-size: 10px; font-weight: 700; border-radius: 4px; color: #64748b; }
    .tab-btn.active { background: var(--blue); color: white; }
    .izin-gun-pill { padding: 4px 8px; background: var(--bg); border-radius: 4px; margin: 2px; font-size: 10px; cursor: pointer; display: inline-block; font-weight: 800; border: 1px solid var(--border); color: var(--text); }
    .izin-gun-pill.active { background: var(--danger); color: white; border-color: var(--danger); }
    .mcr-ayarlar { background: #f8fafc; border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-top: 10px; }
    .admin-only { display: none; } 
    .mobile-day-tabs { display: none; }
    
    @media screen and (max-width: 768px) { 
        .side-panel { width: 100%; right: -100%; }
        .main-header { flex-direction: column; text-align: center; }
        .table-container { margin-top: 10px; }
        table { display: block; min-width: 100%; }
        thead { display: none; } tbody, tfoot { display: block; }
        tr { display: block; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--card-bg); }
        .saat-col { display: block; width: 100%; text-align: center; padding: 8px; background: var(--primary); color: white !important; font-size: 14px; border-left: none; background-clip: padding-box; }
        .row-izin .saat-col { background: var(--danger) !important; }
        td { display: block; border: none; border-bottom: 1px solid var(--border); padding: 8px; min-height: 50px; height: auto; }
        td:last-child { border-bottom: none; }
        .mobile-day-tabs { display: flex; gap: 5px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; }
        .day-tab-btn { flex: 1; min-width: 50px; padding: 10px 5px; border: 1px solid var(--border); background: var(--card-bg); border-radius: 8px; font-weight: 700; font-size: 11px; color: var(--text); text-align: center; cursor: pointer; transition: 0.2s; }
        .day-tab-btn.active { background: var(--blue); color: white; border-color: var(--blue); transform: scale(1.05); }
        .mobile-hidden-day { display: none !important; }
        .birim-card { padding: 8px; }
    }  
  </style>
</head>
<body>

  <div id="loginOverlay">
    <div class="login-card">
        <img src="logo.png" alt="Logo" class="login-logo" onerror="this.style.display='none'">
        <h2 style="margin:0 0 20px 0; color:var(--primary)">Sistem GiriÅŸi</h2>
        
        <div id="loginButtons">
            <button onclick="showPersonelSelect()" class="login-btn btn-user">ğŸ‘¤ PERSONEL GÄ°RÄ°ÅÄ°</button>
            <button onclick="enterSystem('admin')" class="login-btn btn-admin">âš™ï¸ YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ°</button>
        </div>

        <div id="personelSecimDiv">
            <label style="display:block; text-align:left; font-size:10px; font-weight:bold; margin-bottom:5px;">Ä°SMÄ°NÄ°ZÄ° SEÃ‡Ä°N:</label>
            <select id="girisPersonelSec" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border);"></select>
            <button onclick="enterSystem('personel')" class="login-btn" style="background:var(--success); color:white;">GÄ°RÄ°Å YAP &raquo;</button>
            <button onclick="hidePersonelSelect()" style="background:none; border:none; color:var(--text); font-size:11px; cursor:pointer;">&laquo; Geri DÃ¶n</button>
        </div>
        <p style="font-size: 10px; color: #64748b; margin-top: 20px;">TURKMEDYA TEKNÄ°K V9.2 FINAL</p>
    </div>
  </div>

  <div id="talepModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10001; display:none; align-items:center; justify-content:center;">
    <div class="login-card" style="width: 320px; border: 2px solid var(--blue);">
        <h3 style="margin-top:0; color:var(--primary)">Vardiya / Ä°zin Talebi</h3>
        <select id="talepPersonel" style="width:100%; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border);"></select>
        <label style="display:block; text-align:left; font-size:10px; margin-bottom:5px; font-weight:bold; color:var(--text)">TARÄ°H SEÃ‡Ä°N:</label>
        <input type="date" id="talepTarih" style="width:93%; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border); font-family:inherit;">
        <select id="talepTuru" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border);">
            <option value="Ä°ZÄ°NLÄ°">Ä°ZÄ°NLÄ° (Ä°zin Talebi)</option>
            <option value="06:30â€“16:00">06:30â€“16:00</option>
            <option value="09:00â€“18:00">09:00â€“18:00</option>
            <option value="16:00â€“00:00">16:00â€“00:00</option>
            <option value="00:00â€“07:00">00:00â€“07:00</option>
        </select>
        <button onclick="talepGonder()" class="btn-main-action" style="background:var(--success); width:100%; padding:12px;">TALEBÄ° GÃ–NDER</button>
        <button onclick="document.getElementById('talepModal').style.display='none'" style="background:none; border:none; color:var(--danger); margin-top:10px; cursor:pointer; font-weight:bold;">Ä°ptal</button>
    </div>
  </div>

  <div id="panelOverlay" onclick="toggleAdminPanel()"></div>
  
  <div class="app-wrapper" id="appMain">
    <header class="main-header no-print">
      <div style="display: flex; align-items: center; gap: 10px;">
        <img src="logo.png" alt="Logo" style="height: 35px;">
        <div><h1 style="margin:0; font-size:16px;">TEKNiK EKÄ°P Ã‡ALIÅMA LÄ°STESÄ° V9.2</h1><p id="tarihAraligi" style="margin:0; opacity:0.8; font-size:10px;"></p></div>
      </div>
      <div style="display:flex; gap:5px; flex-wrap: wrap; justify-content: center;">
        <button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#475569">Â« Geri</button>
        <button onclick="buluttanYukle()" class="btn-main-action admin-only" style="background:#4285f4">ğŸ”„ BULUTTAN YÃœKLE</button>
        <button onclick="toggleTheme()" class="btn-main-action" style="background:#64748b" id="themeBtn">ğŸŒ™</button>
        <button onclick="excelIndir()" class="btn-main-action admin-only" style="background:#16a34a">EXCEL</button>
        <button onclick="window.print()" class="btn-main-action" style="background:var(--blue)">PDF / YAZDIR</button>
        <button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#475569">Ä°leri Â»</button>
        <button onclick="toggleAdminPanel()" class="btn-main-action admin-only" style="background:var(--primary); border: 1px solid #475569;" id="adminSettingsBtn">âš™ AYARLAR</button>
      </div>
    </header>

    <div id="personalDashboard" class="dashboard-container"></div>

    <div id="persTalepArea" style="text-align:center; display:none;" class="no-print">
         <button onclick="talepModalAc()" class="btn-main-action" style="background:var(--warning); margin: 0 auto 15px auto; width: 250px; color: #1e293b; font-weight: 800; border: 2px solid #1e293b;">ğŸ“ VARDÄ°YA / Ä°ZÄ°N TALEBÄ° OLUÅTUR</button>
    </div>

    <div class="mobile-day-tabs" id="mobilGunTablari"></div>

    <main class="table-container">
        <table id="vardiyaTablosu"><thead id="tableHeader"></thead><tbody id="tableBody"></tbody><tfoot id="tableFooter"></tfoot></table>
    </main>
  </div>

  <div id="sidePanel" class="side-panel no-print">
    <div class="panel-header"><h2 style="margin:0; font-size:16px;">YÃ¶netim Paneli</h2><button onclick="toggleAdminPanel()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button></div>
    <div class="panel-content">
        <div class="panel-action-group">
            <button onclick="vardiyaUretVeKaydet()" class="btn-main-action" style="background:var(--success); grid-column: span 2; padding: 15px; font-size: 13px;">âœ¨ VARDÄ°YA OLUÅTUR</button>
            <button onclick="bulutaKaydet()" class="btn-main-action" style="background:#ea4335">â˜ï¸ BULUTA KAYDET</button>
            <button onclick="whatsappGonder()" class="btn-main-action" style="background:#25D366">ğŸŸ¢ WHATSAPP</button>
        </div>
        <div class="admin-tabs" style="display:flex; gap:2px; margin-bottom:15px;">
          <button id="btn-tab-personel" class="tab-btn active" onclick="tabDegistir('personel')">Personel</button>
          <button id="btn-tab-birimler" class="tab-btn" onclick="tabDegistir('birimler')">Birimler</button>
          <button id="btn-tab-saatler" class="tab-btn" onclick="tabDegistir('saatler')">Saatler</button>
          <button id="btn-tab-sabitle" class="tab-btn" onclick="tabDegistir('sabitle')">Sabitler</button>
          <button id="btn-tab-kapasite" class="tab-btn" onclick="tabDegistir('kapasite')">Kapasite</button>
          <button id="btn-tab-sistem" class="tab-btn" onclick="tabDegistir('sistem')">Sistem</button>
          <button id="btn-tab-talepler" class="tab-btn" onclick="tabDegistir('talepler')" style="background: var(--warning); color: black;">Talepler</button>
        </div>
        
        <div id="tab-personel" class="tab-content">
            <div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:15px; border:2px solid var(--blue);">
                <h4 style="margin:0 0 5px 0; color:var(--primary);">âš¡ PERSONEL DEÄÄ°ÅÄ°MÄ°</h4>
                <select id="swapSource" style="width:100%; padding:8px; margin-bottom:5px; border-radius:6px; border:1px solid var(--border);"></select>
                <div style="text-align:center; font-weight:bold; margin-bottom:5px; font-size:10px;">â¬‡ï¸ YERÄ°NE GEÃ‡ECEK â¬‡ï¸</div>
                <select id="swapTarget" style="width:100%; padding:8px; margin-bottom:5px; border-radius:6px; border:1px solid var(--border);"></select>
                <div style="display:flex; justify-content:space-between; gap:2px; margin-top:5px;">
                    <label><input type="checkbox" class="swap-day-chk" value="0">Pzt</label>
                    <label><input type="checkbox" class="swap-day-chk" value="1">Sal</label>
                    <label><input type="checkbox" class="swap-day-chk" value="2">Ã‡ar</label>
                    <label><input type="checkbox" class="swap-day-chk" value="3">Per</label>
                    <label><input type="checkbox" class="swap-day-chk" value="4">Cum</label>
                    <label><input type="checkbox" class="swap-day-chk" value="5">Cmt</label>
                    <label><input type="checkbox" class="swap-day-chk" value="6">Paz</label>
                </div>
                <button onclick="applyPersonSwap()" class="btn-main-action" style="width:100%; background:var(--blue); margin-top:10px;">UYGULA</button>
            </div>
            <div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:15px;"><input type="text" id="yeniPersInp" placeholder="Ad Soyad" style="width:95%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);"><select id="yeniPersBirimSec" style="width:100%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);"></select><button onclick="personelEkle()" class="btn-main-action" style="width:100%; background:var(--success)">PERSONEL EKLE</button></div>
            <div id="persListesiAdmin"></div>
        </div>

        <div id="tab-birimler" class="tab-content hidden"><div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:15px;"><input type="text" id="yeniBirimInput" placeholder="Yeni Birim AdÄ±" style="width:95%; padding:10px; border-radius:6px; border:1px solid var(--border); margin-bottom:5px;"><button onclick="birimEkle()" class="btn-main-action" style="width:100%; background:var(--success)">EKLE</button></div><div id="birimListesiAdmin"></div></div>
        <div id="tab-saatler" class="tab-content hidden"><div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:15px;"><input type="text" id="yeniSaatInput" placeholder="00:00â€“00:00" style="width:95%; padding:10px; border-radius:6px; border:1px solid var(--border); margin-bottom:5px;"><button onclick="saatEkle()" class="btn-main-action" style="width:100%; background:var(--success)">EKLE</button></div><div id="saatListesiAdmin"></div></div>
        <div id="tab-sabitle" class="tab-content hidden"><div id="sabitListeAdmin"></div></div>
        <div id="tab-kapasite" class="tab-content hidden"><div id="kapasiteTable"></div></div>
        <div id="tab-sistem" class="tab-content hidden">
            <button onclick="jsonYedekAl()" class="btn-main-action" style="width:100%; background:var(--blue); margin-bottom:10px;">ğŸ’¾ JSON Ä°NDÄ°R</button>
            <button onclick="jsonYedekYukle()" class="btn-main-action" style="width:100%; background:var(--success); margin-bottom:10px;">ğŸ“‚ YEDEÄÄ° YÃœKLE</button>
            <input type="file" id="jsonInput" style="display:none" onchange="handleFileSelect(this)">
            <button onclick="githubdanYedekYukle()" class="btn-main-action" style="width:100%; background:#000; color:#fff; margin-bottom:10px;">ğŸ“‚ GITHUB'DAN YÃœKLE</button>
            <button onclick="vardiyaSifirla()" class="btn-main-action" style="width:100%; background:var(--warning); margin-bottom:10px;">Bu HaftayÄ± Temizle</button>
            <button onclick="tamSifirla()" class="btn-main-action" style="width:100%; background:var(--danger)">TÃ¼m VeritabanÄ±nÄ± Sil</button>
        </div>
        <div id="tab-talepler" class="tab-content hidden"><div id="gelenTaleplerListesi" style="max-height: 400px; overflow-y: auto;"></div></div>
  </div>

  <script>
    const CONFIG = {
        firebase: { apiKey: "AIzaSyBY8dA7IQ0vcdjtG0haRVFuF0vTgZACU0M", authDomain: "teknik-vardiya-listesi.firebaseapp.com", databaseURL: "https://teknik-vardiya-listesi-default-rtdb.europe-west1.firebasedatabase.app", projectId: "teknik-vardiya-listesi", storageBucket: "teknik-vardiya-listesi.firebasestorage.app", messagingSenderId: "900931844150", appId: "1:900931844150:web:41c799492e85d62df8c097" },
        days: ["Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt", "Paz"],
        colors: { "TEKNÄ°K YÃ–NETMEN": "#2563eb", "SES OPERATÃ–RÃœ": "#7c3aed", "KJ OPERATÃ–RÃœ": "#db2777", "PLAYOUT OPERATÃ–RÃœ": "#059669", "REJÄ°": "#d97706", "24TV MCR OPERATÃ–RÃœ": "#9333ea","360TV MCR OPERATÃ–RÃœ": "#9333ea", "INGEST OPERATÃ–RÃœ": "#06b6d4" },
        telegram: { api: "8509542541:AAFu-iDK85iELZQmImCWSZRi3_eWzUyyCiM", id: "859235247" } 
    };

    firebase.initializeApp(CONFIG.firebase); const database = firebase.database();
    let isAdmin = false; let aktifMobilGun = (new Date().getDay() + 6) % 7; let activeUser = ""; let currentMonday = getMonday(new Date());
    let state = { birimler: JSON.parse(localStorage.getItem("birimler")) || Object.keys(CONFIG.colors), saatler: JSON.parse(localStorage.getItem("saatler")) || ["06:30â€“16:00", "09:00â€“18:00", "16:00â€“00:00", "00:00â€“07:00"], personeller: JSON.parse(localStorage.getItem("personeller")) || [], kapasite: JSON.parse(localStorage.getItem("kapasite")) || {}, manuelAtamalar: JSON.parse(localStorage.getItem("manuelAtamalar")) || {}, haftaIciSabitler: JSON.parse(localStorage.getItem("haftaIciSabitler")) || {}, mcrAyarlari: JSON.parse(localStorage.getItem("mcrAyarlari")) || { baslangicTarihi: new Date().toISOString().split('T')[0], ofsetler: {} } };

    async function hassasAyarlariYukle() { try { const snap = await database.ref('config').once('value'); if (snap.exists()) { const c = snap.val(); if(c.telegram_api) CONFIG.telegram.api = c.telegram_api; if(c.telegram_id) CONFIG.telegram.id = c.telegram_id; } } catch (e) {} }

    function showPersonelSelect() { 
        document.getElementById('loginButtons').style.display = 'none'; 
        const sel = document.getElementById('girisPersonelSec');
        sel.innerHTML = `<option value="">SeÃ§iniz...</option>` + state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
        document.getElementById('personelSecimDiv').style.display = 'block'; 
    }
    function hidePersonelSelect() { document.getElementById('personelSecimDiv').style.display = 'none'; document.getElementById('loginButtons').style.display = 'block'; }

    async function enterSystem(role) {
        if (role === 'admin') {
            const email = prompt("E-posta:"); const password = prompt("Åifre:");
            if (!email || !password) return;
            try { await firebase.auth().signInWithEmailAndPassword(email, password); isAdmin = true; document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex'); document.getElementById('persTalepArea').style.display = 'none'; } catch (e) { alert("Hata: " + e.message); return; }
        } else {
            const selectedName = document.getElementById('girisPersonelSec').value;
            if(!selectedName) { alert("LÃ¼tfen isminizi seÃ§in."); return; }
            isAdmin = false; activeUser = selectedName;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.getElementById('persTalepArea').style.display = 'block';
        }
        
        database.ref('vardiya_data').once('value').then(snap => {
            if(snap.exists()) { state = snap.val(); save(); tabloyuOlustur(); if(!isAdmin && activeUser) renderPersonalDashboard(activeUser); }
            document.getElementById('loginOverlay').style.opacity = '0'; 
            setTimeout(() => { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('appMain').style.display = 'block'; }, 500);
        }).catch(e => { console.log(e); document.getElementById('loginOverlay').style.opacity = '0'; setTimeout(() => { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('appMain').style.display = 'block'; tabloyuOlustur(); if(!isAdmin && activeUser) renderPersonalDashboard(activeUser); }, 500); });
    }

    function talepModalAc() { 
        const sel = document.getElementById('talepPersonel'); 
        let options = "";
        if (state.personeller && state.personeller.length > 0) {
            options = state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
        }
        sel.innerHTML = options;
        if(activeUser) sel.value = activeUser; 
        document.getElementById('talepModal').style.display = 'flex'; 
    }

    function renderPersonalDashboard(userName) {
        const hKey = currentMonday.toISOString().split('T')[0];
        const bugunIdx = (new Date().getDay() + 6) % 7; const yarinIdx = (bugunIdx + 1) % 7;
        let bugunVardiya = state.manuelAtamalar[`${hKey}_${userName}_${bugunIdx}`] || "Ä°ZÄ°NLÄ°";
        let yarinVardiya = state.manuelAtamalar[`${hKey}_${userName}_${yarinIdx}`] || "Ä°ZÄ°NLÄ°";
        const container = document.getElementById('personalDashboard'); container.style.display = 'block';
        let bg = "linear-gradient(135deg, var(--blue), var(--primary))";
        if(bugunVardiya === "Ä°ZÄ°NLÄ°") bg = "linear-gradient(135deg, var(--success), #15803d)";
        if(bugunVardiya === "00:00â€“07:00") bg = "linear-gradient(135deg, #4f46e5, #312e81)";
        container.innerHTML = `<div class="welcome-card" style="background:${bg}"><h2>HoÅŸ Geldin,</h2><h1>${userName.split(' ')[0]}</h1><div class="status-badge">BUGÃœN: ${bugunVardiya}</div><div class="next-shift-info"><span>ğŸ“… <strong>YARIN:</strong> ${yarinVardiya}</span></div></div>`;
        highlightPerson(userName);
    }

    function highlightPerson(name) {
        const cleanName = name.split(' (')[0].trim();
        if (activeHighlight === cleanName && !activeUser) { document.querySelectorAll('.birim-card').forEach(el => el.classList.remove('dimmed', 'highlighted')); activeHighlight = null; }
        else { activeHighlight = cleanName; document.querySelectorAll('.birim-card').forEach(el => { const n = el.querySelector('.pers-name'); if(!n) return; if (n.innerText.split(' (')[0].trim() === cleanName) { el.classList.remove('dimmed'); el.classList.add('highlighted'); } else { el.classList.remove('highlighted'); el.classList.add('dimmed'); } }); }
    }

    function mobilGunSec(gunIndex) { aktifMobilGun = gunIndex; document.querySelectorAll('.day-tab-btn').forEach((btn, idx) => { if(idx === gunIndex) btn.classList.add('active'); else btn.classList.remove('active'); }); tabloyuOlustur(); }
    function getMonday(d) { d = new Date(d); let day = d.getDay(); return new Date(d.setDate(d.getDate() - day + (day == 0 ? -6 : 1))); }
    function save() { Object.keys(state).forEach(k => localStorage.setItem(k, JSON.stringify(state[k]))); }
    function getBirimColor(birim) { return CONFIG.colors[birim] || "#64748b"; }

    function tabloyuOlustur() {
        const hKey = currentMonday.toISOString().split('T')[0];
        document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} HaftasÄ±`;
        document.getElementById("mobilGunTablari").innerHTML = CONFIG.days.map((g, i) => `<div class="day-tab-btn ${i === aktifMobilGun ? 'active' : ''}" onclick="mobilGunSec(${i})">${g}</div>`).join('');

        let headerHtml = `<tr><th style="width:100px;">SAAT</th>`;
        CONFIG.days.forEach((g, i) => { let hiddenClass = (i !== aktifMobilGun) ? 'mobile-hidden-day' : ''; headerHtml += `<th class="${i>=5?'weekend-col':''} ${hiddenClass}">${g}</th>`; });
        headerHtml += `</tr>`; document.getElementById("tableHeader").innerHTML = headerHtml;
        
        let prog = {}; let calis = {};
        state.personeller.forEach(p => { prog[p.ad] = Array(7).fill(null); calis[p.ad] = 0; for(let i=0; i<7; i++) { let mKey = `${hKey}_${p.ad}_${i}`; if(state.manuelAtamalar[mKey]) prog[p.ad][i] = state.manuelAtamalar[mKey]; if(prog[p.ad][i] && !["Ä°ZÄ°NLÄ°","BOÅ",null].includes(prog[p.ad][i])) calis[p.ad]++; } });

        document.getElementById("tableBody").innerHTML = state.saatler.map((s, sIdx) => {
            let rowHtml = `<tr class="row-saat-${sIdx}"><td class="saat-col">${s}</td>`;
            for(let g=0; g<7; g++) {
                let hiddenClass = (g !== aktifMobilGun) ? 'mobile-hidden-day' : '';
                let sortedPers = state.personeller.filter(p => prog[p.ad][g] === s).sort((a, b) => { if(state.birimler.indexOf(a.birim) !== state.birimler.indexOf(b.birim)) return state.birimler.indexOf(a.birim) - state.birimler.indexOf(b.birim); return (b.oncelik || 0) - (a.oncelik || 0); });
                let cellContent = "";
                sortedPers.forEach((p) => {
                    let click = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : `onclick="highlightPerson('${p.ad}')"`;
                    let drag = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, '${s}')"` : "";
                    cellContent += `<div class="birim-card" style="border-left-color:${getBirimColor(p.birim)}; background-color:${getBirimColor(p.birim)}15;" ${drag} ${click}><span class="birim-tag" style="background:${getBirimColor(p.birim)}">${p.birim}</span><span class="pers-name">${p.ad}</span></div>`;
                });
                rowHtml += `<td class="${g>=5?'weekend-col':''} ${hiddenClass}" data-label="${CONFIG.days[g]}" ondragover="event.preventDefault()" ondrop="drop(event, '${s}', ${g})">${cellContent}</td>`;
            } return rowHtml + "</tr>";
        }).join('');

        let footerHtml = `<tr class="row-izin"><td class="saat-col">Ä°ZÄ°N / BOÅ</td>`;
        for(let g=0; g<7; g++) {
            let hiddenClass = (g !== aktifMobilGun) ? 'mobile-hidden-day' : '';
            let sortedPers = state.personeller.filter(p => ["Ä°ZÄ°NLÄ°","BOÅ",null].includes(prog[p.ad][g])).sort((a, b) => state.birimler.indexOf(a.birim) - state.birimler.indexOf(b.birim));
            let cellContent = "";
            sortedPers.forEach(p => {
                let click = isAdmin ? `onclick="vardiyaDegistir('${p.ad}',${g})"` : `onclick="highlightPerson('${p.ad}')"`;
                let drag = isAdmin ? `draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, 'BOÅ')"` : "";
                cellContent += `<div class="birim-card" style="border-left-color:${getBirimColor(p.birim)};" ${drag} ${click}><span class="birim-tag" style="background:${prog[p.ad][g]==='Ä°ZÄ°NLÄ°'?'var(--danger)':getBirimColor(p.birim)}">${prog[p.ad][g]==='Ä°ZÄ°NLÄ°'?'Ä°ZÄ°NLÄ°':p.birim}</span><span class="pers-name">${p.ad} (${calis[p.ad]}G)</span></div>`;
            });
            footerHtml += `<td class="${g>=5?'weekend-col':''} ${hiddenClass}" data-label="${CONFIG.days[g]}" ondragover="event.preventDefault()" ondrop="drop(event, 'BOÅ', ${g})">${cellContent}</td>`;
        }
        footerHtml += `</tr>`; document.getElementById("tableFooter").innerHTML = footerHtml;
        if(activeUser) highlightPerson(activeUser);
    }

    async function vardiyaUretVeKaydet() {
        if(!isAdmin) return;
        if(!confirm("Vardiya oluÅŸturulsun mu? OnaylÄ± izinler korunacak.")) return;

        try {
            const snap = await database.ref('vardiya_data').once('value');
            if (snap.exists()) { state = snap.val(); save(); console.log("Veri senkronize edildi."); }
        } catch (e) { alert("Veri Ã§ekilemedi!"); return; }

        const hKey = currentMonday.toISOString().split('T')[0];
        let tempProg = {}; let calis = {};
        const mcrDongu = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "00:00â€“07:00", "00:00â€“07:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"]; 
        const ingestDongu = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"];
        const baseDate = new Date(state.mcrAyarlari.baslangicTarihi);

        state.personeller.forEach(p => { 
            tempProg[p.ad] = Array(7).fill(null); calis[p.ad] = 0; 
            
            for(let g=0; g<7; g++) {
                let mKey = `${hKey}_${p.ad}_${g}`;
                if(state.manuelAtamalar[mKey]) { 
                    tempProg[p.ad][g] = state.manuelAtamalar[mKey]; 
                    if(!["Ä°ZÄ°NLÄ°","BOÅ",null].includes(tempProg[p.ad][g])) calis[p.ad]++; 
                }
                
                // Ã–NCELÄ°K 2: YÃ–NETÄ°CÄ° Ä°ZNÄ° (KESÄ°N EMÄ°R)
                if (tempProg[p.ad][g] === null && p.izinGunleri && p.izinGunleri.includes(g)) {
                    tempProg[p.ad][g] = "Ä°ZÄ°NLÄ°";
                }
            }

            const persOfset = parseInt(state.mcrAyarlari.ofsetler[p.ad] || 0);

            // Ã–NCELÄ°K 3: DÃ–NGÃœLER
            if(p.birim.includes("INGEST")) {
                for(let g=0; g<7; g++) { 
                    if(tempProg[p.ad][g] !== null) continue;
                    let d = new Date(currentMonday); d.setDate(d.getDate() + g); const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24)); const modIndex = ((diffDays + persOfset) % 6 + 6) % 6; tempProg[p.ad][g] = ingestDongu[modIndex]; if(!["Ä°ZÄ°NLÄ°","BOÅ",null].includes(tempProg[p.ad][g])) calis[p.ad]++; 
                }
            } else if(p.birim.includes("MCR")) {
                for(let g=0; g<7; g++) { 
                    if(tempProg[p.ad][g] !== null) continue; 
                    let d = new Date(currentMonday); d.setDate(d.getDate() + g); const diffDays = Math.floor((d - baseDate) / (1000 * 60 * 60 * 24)); const modIndex = ((diffDays + persOfset) % 8 + 8) % 8; tempProg[p.ad][g] = mcrDongu[modIndex]; if(!["Ä°ZÄ°NLÄ°","BOÅ",null].includes(tempProg[p.ad][g])) calis[p.ad]++; 
                }
            } else if (state.haftaIciSabitler[p.ad]) {
                const sabitSaat = state.haftaIciSabitler[p.ad]; for(let i=0; i<5; i++) { if(tempProg[p.ad][i] === null) { tempProg[p.ad][i] = sabitSaat; calis[p.ad]++; } } if(tempProg[p.ad][5] === null) tempProg[p.ad][5] = "Ä°ZÄ°NLÄ°"; if(tempProg[p.ad][6] === null) tempProg[p.ad][6] = "Ä°ZÄ°NLÄ°";
            }
        });

        for (let gun = 0; gun < 7; gun++) {
            kapasiteDoldur(gun, "00:00â€“07:00", tempProg, calis);
            state.saatler.filter(s => s !== "00:00â€“07:00").forEach(saat => kapasiteDoldur(gun, saat, tempProg, calis));
        }

        // Ã–NCELÄ°K 5: BOÅLUK DOLDURMA (Ä°ZÄ°N KORUMALI)
        state.personeller.forEach(p => {
            for(let g=0; g<7; g++) { 
                if(tempProg[p.ad][g] === null) {
                    if (p.izinGunleri && p.izinGunleri.includes(g)) tempProg[p.ad][g] = "Ä°ZÄ°NLÄ°";
                    else if(p.birim.includes("MCR") || p.birim.includes("INGEST")) tempProg[p.ad][g] = "Ä°ZÄ°NLÄ°";
                    else if(calis[p.ad] < 5) { tempProg[p.ad][g] = "09:00â€“18:00"; calis[p.ad]++; }
                    else tempProg[p.ad][g] = "Ä°ZÄ°NLÄ°";
                }
            }
        });

        state.personeller.forEach(p => { for(let i=0; i<7; i++) state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] = tempProg[p.ad][i]; });
        save(); 
        tabloyuOlustur(); 
        database.ref('vardiya_data').set(state); 
        alert("Vardiya oluÅŸturuldu.");
    }

    function kapasiteDoldur(gun, saat, tempProg, calis) {
        state.birimler.filter(b => !b.includes("MCR") && !b.includes("INGEST")).forEach(birim => {
            const hedef = (state.kapasite[`${birim}_${saat}`] || [0,0,0,0,0,0,0])[gun];
            let mevcut = state.personeller.filter(p => p.birim === birim && tempProg[p.ad][gun] === saat).length;
            if (mevcut < hedef) {
                let adaylar = state.personeller.filter(p => p.birim === birim && tempProg[p.ad][gun] === null && (!p.izinGunleri || !p.izinGunleri.includes(gun)));
                adaylar.sort((a, b) => (calis[a.ad] - calis[b.ad]) || (Math.random() - 0.5));
                for (let p of adaylar) { if (mevcut < hedef) { tempProg[p.ad][gun] = saat; calis[p.ad]++; mevcut++; } }
            }
        });
    }

    function refreshUI() {
        document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
        const swapSourceSel = document.getElementById("swapSource"); const swapTargetSel = document.getElementById("swapTarget");
        const personOptions = `<option value="">SeÃ§iniz...</option>` + state.personeller.map(p => `<option value="${p.ad}">${p.ad} (${p.birim})</option>`).join('');
        if(swapSourceSel) swapSourceSel.innerHTML = personOptions; if(swapTargetSel) swapTargetSel.innerHTML = personOptions;

        document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => {
            let mcrHtml = ""; 
            if(p.birim.includes("MCR")) mcrHtml = `<div class="mcr-ayarlar"><span>DÃ¶ngÃ¼ Ofseti: </span><input type="number" min="0" max="7" value="${state.mcrAyarlari.ofsetler[p.ad] || 0}" style="width:50px" onchange="mcrOfsetGuncelle('${p.ad}', this.value)"></div>`;
            else if(p.birim.includes("INGEST")) mcrHtml = `<div class="mcr-ayarlar"><span>DÃ¶ngÃ¼ Ofseti: </span><input type="number" min="0" max="5" value="${state.mcrAyarlari.ofsetler[p.ad] || 0}" style="width:50px" onchange="mcrOfsetGuncelle('${p.ad}', this.value)"></div>`;
            
            let birimSecimHtml = `<select onchange="birimGuncelle('${p.ad}', this.value)" style="margin-left:5px; padding:2px; font-size:10px; border-radius:4px;">`;
            state.birimler.forEach(b => { birimSecimHtml += `<option value="${b}" ${p.birim === b ? 'selected' : ''}>${b}</option>`; }); birimSecimHtml += `</select>`;

            return `<div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:5px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span><strong>${p.ad}</strong> ${birimSecimHtml}</span>
                    <button onclick="state.personeller.splice(${i},1); save(); refreshUI(); database.ref('vardiya_data').set(state);" style="color:var(--danger); border:none; background:none; cursor:pointer;">Sil</button>
                </div>
                <div style="margin-top:5px;">
                    ${CONFIG.days.map((g, gi) => `<span class="izin-gun-pill ${p.izinGunleri?.includes(gi)?'active':''}" onclick="izinGunuTetikle(${i},${gi})">${g}</span>`).join('')}
                </div>${mcrHtml}
            </div>`;
        }).join('');
        
        let capHtml = ""; state.birimler.forEach(b => { capHtml += `<div style="margin-bottom:15px; background:var(--bg); padding:10px; border-radius:8px;"><strong>${b}</strong>`; state.saatler.forEach(s => { const v = state.kapasite[`${b}_${s}`] || [0,0,0,0,0,0,0]; capHtml += `<div style="font-size:9px; margin-top:5px;">${s}</div><div style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px;">${CONFIG.days.map((g, gi) => `<input type="number" value="${v[gi]}" style="width:100%; text-align:center;" onchange="capUp('${b}_${s}',${gi},this.value)">`).join('')}</div>`; }); capHtml += `</div>`; });
        document.getElementById("kapasiteTable").innerHTML = capHtml;
        document.getElementById("sabitListeAdmin").innerHTML = `<div style="background:#e0f2fe; padding:10px; border-radius:8px; margin-bottom:10px;"><strong>DÃ¶ngÃ¼ BaÅŸlangÄ±Ã§ Tarihi:</strong><br><input type="date" value="${state.mcrAyarlari.baslangicTarihi}" onchange="state.mcrAyarlari.baslangicTarihi = this.value; save();" style="width:100%; padding:5px; margin-top:5px;"></div>` + state.personeller.filter(p => !p.birim.includes("MCR") && !p.birim.includes("INGEST")).map(p => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:var(--bg); padding:5px; border-radius:5px;"><label><input type="checkbox" ${state.haftaIciSabitler[p.ad]?'checked':''} onchange="sabitTetikle('${p.ad}')"> ${p.ad}</label><select onchange="sabitSaatGuncelle('${p.ad}', this.value)" ${!state.haftaIciSabitler[p.ad]?'disabled':''}>${state.saatler.map(s => `<option value="${s}" ${state.haftaIciSabitler[p.ad] === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`).join('');
        document.getElementById("birimListesiAdmin").innerHTML = state.birimler.map((b,i) => `<div style="padding:5px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">${b} <button onclick="birimSil(${i})" style="color:red;border:none;background:none;cursor:pointer;">x</button></div>`).join('');
        document.getElementById("saatListesiAdmin").innerHTML = state.saatler.map((s,i) => `<div style="padding:5px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">${s} <button onclick="saatSil(${i})" style="color:red;border:none;background:none;cursor:pointer;">x</button></div>`).join('');
    }

    function izinGunuTetikle(pi, gi) { 
        if(!state.personeller[pi].izinGunleri) state.personeller[pi].izinGunleri = []; 
        const idx = state.personeller[pi].izinGunleri.indexOf(gi); 
        if(idx > -1) state.personeller[pi].izinGunleri.splice(idx, 1); 
        else state.personeller[pi].izinGunleri.push(gi); 
        save(); 
        refreshUI(); 
        database.ref('vardiya_data/personeller').set(state.personeller);
    }

    function talepGonder() { 
        const ad = document.getElementById('talepPersonel').value; const tarih = document.getElementById('talepTarih').value; const tur = document.getElementById('talepTuru').value; 
        if(!tarih) { alert("Tarih seÃ§in!"); return; }
        const hKey = getMonday(new Date(tarih)).toISOString().split('T')[0]; const gunIdx = (new Date(tarih).getDay() + 6) % 7; const talepId = Date.now().toString(); 
        database.ref('talepler/' + talepId).set({ id: talepId, ad, tarih, gunIdx, tur, hKey, durum: "bekliyor" }); 
        fetch(`https://api.telegram.org/bot${CONFIG.telegram.api}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: CONFIG.telegram.id, text: `ğŸ”” *TALEP*\nğŸ‘¤ ${ad}\nğŸ“… ${tarih}\nğŸ“ ${tur}`, parse_mode: 'Markdown', reply_markup: { inline_keyboard: [[{ text: "âœ… ONAY", callback_data: `onay_${talepId}` }, { text: "âŒ RED", callback_data: `red_${talepId}` }]] } }) }); 
        alert("Ä°letildi."); document.getElementById('talepModal').style.display = 'none'; 
    }

    function talepleriRenderEt(taleplerObj) {
        const liste = document.getElementById('gelenTaleplerListesi');
        if(!taleplerObj) { liste.innerHTML = "<p style='text-align:center; opacity:0.5;'>Bekleyen talep yok.</p>"; return; }
        
        let html = "";
        const talepDizisi = Object.values(taleplerObj);
        
        talepDizisi.forEach(t => {
            if(t.durum === 'bekliyor') {
                html += `<div style="background:var(--card-bg); border:1px solid var(--border); border-left:5px solid var(--warning); padding:10px; margin-bottom:5px;">
                    <div><strong>${t.ad}</strong> <small>${t.tarih}</small></div>
                    <div>${t.tur}</div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button onclick="talepIslem('${t.id}', 'onay')" style="flex:1; background:var(--success); color:white; border:none; padding:5px;">ONAY</button>
                        <button onclick="talepIslem('${t.id}', 'red')" style="flex:1; background:var(--danger); color:white; border:none; padding:5px;">RED</button>
                    </div></div>`;
            }
        });
        
        if (html === "") {
            liste.innerHTML = "<p style='text-align:center; opacity:0.5;'>Bekleyen talep yok.</p>";
        } else {
            liste.innerHTML = html;
        }
    }

    function talepIslem(id, tip) { 
        database.ref('talepler/' + id).once('value', snap => { 
            const t = snap.val(); 
            if(tip === 'onay') { 
                state.manuelAtamalar[`${t.hKey}_${t.ad}_${t.gunIdx}`] = t.tur; 
                save(); tabloyuOlustur(); database.ref('vardiya_data').set(state);
                database.ref('talepler/' + id).update({ durum: 'onaylandi' }); 
            } else { 
                database.ref('talepler/' + id).update({ durum: 'reddedildi' }); 
            } 
        }); 
    }

    function applyPersonSwap() {
        const sourceName = document.getElementById("swapSource").value; const targetName = document.getElementById("swapTarget").value;
        if(!sourceName || !targetName || sourceName === targetName) { alert("HatalÄ± seÃ§im!"); return; }
        
        const checkboxes = document.querySelectorAll('.swap-day-chk:checked');
        const selectedDays = Array.from(checkboxes).map(c => parseInt(c.value));
        
        if (selectedDays.length === 0) {
            if(confirm("KalÄ±cÄ± deÄŸiÅŸim yapÄ±lsÄ±n mÄ±?")) {
                const sP = state.personeller.find(p => p.ad === sourceName); const tP = state.personeller.find(p => p.ad === targetName);
                if(sP && tP) { sP.birim = tP.birim; if(state.mcrAyarlari.ofsetler[targetName] !== undefined) state.mcrAyarlari.ofsetler[sourceName] = state.mcrAyarlari.ofsetler[targetName]; save(); refreshUI(); alert("DeÄŸiÅŸim tamamlandÄ±."); }
            }
        } else {
            if(confirm("Sadece seÃ§ili gÃ¼nlerde vardiya devralÄ±nsÄ±n mÄ±?")) {
                const hKey = currentMonday.toISOString().split('T')[0];
                selectedDays.forEach(dayIndex => {
                    let targetShift = state.manuelAtamalar[`${hKey}_${targetName}_${dayIndex}`];
                    if(targetShift && targetShift !== "Ä°ZÄ°NLÄ°") { 
                        state.manuelAtamalar[`${hKey}_${sourceName}_${dayIndex}`] = targetShift; 
                        state.manuelAtamalar[`${hKey}_${targetName}_${dayIndex}`] = "Ä°ZÄ°NLÄ°"; 
                    }
                });
                save(); tabloyuOlustur(); database.ref('vardiya_data').set(state); alert("Devralma tamamlandÄ±.");
            }
        }
    }

    function birimEkle() { const b = document.getElementById('yeniBirimInput').value.toUpperCase(); if(b && !state.birimler.includes(b)) { state.birimler.push(b); document.getElementById('yeniBirimInput').value = ""; save(); refreshUI(); } }
    function birimSil(idx) { if(confirm("Silinsin mi?")) { state.birimler.splice(idx, 1); save(); refreshUI(); } }
    function saatEkle() { const s = document.getElementById('yeniSaatInput').value; if(s && !state.saatler.includes(s)) { state.saatler.push(s); document.getElementById('yeniSaatInput').value = ""; save(); refreshUI(); } }
    function saatSil(idx) { if(confirm("Silinsin mi?")) { state.saatler.splice(idx, 1); save(); refreshUI(); } }
    function birimGuncelle(ad, yeniBirim) { const p = state.personeller.find(x => x.ad === ad); if (p) { p.birim = yeniBirim; save(); refreshUI(); tabloyuOlustur(); database.ref('vardiya_data').set(state); } }
    function oncelikGuncelle(ad, val) { const p = state.personeller.find(x=>x.ad===ad); if(p){ p.oncelik = parseInt(val); save(); } }
    function mcrOfsetGuncelle(ad, val) { if(!state.mcrAyarlari.ofsetler) state.mcrAyarlari.ofsetler = {}; state.mcrAyarlari.ofsetler[ad] = parseInt(val); save(); }
    function capUp(k, g, v) { if(!state.kapasite[k]) state.kapasite[k] = [0,0,0,0,0,0,0]; state.kapasite[k][g] = parseInt(v) || 0; save(); }
    function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + v); tabloyuOlustur(); if(activeUser) renderPersonalDashboard(activeUser); }
    function toggleAdminPanel() { const p = document.getElementById("sidePanel"); const o = document.getElementById("panelOverlay"); p.classList.toggle("open"); o.style.display = p.classList.contains("open") ? "block" : "none"; if(p.classList.contains("open")) tabDegistir('personel'); }
    function tabDegistir(t) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab-' + t).classList.remove('hidden'); event.target.classList.add('active'); refreshUI(); }
    function personelEkle() { const ad = document.getElementById("yeniPersInp").value.toUpperCase(); const b = document.getElementById("yeniPersBirimSec").value; if(ad){ state.personeller.push({ad, birim:b, izinGunleri:[], oncelik: 0}); save(); refreshUI(); document.getElementById("yeniPersInp").value=""; database.ref('vardiya_data').set(state); } }
    function vardiyaDegistir(p, g) { if(!isAdmin) return; const s = prompt(`${p}: 1:06:30, 2:09:00, 3:16:00, 4:00:00, 5:Ä°ZÄ°N`); if(s){ let v = null; if(s=="1") v="06:30â€“16:00"; if(s=="2") v="09:00â€“18:00"; if(s=="3") v="16:00â€“00:00"; if(s=="4") v="00:00â€“07:00"; if(s=="5") v="Ä°ZÄ°NLÄ°"; state.manuelAtamalar[`${currentMonday.toISOString().split('T')[0]}_${p}_${g}`] = v; save(); tabloyuOlustur(); database.ref('vardiya_data').set(state); } }
    function mcrOfsetGuncelle(ad, val) { if(!state.mcrAyarlari.ofsetler) state.mcrAyarlari.ofsetler = {}; state.mcrAyarlari.ofsetler[ad] = parseInt(val); save(); }
    function excelIndir() { /* Excel Kodu */ alert("Excel indiriliyor..."); }
    function whatsappGonder() { /* WP Kodu */ window.open(`https://wa.me/?text=Vardiya Listesi GÃ¼ncellendi!`); }
    function vardiyaSifirla() { if(confirm("HaftayÄ± temizle?")) { const hKey = currentMonday.toISOString().split('T')[0]; Object.keys(state.manuelAtamalar).forEach(k => { if(k.startsWith(hKey)) delete state.manuelAtamalar[k]; }); save(); tabloyuOlustur(); database.ref('vardiya_data').set(state); } }
    
    // --- TAM SIFIRLAMA (DÃœZELTÄ°LDÄ°) ---
    async function tamSifirla() { 
        if(confirm("DÄ°KKAT: VeritabanÄ±ndaki VE TarayÄ±cÄ±daki TÃœM veriler silinecek. Emin misiniz?")) { 
            await database.ref('vardiya_data').remove(); 
            await database.ref('talepler').remove(); 
            localStorage.clear(); 
            location.reload(); 
        } 
    }
    
    function jsonYedekAl() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "Yedek.json"); dl.click(); }
    async function githubdanYedekYukle() { const url = "https://raw.githubusercontent.com/ugurbakirtas/vardiya-sistemi/main/ilk_kurulum.json?t=" + new Date().getTime(); if (confirm("SÄ±fÄ±rlanacak. Onay?")) { try { const response = await fetch(url); if (!response.ok) throw new Error("Hata."); state = await response.json(); save(); alert("YÃ¼klendi!"); location.reload(); } catch (error) { alert("Hata: " + error.message); } } }
    function sabitTetikle(ad) { if(state.haftaIciSabitler[ad]) delete state.haftaIciSabitler[ad]; else state.haftaIciSabitler[ad] = state.saatler[0]; save(); refreshUI(); }
    function sabitSaatGuncelle(ad, saat) { state.haftaIciSabitler[ad] = saat; save(); }
    function cakismaKontrol(personelAd, hedefGun, hedefSaat) { const hKey = currentMonday.toISOString().split('T')[0]; if (["Ä°ZÄ°NLÄ°", "BOÅ", null].includes(hedefSaat)) return; if (hedefGun > 0) { let dunKey = `${hKey}_${personelAd}_${hedefGun - 1}`; let dunVardiya = state.manuelAtamalar[dunKey]; if (["16:00â€“00:00", "00:00â€“07:00"].includes(dunVardiya) && ["06:30â€“16:00", "09:00â€“18:00"].includes(hedefSaat)) { alert(`âš ï¸ DÄ°KKAT: ${personelAd} dinlenme sÃ¼resi ihlali olabilir!`); } } }
    function drag(e, p, g, s) { if(!isAdmin) return; e.dataTransfer.setData("p", p); e.dataTransfer.setData("oldG", g); }
    function drop(e, ns, ng) { if(!isAdmin) return; e.preventDefault(); const p = e.dataTransfer.getData("p"); const hKey = currentMonday.toISOString().split('T')[0]; cakismaKontrol(p, ng, ns); state.manuelAtamalar[`${hKey}_${p}_${ng}`] = ns === 'BOÅ' ? null : ns; save(); tabloyuOlustur(); database.ref('vardiya_data').set(state); }
    function toggleTheme() { const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark"; document.documentElement.setAttribute("data-theme", t); localStorage.setItem("theme", t); }

    // --- SENKRONÄ°ZASYON ---
    function anlikSenkronizasyonBaslat() {
        database.ref().on('value', (snap) => {
            if (snap.exists()) {
                const data = snap.val();
                
                // Vardiya Verisi
                if(data.vardiya_data) { 
                    state = data.vardiya_data; 
                    save(); 
                    tabloyuOlustur(); 
                    if(activeUser) renderPersonalDashboard(activeUser); 
                }
                
                // Talepler
                if(isAdmin && data.talepler) {
                    talepleriRenderEt(data.talepler);
                } else if(isAdmin) {
                    document.getElementById('gelenTaleplerListesi').innerHTML = "<p style='text-align:center; opacity:0.5;'>Bekleyen talep yok.</p>";
                }
                
                if(isAdmin) refreshUI();
            } else {
                // Ä°lk kurulum
                database.ref('vardiya_data').set(state);
            }
        });
    }

    window.onload = async () => { if(localStorage.getItem("theme") === "dark") document.documentElement.setAttribute("data-theme", "dark"); await hassasAyarlariYukle(); anlikSenkronizasyonBaslat(); };
  </script>
</body>
</html>