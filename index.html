<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TEKNÄ°K VARDÄ°YA LÄ°STESÄ° - index</title>

  <!-- Firebase + XLSX (optional) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary:#1e293b; --blue:#2563eb; --bg:#f1f5f9; --card:#fff;
      --text:#334155; --border:#e2e8f0; --danger:#ef4444; --success:#22c55e;
      --warning:#f59e0b;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);margin:0;font-size:13px}
    .center-card{max-width:980px;margin:20px auto;padding:12px}
    .login-overlay{position:fixed;inset:0;background:var(--primary);display:flex;align-items:center;justify-content:center;z-index:9999}
    .login-card{background:var(--card);padding:28px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);width:340px;text-align:center}
    button{cursor:pointer}
    .btn{padding:10px 12px;border-radius:8px;border:0;color:#fff;font-weight:700}
    .btn-admin{background:#475569}
    .btn-user{background:var(--blue)}
    header.main{display:flex;justify-content:space-between;align-items:center;background:var(--primary);color:#fff;padding:12px;border-radius:8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .table-container{background:var(--card);padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:12px;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:800px}
    th,td{padding:8px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:top}
    th{background:#f8fafc}
    .side-panel{position:fixed;right:-520px;top:0;width:480px;height:100%;background:var(--card);box-shadow:-10px 0 30px rgba(0,0,0,.12);transition:right .28s;padding:16px;overflow:auto;z-index:999}
    .side-panel.open{right:0}
    .talep{border-left:4px solid var(--blue);padding:10px;margin-bottom:12px;background:#fff;border:1px solid var(--border);border-radius:6px}
    .hidden{display:none}
    @media (max-width:700px){ .table-container{display:none} }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-card">
      <h2 style="margin:0 0 10px 0;color:var(--primary)">Sistem GiriÅŸi</h2>
      <button class="btn btn-user" onclick="enterSystem('personel')">ğŸ‘¤ PERSONEL GÄ°RÄ°ÅÄ°</button>
      <div style="height:8px"></div>
      <button class="btn btn-admin" onclick="enterSystem('admin')">âš™ï¸ YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ°</button>
      <p style="margin:12px 0 0 0;font-size:12px;color:#64748b">Not: YÃ¶netici iÃ§in Firebase Email/Password hesabÄ± gerekli</p>
    </div>
  </div>

  <div id="app" class="center-card" style="display:none">
    <header class="main">
      <div>
        <h3 style="margin:0">TEKNÄ°K EKÄ°P VARDÄ°YA LÄ°STESÄ°</h3>
        <div id="weekLabel" style="font-size:12px;opacity:.85"></div>
      </div>
      <div class="controls">
        <button class="btn" style="background:#475569" onclick="haftaDegistir(-7)">Â« Geri</button>
        <button class="btn" style="background:var(--blue)" onclick="window.print()">PDF</button>
        <button class="btn" style="background:#475569" onclick="haftaDegistir(7)">Ä°leri Â»</button>
        <button class="btn btn-admin admin-only" style="background:#16a34a" onclick="excelIndir()">EXCEL</button>
        <button class="btn btn-admin admin-only" style="background:#111" onclick="toggleAdminPanel()">âš™ AYARLAR</button>
      </div>
    </header>

    <div style="margin-top:12px">
      <div id="duyuru" class="hidden" style="padding:8px;border-radius:6px;background:#fffbeb;color:#92400e;margin-bottom:8px"></div>
      <div id="yorgunluk" class="hidden" style="padding:8px;border-radius:6px;background:#fee2e2;color:#991b1b;margin-bottom:8px"></div>

      <div style="margin-bottom:8px">
        <div id="mobilPanel" style="display:none;background:#fff;padding:12px;border-radius:8px;border:1px solid var(--border);margin-bottom:8px">
          <label><b>KiÅŸisel Vardiya</b></label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="mobilSelect" style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border)"></select>
            <button class="btn" style="background:var(--blue)" onclick="mobilVerileriYenile()">ğŸ”„</button>
          </div>
          <div id="mobilList" style="margin-top:8px;color:#666;font-size:13px">Ä°sminizi seÃ§in.</div>
        </div>

        <div id="talepArea" style="text-align:center;display:none">
          <button class="btn" style="background:var(--warning);color:#111;font-weight:900" onclick="openTalepModal()">ğŸ“ VARDÄ°YA / Ä°ZÄ°N TALEBÄ°</button>
        </div>
      </div>

      <div class="table-container">
        <table id="vardiyaTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
          <tfoot id="tableFoot"></tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- SIDE PANEL -->
  <div id="sidePanel" class="side-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h4 style="margin:0">YÃ¶netim Paneli</h4>
      <button onclick="toggleAdminPanel()" style="background:none;border:0;font-size:18px;cursor:pointer">âœ•</button>
    </div>

    <div style="margin-bottom:10px">
      <button class="btn" style="background:var(--success);width:100%;margin-bottom:6px" onclick="vardiyaUretVeKaydet()">âœ¨ OTO VARDÄ°YA</button>
      <button class="btn" style="background:#ea4335;width:100%;margin-bottom:6px" onclick="bulutaKaydet()">â˜ï¸ BULUTA KAYDET</button>
    </div>

    <div class="admin-tabs" style="margin-bottom:12px">
      <button id="tab-personel-btn" class="tab-btn active" onclick="showTab('personel')" style="padding:8px;border-radius:6px">Personel</button>
      <button id="tab-talepler-btn" class="tab-btn" onclick="showTab('talepler')" style="padding:8px;border-radius:6px">Talepler</button>
      <button id="tab-telegram-btn" class="tab-btn" onclick="showTab('telegram')" style="padding:8px;border-radius:6px">Telegram</button>
      <button id="tab-logs-btn" class="tab-btn" onclick="showTab('logs')" style="padding:8px;border-radius:6px">Loglar</button>
    </div>

    <div id="tab-personel" class="tab-content">
      <div style="background:#fff;padding:10px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px">
        <input id="newName" placeholder="AD SOYAD" style="margin-bottom:8px" />
        <select id="newUnit" style="margin-bottom:8px"></select>
        <input id="newTelegram" placeholder="Telegram Chat ID (opsiyonel)" style="margin-bottom:8px" />
        <button class="btn" style="background:var(--success);width:100%" onclick="addPersonel()">+ Personel Ekle</button>
      </div>
      <div id="personelList"></div>
    </div>

    <div id="tab-talepler" class="tab-content hidden">
      <div id="taleplerList" style="max-height:420px;overflow:auto"></div>
    </div>

    <div id="tab-telegram" class="tab-content hidden">
      <div style="background:#f3f3f3;padding:10px;border-radius:8px;margin-bottom:10px">
        <label>Bot Token</label>
        <input id="telegramBotToken" placeholder="123456:ABC-DEF..." style="margin-bottom:8px" />
        <label>Admin Chat ID</label>
        <input id="telegramAdminId" placeholder="Admin Chat ID" style="margin-bottom:8px" />
        <button class="btn" style="background:#4caf50;width:100%" onclick="saveTelegram()">Kaydet</button>
        <div id="telegramStatus" style="margin-top:8px;font-size:13px;color:#666"></div>
      </div>
    </div>

    <div id="tab-logs" class="tab-content hidden">
      <div id="logContainer" style="max-height:420px;overflow:auto"></div>
      <div style="margin-top:8px">
        <button style="background:#f87171;color:#fff;border:0;padding:8px;border-radius:6px" onclick="clearLogs()">LoglarÄ± Temizle</button>
      </div>
    </div>
  </div>

  <!-- TALEP MODAL (simple) -->
  <div id="talepModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:10000">
    <div style="background:#fff;padding:16px;border-radius:8px;width:320px">
      <h4 style="margin:0 0 8px 0">Vardiya / Ä°zin Talebi</h4>
      <select id="talepPersonelSelect" style="width:100%;margin-bottom:8px"></select>
      <input id="talepDate" type="date" style="width:100%;margin-bottom:8px" />
      <select id="talepType" style="width:100%;margin-bottom:8px">
        <option value="Ä°ZÄ°NLÄ°">Ä°ZÄ°NLÄ°</option>
        <option value="06:30â€“16:00">06:30â€“16:00</option>
        <option value="09:00â€“18:00">09:00â€“18:00</option>
        <option value="16:00â€“00:00">16:00â€“00:00</option>
        <option value="00:00â€“07:00">00:00â€“07:00</option>
      </select>
      <div style="display:flex;gap:8px">
        <button class="btn" style="background:var(--success);flex:1" onclick="submitTalep()">GÃ¶nder</button>
        <button style="flex:1" onclick="closeTalepModal()">Ä°ptal</button>
      </div>
    </div>
  </div>

  <script>
    // --------------------------
    // CONFIG + STATE
    // --------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBY8dA7IQ0vcdjtG0haRVFuF0vTgZACU0M",
      authDomain: "teknik-vardiya-listesi.firebaseapp.com",
      databaseURL: "https://teknik-vardiya-listesi-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "teknik-vardiya-listesi",
      storageBucket: "teknik-vardiya-listesi.firebasestorage.app",
      messagingSenderId: "900931844150",
      appId: "1:900931844150:web:41c799492e85d62df8c097"
    };

    // in-memory
    let database = null;
    let auth = null;
    const PREFIX = "vardiya_v_final_";

    let state = {
      birimler: ["TEKNÄ°K YÃ–NETMEN","SES OPERATÃ–RÃœ","KJ OPERATÃ–RÃœ","PLAYOUT OPERATÃ–RÃœ","REJÄ°","24TV MCR OPERATÃ–RÃœ","360TV MCR OPERATÃ–RÃœ","INGEST OPERATÃ–RÃœ"],
      saatler: ["06:30â€“16:00","09:00â€“18:00","16:00â€“00:00","00:00â€“07:00"],
      personeller: [],
      manuelAtamalar: {},
      kapasite: {},
      geciciGorevler: {},
      logs: [],
      duyuru: "",
      telegram: { botToken: "", adminId: "" }
    };

    // --------------------------
    // STORAGE HELPERS
    // --------------------------
    function saveToLocal(key, value) {
      try {
        localStorage.setItem(PREFIX + key, JSON.stringify(value));
      } catch (e) { console.warn("Local save failed", e); }
    }
    function loadFromLocal(key, fallback) {
      try {
        const v = localStorage.getItem(PREFIX + key);
        return v ? JSON.parse(v) : fallback;
      } catch (e) { return fallback; }
    }

    function persistState() {
      saveToLocal("personeller", state.personeller);
      saveToLocal("manuelAtamalar", state.manuelAtamalar);
      saveToLocal("duyuru", state.duyuru);
      saveToLocal("telegram", state.telegram);
      saveToLocal("logs", state.logs);
    }

    // --------------------------
    // INIT FIREBASE
    // --------------------------
    try {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      auth = firebase.auth();
    } catch (e) {
      console.error("Firebase init error", e);
    }

    // --------------------------
    // BOOTSTRAP - load local state
    // --------------------------
    (function bootstrapLocal() {
      state.personeller = loadFromLocal("personeller", []);
      state.manuelAtamalar = loadFromLocal("manuelAtamalar", {});
      state.duyuru = loadFromLocal("duyuru", "");
      state.telegram = loadFromLocal("telegram", { botToken:"", adminId:"" });
      state.logs = loadFromLocal("logs", []);
    })();

    // --------------------------
    // UI utility
    // --------------------------
    function showApp() {
      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("app").style.display = "block";
    }
    function showLogin() {
      document.getElementById("loginOverlay").style.display = "flex";
      document.getElementById("app").style.display = "none";
    }

    // --------------------------
    // AUTH: enterSystem
    // --------------------------
    async function enterSystem(role) {
      if (role === 'admin') {
        const email = prompt("YÃ¶netici E-posta:");
        const password = prompt("YÃ¶netici Åifresi:");
        if (!email || !password) return alert("E-posta ve ÅŸifre gerekli");
        try {
          await auth.signInWithEmailAndPassword(email, password);
          isAdmin = true;
          showApp();
          loadTelegramUI();
          startRealtime();
          refreshUI();
        } catch (err) {
          console.error("Auth error", err);
          alert("GiriÅŸ hatasÄ±: " + (err.message || err.code));
        }
      } else {
        // Personel: no auth, just load public data from DB (optional)
        isAdmin = false;
        try {
          if (database) {
            const snap = await database.ref('vardiya_data').once('value');
            if (snap.exists()) {
              const remote = snap.val();
              // merge basic structures if present
              if (remote.personeller) state.personeller = remote.personeller;
              if (remote.manuelAtamalar) state.manuelAtamalar = remote.manuelAtamalar;
            }
          }
        } catch (e) {
          console.warn("Failed loading cloud data", e);
        }
        showApp();
        refreshUI();
      }
    }

    // --------------------------
    // ON LOAD: wire auth state
    // --------------------------
    window.onload = function() {
      // theme (optional)
      if (localStorage.getItem(PREFIX + "theme") === "dark") document.documentElement.setAttribute("data-theme", "dark");

      // ensure UI lists
      refreshUI();

      // auth state listener: if already signed in, show admin features
      if (auth) {
        auth.onAuthStateChanged(user => {
          if (user) {
            console.log("Auth: signed in as", user.email);
            isAdmin = true;
            loadTelegramUI();
            startRealtime();
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
            showApp();
            refreshUI();
          } else {
            console.log("Auth: no user");
            // keep login overlay visible; personel can continue by clicking PERSONEL
            showLogin();
          }
        });
      } else {
        // if Firebase not init, show page but with limited features
        showLogin();
      }
    };

    // --------------------------
    // UI TAB / PANEL
    // --------------------------
    function toggleAdminPanel() {
      const p = document.getElementById("sidePanel");
      p.classList.toggle("open");
      // load current telegram values
      loadTelegramUI();
      loadTabsDefault();
    }
    function showTab(name) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById('tab-' + name).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-' + name + '-btn')?.classList?.add('active');
    }
    function loadTabsDefault() {
      // default show personel
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById('tab-personel').classList.remove('hidden');
    }

    // --------------------------
    // PERSONEL MANAGEMENT
    // --------------------------
    function refreshUI() {
      // week label
      document.getElementById("weekLabel").innerText = getMonday(new Date()).toLocaleDateString('tr-TR') + " HaftasÄ±";

      // personel list in admin panel
      const pl = document.getElementById("personelList");
      pl.innerHTML = state.personeller.map((p,i) => {
        return `<div style="padding:8px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;background:#fff">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${p.ad}</strong><div style="font-size:12px;color:#666">${p.birim}${p.telegramId?(" â€¢ tg:"+p.telegramId):""}</div></div>
            <div style="display:flex;gap:8px">
              <button onclick="removePersonel(${i})" style="background:${'#ef4444'};color:#fff;border:0;padding:6px;border-radius:6px">Sil</button>
            </div>
          </div>
        </div>`;
      }).join('');
      // populate selects
      const newUnit = document.getElementById("newUnit");
      newUnit.innerHTML = state.birimler.map(b => `<option>${b}</option>`).join('');
      const talepPersonelSelect = document.getElementById("talepPersonelSelect");
      talepPersonelSelect.innerHTML = state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
      const mobilSelect = document.getElementById("mobilSelect");
      mobilSelect.innerHTML = `<option value="">SeÃ§iniz...</option>` + state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
      // logs
      const lc = document.getElementById("logContainer");
      lc.innerHTML = state.logs.map(l=>`<div style="padding:8px;border-bottom:1px solid #eee"><small style="color:#666">${l.timestamp}</small><div>${l.user}: ${l.message}</div></div>`).join('');
      // talepler (admin)
      renderTalepler();
      // main table
      buildTable();
      // duyuru
      if (state.duyuru) {
        document.getElementById("duyuru").innerText = state.duyuru;
        document.getElementById("duyuru").classList.remove("hidden");
      } else document.getElementById("duyuru").classList.add("hidden");
    }

    function addPersonel() {
      const ad = (document.getElementById("newName").value || "").trim();
      const birim = document.getElementById("newUnit").value || state.birimler[0];
      const telegramId = (document.getElementById("newTelegram").value || "").trim();
      if (!ad) return alert("Ad giriniz");
      if (state.personeller.some(p=>p.ad === ad)) return alert("Bu personel zaten var");
      const p = { ad, birim, telegramId: telegramId || null, createdAt: new Date().toISOString() };
      state.personeller.push(p);
      addLog("Personel eklendi: "+ad,"Admin");
      persistState();
      refreshUI();
      document.getElementById("newName").value = "";
      document.getElementById("newTelegram").value = "";
    }

    function removePersonel(index) {
      if (!confirm("Silmek istediÄŸinize emin misiniz?")) return;
      const removed = state.personeller.splice(index,1)[0];
      addLog("Personel silindi: "+removed.ad,"Admin");
      persistState();
      refreshUI();
    }

    // --------------------------
    // TABLE BUILD (simple)
    // --------------------------
    function buildTable() {
      const head = document.getElementById("tableHead");
      head.innerHTML = `<tr><th>SAAT</th>${["Pzt","Sal","Ã‡ar","Per","Cum","Cmt","Paz"].map(d=>`<th>${d}</th>`).join('')}</tr>`;
      const body = document.getElementById("tableBody");
      // show rows per saat
      body.innerHTML = state.saatler.map(s=> {
        return `<tr><td class="saat-col">${s}</td>${[0,1,2,3,4,5,6].map(()=>`<td></td>`).join('')}</tr>`;
      }).join('');
      // footer izin
      const foot = document.getElementById("tableFoot");
      foot.innerHTML = `<tr><td>Ä°ZÄ°N / BOÅ</td>${[0,1,2,3,4,5,6].map(()=>`<td></td>`).join('')}</tr>`;
    }

    // --------------------------
    // TALEP: create / list / approve / reject
    // --------------------------
    async function submitTalep() {
      const ad = document.getElementById("talepPersonelSelect").value;
      const tarih = document.getElementById("talepDate").value;
      const tur = document.getElementById("talepType").value;
      if (!ad || !tarih || !tur) return alert("TÃ¼m alanlarÄ± doldurun");
      const talepId = Date.now().toString();
      const payload = { id: talepId, ad, tarih, tur, durum: "bekliyor", createdAt: new Date().toLocaleString('tr-TR') };
      try {
        if (database) await database.ref('talepler/'+talepId).set(payload);
        else console.warn("No database configured: saving locally");
        // also save locally for admin UI if offline
        addLog(`Talep oluÅŸturuldu: ${ad} ${tarih} ${tur}`, "Personel");
        persistState();
        // send telegram notification to admin (if configured)
        if (state.telegram && state.telegram.botToken && state.telegram.adminId) {
          sendTelegramNotification(ad,tarih,tur,talepId);
        }
        closeTalepModal();
        refreshUI();
        alert("Talep gÃ¶nderildi");
      } catch (e) {
        console.error("Talep gÃ¶nder hata", e);
        alert("Hata: " + e.message);
      }
    }

    function openTalepModal() {
      // fill select
      const sel = document.getElementById("talepPersonelSelect");
      sel.innerHTML = state.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
      document.getElementById("talepDate").value = "";
      document.getElementById("talepModal").style.display = "flex";
    }
    function closeTalepModal() { document.getElementById("talepModal").style.display = "none"; }

    // render talepler in admin panel (from firebase or local)
    async function renderTalepler() {
      const container = document.getElementById("taleplerList");
      container.innerHTML = "<div style='color:#666'>YÃ¼kleniyor...</div>";
      try {
        let snapshot = null;
        if (database) snapshot = await database.ref('talepler').orderByChild('durum').equalTo('bekliyor').once('value');
        if (snapshot && snapshot.exists()) {
          const arr = [];
          snapshot.forEach(s => arr.push(s.val()));
          container.innerHTML = arr.map(t => `
            <div class="talep">
              <div class="talep-header">${t.ad} â€” ${t.tarih}</div>
              <div class="talep-info">${t.tur}</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button onclick="adminOnay('${t.id}','${t.ad}','${t.tur}','${t.tarih}')" style="background:${'#16a34a'};color:#fff;border:0;padding:6px;border-radius:6px">ONAY</button>
                <button onclick="adminRed('${t.id}','${t.ad}')" style="background:${'#ef4444'};color:#fff;border:0;padding:6px;border-radius:6px">RED</button>
              </div>
            </div>
          `).join('');
        } else {
          container.innerHTML = "<div style='color:#666'>Bekleyen talep yok.</div>";
        }
      } catch (e) {
        console.error("Talepler yÃ¼klenemedi", e);
        container.innerHTML = "<div style='color:#c00'>Hata yÃ¼kleme</div>";
      }
    }

    async function adminOnay(id, ad, tur, tarih) {
      if (!confirm(`${ad} talebini onaylÄ±yor musunuz?`)) return;
      try {
        // determine hKey/day - simplified: mark manual assignment for that date (system specifics omitted)
        // update DB talep durum
        if (database) await database.ref('talepler/'+id).update({ durum:'onaylandi' });
        // send notification to personel if they have telegramId
        const person = state.personeller.find(p => p.ad === ad);
        if (person && person.telegramId) {
          await sendTelegramToPersonel(person.telegramId, `âœ… Talebiniz onaylandÄ±: ${tur} - ${tarih}`);
        }
        addLog(`Talep onaylandÄ±: ${ad} ${tur} ${tarih}`,"Admin");
        renderTalepler();
      } catch (e) { console.error(e); alert("Hata: "+e.message); }
    }

    async function adminRed(id, ad) {
      if (!confirm(`${ad} talebini reddetmek istiyor musunuz?`)) return;
      try {
        if (database) await database.ref('talepler/'+id).update({ durum:'reddedildi' });
        const person = state.personeller.find(p => p.ad === ad);
        if (person && person.telegramId) {
          await sendTelegramToPersonel(person.telegramId, `âŒ Talebiniz reddedildi. YÃ¶netici ile gÃ¶rÃ¼ÅŸÃ¼nÃ¼z.`);
        }
        addLog(`Talep reddedildi: ${ad}`,"Admin");
        renderTalepler();
      } catch (e) { console.error(e); alert("Hata: "+e.message); }
    }

    // --------------------------
    // TELEGRAM (send only)
    // --------------------------
    function loadTelegramUI() {
      const tv = state.telegram || { botToken:"", adminId:"" };
      document.getElementById("telegramBotToken").value = tv.botToken || "";
      document.getElementById("telegramAdminId").value = tv.adminId || "";
      updateTelegramStatus();
    }
    function saveTelegram() {
      const botToken = document.getElementById("telegramBotToken").value.trim();
      const adminId = document.getElementById("telegramAdminId").value.trim();
      if (!botToken || !adminId) return alert("Token ve Admin ID gerekli");
      state.telegram = { botToken, adminId };
      saveToLocal("telegram", state.telegram);
      updateTelegramStatus();
      addLog("Telegram bilgileri gÃ¼ncellendi","Admin");
      alert("Kaydedildi");
    }
    function updateTelegramStatus() {
      const s = document.getElementById("telegramStatus");
      if (state.telegram && state.telegram.botToken && state.telegram.adminId) {
        s.innerText = "Telegram konfigÃ¼re edildi (admin bildirimi aktif).";
      } else s.innerText = "Telegram yapÄ±landÄ±rÄ±lmamÄ±ÅŸ.";
    }

    async function sendTelegramNotification(personelAd, tarih, tur, talepId) {
      if (!state.telegram || !state.telegram.botToken || !state.telegram.adminId) return;
      const url = `https://api.telegram.org/bot${state.telegram.botToken}/sendMessage`;
      const text = `ğŸ“‹ Yeni talep\nğŸ‘¤ ${personelAd}\nğŸ“… ${tarih}\nğŸ“ ${tur}\nID:${talepId}`;
      try {
        await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          chat_id: state.telegram.adminId,
          text,
          parse_mode: "Markdown",
          reply_markup: {
            inline_keyboard: [
              [{ text: "âœ… ONAYLA", callback_data: `onay_${talepId}` }, { text: "âŒ REDDET", callback_data: `red_${talepId}` }]
            ]
          }
        })});
      } catch (e) { console.warn("Telegram send failed", e); }
    }

    async function sendTelegramToPersonel(chatId, message) {
      if (!state.telegram || !state.telegram.botToken) return;
      const url = `https://api.telegram.org/bot${state.telegram.botToken}/sendMessage`;
      try {
        await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          chat_id: chatId, text: message, parse_mode: "Markdown"
        })});
      } catch (e) { console.warn("Send to person failed", e); }
    }

    // --------------------------
    // REALTIME / FIREBASE SYNC
    // --------------------------
    function startRealtime() {
      if (!database) return;
      // clear previous listeners if any
      firebaseListenersCleanup();
      const ref = database.ref('talepler');
      ref.on('value', snap => {
        // re-render admin list
        renderTalepler();
      }, err => console.warn('talepler listen error',err));
      firebaseListenersCleanup.push(ref);
    }
    const firebaseListenersCleanup = [];

    // --------------------------
    // LOGS
    // --------------------------
    function addLog(message, user="Sistem") {
      const entry = { timestamp: new Date().toLocaleString('tr-TR'), user, message };
      state.logs.unshift(entry);
      if (state.logs.length>500) state.logs.pop();
      persistState();
      refreshUI();
    }
    function clearLogs(){ if (!confirm("Temizlensin mi?")) return; state.logs=[]; persistState(); refreshUI(); }

    // --------------------------
    // OTHER ACTIONS / UTIL
    // --------------------------
    function excelIndir(){ alert("Excel oluÅŸturma (placeholder)"); }
    function bulutaKaydet(){ if (!database) return alert("Bulut ayarlÄ± deÄŸil"); database.ref('vardiya_data').set({ personeller: state.personeller, manuelAtamalar: state.manuelAtamalar }).then(()=>alert("Buluta kaydedildi")).catch(e=>alert("Hata:"+e.message)); }
    function haftaDegistir(v){ const d = getMonday(new Date()); d.setDate(d.getDate()+v); currentMonday = d; buildTable(); }
    function vardiyaUretVeKaydet(){ alert("Otomatik vardiya (placeholder)"); addLog("Otomatik vardiya Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±","Admin"); }
    function mobilVerileriYenile(){ alert("Mobil verileri yenilendi (placeholder)"); }
    function getMonday(d){ if(!(d instanceof Date)) d=new Date(d); let day=d.getDay(); return new Date(d.setDate(d.getDate()-day+(day===0?-6:1))); }

    // --------------------------
    // START helpers
    // --------------------------
    // allow tab content initial mapping (IDs used)
    (function wireTabButtons(){
      // provide map id fix for dynamic calls (safe)
      window.showTab = function(t){
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
        const el = document.getElementById('tab-'+t);
        if (el) el.classList.remove('hidden');
      };
    })();

    // expose some functions for buttons
    window.openTalepModal = openTalepModal;
    window.closeTalepModal = closeTalepModal;
    window.submitTalep = submitTalep;
    window.addPersonel = addPersonel;
    window.toggleAdminPanel = toggleAdminPanel;
    window.refreshUI = refreshUI;
    window.clearLogs = clearLogs;
    window.vardiyaUretVeKaydet = vardiyaUretVeKaydet;
    window.bulutaKaydet = bulutaKaydet;
    window.excelIndir = excelIndir;
    window.haftaDegistir = haftaDegistir;
    window.cikisYap = async function(){ if(auth) await auth.signOut(); location.reload(); };

  </script>
</body>
</html>
