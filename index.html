<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TURKMEDYA TEKNiK VARDiYA LiSTESi | Pro_Ugr</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #1e293b; --blue: #2563eb; --bg: #f1f5f9; --card-bg: #ffffff;
      --text: #334155; --border: #e2e8f0; --danger: #ef4444; --success: #22c55e;
      --warning: #f59e0b; --weekend-bg: #fff1f2; --table-head: #f8fafc;
      --saat1: #e0f2fe; --saat2: #f0fdf4; --saat3: #faf5ff; --saat4: #fff7ed;
      --izin-bg: #fef2f2;
    }
    [data-theme="dark"] {
      --primary: #0f172a; --bg: #020617; --card-bg: #1e293b; --text: #f1f5f9;
      --border: #334155; --weekend-bg: #2d1a1a; --table-head: #0f172a;
      --saat1: #0c4a6e; --saat2: #064e3b; --saat3: #581c87; --saat4: #7c2d12;
      --izin-bg: #450a0a;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; font-size: 12px; transition: background 0.3s ease; }
    .app-wrapper { padding: 10px; }
    
    .main-header { 
        display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; 
        background: var(--primary); color: white; padding: 10px 15px; border-radius: 12px; 
        margin-bottom: 15px; gap: 10px;
    }

    .table-container { 
        overflow-x: auto; background: var(--card-bg); border-radius: 12px; 
        border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
    }
    
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; table-layout: fixed; }
    th { background: var(--table-head); color: var(--text); padding: 12px 8px; border-bottom: 2px solid var(--border); border-right: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
    td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 6px; vertical-align: top; height: 95px; }
    
    /* Saat ve ƒ∞zin S√ºtunu Renklendirmeleri */
    .saat-col { font-weight: 800; text-align: center; color: var(--text); border-left: 5px solid var(--blue); }
    .row-saat-0 { background-color: var(--saat1); }
    .row-saat-1 { background-color: var(--saat2); }
    .row-saat-2 { background-color: var(--saat3); }
    .row-saat-3 { background-color: var(--saat4); }
    .row-izin { background-color: var(--izin-bg) !important; }
    .row-izin td { border-bottom: none; }
    .row-izin .saat-col { border-left-color: var(--danger) !important; color: var(--danger); }

    .weekend-col { background-color: var(--weekend-bg) !important; }
    
    .birim-card { 
        border-left: 4px solid var(--blue); padding: 6px 8px; margin-bottom: 5px; 
        background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border); 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s;
    }
    .birim-card:hover { transform: translateY(-2px); }
    .birim-tag { font-size: 7px; font-weight: 800; color: white; display: inline-block; padding: 1px 4px; border-radius: 3px; margin-bottom: 2px; text-transform: uppercase; }
    .pers-name { font-size: 10px; font-weight: 700; display: block; }

    .side-panel { position: fixed; top: 0; right: -550px; width: 500px; height: 100%; background: var(--card-bg); z-index: 1000; transition: 0.4s; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.2); }
    .side-panel.open { right: 0; }
    .panel-content { padding: 15px; overflow-y: auto; flex: 1; }
    
    .admin-action-group { 
        display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; 
        background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border);
    }

    .btn-main-action { 
        padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 11px;
        display: flex; align-items: center; justify-content: center; gap: 6px; color: white; transition: opacity 0.2s;
    }
    .btn-main-action:active { opacity: 0.7; }
    
    .izin-gun-pill { padding: 4px 6px; background: var(--bg); border-radius: 4px; margin: 2px; font-size: 9px; cursor: pointer; display: inline-block; font-weight: 700; border: 1px solid var(--border); }
    .izin-gun-pill.active { background: var(--danger); color: white; }

    @media (max-width: 600px) {
        .side-panel { width: 100%; right: -100%; }
        .main-header { padding: 10px; justify-content: center; }
        .main-header h1 { font-size: 13px !important; }
        .btn-main-action { padding: 8px 10px; font-size: 10px; }
        .table-container { margin: 0 -10px; border-radius: 0; }
    }
    @media print { .no-print { display: none !important; } body { background: white; } }
  </style>
</head>
<body>
  <div id="panelOverlay" class="panel-overlay no-print" onclick="toggleAdminPanel()" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none;"></div>
  
  <div class="app-wrapper">
    <header class="main-header no-print">
      <div style="display: flex; align-items: center; gap: 10px;">
        <img src="logo.png" alt="Logo" style="height: 35px;">
        <div>
          <h1 style="margin:0; font-size:16px;">VARDiYA LiSTESi <span style="color:var(--blue)">V62</span></h1>
          <p id="tarihAraligi" style="margin:0; opacity:0.8; font-size:10px;"></p>
        </div>
      </div>
      <div style="display:flex; gap:5px; flex-wrap: wrap; justify-content: center;">
        <button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#475569">¬´</button>
        <button onclick="toggleTheme()" class="btn-main-action" style="background:#64748b" id="themeBtn">üåô</button>
        <button onclick="buluttanYukle()" class="btn-main-action" style="background:#4285f4">üîÑ Y√úKLE</button>
        <button onclick="excelIndir()" class="btn-main-action" style="background:#16a34a">EXCEL</button>
        <button onclick="window.print()" class="btn-main-action" style="background:var(--blue)">PDF</button>
        <button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#475569">¬ª</button>
        <button onclick="toggleAdminPanel()" class="btn-main-action" style="background:var(--primary); border: 1px solid #475569;">‚öô AYARLAR</button>
      </div>
    </header>

    <main class="table-container">
        <table id="vardiyaTablosu">
            <thead id="tableHeader"></thead>
            <tbody id="tableBody"></tbody>
            <tfoot id="tableFooter"></tfoot>
        </table>
    </main>
  </div>

  <div id="sidePanel" class="side-panel no-print">
    <div class="panel-header" style="padding:15px; background:var(--primary); color:white; display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; font-size:16px;">Y√∂netim Paneli</h2>
        <button onclick="toggleAdminPanel()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
    </div>
    
    <div class="panel-content">
        <div class="admin-action-group">
            <button onclick="vardiyaUretVeKaydet()" class="btn-main-action" style="background:var(--success); grid-column: span 2; font-size:13px; padding:15px;">‚ú® VARDƒ∞YA OLU≈ûTUR</button>
            <button onclick="bulutaKaydet()" class="btn-main-action" style="background:#ea4335">‚òÅÔ∏è BULUTA KAYDET</button>
            <button onclick="whatsappGonder()" class="btn-main-action" style="background:#25D366">üü¢ WHATSAPP</button>
        </div>

        <div class="admin-tabs" style="display:flex; gap:2px; margin-bottom:15px; background:var(--bg); padding:4px; border-radius:8px;">
          <button id="btn-tab-personel" class="tab-btn" onclick="tabDegistir('personel')" style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-size:10px; font-weight:700;">Personel</button>
          <button id="btn-tab-kapasite" class="tab-btn" onclick="tabDegistir('kapasite')" style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-size:10px; font-weight:700;">Kapasite</button>
          <button id="btn-tab-sabitle" class="tab-btn" onclick="tabDegistir('sabitle')" style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-size:10px; font-weight:700;">Sabitler</button>
          <button id="btn-tab-sistem" class="tab-btn" onclick="tabDegistir('sistem')" style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-size:10px; font-weight:700;">Sistem</button>
        </div>

        <div id="tab-personel" class="tab-content">
            <div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:15px;">
              <input type="text" id="yeniPersInp" placeholder="Ad Soyad" style="width:95%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);">
              <select id="yeniPersBirimSec" style="width:100%; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border);"></select>
              <button onclick="personelEkle()" class="btn-main-action" style="width:100%; background:var(--success)">PERSONEL EKLE</button>
            </div>
            <div id="persListesiAdmin"></div>
        </div>
        <div id="tab-sabitle" class="tab-content hidden">
            <div id="sabitListeAdmin"></div>
        </div>
        <div id="tab-kapasite" class="tab-content hidden"><div id="kapasiteTable"></div></div>
        <div id="tab-sistem" class="tab-content hidden">
            <button onclick="jsonYedekAl()" class="btn-main-action" style="width:100%; background:var(--blue); margin-bottom:10px;">üíæ JSON ƒ∞NDƒ∞R</button>
            <button onclick="jsonYedekYukle()" class="btn-main-action" style="width:100%; background:var(--success); margin-bottom:10px;">üìÇ YEDEƒûƒ∞ Y√úKLE</button>
            <input type="file" id="jsonInput" style="display:none" onchange="handleFileSelect(this)">
            <button onclick="vardiyaSifirla()" class="btn-main-action" style="width:100%; background:var(--warning); margin-bottom:10px;">Bu Haftayƒ± Temizle</button>
            <button onclick="tamSifirla()" class="btn-main-action" style="width:100%; background:var(--danger)">T√ºm Hafƒ±zayƒ± Sil</button>
        </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBY8dA7IQ0vcdjtG0haRVFuF0vTgZACU0M",
      authDomain: "teknik-vardiya-listesi.firebaseapp.com",
      databaseURL: "https://teknik-vardiya-listesi-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "teknik-vardiya-listesi",
      storageBucket: "teknik-vardiya-listesi.firebasestorage.app",
      messagingSenderId: "900931844150",
      appId: "1:900931844150:web:41c799492e85d62df8c097"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const GUNLER = ["Pzt", "Sal", "√áar", "Per", "Cum", "Cmt", "Paz"];
    const PREFIX = "v76_";
    const PANEL_SIFRE = "6161"; 

    const BIRIM_RENKLERI = {
        "TEKNƒ∞K Y√ñNETMEN": "#2563eb", "SES OPERAT√ñR√ú": "#7c3aed", "KJ OPERAT√ñR√ú": "#db2777",
        "PLAYOUT OPERAT√ñR√ú": "#059669", "REJƒ∞": "#d97706", "MCR": "#9333ea", "INGEST OPERAT√ñR√ú": "#06b6d4"
    };

    let state = {
        birimler: JSON.parse(localStorage.getItem(PREFIX + "birimler")) || ["TEKNƒ∞K Y√ñNETMEN", "SES OPERAT√ñR√ú", "KJ OPERAT√ñR√ú", "PLAYOUT OPERAT√ñR√ú", "MCR", "INGEST OPERAT√ñR√ú"],
        saatler: JSON.parse(localStorage.getItem(PREFIX + "saatler")) || ["06:30‚Äì16:00", "09:00‚Äì18:00", "16:00‚Äì00:00", "00:00‚Äì07:00"],
        personeller: JSON.parse(localStorage.getItem(PREFIX + "personeller")) || [],
        kapasite: JSON.parse(localStorage.getItem(PREFIX + "kapasite")) || {},
        manuelAtamalar: JSON.parse(localStorage.getItem(PREFIX + "manuelAtamalar")) || {},
        haftaIciSabitler: JSON.parse(localStorage.getItem(PREFIX + "haftaIciSabitler")) || {}
    };

    let currentMonday = getMonday(new Date());
    function getMonday(d) { d = new Date(d); let day = d.getDay(); return new Date(d.setDate(d.getDate() - day + (day == 0 ? -6 : 1))); }
    function save() { Object.keys(state).forEach(k => localStorage.setItem(PREFIX + k, JSON.stringify(state[k]))); }
    function getBirimColor(birim) { return BIRIM_RENKLERI[birim] || "#64748b"; }

    function tabloyuOlustur() {
        const hKey = currentMonday.toISOString().split('T')[0];
        document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} Haftasƒ±`;
        document.getElementById("tableHeader").innerHTML = `<tr><th style="width:100px;">SAAT</th>${GUNLER.map((g,i)=>`<th class="${i>=5?'weekend-col':''}">${g}</th>`).join('')}</tr>`;
        
        let prog = {}; let calis = {};
        state.personeller.forEach(p => { 
            prog[p.ad] = Array(7).fill(null); calis[p.ad] = 0;
            for(let i=0; i<7; i++) {
                let mKey = `${hKey}_${p.ad}_${i}`;
                if(state.manuelAtamalar[mKey]) prog[p.ad][i] = state.manuelAtamalar[mKey];
                if(prog[p.ad][i] && !["ƒ∞Zƒ∞NLƒ∞","BO≈û",null].includes(prog[p.ad][i])) calis[p.ad]++;
            }
        });

        document.getElementById("tableBody").innerHTML = state.saatler.map((s, sIdx) => `
            <tr>
                <td class="saat-col row-saat-${sIdx}">${s}</td>
                ${[0,1,2,3,4,5,6].map(g => `
                    <td class="${g>=5?'weekend-col':''}" ondragover="event.preventDefault()" ondrop="drop(event, '${s}', ${g})">
                        ${state.personeller.filter(p => prog[p.ad][g] === s).map(p => `
                            <div class="birim-card" style="border-left-color:${getBirimColor(p.birim)}; background-color:${getBirimColor(p.birim)}10;" draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, '${s}')" onclick="vardiyaDegistir('${p.ad}',${g})">
                                <span class="birim-tag" style="background:${getBirimColor(p.birim)}">${p.birim}</span>
                                <span class="pers-name">${p.ad}</span>
                            </div>
                        `).join('')}
                    </td>
                `).join('')}
            </tr>
        `).join('');

        document.getElementById("tableFooter").innerHTML = `
            <tr class="row-izin">
                <td class="saat-col">ƒ∞Zƒ∞N / BO≈û</td>
                ${[0,1,2,3,4,5,6].map(g => `
                    <td class="${g>=5?'weekend-col':''}" ondragover="event.preventDefault()" ondrop="drop(event, 'BO≈û', ${g})">
                        ${state.personeller.filter(p => ["ƒ∞Zƒ∞NLƒ∞","BO≈û",null].includes(prog[p.ad][g])).map(p => `
                            <div class="birim-card" style="border-left-color:${getBirimColor(p.birim)}; opacity:0.8;" draggable="true" ondragstart="drag(event, '${p.ad}', ${g}, 'BO≈û')" onclick="vardiyaDegistir('${p.ad}',${g})">
                                <span class="birim-tag" style="background:${prog[p.ad][g]==='ƒ∞Zƒ∞NLƒ∞'?'var(--danger)':getBirimColor(p.birim)}">${prog[p.ad][g]==='ƒ∞Zƒ∞NLƒ∞'?'ƒ∞Zƒ∞NLƒ∞':p.birim}</span>
                                <span class="pers-name">${p.ad} (${calis[p.ad]}G)</span>
                            </div>
                        `).join('')}
                    </td>
                `).join('')}
            </tr>`;
    }

    function bulutaKaydet() { database.ref('vardiya_data').set(state).then(() => alert("Buluta kaydedildi!")).catch((e) => alert("Hata: " + e.message)); }
    function buluttanYukle() { if(confirm("Buluttaki g√ºncel veriler y√ºklensin mi?")) { database.ref('vardiya_data').once('value').then((snapshot) => { if(snapshot.exists()) { state = snapshot.val(); save(); tabloyuOlustur(); alert("Veriler ba≈üarƒ±yla √ßekildi."); } }); } }
    
    function vardiyaUretVeKaydet() {
        const hKey = currentMonday.toISOString().split('T')[0];
        let tempProg = {}; let calis = {};
        state.personeller.forEach(p => { 
            tempProg[p.ad] = Array(7).fill(null); calis[p.ad] = 0; 
            if(p.izinGunleri) p.izinGunleri.forEach(gi => tempProg[p.ad][gi] = "ƒ∞Zƒ∞NLƒ∞");
            if (state.haftaIciSabitler[p.ad]) {
                const sabitSaat = state.haftaIciSabitler[p.ad];
                for(let i=0; i<5; i++) tempProg[p.ad][i] = sabitSaat;
                calis[p.ad] = 5;
            }
        });
        // (Vardiya daƒüƒ±tƒ±m algoritmasƒ±...)
        for (let gun = 0; gun < 7; gun++) {
            state.saatler.forEach(saat => {
                state.birimler.forEach(birim => {
                    const hedef = (state.kapasite[`${birim}_${saat}`] || [0,0,0,0,0,0,0])[gun];
                    let mevcut = state.personeller.filter(p => p.birim === birim && tempProg[p.ad][gun] === saat).length;
                    if (mevcut < hedef) {
                        let adaylar = state.personeller.filter(p => p.birim === birim && tempProg[p.ad][gun] === null);
                        for (let p of adaylar) { if (mevcut < hedef && calis[p.ad] < 6) { tempProg[p.ad][gun] = saat; calis[p.ad]++; mevcut++; } }
                    }
                });
            });
        }
        state.personeller.forEach(p => { for(let i=0; i<7; i++) if(tempProg[p.ad][i]) state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] = tempProg[p.ad][i]; });
        save(); tabloyuOlustur(); alert("Vardiya planlandƒ±.");
    }

    function toggleAdminPanel() { 
        const p = document.getElementById("sidePanel"); 
        const o = document.getElementById("panelOverlay"); 
        if (!p.classList.contains("open")) { 
            const pass = prompt("Y√∂netici ≈ûifresi:"); 
            if (pass !== PANEL_SIFRE) { alert("Yetkisiz Giri≈ü!"); return; } 
        } 
        p.classList.toggle("open"); 
        o.style.display = p.classList.contains("open") ? "block" : "none";
        if(p.classList.contains("open")) tabDegistir('personel'); 
    }

    function tabDegistir(t) { 
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); 
        document.querySelectorAll('.tab-btn').forEach(el => { el.style.background = "none"; el.style.color = "#64748b"; }); 
        document.getElementById('tab-' + t).classList.remove('hidden'); 
        const activeBtn = document.getElementById('btn-tab-' + t);
        activeBtn.style.background = "var(--card-bg)"; activeBtn.style.color = "var(--blue)";
        refreshUI(); 
    }

    function drag(e, p, g, oldSaat) { e.dataTransfer.setData("p", p); e.dataTransfer.setData("oldG", g); e.dataTransfer.setData("oldSaat", oldSaat); }
    function drop(e, newSaat, newG) { e.preventDefault(); const p = e.dataTransfer.getData("p"); const oldG = e.dataTransfer.getData("oldG"); const hKey = currentMonday.toISOString().split('T')[0]; delete state.manuelAtamalar[`${hKey}_${p}_${oldG}`]; state.manuelAtamalar[`${hKey}_${p}_${newG}`] = (newSaat === 'BO≈û' ? null : newSaat); save(); tabloyuOlustur(); }
    
    function refreshUI() {
        document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
        document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => `<div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:5px;"><strong>${p.ad}</strong> <button onclick="state.personeller.splice(${i},1); save(); refreshUI(); tabloyuOlustur();" style="color:var(--danger); border:none; background:none; cursor:pointer; float:right;">Sil</button><div style="margin-top:5px;">${GUNLER.map((g, gi) => `<span class="izin-gun-pill ${p.izinGunleri?.includes(gi)?'active':''}" onclick="izinGunuTetikle(${i},${gi})">${g}</span>`).join('')}</div></div>`).join('');
        let capHtml = ""; state.birimler.forEach(b => { capHtml += `<div style="margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:5px;"><strong>${b}</strong>`; state.saatler.forEach(s => { const v = state.kapasite[`${b}_${s}`] || [0,0,0,0,0,0,0]; capHtml += `<div style="font-size:9px; margin:4px 0;">${s}</div><div style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px;">${GUNLER.map((g, gi) => `<input type="number" value="${v[gi]}" style="width:100%; padding:2px; font-size:10px; text-align:center;" onchange="capUp('${b}_${s}',${gi},this.value)">`).join('')}</div>`; }); capHtml += `</div>`; });
        document.getElementById("kapasiteTable").innerHTML = capHtml;
        document.getElementById("sabitListeAdmin").innerHTML = state.personeller.filter(p => p.birim !== "TEKNƒ∞K Y√ñNETMEN").map(p => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:11px; align-items:center; background:var(--bg); padding:6px; border-radius:4px;"><label style="font-weight:600;"><input type="checkbox" ${state.haftaIciSabitler[p.ad]?'checked':''} onchange="sabitTetikle('${p.ad}')"> ${p.ad}</label><select onchange="sabitSaatGuncelle('${p.ad}', this.value)" ${!state.haftaIciSabitler[p.ad]?'disabled':''} style="font-size:10px;">${state.saatler.map(s => `<option value="${s}" ${state.haftaIciSabitler[p.ad] === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`).join('');
    }

    function capUp(k, g, v) { if(!state.kapasite[k]) state.kapasite[k] = [0,0,0,0,0,0,0]; state.kapasite[k][g] = parseInt(v) || 0; save(); }
    function izinGunuTetikle(pi, gi) { if(!state.personeller[pi].izinGunleri) state.personeller[pi].izinGunleri = []; const idx = state.personeller[pi].izinGunleri.indexOf(gi); if(idx > -1) state.personeller[pi].izinGunleri.splice(idx, 1); else state.personeller[pi].izinGunleri.push(gi); save(); refreshUI(); }
    function personelEkle() { const ad = document.getElementById("yeniPersInp").value.toUpperCase(); const b = document.getElementById("yeniPersBirimSec").value; if(ad){ state.personeller.push({ad, birim:b, izinGunleri:[]}); save(); refreshUI(); document.getElementById("yeniPersInp").value=""; } }
    function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + v); tabloyuOlustur(); }
    function vardiyaSifirla() { if(confirm("Bu haftayƒ± temizle?")) { const hKey = currentMonday.toISOString().split('T')[0]; Object.keys(state.manuelAtamalar).forEach(k => { if(k.startsWith(hKey)) delete state.manuelAtamalar[k]; }); save(); tabloyuOlustur(); } }
    function tamSifirla() { if(confirm("T√úM VERƒ∞LER Sƒ∞Lƒ∞NECEK! Emin misiniz?")) { localStorage.clear(); location.reload(); } }
    function jsonYedekAl() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "VardiyaYedek.json"); dl.click(); }
    function jsonYedekYukle() { document.getElementById('jsonInput').click(); }
    function handleFileSelect(input) { const f = input.files[0]; if(f){ const r = new FileReader(); r.onload = (e) => { state = JSON.parse(e.target.result); save(); location.reload(); }; r.readAsText(f); } }
    function toggleTheme() { const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark"; document.documentElement.setAttribute("data-theme", t); localStorage.setItem(PREFIX + "theme", t); document.getElementById("themeBtn").innerText = t === "dark" ? "‚òÄÔ∏è" : "üåô"; }
    function excelIndir() { let csv = "\uFEFFSaat;" + GUNLER.join(";") + "\n"; state.saatler.forEach(s => { let r = s + ";"; GUNLER.forEach((g,i) => { r += state.personeller.filter(p => state.manuelAtamalar[`${currentMonday.toISOString().split('T')[0]}_${p.ad}_${i}`] === s).map(p=>p.ad).join(", ") + ";"; }); csv += r + "\n"; }); const b = new Blob([csv], {type:'text/csv'}); const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = "Vardiya_Listesi.csv"; l.click(); }
    function whatsappGonder() { const hKey = currentMonday.toISOString().split('T')[0]; let m = `*üìÖ ${currentMonday.toLocaleDateString('tr-TR')} VARDƒ∞YASI*\n\n`; GUNLER.forEach((g, i) => { m += `*${g.toUpperCase()}*\n`; state.saatler.forEach(s => { let pList = state.personeller.filter(p => state.manuelAtamalar[`${hKey}_${p.ad}_${i}`] === s).map(p => p.ad).join(", "); if (pList) m += `‚Ä¢ ${s}: ${pList}\n`; }); m += `\n`; }); window.open(`https://wa.me/?text=${encodeURIComponent(m)}`, '_blank'); }
    function vardiyaDegistir(p, g) { const s = prompt(`${p} Se√ßimi: (1:06:30, 2:09:00, 3:16:00, 4:00:00, 5:ƒ∞Zƒ∞N, 6:Sƒ∞L)`); if(s){ let val = null; if(s=="1") val="06:30‚Äì16:00"; if(s=="2") val="09:00‚Äì18:00"; if(s=="3") val="16:00‚Äì00:00"; if(s=="4") val="00:00‚Äì07:00"; if(s=="5") val="ƒ∞Zƒ∞NLƒ∞"; state.manuelAtamalar[`${currentMonday.toISOString().split('T')[0]}_${p}_${g}`] = val; save(); tabloyuOlustur(); } }
    function sabitTetikle(ad) { if(state.haftaIciSabitler[ad]) delete state.haftaIciSabitler[ad]; else state.haftaIciSabitler[ad] = state.saatler[0]; save(); refreshUI(); }
    function sabitSaatGuncelle(ad, saat) { state.haftaIciSabitler[ad] = saat; save(); }

    window.onload = () => { 
        if(localStorage.getItem(PREFIX + "theme") === "dark") { document.documentElement.setAttribute("data-theme", "dark"); document.getElementById("themeBtn").innerText = "‚òÄÔ∏è"; } 
        tabloyuOlustur(); 
        refreshUI(); 
    };
  </script>
</body>
</html>